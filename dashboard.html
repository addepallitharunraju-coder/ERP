<!DOCTYPE html>
<!-- Cache bust v5.0 - Fixed PF No fetching in downloadPayslip function -->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard - SoftSol ERP</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fontselect@0.1.2/css/fontselect.css">
    <script src="https://cdn.jsdelivr.net/npm/fontselect@0.1.2/js/jquery.fontselect.min.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link id="google-font-link" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        video#bgVideo {
            position: fixed;
            top: 0;
            left: 0;
            min-width: 100%;
            min-height: 100%;
            object-fit: cover;
            z-index: -1;
        }

        .top-buttons {
            position: absolute;
            top: 20px;
            right: 30px;
            z-index: 10;
        }

        .btn {
            text-decoration: none;
            background-color: rgba(255, 50, 50, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: rgba(200, 20, 20, 0.85);
        }

        .dashboard-content {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 90vw;
            max-width: 1200px;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 60px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            z-index: 5;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 240px;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding-top: 60px;
            padding-left: 20px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 10;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }

        .sidebar ul li {
            padding: 12px 0;
            font-size: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: color 0.3s;
        }

        .sidebar ul li:hover {
            color: #00bfff;
        }

        #mainContent {
            margin-left: 260px;
            padding: 40px;
            color: white;
            display: none;
            z-index: 5;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }


        input,
        textarea,
        select,
        .btn,
        button {
            transition: all 0.3s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: #00d1ff;
            background: rgba(0, 209, 255, 0.1);
            outline: none;
        }

        .member-select-container {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
        }

        .teams-subsection {
            transition: all 0.3s ease;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 209, 255, 0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .project-card:hover {
            transform: scale(1.02);
            background: rgba(0, 209, 255, 0.1);
        }

        .add-tab-button {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
        }

        .add-tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.6);
        }

        /* salaries */
        .salaries-container {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
        }

        .salaries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .salaries-section {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 209, 255, 0.1);
        }

        .salaries-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
        }

        .salaries-section-header h3 {
            color: #00d1ff;
            font-size: 22px;
            margin: 0;
        }

        .salaries-section-content {
            display: grid;
            /* Use a single column for all fields to ensure they stack vertically */
            grid-template-columns: 1fr;
            gap: 15px;
            transition: all 0.3s ease-out;
            max-height: 500px;
            overflow: hidden;
            opacity: 1;
        }

        .salaries-section-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .salaries-section-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        /* This new class will be used to wrap each label and input pair */
        .salaries-field-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            /* Align text and input to the left */
        }

        .salaries-field-group label {
            margin-bottom: 5px;
            /* Add a small gap between label and input */
        }

       /* Update the existing styles for input elements */
.salaries-field-group input,
.salaries-field-group div.salaries-total-field {
    width: 100%;
    padding: 8px 12px;
    border-radius: 5px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

/* Add a new, specific rule for the dropdown in the header */
.salaries-header select {
    background-color: #333 !important;
    color: #fff !important;
    border: 1px solid #666 !important;
    padding: 8px 12px;
    border-radius: 5px;
}

        .salaries-main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .salaries-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .salaries-actions button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .salaries-actions .save-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
        }

        .salaries-actions .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.6);
        }

        .salaries-actions .download-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
        }

        .salaries-actions .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.6);
        }

        .salaries-actions .download-sheet-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #333;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);
        }

        .salaries-actions .download-sheet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.6);
        }

        .download-payslips-container {
            position: relative;
            display: inline-block;
        }

        .download-payslips-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #333;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }

        .download-payslips-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.6);
        }

        .download-payslips-btn::after {
            content: ' ▼';
            font-size: 12px;
            margin-left: 8px;
        }

        .payslips-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: #2c2c2c;
            border: 1px solid #555;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            min-width: 200px;
        }

        .payslips-dropdown.show {
            display: block;
        }

        .payslips-dropdown .payslip-option {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background: transparent;
            color: #fff;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .payslips-dropdown .payslip-option:hover {
            background: rgba(255, 193, 7, 0.2);
        }

        .payslips-dropdown .payslip-option:first-child {
            border-radius: 8px 8px 0 0;
        }

        .payslips-dropdown .payslip-option:last-child {
            border-radius: 0 0 8px 8px;
        }

        .download-salary-sheet-container {
            position: relative;
            display: inline-block;
        }

        .download-salary-sheet-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(23, 162, 184, 0.4);
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }

        .download-salary-sheet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(23, 162, 184, 0.6);
        }

        .download-salary-sheet-btn::after {
            content: ' ▼';
            font-size: 12px;
            margin-left: 8px;
        }

        .salary-sheet-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: #2c2c2c;
            border: 1px solid #555;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            min-width: 200px;
        }

        .salary-sheet-dropdown.show {
            display: block;
        }

        .salary-sheet-dropdown .salary-sheet-option {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background: transparent;
            color: #fff;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .salary-sheet-dropdown .salary-sheet-option:hover {
            background: rgba(23, 162, 184, 0.2);
        }

        .salary-sheet-dropdown .salary-sheet-option:first-child {
            border-radius: 8px 8px 0 0;
        }

        .salary-sheet-dropdown .salary-sheet-option:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* Billing Styles */
        .product-cards-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .product-card-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            width: 300px;
            text-align: left;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 209, 255, 0.2);
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .product-card-item:hover {
            transform: translateY(-5px);
            background: rgba(0, 209, 255, 0.15);
        }

        .product-card-item h3 {
            font-size: 28px;
            color: #00d1ff;
            margin-bottom: 10px;
        }

        .product-card-item .price {
            font-size: 48px;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
        }

        .product-card-item .price small {
            font-size: 18px;
            color: #ccc;
        }

        .product-card-item .description {
            color: #ccc;
            font-size: 15px;
            margin-bottom: 25px;
            min-height: 45px;
        }

        .product-card-item ul {
            list-style: none;
            padding: 0;
            margin-bottom: 30px;
        }

        .product-card-item ul li {
            color: #eee;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .product-card-item ul li::before {
            content: '⚡';
            margin-right: 10px;
            color: #00d1ff;
            font-size: 20px;
        }

        .product-card-item .btn-select {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .product-card-item .btn-select:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .product-card-item.popular {
            border: 2px solid #00d1ff;
            box-shadow: 0 8px 30px rgba(0, 209, 255, 0.4);
            background: rgba(0, 209, 255, 0.08);
            position: relative;
        }

        .product-card-item.popular::before {
            content: 'POPULAR';
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #00d1ff;
            color: #1e1e1e;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .countdown-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .countdown-timer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            font-size: 24px;
            color: #00d1ff;
            font-family: 'monospace', 'Courier New', Courier;
            font-weight: bold;
        }

        .time-segment {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }

        .time-segment small {
            font-size: 10px;
            color: #ccc;
            text-transform: uppercase;
            font-weight: normal;
            margin-top: 4px;
        }

        .time-colon {
            /* Vertically align the colons with the numbers */
            padding-bottom: 12px;
        }

        /* Settings Styles */
        .appearance-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 16px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: 0.3s ease;
        }

        .appearance-card:hover {
            background: rgba(0, 123, 255, 0.2);
            transform: scale(1.01);
        }

        .appearance-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 17px;
            font-weight: 600;
            color: #fff;
        }

        .appearance-content {
            margin-top: 12px;
            display: none;
        }

        .appearance-select,
        .appearance-input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            background: #111;
            color: #fff;
            border: 1px solid #555;
        }

        /* New Styles for the Assets UI */
        .assets-list-container {
            padding-top: 1rem;
            max-height: 75vh;
            overflow-y: auto;
        }

        .asset-item-card {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        .asset-item-card:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
        }

        .asset-header .toggle-icon {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .asset-header.expanded .toggle-icon {
            transform: rotate(90deg);
        }

        .asset-details {
            display: none;
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .asset-details p {
            margin: 5px 0;
            color: #ccc;
        }

        .asset-details strong {
            color: #fff;
        }

        .asset-details button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .search-bar-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #assetSearch {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
        }

        .filter-button {
            background-color: rgba(0, 123, 255, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            white-space: nowrap;
        }

        .filter-button:hover {
            background-color: rgba(0, 123, 255, 1);
        }

        .filter-options {
            display: flex;
            gap: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-dropdown label {
            margin-right: 10px;
        }

        .filter-dropdown select {
            padding: 8px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* support styling */
        /* support styling */



        .support-container {
            padding: 0;
            /* Remove padding from here */
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            /* Add flex properties */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        /* Support Module Styles */
        .query-box {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(0, 209, 255, 0.3);
            padding: 30px;
            margin-bottom: 25px;
            flex-shrink: 0;
            /* Prevents this box from shrinking */
        }

        .query-box textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 1);
            color: #333;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 20px;
        }

        .query-box .submit-btn {
            padding: 10px 25px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            color: #111;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .query-box .submit-btn:hover {
            background: #fff;
            border-color: #fff;
            transform: translateY(-1px);
        }

        .faq-section {
            flex-grow: 1;
            /* Makes this section fill available space */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* IMPORTANT: Hides overflow on the section itself */
        }

        .faq-section h3 {
            color: #00d1ff;
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
            /* Prevents this header from shrinking */
        }

        .faq-container {
            overflow-y: auto;
            /* IMPORTANT: Adds scrolling ONLY to the question list */
            flex-grow: 1;
            padding-right: 15px;
        }

        .faq-item {
            background: rgba(0, 0, 0, 0.7);
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid rgba(0, 209, 255, 0.2);
            overflow: hidden;
        }

        .faq-question {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 17px;
            color: #eee;
            transition: background-color 0.3s ease;
        }

        .faq-question:hover {
            background-color: rgba(0, 209, 255, 0.1);
        }

        .faq-toggle {
            font-size: 24px;
            transition: transform 0.3s ease;
            transform: rotate(0deg);
            color: #00d1ff;
        }

        .faq-question.active .faq-toggle {
            transform: rotate(180deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            background: rgba(0, 0, 0, 0.3);
            padding: 0 20px;
            color: #ccc;
            font-size: 16px;
            line-height: 1.6;
        }

        .faq-answer p {
            padding: 20px 0;
        }

        /* Make tables larger and span the full screen width */
        .table-xl {
            width: 100%;
            table-layout: fixed;
            /* prevents weird column squeezing */
            background: rgba(255, 255, 255, .05);
            border-radius: 12px;
            overflow: hidden;
        }

        .table-xl thead th {
            font-size: 18px;
            /* header font size */
            padding: 14px 18px;
            /* header cell padding */
            background: rgba(255, 255, 255, .12);
        }

        .table-xl td {
            font-size: 17px;
            /* body font size */
            padding: 14px 18px;
            /* body cell padding */
        }

        .table-xl th,
        .table-xl td {
            white-space: nowrap;
            /* keeps times/names on one line */
            overflow: hidden;
            text-overflow: ellipsis;
            /* truncate if too long */
        }

        /* On very large screens, scale up a bit more */
        @media (min-width: 1400px) {
            .table-xl thead th {
                font-size: 19px;
                padding: 16px 20px;
            }

            .table-xl td {
                font-size: 18px;
                padding: 16px 20px;
            }
        }



        /* Reports Styling */
        .reports-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 40px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(0, 209, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 0 35px rgba(0, 209, 255, 0.2);
            text-align: left;
        }

        .reports-container h2 {
            text-align: center;
            color: #00d1ff;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 0 0 10px #00d1ff;
        }

        .report-field-group {
            margin-bottom: 25px;
        }

        .report-field-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 1.1em;
        }

        .report-field-group select,
        .report-field-group input[type="date"],
        .report-field-group input[type="month"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 209, 255, 0.5);
            background: rgba(0, 20, 30, 0.8);
            color: white;
            font-size: 1em;
            outline: none;
            transition: all 0.3s ease;
            color-scheme: dark;
            /* Ensures dark mode for date picker */
        }

        .report-field-group select:focus,
        .report-field-group input[type="date"]:focus,
        .report-field-group input[type="month"]:focus {
            border-color: #00d1ff;
            box-shadow: 0 0 15px rgba(0, 209, 255, 0.5);
        }

        /* Style for date and time picker icons - make them white */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="time"]::-webkit-calendar-picker-indicator:hover,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover,
        input[type="month"]::-webkit-calendar-picker-indicator:hover {
            filter: invert(1) brightness(1.2);
        }

        /* For Firefox */
        input[type="date"]::-moz-calendar-picker-indicator,
        input[type="time"]::-moz-calendar-picker-indicator,
        input[type="datetime-local"]::-moz-calendar-picker-indicator,
        input[type="month"]::-moz-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        input[type="date"]::-moz-calendar-picker-indicator:hover,
        input[type="time"]::-moz-calendar-picker-indicator:hover,
        input[type="datetime-local"]::-moz-calendar-picker-indicator:hover,
        input[type="month"]::-moz-calendar-picker-indicator:hover {
            filter: invert(1) brightness(1.2);
        }

        .report-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .report-actions button {
            padding: 12px 25px;
            border: 1px solid #00d1ff;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            background: transparent;
            color: #00d1ff;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .report-actions button:hover {
            background: rgba(0, 209, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 209, 255, 0.6);
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        /* Let the content area use the whole width minus sidebar */
        #mainContent {
            max-width: none;
        }

        /* ADD THIS AT THE END OF YOUR <style> TAG */

        /* New styles for form layout */
        
        /* ADD THIS AT THE END OF YOUR <style> TAG */

        /* New styles for form layout */
 .purchase-indent-form {
            background: rgba(0, 0, 0, 0.6);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(0, 209, 255, 0.2);
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .form-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .form-header h2 {
            color: #fff;
            font-size: 24px;
        }

        .form-section {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .form-section h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #00d1ff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        .form-fields-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-field-group {
            display: flex;
            flex-direction: column;
        }

        .form-field-group label {
            margin-bottom: 0.5rem;
            color: #ccc;
            font-size: 14px;
        }

        /* MODIFIED: This is the key change to make inputs visible */
        /* Apply styling similar to your <th> element */
        .form-section input,
        .form-section select,
        .form-section textarea,
        .table-bordered td input,
        .table-bordered td select {
            width: 100%;
            /* Matching the padding of your <th> */
            padding: 12px;
            border-radius: 5px;
            /* Use a solid background to make it visible */
            background-color: rgba(255, 255, 255, 0.12);
            /* Set a bottom border like your <th> */
            border: none;
            border-bottom: 1px solid #666;
            color: white;
            font-size: 15px;
        }

        /* Optional: Add a subtle focus effect */
        .form-section input:focus,
        .form-section select:focus,
        .form-section textarea:focus {
            background-color: rgba(0, 209, 255, 0.1);
            /* Lighter background on focus */
            border-bottom-color: #00d1ff;
            /* Accent color on focus */
            outline: none;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .table-bordered {
            width: 100%;
            border-collapse: collapse;
        }

        .table-bordered th,
        .table-bordered td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px;
            text-align: left;
            white-space: nowrap;
        }

        .table-bordered th {
            background-color: rgba(0, 209, 255, 0.1);
        }

        .table-bordered td input {
            min-width: 150px;
        }

        /* Button Styles for Form */
        .btn-add {
            background-color: #28a745 !important;
        }

        .btn-next {
            background-color: #007bff !important;
        }

        .btn-success {
            background-color: #28a745 !important;
        }

        .btn-secondary {
            background-color: #6c757d !important;
        }

        .btn-danger {
            background-color: #dc3545 !important;
        }

        .d-flex {
            display: flex;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .justify-content-end {
            justify-content: flex-end;
        }

        .mt-4 {
            margin-top: 1.5rem;
        }

        .mt-3 {
            margin-top: 1rem;
        }


        .payslip-container {
    width: 190mm; /* This is fine, keep it */
    /* Remove the 'height' property completely */
    padding: 10mm;
    font-family: Arial, sans-serif;
    font-size: 10pt;
    border: 1px solid #000;
    margin: auto;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    background: #fff;
    color: #000;
}
.payslip-header-table, .payslip-main-table {
    width: 100%;
    border-collapse: collapse;
}
.payslip-header-table th, .payslip-header-table td,
.payslip-main-table th, .payslip-main-table td {
    border: 1px solid #000;
    padding: 5px;
    text-align: left;
    vertical-align: top;
}
.payslip-header-table .company-name {
    text-align: center;
    font-size: 14pt;
    font-weight: bold;
}
.payslip-header-table .company-details {
    font-size: 8pt;
    text-align: center;
}
.payslip-header-table .payslip-title {
    text-align: center;
    font-size: 12pt;
    font-weight: bold;
}
.payslip-logo {
    width: 80px;
}
.payslip-total-row {
    font-weight: bold;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: #1a1a1a;
    border-radius: 15px;
    padding: 0;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(0, 0, 0, 0.2);
}

.modal-header h3 {
    margin: 0;
    color: #00d1ff;
    font-size: 20px;
}

.modal-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
}

.modal-body {
    padding: 25px;
}
    </style>
</head>

<body id="body">
    <video autoplay muted loop id="bgVideo">
        <source src="/static/videos/indexbg.mp4" type="video/mp4">
    </video>
    <div class="top-buttons" id="topButtonsContainer">
        <a href="/logout" class="btn" id="logoutButton">Logout</a>
    </div>
    <div class="dashboard-content" id="welcomeBlock">
        <h1>Welcome, {{ name }}!</h1>
        <p>This is your personalized ERP dashboard.</p>
        <button onclick="showDashboard()">Let's Get Started</button>
    </div>
    <div class="sidebar" id="sidebar">
        <ul>
            <li onclick="loadHome()">Home</li>
            <li onclick="loadSection('Users')">Users</li>
            <li onclick="loadSection('Teams & Groups')">Teams & Groups</li>
            <li onclick="loadSection('Attendance')">Attendance</li>
            <li onclick="loadSection('Roles')">Roles</li>
            <li onclick="loadSection('Salaries')">Salaries</li>
            <li onclick="loadSection('Assets')">Assets</li>
            <li onclick="loadSection('Billing')">Billing</li>
            <li onclick="loadSection('Support')">Support</li>
            <li onclick="loadSection('Settings')">Settings</li>
            <li onclick="window.location.href='/logout'"
                style="margin-top: 20px; font-weight: bold; color: #ff5555; border: none;">Logout</li>
        </ul>
    </div>
    <div id="mainContent"></div>

    <div id="addRoleModal"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.65); display: none; justify-content: center; align-items: center; z-index: 9999;">
        <div
            style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 400px; box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);">
            <h3 style="margin-bottom: 20px; color: #fff;">Enter New Role Name</h3>
            <input type="text" id="newRoleName" placeholder="e.g., Administrator"
                style="margin-bottom:20px;width:100%;padding:10px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                <button onclick="closeAddRoleModal()"
                    style="padding: 8px 16px; border: none; background: #6c757d; color: white; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button onclick="createRole()"
                    style="padding: 8px 16px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">Save</button>
            </div>
        </div>
    </div>


    <div id="addUserModal"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.65); display: none; justify-content: center; align-items: center; z-index: 9999;">
        <div style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 400px;">
            <h3 style="margin-bottom: 20px; color: #fff;">Add New User</h3>
            <input type="text" id="fullName" placeholder="Full Name"
                style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            <input type="text" id="username" placeholder="Username"
                style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            <input type="email" id="email" placeholder="Email ID"
                style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            <div style="margin-bottom: 10px;">
                <label style="color: #ccc; font-size: 14px;">Select Roles:</label><br>
                <div id="roleList" style="margin-top: 5px;"></div>
            </div>
            <input type="password" id="userPass" placeholder="Password"
                style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            <input type="password" id="confirmPass" placeholder="Re-enter Password"
                style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="generatePassword()"
                    style="padding:6px 12px;border:none;background:#17a2b8;color:white;border-radius:4px;">Auto
                    Generate</button>
                <div>
                    <button onclick="closeAddUserModal()"
                        style="margin-right:10px;padding:6px 12px;border:none;background:#6c757d;color:white;border-radius:4px;">Cancel</button>
                    <button onclick="submitUserForm()"
                        style="padding:6px 12px;border:none;background:#28a745;color:white;border-radius:4px;">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div id="manageUserModal"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.65); display: none; justify-content: center; align-items: center; z-index: 9999;">
        <div style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 400px;">
            <h3 style="margin-bottom: 20px; color: #fff;">Manage User</h3>

            <input type="text" id="editUsername" placeholder="Username"
                style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            <input type="email" id="editEmail" placeholder="Email ID"
                style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            <input type="password" id="editPassword" placeholder="New Password (optional)"
                style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">

            <div style="margin-bottom: 10px;">
                <label style="color: #ccc; font-size: 14px;">Roles:</label><br>
                <div id="editRoleList" style="margin-top: 5px;"></div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="closeManageUserModal()"
                    style="margin-right:10px;padding:6px 12px;border:none;background:#6c757d;color:white;border-radius:4px;">Cancel</button>
                <button onclick="submitUserUpdate()"
                    style="padding:6px 12px;border:none;background:#007bff;color:white;border-radius:4px;">Update</button>
            </div>
        </div>
    </div>
    <div id="changePasswordModal"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.65); display: none; justify-content: center; align-items: center; z-index: 9999;">
        <div
            style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 450px; box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #fff;">Change Password</h3>
                <span onclick="closeChangePasswordModal()"
                    style="font-size: 26px; color: #fff; cursor: pointer;">✖️</span>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #ccc; margin-bottom: 5px;">Current Password</label>
                <input type="password" id="currentPassword" placeholder="Enter current password"
                    style="width:100%;padding:10px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #ccc; margin-bottom: 5px;">New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password"
                    style="width:100%;padding:10px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #ccc; margin-bottom: 5px;">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" placeholder="Re-enter new password"
                    style="width:100%;padding:10px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
            </div>
            <div id="messageBox"
                style="display: none; padding: 10px; border-radius: 6px; text-align: center; font-size: 14px; margin-bottom: 15px;">
            </div>
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                <button onclick="closeChangePasswordModal()"
                    style="padding: 10px 20px; border: none; background: #6c757d; color: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                <button onclick="submitPasswordChange()"
                    style="padding: 10px 20px; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer;">Save
                    Password</button>
            </div>
        </div>
    </div>
    <script>

        // Your web app's Firebase configuration
        const assetsConfig = {
            apiKey: "AIzaSyC0PhruO5vbjdu8WMLWexXfJoICV86ysRE",
            authDomain: "assets-app-ssev.firebaseapp.com",
            projectId: "assets-app-ssev",
            storageBucket: "assets-app-ssev.appspot.com",
            messagingSenderId: "628586705896",
            appId: "1:628586705896:web:8c7bb831ad56222e2e6a5d"
        };

        const attendanceConfig = {
            apiKey: "AIzaSyAgmFIZ9Mw0XeB1Z39OftZoclzVp6IRJ_E",
            authDomain: "lexicon-1a.firebaseapp.com",
            databaseURL: "https://lexicon-1a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lexicon-1a",
            storageBucket: "lexicon-1a.firebasestorage.app",
            messagingSenderId: "47720757204",
            appId: "1:47720757204:web:0578abd7a573e425b8c841",
            measurementId: "G-3YLDGTG2N3"
        };

        // avoid double-init during hot reload
        if (!firebase.apps.length) {
            firebase.initializeApp(assetsConfig);                            // default app
            firebase.initializeApp(attendanceConfig, "attendanceApp");       // second app
        }

        const dbAttendance = firebase.firestore(firebase.app("attendanceApp"));


        // Get a reference to the Firestore database
        const db = firebase.firestore();

        // Removed the hardcoded roles array and will fetch from the server
        let extraBillingTabs = [];
        let allAssets = [];
        let allDoorLogs = [];
        let activeTimers = [];
        let currentUserEmail = ""; 

        // All available sidebar modules for permissions
        const sidebarModules = ['Home', 'Users', 'Teams & Groups', 'Attendance (Admin)', 'Attendance (Employee)', 'Roles', 'Salaries', 'Assets', 'Billing', 'Support', 'Settings'];

        // Placeholder for roles and their permissions
        let storedRoles = {};

        function toggleSidebar() {
            const sidebarToggleEnabled = localStorage.getItem('sidebarToggleEnabled') === 'true';
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (sidebarToggleEnabled) {
                // For right position, toggle visibility
                if (sidebar.style.display === 'none') {
                    // Show sidebar
                    sidebar.style.display = 'block';
                    mainContent.style.paddingRight = '260px';
                } else {
                    // Hide sidebar
                    sidebar.style.display = 'none';
                    mainContent.style.paddingRight = '40px';
                }
            } else {
                // For left position, use the original toggle
                sidebar.classList.toggle('active');
            }
        }

        function showDashboard() {
            const bgVideo = document.getElementById('bgVideo');
            if (bgVideo.src.indexOf('admindb.mp4') === -1) {
                bgVideo.src = "/static/videos/admindb.mp4";
                bgVideo.load();
            }
            if (bgVideo.paused) {
                bgVideo.play();
            }
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('welcomeBlock').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadHome();
        }

        function ensureVideoPlaying() {
            const bgVideo = document.getElementById('bgVideo');
            if (bgVideo && bgVideo.paused) {
                bgVideo.play().catch(e => console.log('Video play failed:', e));
            }
        }

        function loadHome() {
            const html = `<h2 style="margin-bottom: 30px;">Dashboard Shortcuts</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px;">
            ${shortcutCard('Users', '👥')}${shortcutCard('Teams & Groups', '🤝')}${shortcutCard('Attendance', '🗓️')}
            ${shortcutCard('Roles', '🛡️')}${shortcutCard('Salaries', '💰')}${shortcutCard('Assets', '📦')}
            ${shortcutCard('Billing', '💳')}${shortcutCard('Support', '💬')}${shortcutCard('Settings', '⚙️')}
        </div>
        
        <div id="announcementNotifications" style="margin-top: 40px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <p style="text-align: center; color: #ccc;">Loading announcements...</p>
        </div>`;
            document.getElementById('mainContent').innerHTML = html;
            ensureVideoPlaying();
            showDashboardAnnouncements();
        }

        function shortcutCard(title, emoji) {
            return `<div onclick="${['Users', 'Teams & Groups', 'Attendance', 'Roles', 'Salaries', 'Assets', 'Billing', 'Support', 'Settings'].includes(title) ? `loadSection('${title}')` : `loadSubSection('${title}')`}" style="background-color: rgba(255, 255, 255, 0.12); padding: 35px 40px; border-radius: 18px; display: flex; align-items: center; gap: 25px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); transition: all 0.25s ease; cursor: pointer;" onmouseover="this.style.backgroundColor='rgba(0,123,255,0.3)'; this.style.transform='scale(1.015)';" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.12)'; this.style.transform='scale(1)';"><div style="font-size: 48px;">${emoji}</div><div><div style="font-size: 22px; font-weight: bold;">${title}</div><div style="font-size: 15px; color: #ccc;">Click to manage ${title.toLowerCase()}.</div></div></div>`;
        }

        function loadSection(section) {
    const mainContent = document.getElementById('mainContent');
    const topButtonsContainer = document.getElementById('topButtonsContainer');
    
    // Step 1: Remove all dynamic buttons first.
    // This removes any buttons that were added by previous sections.
    const dynamicButtons = Array.from(topButtonsContainer.children).filter(child => child.id !== 'logoutButton');
    dynamicButtons.forEach(button => button.remove());

    // Step 2: Handle each section.
    if (section === 'Salaries') {
        document.getElementById('logoutButton').style.display = 'none';
        loadSalariesSection();
    } else if (section === 'Assets') {
        // When going to the main Assets section, the `New Asset Request` button is not needed yet.
        loadAssetsSection();
    } else if (section === 'Indents') { // Add a new condition for the Indents section
        loadIndentsSection();
        // The loadIndentsSection function itself will add the button.
    } else if (section === 'Support') {
        document.getElementById('logoutButton').style.display = 'block';
        loadSupportSection();
    } else if (section === 'Roles') {
        document.getElementById('logoutButton').style.display = 'block';
        loadRolesSection();
            } else {
                logoutButton.style.display = 'block';
                if (section === 'Users') {
                    const html = `<h2 style="margin-bottom: 20px;">👥 User Management</h2>
            <div style="display:flex;flex-wrap:wrap;gap:20px;justify-content:flex-start;">
              ${shortcutCard('Active Users', '✅')}${shortcutCard('User Info', '📇')}${shortcutCard('Deleted Users', '🗑️')}${shortcutCard('Announcements', '📢')}
            </div>`;
                    document.getElementById('mainContent').innerHTML = html;
                } else if (section === 'Teams & Groups') {
                    loadTeamsGroupsSection();
                } else if (section === 'Attendance') {
                    // In function loadSection(section), find the "Attendance" block
                    // And replace its 'html' variable with this one:

                    // In function loadSection(section), find the "Attendance" block
                    // Replace its 'html' variable with this corrected version.

                    const today = todayKey();
                    const html = `
<h2 style="margin-bottom: 20px;">🗓️ Attendance Module</h2>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:30px;">
    <div onclick="loadSubSection_Attendance('DateView')">${shortcutCard(today, '📅')}</div>
    <div onclick="loadSubSection_Attendance('Reports')">${shortcutCard('Reports', '📊')}</div>
    <div onclick="loadSubSection_Attendance('Door Logs')">${shortcutCard('Door Logs', '🚪')}</div>
    <div onclick="loadSubSection_Attendance('UserMSIReports')">${shortcutCard('User Reports', '👤')}</div>
    <div onclick="loadSubSection_Attendance('Permissions')">${shortcutCard('Permissions', '📜')}</div>
    <div onclick="loadSubSection_Attendance('Holidays')">${shortcutCard('Holidays', '🎉')}</div>
</div>`; // Notice the extra </div> corresponding to "User" is now removed.
                    document.getElementById('mainContent').innerHTML = html;
                } else if (section === 'Settings') {
                    loadSettingsPage('main');
                } else if (section === 'Billing') {
                    let billingHtml = `<h2 style="margin-bottom:20px;">💳 Billing</h2><div style="display:flex;flex-wrap:wrap;gap:20px;justify-content:flex-start;">`;
                    billingHtml += `${shortcutCard('Your Products', '📦')}${shortcutCard('Bills & Payments', '💸')}${shortcutCard('Billing Accounts', '💼')}${shortcutCard('Billing Notifications', '🔔')}${shortcutCard('Payment Methods', '💳')}`;
                    extraBillingTabs.forEach(t => { billingHtml += `${shortcutCard(t, '✨')}`; });
                    billingHtml += `</div><button onclick="addExtraBillingTab()" class="add-tab-button">Add Extra Tab</button>`;
                    document.getElementById('mainContent').innerHTML = billingHtml;
                } else if (section === 'Settings') {
                    loadSettingsPage('main');
                } else {
                    document.getElementById('mainContent').innerHTML = `<h2>${section}</h2><p style="color:#ccc;">Content for ${section.toLowerCase()} is not yet implemented.</p>`;
                }
            }
        }


        function loadSubSection(subsection) {
            if (subsection === 'Active Users') {
                document.getElementById('mainContent').innerHTML = `
            <h2>✅ ${subsection}</h2>
            <p style="color:#ccc;">Manage all active users linked to this ERP account.</p>
            <div style="margin-top: 25px;"><button onclick="openAddUserModal()" style="margin-right: 15px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px;">Add User</button></div>
            <div style="margin-top: 30px; max-height: 60vh; overflow-y: auto; border-radius: 6px;">
                <table style="width: 100%; border-collapse: collapse; background-color: rgba(255,255,255,0.05);">
                    <thead><tr style="background-color: rgba(255,255,255,0.1);">
                        <th style="padding: 12px; border-bottom: 1px solid #666;">Name</th>
                        <th style="padding: 12px; border-bottom: 1px solid #666;">Email</th>
                        <th style="padding: 12px; border-bottom: 1px solid #666;">Roles</th>
                        <th style="padding: 12px; border-bottom: 1px solid #666;">Actions</th>
                    </tr></thead>
                    <tbody id="userTableBody"></tbody>
                </table>
            </div>`;
                fetch('/api/users').then(res => res.json()).then(data => {
                    if (data.status === 'success') {
                        const tbody = document.getElementById('userTableBody');
                        tbody.innerHTML = '';
                        data.users.forEach(user => {
                            const roles = Array.isArray(user.roles) ? user.roles.join(', ') : user.roles;
                            const row = `<tr>
                        <td style="padding: 10px;">${user.name}</td>
                        <td style="padding: 10px;">${user.email}</td>
                        <td style="padding: 10px;">${roles}</td>
                        <td style="padding: 10px;">
                            <button onclick="manageUser('${user.email}')" style="margin-right: 10px; padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px;">Manage</button>
                            <button onclick="deleteUser('${user.email}')" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px;">Delete</button>
                        </td>
                    </tr>`;
                            tbody.insertAdjacentHTML('beforeend', row);
                        });
                    } else alert("⚠️ Failed to load users.");
                });
            } else if (subsection === 'User Info') {
                loadUserInfoPage();
            } else if (subsection === 'Deleted Users') {
                loadDeletedUsersPage();
            } else if (subsection === 'Announcements') {
                loadAnnouncementsPage();
            } else if (['Your Products', 'Bills & Payments', 'Billing Accounts', 'Billing Notifications', 'Payment Methods'].includes(subsection) || extraBillingTabs.includes(subsection)) {
                loadBillingSubSection(subsection);
            } else {
                document.getElementById('mainContent').innerHTML = `<h2>${subsection}</h2><p style="color:#ccc;">Content for ${subsection.toLowerCase()} is not yet implemented.</p>`;
            }
        }

        // ========= Announcements =========
        function loadAnnouncementsPage() {
            // Check if user is authenticated via Flask session
            fetch('/api/user/roles')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        // User is authenticated, load the page
                        loadAnnouncementsPageContent();
                    } else {
                        document.getElementById('mainContent').innerHTML = '<h2>❌ Error</h2><p>User not authenticated. Please log in again.</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('mainContent').innerHTML = '<h2>❌ Error</h2><p>Authentication error. Please log in again.</p>';
                });
        }

        function loadAnnouncementsPageContent() {

            // Check user permissions to determine what to show
            fetch('/api/user/roles')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        const userRoles = data.roles;
                        const canCreate = userRoles.some(role => ['Admin', 'Manager', 'Team Lead'].includes(role));

                        let createButton = '';
                        if (canCreate) {
                            createButton = `
                                <button onclick="openCreateAnnouncementModal()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    📝 Create Announcement
                                </button>
                            `;
                        }

                        document.getElementById('mainContent').innerHTML = `
                            <h2>📢 Announcements</h2>
                            <p style="color:#ccc;">${canCreate ? 'Manage and view system announcements' : 'View system announcements'}</p>
                            
                            <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
                                ${createButton}
                                <button onclick="refreshAnnouncements()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    🔄 Refresh
                                    </button>
                            </div>

                            <div style="margin-top: 30px;">
                                <h3>📋 ${canCreate ? 'All Announcements' : 'Announcements'}</h3>
                                <div id="announcementsList" style="margin-top: 20px;"></div>
                            </div>
                        `;

                        loadAnnouncements();
                    } else {
                        document.getElementById('mainContent').innerHTML = '<h2>❌ Error</h2><p>Failed to load user permissions.</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('mainContent').innerHTML = '<h2>❌ Error</h2><p>Failed to load user permissions.</p>';
                });
        }

        function loadAnnouncements() {
            // Check user permissions first
            fetch('/api/user/roles')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        const userRoles = data.roles;
                        const canCreate = userRoles.some(role => ['Admin', 'Manager', 'Team Lead'].includes(role));

                        // Use appropriate endpoint based on permissions
                        const endpoint = canCreate ? '/api/announcements/all' : '/api/announcements';

                        fetch(endpoint)
                            .then(res => res.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    displayAnnouncements(data.announcements, canCreate);
                                } else {
                                    document.getElementById('announcementsList').innerHTML = `<p style="color: #ff6b6b;">Error: ${data.message}</p>`;
                                }
                            })
                            .catch(error => {
                                document.getElementById('announcementsList').innerHTML = `<p style="color: #ff6b6b;">Error loading announcements: ${error.message}</p>`;
                            });
                    } else {
                        document.getElementById('announcementsList').innerHTML = '<p style="color: #ff6b6b;">Authentication error</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('announcementsList').innerHTML = '<p style="color: #ff6b6b;">Authentication error</p>';
                });
        }

        function displayAnnouncements(announcements, canCreate = false) {
            const container = document.getElementById('announcementsList');
            if (announcements.length === 0) {
                container.innerHTML = '<p style="color: #ccc;">No announcements found.</p>';
                return;
            }

            let html = '<div style="display: grid; gap: 20px;">';
            announcements.forEach(announcement => {
                const priorityColor = getPriorityColor(announcement.priority);
                const statusBadge = announcement.is_active ?
                    '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Active</span>' :
                    '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Inactive</span>';

                let actionButtons = '';
                if (canCreate) {
                    actionButtons = `
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editAnnouncement(${announcement.id})" style="padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Edit</button>
                            <button onclick="deleteAnnouncement(${announcement.id})" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                        </div>
                    `;
                }

                html += `
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; border-left: 4px solid ${priorityColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: white;">${announcement.title}</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                ${statusBadge}
                                <span style="background: ${priorityColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">${announcement.priority}</span>
                            </div>
                        </div>
                        <p style="color: #ccc; margin-bottom: 15px; line-height: 1.5;">${announcement.content}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #999;">
                            <div>
                                <span>👤 ${announcement.author_name}</span>
                                <span style="margin-left: 15px;">📅 ${announcement.created_at}</span>
                                ${announcement.expires_at ? `<span style="margin-left: 15px;">⏰ Expires: ${announcement.expires_at}</span>` : ''}
                                ${announcement.target_roles && announcement.target_roles.length > 0 ? `<span style="margin-left: 15px;">🎯 ${announcement.target_roles.join(', ')}</span>` : ''}
                                ${announcement.target_users && announcement.target_users.length > 0 ? `<span style="margin-left: 15px;">👥 ${announcement.target_users.length} user(s)</span>` : ''}
                            </div>
                            ${actionButtons}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function getPriorityColor(priority) {
            switch (priority.toLowerCase()) {
                case 'urgent': return '#dc3545';
                case 'high': return '#fd7e14';
                case 'normal': return '#007bff';
                case 'low': return '#6c757d';
                default: return '#007bff';
            }
        }

        function openCreateAnnouncementModal() {
            const modal = document.createElement('div');
            modal.id = 'createAnnouncementModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;

            modal.innerHTML = `
                <div style="background: rgba(0,0,0,0.9); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: white;">📝 Create New Announcement</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: white;">Announcement Title *</label>
                        <input type="text" id="announcementTitle" required placeholder="Enter announcement title" style="width: 100%; padding: 10px; border: 1px solid #666; border-radius: 5px; background: rgba(255,255,255,0.1); color: white;">
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button type="button" onclick="closeCreateAnnouncementModal()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        <button type="button" onclick="saveAnnouncementTitle()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Save</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function saveAnnouncementTitle() {
            const title = document.getElementById('announcementTitle').value.trim();
            if (!title) {
                alert('Please enter an announcement title');
                return;
            }

            // Store the title and show recipient selection
            sessionStorage.setItem('pendingAnnouncementTitle', title);
            showRecipientSelection();
        }

        function showRecipientSelection() {
            const modal = document.getElementById('createAnnouncementModal');
            if (!modal) return;

            modal.innerHTML = `
                <div style="background: rgba(0,0,0,0.9); padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: white;">📢 Select Recipients</h3>
                    <p style="color: #ccc; margin-bottom: 20px;">Who should receive this announcement?</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; color: white;">Recipient Type:</label>
                        <select id="recipientType" onchange="handleRecipientTypeChange()" style="width: 100%; padding: 10px; border: 1px solid #666; border-radius: 5px; background: rgba(255,255,255,0.1); color: white;">
                            <option value="">-- Select Recipient Type --</option>
                            <option value="teamleader">Team Leader</option>
                            <option value="allusers">All Users</option>
                            <option value="individual">Individual Users</option>
                        </select>
                    </div>
                    
                    <div id="individualUsersSection" style="display: none; margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; color: white;">Select Individual Users:</label>
                        <div id="activeUsersList" style="max-height: 200px; overflow-y: auto; border: 1px solid #666; border-radius: 5px; padding: 10px; background: rgba(255,255,255,0.05);">
                            <p style="color: #ccc; text-align: center;">Loading users...</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button type="button" onclick="closeCreateAnnouncementModal()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        <button type="button" onclick="createAnnouncementWithRecipients()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Send Announcement</button>
                    </div>
                </div>
            `;

            // Load active users for individual selection
            loadActiveUsersForSelection();
        }
        document.addEventListener('DOMContentLoaded', function () {
            // Find the "Appearance" card
            const appearanceCard = document.querySelector('.appearance-card');
            if (appearanceCard) {
                appearanceCard.style.cursor = 'default'; // Disable pointer for now as we have a specific button
            }

            // Find the "Customize Fonts" button
            const customizeFontsBtn = document.getElementById('customize-fonts-btn');
            const customizeFontsContent = document.getElementById('customize-fonts-content');
            const fontList = document.getElementById('font-list');

            const availableFonts = [
                'Arial, sans-serif',
                'Verdana, sans-serif',
                'Helvetica, sans-serif',
                'Times New Roman, serif',
                'Courier New, monospace',
                'Georgia, serif',
                'Palatino, serif',
                'Garamond, serif',
                'Trebuchet MS, sans-serif',
                'Impact, sans-serif',
                'Open Sans, sans-serif',
                'Roboto, sans-serif'
            ];

            if (customizeFontsBtn && customizeFontsContent && fontList) {
                customizeFontsBtn.addEventListener('click', function () {
                    if (customizeFontsContent.style.display === 'none') {
                        // Clear the list before populating
                        fontList.innerHTML = '';
                        // Populate the list
                        availableFonts.forEach(fontName => {
                            const listItem = document.createElement('li');
                            // Extract just the first font name for display text
                            const displayName = fontName.split(',')[0].replace(/"/g, '');
                            listItem.textContent = displayName;
                            // Set the font family for the list item itself
                            listItem.style.fontFamily = fontName;
                            fontList.appendChild(listItem);
                        });
                        customizeFontsContent.style.display = 'block';
                    } else {
                        customizeFontsContent.style.display = 'none';
                    }
                });
            }
        });

        function handleRecipientTypeChange() {
            const recipientType = document.getElementById('recipientType').value;
            const individualSection = document.getElementById('individualUsersSection');

            if (recipientType === 'individual') {
                individualSection.style.display = 'block';
            } else {
                individualSection.style.display = 'none';
            }
        }

        function loadActiveUsersForSelection() {
            fetch('/api/users')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        const usersList = document.getElementById('activeUsersList');
                        let html = '';

                        data.users.forEach(user => {
                            html += `
                                <div style="margin-bottom: 10px;">
                                    <label style="display: flex; align-items: center; gap: 10px; color: white; cursor: pointer;">
                                        <input type="checkbox" name="selectedUsers" value="${user.email}" style="transform: scale(1.2);">
                                        <span>${user.name} (${user.email})</span>
                                    </label>
                                </div>
                            `;
                        });

                        usersList.innerHTML = html;
                    } else {
                        document.getElementById('activeUsersList').innerHTML = '<p style="color: #ff6b6b;">Error loading users</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('activeUsersList').innerHTML = '<p style="color: #ff6b6b;">Error: ' + error.message + '</p>';
                });
        }

        function createAnnouncementWithRecipients() {
            const recipientType = document.getElementById('recipientType').value;
            const title = sessionStorage.getItem('pendingAnnouncementTitle');

            if (!recipientType) {
                alert('Please select a recipient type');
                return;
            }

            let targetRoles = [];
            let targetUsers = [];

            if (recipientType === 'teamleader') {
                targetRoles = ['Team Lead'];
            } else if (recipientType === 'allusers') {
                targetRoles = []; // Empty means all users
            } else if (recipientType === 'individual') {
                const selectedCheckboxes = document.querySelectorAll('input[name="selectedUsers"]:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('Please select at least one user');
                    return;
                }
                targetUsers = Array.from(selectedCheckboxes).map(cb => cb.value);
            }

            const data = {
                title: title,
                content: title, // Using title as content for simplicity
                priority: 'Normal',
                target_roles: targetRoles,
                target_users: targetUsers,
                expires_at: null
            };

            fetch('/api/announcements', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('✅ Announcement sent successfully!');
                        sessionStorage.removeItem('pendingAnnouncementTitle');
                        closeCreateAnnouncementModal();
                        loadAnnouncements();
                    } else {
                        alert('❌ Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('❌ Error sending announcement: ' + error.message);
                });
        }

        function closeCreateAnnouncementModal() {
            const modal = document.getElementById('createAnnouncementModal');
            if (modal) {
                modal.remove();
            }
        }



        function editAnnouncement(announcementId) {
            // Implementation for editing announcements
            alert('Edit functionality will be implemented here');
        }

        function deleteAnnouncement(announcementId) {
            if (confirm('Are you sure you want to delete this announcement?')) {
                fetch(`/api/announcements/${announcementId}`, {
                    method: 'DELETE'
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('✅ Announcement deleted successfully!');
                            loadAnnouncements();
                        } else {
                            alert('❌ Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('❌ Error deleting announcement: ' + error.message);
                    });
            }
        }

        function refreshAnnouncements() {
            loadAnnouncements();
        }

        // ========= Show Announcements on Dashboard =========
        function showDashboardAnnouncements() {
            fetch('/api/announcements')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.announcements.length > 0) {
                        const announcementContainer = document.getElementById('announcementNotifications');
                        if (announcementContainer) {
                            let html = '<h3 style="margin-bottom: 15px; color: white;">📢 Recent Announcements</h3>';
                            data.announcements.slice(0, 3).forEach(announcement => {
                                const priorityColor = getPriorityColor(announcement.priority);
                                html += `
                                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid ${priorityColor}; margin-bottom: 10px;">
                                        <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">${announcement.title}</h4>
                                        <p style="color: #ccc; margin-bottom: 10px; font-size: 14px; line-height: 1.4;">${announcement.content.substring(0, 100)}${announcement.content.length > 100 ? '...' : ''}</p>
                                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #999;">
                                            <span>👤 ${announcement.author_name}</span>
                                            <span>📅 ${announcement.created_at}</span>
                                            <span style="background: ${priorityColor}; color: white; padding: 2px 6px; border-radius: 3px;">${announcement.priority}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            if (data.announcements.length > 3) {
                                html += `<p style="text-align: center; color: #ccc; font-size: 14px;">View all announcements in User Management → Announcements</p>`;
                            }
                            announcementContainer.innerHTML = html;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard announcements:', error);
                });
        }

//---------salaries module--------------
function loadSalariesSection() {
    // First, hide the top right logout button
    document.getElementById('logoutButton').style.display = 'none';

    const html = `
    <div class="salaries-container">
        <div class="salaries-header">
            <h2>💰 Salaries</h2>
            <label style="color: #eee; margin-right: 10px;">Employee Name:</label>
            <select id="employeeNameSelect" class="salaries-input" style="width: 200px; margin-bottom: 0;"></select>
            <button onclick="window.location.href='/logout'" style="padding: 10px 20px; background-color: rgba(255, 50, 50, 0.85); color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">Logout</button>
        </div>
        <div class="employee-info">
            <p style="color: #ccc; margin-bottom: 5px;">Employee ID: <span id="employeeId"></span></p>
            <p style="color: #ccc; margin-bottom: 5px;">Designation: 
                <input type="text" id="employeeDesignation" onchange="updateDesignation()" style="background: rgba(255,255,255,0.1); color: #ccc; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 4px 8px; font-size: 14px; width: 200px;" placeholder="Enter designation">
            </p>
            <p style="color: #ccc; margin-bottom: 5px;">Account Number: <span id="employeeAccount"></span></p>
            <p style="color: #ccc;">PF No: <span id="employeePfNo"></span></p>
            <input type="hidden" id="employeePfNoHidden" value="">
        </div>
        <div class="salaries-main-grid">
            <div class="salaries-section">
                <div class="salaries-section-header" onclick="toggleDropdown('actualsContent')">
                    <h3>Actuals</h3><span class="toggle-icon">▼</span>
                </div>
                <div id="actualsContent" class="salaries-section-content">
                    <div class="salaries-field-group">
                        <label for="actualGrossSalary">Actual Gross Salary:</label>
                        <input type="number" id="actualGrossSalary" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="basic">Basic:</label>
                        <input type="number" id="basic" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="hra">HRA:</label>
                        <input type="number" id="hra" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="conveyance">Conveyance:</label>
                        <input type="number" id="conveyance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="vehicleMaintenance">Vehicle Maintenance:</label>
                        <input type="number" id="vehicleMaintenance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="specialAllowance">Special Allowance:</label>
                        <input type="number" id="specialAllowance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="addOthersActuals">Add Others:</label>
                        <input type="number" id="addOthersActuals" value="0.00" oninput="calculateTotals()">
                    </div>
                </div>
            </div>
            <div class="salaries-section">
                <div class="salaries-section-header" onclick="toggleDropdown('earningsContent')">
                    <h3>Earnings</h3><span class="toggle-icon">▼</span>
                </div>
                <div id="earningsContent" class="salaries-section-content">
                    <div class="salaries-field-group">
                        <label for="earningsBasic">Basic:</label>
                        <input type="number" id="earningsBasic" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="earningsHra">HRA:</label>
                        <input type="number" id="earningsHra" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="earningsConveyance">Conveyance:</label>
                        <input type="number" id="earningsConveyance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="earningsVehicleMaintenance">Vehicle Maintenance:</label>
                        <input type="number" id="earningsVehicleMaintenance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="earningsSpecialAllowance">Special Allowance:</label>
                        <input type="number" id="earningsSpecialAllowance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="addOthersEarnings">Add Others:</label>
                        <input type="number" id="addOthersEarnings" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label>Total Earnings:</label>
                        <div id="totalEarnings" class="salaries-total-field">0.00</div>
                    </div>
                </div>
            </div>
            <div class="salaries-section">
                <div class="salaries-section-header" onclick="toggleDropdown('deductionsContent')">
                    <h3>Deductions</h3><span class="toggle-icon">▼</span>
                </div>
                <div id="deductionsContent" class="salaries-section-content">
                    <div class="salaries-field-group">
                        <label for="providentFund">Provident Fund:</label>
                        <input type="number" id="providentFund" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="esi">ESI:</label>
                        <input type="number" id="esi" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="professionalTax">Professional Tax:</label>
                        <input type="number" id="professionalTax" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="incomeTax">Income Tax:</label>
                        <input type="number" id="incomeTax" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="advance">Advance:</label>
                        <input type="number" id="advance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="otherDeductions">Other Deductions:</label>
                        <input type="number" id="otherDeductions" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="lossOfPay">Loss of Pay:</label>
                        <input type="number" id="lossOfPay" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label>Total Deductions:</label>
                        <div id="totalDeductions" class="salaries-total-field">0.00</div>
                    </div>
                </div>
            </div>
            <div class="salaries-section">
                <div class="salaries-section-header" onclick="toggleDropdown('leavesContent')">
                    <h3>Leaves</h3><span class="toggle-icon">▼</span>
                </div>
                <div id="leavesContent" class="salaries-section-content">
                    <div class="salaries-field-group">
                        <label for="totalLeaves">Total Leaves:</label>
                        <input type="number" id="totalLeaves" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="leaveAvailed">Leave Availed:</label>
                        <input type="number" id="leaveAvailed" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="balanceLeaves">Balance:</label>
                        <input type="number" id="balanceLeaves" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="noOfLopDays">No. of LOP Days:</label>
                        <input type="number" id="noOfLopDays" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="totalDays">Total Days:</label>
                        <input type="number" id="totalDays" value="30" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="ndp">NDP:</label>
                        <input type="number" id="ndp" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label>Net Salary:</label>
                        <div id="netSalary" class="salaries-total-field">0.00</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="salaries-actions">
            <button class="save-btn" onclick="saveSalaryData()">Save Salary Data</button>
            <button class="download-btn" onclick="downloadPayslip()">Download Payslip</button>
            <div class="download-payslips-container">
                <button class="download-payslips-btn" id="downloadPayslipsBtn">Download Payslips</button>
                <div class="payslips-dropdown" id="payslipsDropdown">
                    <button class="payslip-option" onclick="downloadSalarySheetByBranch('SSEV'); document.getElementById('payslipsDropdown').classList.remove('show');">SSEV</button>
                    <button class="payslip-option" onclick="downloadSalarySheetByBranch('SSEV SOFT SOLS'); document.getElementById('payslipsDropdown').classList.remove('show');">SSEV SOFT SOLS</button>
                </div>
            </div>
            <div class="download-salary-sheet-container">
                <button class="download-salary-sheet-btn" id="downloadSalarySheetBtn">Download Salary Sheet</button>
                <div class="salary-sheet-dropdown" id="salarySheetDropdown">
                    <button class="salary-sheet-option" onclick="downloadSalarySheetTable('SSEV'); document.getElementById('salarySheetDropdown').classList.remove('show');">SSEV</button>
                    <button class="salary-sheet-option" onclick="downloadSalarySheetTable('SSEV SOFT SOLS'); document.getElementById('salarySheetDropdown').classList.remove('show');">SSEV SOFT SOLS</button>
                </div>
            </div>
        </div>
    </div>`;
    document.getElementById('mainContent').innerHTML = html;
    populateEmployeeDropdown();

    // Add event listeners for the new download buttons
    const downloadPayslipsBtn = document.getElementById('downloadPayslipsBtn');
    const payslipsDropdown = document.getElementById('payslipsDropdown');
    
    downloadPayslipsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        payslipsDropdown.classList.toggle('show');
    });
    
    // Add event listeners for the salary sheet download button
    const downloadSalarySheetBtn = document.getElementById('downloadSalarySheetBtn');
    const salarySheetDropdown = document.getElementById('salarySheetDropdown');
    
    downloadSalarySheetBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        salarySheetDropdown.classList.toggle('show');
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!downloadPayslipsBtn.contains(e.target) && !payslipsDropdown.contains(e.target)) {
            payslipsDropdown.classList.remove('show');
        }
        if (!downloadSalarySheetBtn.contains(e.target) && !salarySheetDropdown.contains(e.target)) {
            salarySheetDropdown.classList.remove('show');
        }
    });
}
        function toggleDropdown(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling;
            content.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        // dashboard.html

function calculateTotals() {
    // Actuals section - no total calculation needed

    // Get values from all Earnings inputs
    const earningsBasic = parseFloat(document.getElementById('earningsBasic').value) || 0;
    const earningsHra = parseFloat(document.getElementById('earningsHra').value) || 0;
    const earningsConveyance = parseFloat(document.getElementById('earningsConveyance').value) || 0;
    const earningsVehicleMaintenance = parseFloat(document.getElementById('earningsVehicleMaintenance').value) || 0;
    const earningsSpecialAllowance = parseFloat(document.getElementById('earningsSpecialAllowance').value) || 0;
    const addOthersEarnings = parseFloat(document.getElementById('addOthersEarnings').value) || 0;

    // Calculate and display Total Earnings
    const totalEarnings = earningsBasic + earningsHra + earningsConveyance + earningsVehicleMaintenance + earningsSpecialAllowance + addOthersEarnings;
    document.getElementById('totalEarnings').textContent = totalEarnings.toFixed(2);

    // Get values from all Deductions inputs
    const providentFund = parseFloat(document.getElementById('providentFund').value) || 0;
    const esi = parseFloat(document.getElementById('esi').value) || 0;
    const professionalTax = parseFloat(document.getElementById('professionalTax').value) || 0;
    const incomeTax = parseFloat(document.getElementById('incomeTax').value) || 0;
    const advance = parseFloat(document.getElementById('advance').value) || 0;
    const otherDeductions = parseFloat(document.getElementById('otherDeductions').value) || 0;
    const lossOfPay = parseFloat(document.getElementById('lossOfPay').value) || 0;

    // Calculate and display Total Deductions
    const totalDeductions = providentFund + esi + professionalTax + incomeTax + advance + otherDeductions + lossOfPay;
    document.getElementById('totalDeductions').textContent = totalDeductions.toFixed(2);

    // Calculate and display Net Salary (using Earnings total)
    const netSalary = totalEarnings - totalDeductions;
    document.getElementById('netSalary').textContent = netSalary.toFixed(2);
}

async function populateEmployeeDropdown() {
    const employeeSelect = document.getElementById('employeeNameSelect');
    try {
        const response = await fetch('/api/get_all_employee_info');
        const data = await response.json();
        if (data.status === 'success' && data.employees) {
            employeeSelect.innerHTML = '<option value="">-- Select an Employee --</option>'; // Add a default option
            data.employees.forEach(emp => {
                const option = document.createElement('option');
                // Use the employee's ID from the EmployeeInfo table as the value
                option.value = emp.id;
                option.textContent = emp.full_name;
                employeeSelect.appendChild(option);
            });
            
            employeeSelect.addEventListener('change', (event) => {
                const selectedEmployeeId = event.target.value;
                if (selectedEmployeeId) {
                    // Pass the correct employee ID to the update function
                    updateEmployeeInfo(selectedEmployeeId);
                } else {
                    resetSalariesForm();
                }
            });
            
            // Optionally, load the data for the first user by default
            if (data.employees.length > 0) {
                 const firstEmployeeId = data.employees[0].id;
                 employeeSelect.value = firstEmployeeId;
                 updateEmployeeInfo(firstEmployeeId);
            } else {
                resetSalariesForm();
            }

        } else {
            console.error('Failed to load users for dropdown:', data.message);
        }
    } catch (error) {
        console.error('Error fetching users for dropdown:', error);
    }
}
// ... (Your existing code) ...

function formatSelectedDate(dateString) {
        // This function takes a date in 'YYYY-MM-DD' format from the date picker
        // and returns it in the format 'YYYY-MM-DD' to match Firestore.
        // It's a simple passthrough, but useful for clarity.
        return dateString;
    }

    

        // Call the Flask API endpoint with the selected filters
        fetch(`/api/download_attendance_report?report_type=${reportType}&date=${selectedValue}&company=${companyType}`)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message);
                    });
                }
                return response.blob();
            })
            .then(blob => {
                // Create a temporary URL for the blob and trigger a download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${companyType.toUpperCase()}_Attendance_Report_${selectedValue}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                alert(`✅ Downloading ${a.download}...`);
            })
            .catch(error => {
                console.error('Download error:', error);
                alert(`❌ An error occurred: ${error.message}`);
            });
    

    async function fetchAttendanceFromFirestore(collectionName, dateKey, companyType) {
        const records = [];
        try {
            const docRefs = await dbAttendance.collection(collectionName).where('date_key', '==', dateKey).get();
            if (docRefs.empty) return records;

            for (const doc of docRefs.docs) {
                const subcollectionRef = doc.ref.collection('door_access');
                const subDocs = await subcollectionRef.get();
                subDocs.forEach(subDoc => {
                    const data = subDoc.data();
                    if (data.Branch && data.Branch.toLowerCase() === companyType.toLowerCase()) {
                        records.push(data);
                    }
                });
            }
            return records;
        } catch (error) {
            console.error('Error fetching data from Firestore:', error);
            return null;
        }
    }
    function resetSalariesForm() {
    document.getElementById('employeeId').textContent = 'N/A';
    document.getElementById('employeeAccount').textContent = 'N/A';
    document.getElementById('employeePfNo').textContent = 'N/A';
    document.getElementById('employeePfNoHidden').value = '';
    
    // Reset designation dropdown
    const designationSelect = document.getElementById('employeeDesignation');
    if (designationSelect) {
        designationSelect.value = '';
    }
    
    const inputs = document.querySelectorAll('#earningsContent input, #deductionsContent input, #leavesContent input');
    inputs.forEach(input => {
        if (input.type === 'number') {
            input.value = '0.00';
        } else {
            input.value = '0';
        }
    });
    
    document.getElementById('totalEarnings').textContent = '0.00';
    document.getElementById('totalDeductions').textContent = '0.00';
    document.getElementById('netSalary').textContent = '0.00';
}
    
    // New functions for fetching month/year data
    async function fetchMonthlyAttendance(collectionName, companyType) {
        const records = [];
        try {
            const docRefs = await dbAttendance.collection(collectionName).get();
            if (docRefs.empty) return records;

            for (const doc of docRefs.docs) {
                const subcollectionRef = doc.ref.collection('door_access');
                const subDocs = await subcollectionRef.get();
                subDocs.forEach(subDoc => {
                    const data = subDoc.data();
                    if (data.Branch && data.Branch.toLowerCase() === companyType.toLowerCase()) {
                        records.push(data);
                    }
                });
            }
            return records;
        } catch (error) {
            console.error('Error fetching monthly data from Firestore:', error);
            return null;
        }
    }

    async function fetchYearlyAttendance(year, companyType) {
        const records = [];
        const monthNames = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
        try {
            for (const month of monthNames) {
                const collectionName = `${month}_${year}`;
                const monthlyRecords = await fetchMonthlyAttendance(collectionName, companyType);
                if (monthlyRecords) {
                    records.push(...monthlyRecords);
                }
            }
            return records;
        } catch (error) {
            console.error('Error fetching yearly data from Firestore:', error);
            return null;
        }
    }

    function generateAttendanceReportHtml(data, date, company) {
        let tableRows = data.map(item => `
            <tr>
                <td style="padding: 8px; border: 1px solid #ccc;">${item.Name || 'N/A'}</td>
                <td style="padding: 8px; border: 1px solid #ccc;">${item.Branch || 'N/A'}</td>
                <td style="padding: 8px; border: 1px solid #ccc;">${item['Check-In Time'] || item.open_time_ist || 'N/A'}</td>
                <td style="padding: 8px; border: 1px solid #ccc;">${item['Check-Out Time'] || item.close_time_ist || 'N/A'}</td>
                <td style="padding: 8px; border: 1px solid #ccc;">${item.Status || 'N/A'}</td>
                <td style="padding: 8px; border: 1px solid #ccc;">${item.date_key || 'N/A'}</td>
            </tr>
        `).join('');

        return `
            <div style="font-family: Arial, sans-serif; padding: 20px;">
                <h2 style="text-align: center;">${company.toUpperCase()} Attendance Report</h2>
                <p style="text-align: center;">Date: ${date}</p>
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Name</th>
                            <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Branch</th>
                            <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Check-In Time</th>
                            <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Check-Out Time</th>
                            <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Status</th>
                            <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            </div>
        `;
    }
function generateAttendanceReportHtml(data, date, company) {
    let tableRows = data.map(item => `
        <tr>
            <td style="padding: 8px; border: 1px solid #ccc;">${item.Name || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ccc;">${item.Branch || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ccc;">${item['Check-In Time'] || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ccc;">${item['Check-Out Time'] || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ccc;">${item.Status || 'N/A'}</td>
        </tr>
    `).join('');

    return `
        <div style="font-family: Arial, sans-serif; padding: 20px;">
            <h2 style="text-align: center;">${company.toUpperCase()} Attendance Report</h2>
            <p style="text-align: center;">Date: ${date}</p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr style="background-color: #f2f2f2;">
                        <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Name</th>
                        <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Branch</th>
                        <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Check-In Time</th>
                        <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Check-Out Time</th>
                        <th style="padding: 8px; border: 1px solid #ccc; text-align: left;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </div>
    `;
}
async function downloadSalarySheetByBranch(branchName) {
    try {
        const response = await fetch('/api/get_all_employee_info');
        const data = await response.json();

        if (data.status !== 'success' || !data.employees) {
            alert('❌ Failed to fetch employee data.');
            return;
        }

        const normalizedBranchName = branchName.trim().toUpperCase();
        
        // Debug: Log all employees and their branches
        console.log('All employees:', data.employees);
        console.log('Looking for branch:', normalizedBranchName);
        
        const employeesForBranch = data.employees.filter(emp => {
            if (emp.office_branch) {
                const empBranch = emp.office_branch.trim().toUpperCase();
                console.log(`Employee ${emp.full_name}: branch="${emp.office_branch}" -> normalized="${empBranch}"`);
                
                // Handle the specific case where dropdown shows "SSEV SOFT SOLS" but database has "SSEV SOFTSOLS"
                if (normalizedBranchName === 'SSEV SOFT SOLS') {
                    return empBranch === 'SSEV SOFT SOLS' || 
                           empBranch === 'SSEV SOFTSOLS' || 
                           empBranch === 'SSEVSOFTSOLS' ||
                           empBranch.includes('SOFT') ||
                           empBranch.includes('SOFTSOLS');
                }
                
                return empBranch === normalizedBranchName;
            }
            console.log(`Employee ${emp.full_name}: no office_branch field`);
            return false;
        });

        // Check if we have employees without office_branch and include them for SSEV SOFT SOLS
        const employeesWithoutBranch = data.employees.filter(emp => !emp.office_branch);
        
        if (employeesForBranch.length === 0) {
            if (employeesWithoutBranch.length > 0 && (branchName === 'SSEV SOFT SOLS' || branchName === 'SSEV Softsols')) {
                // For SSEV SOFT SOLS, include employees without branch assignment
                employeesForBranch.push(...employeesWithoutBranch);
                console.log(`Including employees without branch for SSEV SOFT SOLS: ${employeesWithoutBranch.map(emp => emp.full_name).join(', ')}`);
            } else {
                alert(`No employees found for the branch: ${branchName}`);
                return;
            }
        } else if (employeesWithoutBranch.length > 0 && (branchName === 'SSEV SOFT SOLS' || branchName === 'SSEV Softsols')) {
            // If we found some employees with branch, also include those without branch for SSEV SOFT SOLS
            employeesForBranch.push(...employeesWithoutBranch);
            console.log(`Also including employees without branch for SSEV SOFT SOLS: ${employeesWithoutBranch.map(emp => emp.full_name).join(', ')}`);
        }

        const payslipElements = [];
        for (const employee of employeesForBranch) {
            console.log(`Fetching details for employee: ${employee.full_name} (ID: ${employee.id})`);
            
            try {
                const empDetailsResponse = await fetch(`/api/get_employee_info/${employee.id}`);
                const empDetailsData = await empDetailsResponse.json();

                console.log(`Employee ${employee.full_name} details:`, empDetailsData);

                if (empDetailsData.status === 'success' && empDetailsData.employee) {
                    const payslipHtml = createPayslipHtml(empDetailsData.employee, branchName);
                    payslipElements.push(payslipHtml);
                    console.log(`✅ Successfully created payslip for ${employee.full_name}`);
                } else {
                    console.error(`❌ Failed to get employee details for ${employee.full_name}:`, empDetailsData);
                }
            } catch (error) {
                console.error(`❌ Error fetching details for ${employee.full_name}:`, error);
            }
        }

        console.log(`📊 Summary: Found ${employeesForBranch.length} employees, generated ${payslipElements.length} payslips`);
        
        if (payslipElements.length === 0) {
            alert(`No payslips could be generated for the employees of branch: ${branchName}`);
            return;
        }
        
        if (payslipElements.length < employeesForBranch.length) {
            console.warn(`⚠️ Warning: Only ${payslipElements.length} out of ${employeesForBranch.length} employees had complete salary data`);
        }
        
        // This is the corrected and crucial part for handling page breaks.
        // It joins the HTML strings with a page break element in between.
        let payslipsWithBreaks = payslipElements.join('<div style="page-break-after: always;"></div>');

        // Note: For the final version, you can move the entirepayslip-container class to the body.
        // This is an advanced fix, but for now, this version of the code should work correctly.
        // The original payslip-container class might be causing a few minor layout issues,
        // but it won't produce blank pages.

        const filename = branchName === 'SSEV SOFT SOLS' ? 'SSEV_SOFT_SOLS_Salary_Sheet.pdf' : `${branchName}_Salary_Sheet.pdf`;
        html2pdf().from(payslipsWithBreaks).set({
            margin: [10, 10, 10, 10], // Adjust margins for a better fit
            filename: filename,
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();

        alert(`✅ ${branchName} salary sheet is being generated and downloaded.`);
    } catch (error) {
        console.error('Error downloading salary sheet:', error);
        alert('An error occurred while generating the salary sheet.');
    }
}

async function downloadSalarySheetTable(branchName) {
    try {
        const response = await fetch('/api/get_all_employee_info');
        const data = await response.json();

        if (data.status !== 'success' || !data.employees) {
            alert('❌ Failed to fetch employee data.');
            return;
        }

        const normalizedBranchName = branchName.trim().toUpperCase();
        
        // Filter employees by branch with flexible matching
        console.log('All employees data:', data.employees);
        console.log('Looking for branch:', normalizedBranchName);
        
        const employeesForBranch = data.employees.filter(emp => {
            console.log(`Checking employee: ${emp.full_name}, branch: "${emp.office_branch}"`);
            if (emp.office_branch) {
                const empBranch = emp.office_branch.trim().toUpperCase();
                console.log(`Normalized employee branch: "${empBranch}"`);
                
                // Handle the specific case where dropdown shows "SSEV SOFT SOLS" but database has "SSEV SOFTSOLS"
                if (normalizedBranchName === 'SSEV SOFT SOLS') {
                    const matches = empBranch === 'SSEV SOFT SOLS' || 
                           empBranch === 'SSEV SOFTSOLS' || 
                           empBranch === 'SSEVSOFTSOLS' ||
                           empBranch.includes('SOFT') ||
                           empBranch.includes('SOFTSOLS');
                    console.log(`SSEV SOFT SOLS match for ${emp.full_name}: ${matches}`);
                    return matches;
                }
                
                const matches = empBranch === normalizedBranchName;
                console.log(`Exact match for ${emp.full_name}: ${matches}`);
                return matches;
            }
            console.log(`No office_branch for ${emp.full_name}`);
            return false;
        });

        if (employeesForBranch.length === 0) {
            alert(`No employees found for the branch: ${branchName}`);
            return;
        }

        // Get current month and year
        const now = new Date();
        const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE",
                           "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
        const currentMonth = monthNames[now.getMonth()];
        const currentYear = now.getFullYear();

        // Calculate working days for the month (assuming 30 days per month for now)
        const workingDays = 30;

        // Create the salary sheet table HTML
        let salarySheetHtml = `
        <div style="font-family: Arial, sans-serif; margin: 20px;">
            <h2 style="text-align: center; margin-bottom: 30px;">
                SSEV SOFTWARE SOLUTIONS OF PRIVATE LIMITED<br>
                SALARY STATEMENT FOR THE MONTH OF ${currentMonth} - ${currentYear}
            </h2>
            
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 10px; table-layout: fixed;">
                <thead>
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 5%;">S No</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 15%;">Name of the Employee</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 12%;">Designation</th>
                        <th colspan="3" style="border: 1px solid #000; padding: 4px; text-align: center; width: 12%;">Total</th>
                        <th colspan="4" style="border: 1px solid #000; padding: 4px; text-align: center; width: 20%;">Actuals</th>
                        <th colspan="4" style="border: 1px solid #000; padding: 4px; text-align: center; width: 20%;">Earnings</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 6%;">Total</th>
                        <th colspan="5" style="border: 1px solid #000; padding: 4px; text-align: center; width: 25%;">Employee Contribution</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 6%;">Net</th>
                        <th colspan="1" style="border: 1px solid #000; padding: 4px; text-align: center; width: 6%;">Employers Contribution</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 6%;">TOTAL</th>
                    </tr>
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Days</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">NDP</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Fixed Gross</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">BASIC</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">HRA</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">CONV</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Spl. Allow</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">BASIC</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">HRA</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">CONV</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Spl. Allow</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">PF</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">IT</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Salary Advance</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">P.Tax</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Additional Arrears</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">PF</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                    </tr>
                </thead>
                <tbody>`;

        // Add employee rows
        console.log(`Found ${employeesForBranch.length} employees for branch ${branchName}`);
        employeesForBranch.forEach((emp, index) => {
            console.log(`Processing employee ${index + 1}: ${emp.full_name}`, emp);
            // Get salary details from employee info
            // These values come from the database (saved from Earnings section)
            const basic = parseFloat(emp.basic) || 0;
            const hra = parseFloat(emp.hra) || 0;
            const conveyance = parseFloat(emp.conveyance) || 0;
            const specialAllowance = parseFloat(emp.special_allowance) || 0;
            const actualGrossSalary = parseFloat(emp.actual_gross_salary) || 0;
            
            // Get NDP from employee data
            const ndp = parseFloat(emp.ndp) || workingDays;
            
            console.log(`Employee ${emp.full_name} data:`, {
                basic, hra, conveyance, specialAllowance, actualGrossSalary, ndp
            });
            
            // Calculate totals
            const earningsTotal = basic + hra + conveyance + specialAllowance;
            const fixedGross = actualGrossSalary || earningsTotal;
            
            // Employee contributions
            const pf = parseFloat(emp.provident_fund) || 0;
            const incomeTax = parseFloat(emp.income_tax) || 0;
            const salaryAdvance = parseFloat(emp.advance) || 0;
            const professionalTax = parseFloat(emp.professional_tax) || 0;
            const additionalArrears = 0; // This field doesn't exist in current schema
            
            const employeeContributionsTotal = pf + incomeTax + salaryAdvance + professionalTax + additionalArrears;
            const net = earningsTotal - employeeContributionsTotal;
            const employerPf = pf; // Same as employee PF
            const total = net + employerPf;

            salarySheetHtml += `
                <tr>
                    <td style="border: 1px solid #000; padding: 4px; text-align: center;">${index + 1}</td>
                    <td style="border: 1px solid #000; padding: 4px;">${emp.full_name || 'N/A'}</td>
                    <td style="border: 1px solid #000; padding: 4px;">${emp.designation || 'N/A'}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: center;">${workingDays}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: center;">${ndp}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${fixedGross.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${basic.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${hra.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${conveyance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${specialAllowance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${basic.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${hra.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${conveyance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${specialAllowance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${earningsTotal.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${pf.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${incomeTax.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${salaryAdvance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${professionalTax.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${additionalArrears.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${net.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${employerPf.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${total.toFixed(2)}</td>
                </tr>`;
        });

        salarySheetHtml += `
                </tbody>
            </table>
        </div>`;

        // Create Excel data
        const excelData = [];
        
        // Add header rows
        excelData.push(['SSEV SOFTWARE SOLUTIONS OF PRIVATE LIMITED']);
        excelData.push([`SALARY STATEMENT FOR THE MONTH OF ${currentMonth} - ${currentYear}`]);
        excelData.push([]); // Empty row
        
        // Add grouped headers row with proper structure
        excelData.push([
            'S No', 'Name of the Employee', 'Designation', 
            'Total', '', '',  // Total group header spans 3 columns
            'Actuals', '', '', '',  // Actuals group header spans 4 columns
            'Earnings', '', '', '',  // Earnings group header spans 4 columns
            'Total',  // Standalone Total
            'Employee Contribution', '', '', '', '',  // Employee Contribution group header spans 5 columns
            'Net',  // Standalone Net
            'Employers Contribution', '',  // Employers Contribution group header spans 2 columns
            'TOTAL'  // Final TOTAL
        ]);
        
        // Add sub-headers row
        excelData.push([
            '', '', '',  // S No, Name, Designation
            'Days', 'NDP', 'Fixed Gross',  // Total group sub-headers
            'BASIC', 'HRA', 'CONV', 'Spl. Allow',  // Actuals group sub-headers
            'BASIC', 'HRA', 'CONV', 'Spl. Allow',  // Earnings group sub-headers
            'Total',  // Standalone Total
            'PF', 'IT', 'Salary Advance', 'P.Tax', 'Additional Arrears',  // Employee Contribution sub-headers
            'Net',  // Standalone Net
            'PF', 'TOTAL'  // Employers Contribution sub-headers
        ]);
        
        // Add employee data rows
        employeesForBranch.forEach((emp, index) => {
            // Get employee name and designation from user info
            const employeeName = emp.full_name || 'N/A';
            const designation = emp.designation || 'N/A';
            
            // Get NDP from leaves in salaries (assuming this is leave_availed or similar field)
            const ndpValue = parseFloat(emp.leave_availed) || 0;
            
            // Fixed Gross = actual_gross_salary
            const fixedGross = parseFloat(emp.actual_gross_salary) || 0;
            
            // ACTUALS section - from original/planned salary values
            const actualsBasic = parseFloat(emp.basic) || 0;
            const actualsHra = parseFloat(emp.hra) || 0;
            const actualsConveyance = parseFloat(emp.conveyance) || 0;
            const actualsSpecialAllowance = parseFloat(emp.special_allowance) || 0;
            const additionalArrears = parseFloat(emp.add_others) || 0; // Add Others from actuals
            
            // EARNINGS section - from separate earnings fields (what's actually being paid)
            // If earnings fields are null/undefined, fall back to actuals values
            const earningsBasic = parseFloat(emp.earnings_basic) || parseFloat(emp.basic) || 0;
            const earningsHra = parseFloat(emp.earnings_hra) || parseFloat(emp.hra) || 0;
            const earningsConveyance = parseFloat(emp.earnings_conveyance) || parseFloat(emp.conveyance) || 0;
            const earningsSpecialAllowance = parseFloat(emp.earnings_special_allowance) || parseFloat(emp.special_allowance) || 0;
            
            // Calculate earnings total
            const earningsTotal = earningsBasic + earningsHra + earningsConveyance + earningsSpecialAllowance;
            
            // DEDUCTIONS section - from deductions in salaries
            const pf = parseFloat(emp.provident_fund) || 0;
            const incomeTax = parseFloat(emp.income_tax) || 0;
            const salaryAdvance = parseFloat(emp.advance) || 0;
            const professionalTax = parseFloat(emp.professional_tax) || 0;
            
            // Calculate totals
            const employeeContributionsTotal = pf + incomeTax + salaryAdvance + professionalTax + additionalArrears;
            const net = earningsTotal - employeeContributionsTotal;
            const employerPf = pf; // Same as employee PF
            const total = net + employerPf;

            excelData.push([
                index + 1,                    // S No
                employeeName,                 // Name of the Employee
                designation,                  // Designation
                workingDays,                  // Days
                ndpValue,                     // NDP (from leaves)
                fixedGross,                   // Fixed Gross (actual_gross_salary)
                actualsBasic,                 // BASIC (Actuals)
                actualsHra,                   // HRA (Actuals)
                actualsConveyance,            // CONV (Actuals)
                actualsSpecialAllowance,      // Spl. Allow (Actuals)
                earningsBasic,                // BASIC (Earnings)
                earningsHra,                  // HRA (Earnings)
                earningsConveyance,           // CONV (Earnings)
                earningsSpecialAllowance,     // Spl. Allow (Earnings)
                earningsTotal,                // Total (Earnings)
                pf,                           // PF (Employee)
                incomeTax,                    // IT (Employee)
                salaryAdvance,                // Salary Advance
                professionalTax,              // P.Tax
                additionalArrears,            // Additional Arrears (Add Others)
                net,                          // Net
                employerPf,                   // PF (Employer)
                total                         // TOTAL
            ]);
        });

        // Create and download Excel file
        const filename = branchName === 'SSEV SOFT SOLS' ? 'SSEV_SOFT_SOLS_Salary_Statement.xlsx' : `${branchName}_Salary_Statement.xlsx`;
        
        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // Add cell merging for grouped headers
        if (!ws['!merges']) ws['!merges'] = [];
        
        // Find the header row (after company name, month, and empty row)
        const headerRow = 3; // 0-based index (row 4 in Excel)
        const subHeaderRow = 4; // 0-based index (row 5 in Excel)
        
        // Merge cells for grouped headers
        // Total group (columns D-F, spans 3 columns)
        ws['!merges'].push({s: {r: headerRow, c: 3}, e: {r: headerRow, c: 5}});
        
        // Actuals group (columns G-J, spans 4 columns)
        ws['!merges'].push({s: {r: headerRow, c: 6}, e: {r: headerRow, c: 9}});
        
        // Earnings group (columns K-N, spans 4 columns)
        ws['!merges'].push({s: {r: headerRow, c: 10}, e: {r: headerRow, c: 13}});
        
        // Employee Contribution group (columns P-T, spans 5 columns)
        ws['!merges'].push({s: {r: headerRow, c: 15}, e: {r: headerRow, c: 19}});
        
        // Employers Contribution group (columns V-W, spans 2 columns)
        ws['!merges'].push({s: {r: headerRow, c: 21}, e: {r: headerRow, c: 22}});
        
        // Add styling for grouped headers
        const headerStyle = {
            font: { bold: true, size: 12, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "366092" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: {
                top: { style: "thin", color: { rgb: "000000" } },
                bottom: { style: "thin", color: { rgb: "000000" } },
                left: { style: "thin", color: { rgb: "000000" } },
                right: { style: "thin", color: { rgb: "000000" } }
            }
        };
        
        const subHeaderStyle = {
            font: { bold: true, size: 10 },
            fill: { fgColor: { rgb: "D9E2F3" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: {
                top: { style: "thin", color: { rgb: "000000" } },
                bottom: { style: "thin", color: { rgb: "000000" } },
                left: { style: "thin", color: { rgb: "000000" } },
                right: { style: "thin", color: { rgb: "000000" } }
            }
        };
        
        // Apply styling to grouped header cells
        const headerCells = [
            'D3', 'E3', 'F3',  // Total group
            'G3', 'H3', 'I3', 'J3',  // Actuals group
            'K3', 'L3', 'M3', 'N3',  // Earnings group
            'O3',  // Standalone Total
            'P3', 'Q3', 'R3', 'S3', 'T3',  // Employee Contribution group
            'U3',  // Standalone Net
            'V3', 'W3',  // Employers Contribution group
            'X3'   // Final TOTAL
        ];
        
        headerCells.forEach(cell => {
            if (!ws[cell]) ws[cell] = { v: '' };
            ws[cell].s = headerStyle;
        });
        
        // Apply styling to sub-header cells
        const subHeaderCells = [
            'D4', 'E4', 'F4',  // Total sub-headers
            'G4', 'H4', 'I4', 'J4',  // Actuals sub-headers
            'K4', 'L4', 'M4', 'N4',  // Earnings sub-headers
            'O4',  // Standalone Total
            'P4', 'Q4', 'R4', 'S4', 'T4',  // Employee Contribution sub-headers
            'U4',  // Standalone Net
            'V4', 'W4',  // Employers Contribution sub-headers
            'X4'   // Final TOTAL
        ];
        
        subHeaderCells.forEach(cell => {
            if (!ws[cell]) ws[cell] = { v: '' };
            ws[cell].s = subHeaderStyle;
        });
        
        // Set column widths
        const colWidths = [
            { wch: 5 },   // S No
            { wch: 20 },  // Name
            { wch: 15 },  // Designation
            { wch: 8 },   // Days
            { wch: 8 },   // NDP
            { wch: 12 },  // Fixed Gross
            { wch: 10 },  // BASIC (Actuals)
            { wch: 10 },  // HRA (Actuals)
            { wch: 10 },  // CONV (Actuals)
            { wch: 12 },  // Spl. Allow (Actuals)
            { wch: 10 },  // BASIC (Earnings)
            { wch: 10 },  // HRA (Earnings)
            { wch: 10 },  // CONV (Earnings)
            { wch: 12 },  // Spl. Allow (Earnings)
            { wch: 10 },  // Total
            { wch: 10 },  // PF
            { wch: 10 },  // IT
            { wch: 12 },  // Salary Advance
            { wch: 10 },  // P.Tax
            { wch: 15 },  // Additional Arrears
            { wch: 10 },  // Net
            { wch: 10 },  // PF (Employer)
            { wch: 10 }   // TOTAL
        ];
        ws['!cols'] = colWidths;
        
        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Salary Statement');
        
        // Generate and download Excel file
        XLSX.writeFile(wb, filename);

    } catch (error) {
        console.error('Error downloading salary sheet table:', error);
        alert('Error downloading salary sheet table: ' + error.message);
    }
}

async function saveSalaryData() {
    try {
        const selectedEmployeeId = document.getElementById('employeeNameSelect').value;
        if (!selectedEmployeeId) {
            alert('Please select an employee first.');
            return;
        }

        // Get all form data from Earnings section (as requested by user)
        const earningsBasic = parseFloat(document.getElementById('earningsBasic').value) || 0;
        const earningsHra = parseFloat(document.getElementById('earningsHra').value) || 0;
        const earningsConveyance = parseFloat(document.getElementById('earningsConveyance').value) || 0;
        const earningsVehicleMaintenance = parseFloat(document.getElementById('earningsVehicleMaintenance').value) || 0;
        const earningsSpecialAllowance = parseFloat(document.getElementById('earningsSpecialAllowance').value) || 0;
        const earningsAddOthers = parseFloat(document.getElementById('addOthersEarnings').value) || 0;
        
        // Debug logging
        console.log('DEBUG: Earnings values being sent:', {
            basic: earningsBasic,
            hra: earningsHra,
            conveyance: earningsConveyance,
            vehicle_maintenance: earningsVehicleMaintenance,
            special_allowance: earningsSpecialAllowance,
            add_others: earningsAddOthers
        });
        
        const formData = {
            actual_gross_salary: earningsBasic + earningsHra + earningsConveyance + earningsVehicleMaintenance + earningsSpecialAllowance + earningsAddOthers,
            basic: earningsBasic,
            hra: earningsHra,
            conveyance: earningsConveyance,
            vehicle_maintenance: earningsVehicleMaintenance,
            special_allowance: earningsSpecialAllowance,
            add_others: earningsAddOthers,
            provident_fund: parseFloat(document.getElementById('providentFund').value) || 0,
            esi: parseFloat(document.getElementById('esi').value) || 0,
            professional_tax: parseFloat(document.getElementById('professionalTax').value) || 0,
            income_tax: parseFloat(document.getElementById('incomeTax').value) || 0,
            advance: parseFloat(document.getElementById('advance').value) || 0,
            other_deductions: parseFloat(document.getElementById('otherDeductions').value) || 0,
            loss_of_pay: parseFloat(document.getElementById('lossOfPay').value) || 0,
            total_leaves: parseInt(document.getElementById('totalLeaves').value) || 0,
            leave_availed: parseInt(document.getElementById('leaveAvailed').value) || 0,
            balance_leaves: parseInt(document.getElementById('balanceLeaves').value) || 0,
            no_of_lop_days: parseInt(document.getElementById('noOfLopDays').value) || 0,
            total_days: parseInt(document.getElementById('totalDays').value) || 30,
            ndp: parseInt(document.getElementById('ndp').value) || 0
        };

        // Send data to backend to save
        console.log('DEBUG: Sending data:', {
            employee_id: selectedEmployeeId,
            salary_data: formData
        });
        
        const response = await fetch('/api/update_employee_salary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                employee_id: selectedEmployeeId,
                salary_data: formData
            })
        });

        const result = await response.json();
        
        if (result.status === 'success') {
            alert('✅ Salary data saved successfully!');
        } else {
            alert('❌ Error saving salary data: ' + result.message);
        }

    } catch (error) {
        console.error('Error saving salary data:', error);
        alert('Error saving salary data: ' + error.message);
    }
}

// dashboard.html - Cache bust v2.0 - Fixed pay slip date issue
function getCurrentMonthYear() {
    const now = new Date();
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
    return `Pay-Slip For The Month of ${monthNames[now.getMonth()]} ${now.getFullYear()}`;
}

function createPayslipHtml(emp, companyBranch = '') {
    // Total Earnings = Basic + HRA + Conveyance + Special Allowance + Vehicle Maintenance + Add Others (from earnings section)
    const totalEarnings = (emp.basic || 0) + (emp.hra || 0) + (emp.conveyance || 0) + (emp.special_allowance || 0) + (emp.vehicle_maintenance || 0) + (emp.add_others || 0);
    // Total Deductions = PF + ESI + Professional Tax + Income Tax + Advance + Other Deductions + Loss of Pay
    const totalDeductions = (emp.provident_fund || 0) + (emp.esi || 0) + (emp.professional_tax || 0) + (emp.income_tax || 0) + (emp.advance || 0) + (emp.other_deductions || 0) + (emp.loss_of_pay || 0);
    const netSalary = totalEarnings - totalDeductions;
    const designation = emp.designation || ((emp.roles && emp.roles.includes('Manager')) ? 'Manager' : 'Employee');
    const employeeId = `SSDEV-${emp.id.toString().padStart(2, '0')}-002`;
    const payslipTitle = getCurrentMonthYear();

    // Determine watermark based on company branch
    let watermarkSrc = '';
    if (companyBranch && companyBranch.toLowerCase().includes('softsols')) {
        watermarkSrc = 'static/images/watermark-ssev-softsols.png';
    } else {
        watermarkSrc = 'static/images/watermark-ssev.png';
    }
    
    console.log(`Using watermark: ${watermarkSrc} for company branch: ${companyBranch}`);

    return `
    <div class="payslip-container" style="position: relative;">
        <!-- Watermark -->
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; display: flex; align-items: center; justify-content: center; background-image: url('${watermarkSrc}'); background-repeat: no-repeat; background-position: center; background-size: contain;">
        </div>
        
        <table class="payslip-header-table">
            <tr>
                <td style="width: 15%; border: none;">
                    <img src="static/images/logo.png" alt="Company Logo" class="payslip-logo">
                </td>
                <td style="width: 85%; border: none; padding: 0;">
                    <div class="company-name">SSEV SOFTWARE SOLUTIONS PRIVATE LIMITED</div>
                    <div class="company-details">Corporate office: #2-057/A/112, 1st Floor, VSS Nandadeep,<br>Near Medchal RTA Office, Petbasheerabad Village, Kompally Road,<br>Medchal District Telangana Hyderabad 500067.<br>Ph.040-35042301.</div>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="payslip-title" style="border-left: none; border-right: none;">${payslipTitle}</td>
            </tr>
        </table>
        
        <table class="payslip-main-table" style="margin-top: 20px;">
            <tr>
                <td style="width: 25%;">Employee No</td>
                <td style="width: 25%;">${employeeId || 'N/A'}</td>
                <td style="width: 25%;">Designation</td>
                <td style="width: 25%;">${designation || 'N/A'}</td>
            </tr>
            <tr>
                <td>Name</td>
                <td>${emp.full_name || 'N/A'}</td>
                <td>Total Days</td>
                <td>${emp.total_days || '30'}</td>
            </tr>
            <tr>
                <td>Bank A/c No</td>
                <td>${emp.account_number || 'N/A'}</td>
                <td>LOP</td>
                <td>0</td>
            </tr>
            <tr>
                <td>PF No.</td>
                <td>${emp.pf_no || 'N/A'}</td>
                <td>Date of Joining</td>
                <td>${emp.date_of_joining || 'N/A'}</td>
            </tr>
            <tr>
                <td colspan="2"></td>
                <td>Effective work days</td>
                <td>${emp.ndp || '0'}</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: center;">Total Leaves : ${emp.total_leaves || '0'} | Leave Availed : 0 | Balance : 0</td>
            </tr>
            <tr>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Earnings</th>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Deductions</th>
            </tr>
            <tr>
                <td>BASIC</td>
                <td>${(emp.basic || 0).toFixed(2)}</td>
                <td>PF</td>
                <td>${(emp.provident_fund || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>HRA</td>
                <td>${(emp.hra || 0).toFixed(2)}</td>
                <td>ESI</td>
                <td>${(emp.esi || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>CONVEYANCE</td>
                <td>${(emp.conveyance || 0).toFixed(2)}</td>
                <td>P. Tax</td>
                <td>${(emp.professional_tax || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>VEHICLE MAINTENANCE</td>
                <td>${(emp.vehicle_maintenance || 0).toFixed(2)}</td>
                <td>Income Tax</td>
                <td>${(emp.income_tax || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>SPL ALLOWANCE</td>
                <td>${(emp.special_allowance || 0).toFixed(2)}</td>
                <td>Advance</td>
                <td>${(emp.advance || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>Add Others</td>
                <td>${(emp.add_others || 0).toFixed(2)}</td>
                <td>Others Deduction</td>
                <td>${(emp.other_deductions || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td colspan="2" style="border: none;"></td>
                <td>Loss of Pay</td>
                <td>${(emp.loss_of_pay || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td colspan="2" style="border: none;"></td>
                <td>Total Deduction</td>
                <td>${totalDeductions.toFixed(2)}</td>
            </tr>
            <tr class="payslip-total-row">
                <td>Total Earnings</td>
                <td>${totalEarnings.toFixed(2)}</td>
                <td colspan="2" style="border: none;"></td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: right; font-weight: bold; font-size: 12pt;">Net Salary: ${netSalary.toFixed(2)}</td>
            </tr>
        </table>
        
        <!-- System Generated Disclaimer -->
        <div style="margin-top: 20px; text-align: left; font-size: 10pt; color: #666;">
            It is System generated, Signature not required
        </div>
    </div>`;
}

        // ========= Attendance =========
        // Replace the entire loadSubSection_Attendance function with this corrected version

        function loadSubSection_Attendance(subsection) {
                    const mainContent = document.getElementById('mainContent');
                    if (subsection === 'DateView') {
                        mainContent.innerHTML = `
                  <h2>📅 Employee Manager</h2>
                  <p style="color:#ccc;">Today's attendance overview</p>
                  <div style="margin:10px 0;">
                    <input id="attDate" type="date" value="${todayKey()}" style="padding:7px 10px;border-radius:8px;background:rgba(255,255,255,.08);border:1px solid #666;color:#fff;">
                    <button class="add-tab-button" style="padding:8px 12px;" onclick="fetchAttendanceForDate(document.getElementById('attDate').value || todayKey())">Load</button>
                  </div>
                  <div style="margin-top:10px; max-height: 80vh; overflow-y: auto; border-radius: 6px;">
                    <table class="table-xl">
                      <thead>
                        <tr>
                          <th style="padding:12px;border-bottom:1px solid #666;text-align:left;">Name</th>
                          <th style="padding:12px;border-bottom:1px solid #666;text-align:left;">Branch</th>
                          <th style="padding:12px;border-bottom:1px solid #666;text-align:left;">Designation</th>
                          <th style="padding:12px;border-bottom:1px solid #666;">Check-In</th>
                          <th style="padding:12px;border-bottom:1px solid #666;">Check-Out</th>
                          <th style="padding:12px;border-bottom:1px solid #666;">Status</th>
                          <th style="padding:12px;border-bottom:1px solid #666;">Action</th>
                        </tr>
                      </thead>
                      <tbody id="attendanceTableBody"></tbody>
                    </table>
                  </div>`;
                        fetchAttendanceForDate(todayKey());
                    } else if (subsection === 'Reports') {
                loadReportsSection();
            } else if (subsection === 'Door Logs') {
                loadDoorLogsSection();
            } else if (subsection === 'UserMSIReports') { // This is the new section we added
                loadUserMsiReportsSection();
            } else if (subsection === 'Permissions') {
                loadPermissionsSection(); // This function is in scripts.js
            } else if (subsection === 'Holidays') {
                loadHolidaysSection(); // This function will be implemented
            }else if (subsection === 'User') { // THIS IS THE PART THAT WAS MISSING
                // It seems 'User' was intended to show the user list.
                // Let's restore the functionality to load the 'Active Users' section.
                loadSubSection('Active Users');
            } else {
                mainContent.innerHTML = `<h2>${subsection}</h2><p style="color:#ccc;">Content for ${subsection.toLowerCase()} is not yet implemented.</p>`;
            }
        }


        async function loadHolidaysSection() {
            const mainContent = document.getElementById('mainContent');
            
            // Check user roles to determine if they can add holidays
            let canAddHolidays = false;
            try {
                const response = await fetch('/api/user/roles');
                const data = await response.json();
                if (data.status === 'success') {
                    const roles = data.roles || [];
                    canAddHolidays = roles.includes('Admin') || roles.includes('HR');
                }
            } catch (error) {
                console.error('Error fetching user roles:', error);
            }
            
            let html = `<h2>🎉 Holidays Management</h2>`;
            
            if (canAddHolidays) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <button onclick="openAddHolidayModal()" class="add-tab-button" style="background: #00d1ff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            + Add New Holiday
                        </button>
                    </div>
                `;
            }
            
            html += `
                <div id="holidaysList" style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 20px;">
                    <p style="color: #ccc; text-align: center;">Loading holidays...</p>
                </div>
            `;
            
            mainContent.innerHTML = html;
            loadHolidaysData(canAddHolidays);
        }

        // Global holiday functions
        function openAddHolidayModal() {
            console.log('openAddHolidayModal called'); // Debug log
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Add New Holiday</h3>
                        <button onclick="closeModal()" class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="addHolidayForm">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #fff;">Holiday Name:</label>
                                <input type="text" id="holidayName" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #666; background: rgba(255,255,255,0.1); color: #fff;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #fff;">Date:</label>
                                <input type="date" id="holidayDate" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #666; background: rgba(255,255,255,0.1); color: #fff;">
                            </div>
                            <div style="text-align: right;">
                                <button type="button" onclick="closeModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-right: 10px;">Cancel</button>
                                <button type="submit" style="background: #00d1ff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Save Holiday</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.getElementById('addHolidayForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('holidayName').value;
                const date = document.getElementById('holidayDate').value;
                
                try {
                    const response = await fetch('/api/holidays', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name, date })
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        alert('Holiday added successfully!');
                        closeModal();
                        loadHolidaysData();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error adding holiday: ' + error.message);
                }
            });
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        async function loadHolidaysData(canDelete = false) {
            try {
                const response = await fetch('/api/holidays');
                const result = await response.json();
                
                const holidaysList = document.getElementById('holidaysList');
                if (result.status === 'success') {
                    if (result.holidays.length === 0) {
                        holidaysList.innerHTML = '<p style="color: #ccc; text-align: center;">No holidays added yet.</p>';
                    } else {
                        const holidaysHtml = result.holidays.map(holiday => {
                            let deleteButton = '';
                            if (canDelete) {
                                deleteButton = `<button onclick="deleteHoliday(${holiday.id})" style="background: #ff4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">Delete</button>`;
                            }
                            
                            return `
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0; color: #fff;">${holiday.name}</h4>
                                        <p style="margin: 5px 0 0 0; color: #ccc; font-size: 14px;">${holiday.date} | Added by: ${holiday.created_by}</p>
                                    </div>
                                    ${deleteButton}
                                </div>
                            `;
                        }).join('');
                        holidaysList.innerHTML = holidaysHtml;
                    }
                } else {
                    holidaysList.innerHTML = '<p style="color: #ff4444; text-align: center;">Error loading holidays: ' + result.message + '</p>';
                }
            } catch (error) {
                const holidaysList = document.getElementById('holidaysList');
                holidaysList.innerHTML = '<p style="color: #ff4444; text-align: center;">Error loading holidays: ' + error.message + '</p>';
            }
        }

        async function deleteHoliday(holidayId) {
            if (confirm('Are you sure you want to delete this holiday?')) {
                try {
                    const response = await fetch(`/api/holidays/${holidayId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        alert('Holiday deleted successfully!');
                        loadHolidaysData();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error deleting holiday: ' + error.message);
                }
            }
        }

                function fmtTime(val) {
                    if (!val) return '—';
                    let d = (typeof val?.toDate === 'function') ? val.toDate() : new Date(val);
                    if (isNaN(d)) return '—';
                    return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }
                function todayKey() {
                    const d = new Date();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${d.getFullYear()}-${m}-${day}`;
                }

                // This is the only function that needs to be replaced.
        // It will now dynamically construct the collection name from the date.
        async function fetchAttendanceForDate(dateKey) {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;">Loading attendance for ${dateKey}…</td></tr>`;

            // Extract year and month from the dateKey (e.g., "2025-08-25")
            const [year, month] = dateKey.split('-');

            // Construct the new dynamic collection name (e.g., "august_2025")
            const monthNames = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
            const monthString = monthNames[parseInt(month, 10) - 1]; // Convert '08' to 'august'
            const collectionName = `${monthString}_${year}`;

            try {
                console.log(`Fetching attendance for collection: ${collectionName}, date: ${dateKey}`);
                const snap = await dbAttendance.collection(collectionName).where('date_key', '==', dateKey).get();
                console.log(`Firebase query result: ${snap.size} documents found`);
                
                if (snap.empty) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:#ccc;">No attendance records for ${dateKey}.</td></tr>`;
                    return;
                }

                const rows = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    const checkIn = d.check_in || null;
                    const checkOut = d.check_out || null;
                    let status = '—';
                    if (checkOut) status = 'Checked Out';
                    else if (checkIn) status = d.late ? 'Late' : 'On Duty';

                    rows.push({
                        name: d.Name || d.name || '—',
                        branch: d.Branch || d.branch || '—',
                        designation: d.Designation || d.designation || '—',
                        checkin: fmtTime(checkIn),
                        checkout: fmtTime(checkOut),
                        status
                    });
                });

                rows.sort((a, b) => a.name.localeCompare(b.name));
                tbody.innerHTML = rows.map(r => `
                  <tr>
                    <td style="padding:10px;">${r.name}</td>
                    <td style="padding:10px;">${r.branch}</td>
                    <td style="padding:10px;">${r.designation}</td>
                    <td style="padding:10px;">${r.checkin}</td>
                    <td style="padding:10px;">${r.checkout}</td>
                    <td style="padding:10px;">${r.status}</td>
                    <td style="padding:10px;">
                      <select>
                        <option>Select Action</option>
                        <option>On Duty</option>
                        <option>Checkout</option>
                        <option>Remove</option>
                      </select>
                    </td>
                  </tr>`).join('');

            } catch (err) {
                console.error('Attendance fetch error:', err);
                let errorMessage = 'Failed to load attendance.';
                
                if (err.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please check Firebase security rules.';
                } else if (err.code === 'unavailable') {
                    errorMessage = 'Firebase service unavailable. Please try again later.';
                } else if (err.message && err.message.includes('permissions')) {
                    errorMessage = 'Missing or insufficient permissions. Please contact administrator.';
                }
                
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:red;">${errorMessage}</td></tr>`;
            }
        }
        function fmtTime(val) {
            if (!val) return '—';
            let d = (typeof val?.toDate === 'function') ? val.toDate() : new Date(val);
            if (isNaN(d)) return '—';
            return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        function todayKey() {
            const d = new Date();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${d.getFullYear()}-${m}-${day}`;
        }

        


        

        function clearAllTimers() {
            activeTimers.forEach(timer => clearInterval(timer));
            activeTimers = [];
        }

        function startCountdown(endDateString, elementId) {
            const countDownDate = new Date(endDateString).getTime();
            const element = document.getElementById(elementId);
            if (!element || isNaN(countDownDate)) {
                if (element) {
                    element.innerHTML = '<span style="font-size: 12px; color: #aaa;">No deadline set</span>';
                }
                return;
            }
            const interval = setInterval(function () {
                const now = new Date().getTime();
                const distance = countDownDate - now;
                if (distance < 0) {
                    clearInterval(interval);
                    element.innerHTML = '<span style="font-size: 14px; color: #dc3545;">Deadline Passed</span>';
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                const d = String(days).padStart(2, '0');
                const h = String(hours).padStart(2, '0');
                const m = String(minutes).padStart(2, '0');
                const s = String(seconds).padStart(2, '0');
                element.innerHTML = `
            <span class="time-segment">${d}<small>Days</small></span>
            <span class="time-colon">:</span>
            <span class="time-segment">${h}<small>Hrs</small></span>
            <span class="time-colon">:</span>
            <span class="time-segment">${m}<small>Min</small></span>
            <span class="time-colon">:</span>
            <span class="time-segment">${s}<small>Sec</small></span>
        `;
            }, 1000);
            activeTimers.push(interval);
        }

        // === Billing Module ===
        function addExtraBillingTab() {
            const newTabName = prompt("Enter the name for the new billing tab:");
            if (newTabName && newTabName.trim() !== "") {
                extraBillingTabs.push(newTabName.trim());
                loadSection('Billing');
            } else if (newTabName !== null) {
                alert("Tab name cannot be empty.");
            }
        }

        function loadBillingSubSection(subsection) {
            let content = '';
            switch (subsection) {
                case 'Your Products':
                    content = `
                    <h2>📦 Your Products</h2>
                    <p style="color:#ccc;">Details about the products and services you are subscribed to.</p>
                    <div class="product-cards-container">
                        <div class="product-card-item">
                            <h3>ERP</h3>
                            <div class="price">$0 <small>/ month</small></div>
                            <p class="description">Intelligence for everyday tasks</p>
                            <ul>
                                <li>Basic models</li>
                                <li>Limited messages and uploads</li>
                                <li>Limited and slower image generation</li>
                                <li>Limited deep research</li>
                                <li>Limited memory and context</li>
                            </ul>
                            <button class="btn-select">Your current plan</button>
                        </div>
                        <div class="product-card-item popular">
                            <h3>ERP + LEXICON</h3>
                            <div class="price">$20 <small>/ month</small></div>
                            <p class="description">More access to advanced intelligence</p>
                            <ul>
                                <li>Smarter models</li>
                                <li>Expanded messaging and uploads</li>
                                <li>Expanded and faster image creation</li>
                                <li>Expanded deep research and agent mode</li>
                                <li>Expanded memory and context</li>
                                <li>Projects, tasks and custom GPTs</li>
                                <li>Sora video generation</li>
                                <li>Codex agent</li>
                            </ul>
                            <button class="btn-select">Get Plus</button>
                        </div>
                        <div class="product-card-item">
                            <h3>LEXICON</h3>
                            <div class="price">$200 <small>/ month</small></div>
                            <p class="description">Full access to the best of SoftSol ERP</p>
                            <ul>
                                <li>Most powerful models</li>
                                <li>Unlimited messages and uploads</li>
                                <li>Unlimited and faster image creation</li>
                                <li>Maximum deep research and agent mode</li>
                                <li>Maximum memory and context</li>
                                <li>Expanded projects, tasks, and custom GPTs</li>
                                <li>Sora video generation</li>
                                <li>Expanded Codex agent</li>
                                <li>Research preview of new features</li>
                            </ul>
                            <button class="btn-select">Get Pro</button>
                        </div>
                    </div>
                    `;
                    break;
                case 'Bills & Payments':
                    content = `<h2>💸 Bills & Payments</h2><p style="color:#ccc;">View your invoices, billing history, and payment status.</p><div style="margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px;"><p>You have no pending bills.</p></div>`;
                    break;
                case 'Billing Accounts':
                    content = `<h2>💼 Billing Accounts</h2><p style="color:#ccc;">Manage your billing accounts and information.</p><div style="margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px;"><p>Account details here.</p></div>`;
                    break;
                case 'Billing Notifications':
                    content = `<h2>🔔 Billing Notifications</h2><p style="color:#ccc;">Set up and manage your billing alerts and notifications.</p><div style="margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px;"><p>No notifications configured.</p></div>`;
                    break;
                case 'Payment Methods':
                    content = `<h2>💳 Payment Methods</h2><p style="color:#ccc;">Add or update your payment methods.</p><div style="margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px;"><p>You have no saved payment methods.</p></div>`;
                    break;
                default:
                    content = `<h2>✨ ${subsection}</h2><p style="color:#ccc;">Content for the dynamically added tab "${subsection}".</p><div style="margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px;"><p>This is a custom tab. You can add specific content here.</p></div>`;
                    break;
            }
            document.getElementById('mainContent').innerHTML = content;
        }


        // NEW FUNCTION: Load Door Logs Section
        async function loadDoorLogsSection() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
    <h2>🚪 Door Logs</h2>
    <p style="color:#ccc;">Real-time door access logs from Firestore.</p>

    <!-- Search bar -->
    <div style="display:flex; gap:10px; align-items:center; margin:14px 0 6px;">
      <input id="doorLogSearch" type="text" placeholder="Filter by any field (Branch, Door No., Name, date_key, device_id, open_time, open_time_ist)…"
        style="flex:1; padding:10px 12px; border-radius:8px; border:1px solid #666; background:rgba(255,255,255,0.08); color:#fff; outline:none;">
      <button onclick="clearDoorLogFilter()" style="padding:10px 14px; border-radius:8px; border:none; background:#444; color:#fff; cursor:pointer;">
        Clear
      </button>
    </div>

    <div style="margin-top:10px;max-height:80vh;overflow-y:auto;border-radius:6px;">
      <table style="width:100%;border-collapse:collapse;background-color:rgba(255,255,255,0.05);">
        <thead>
          <tr style="background-color:rgba(255,255,255,0.1);">
            <th style="padding:12px;border-bottom:1px solid #666;text-align:left;">Branch</th>
            <th style="padding:12px;border-bottom:1px solid #666;text-align:left;">Door No.</th>
            <th style="padding:12px;border-bottom:1px solid #666;text-align:left;">Name</th>
            <th style="padding:12px;border-bottom:1px solid #666;text-align:left;">date_key</th>
            <th style="padding:12px;border-bottom:1px solid #666;text-align:left;">device_id</th>

            <th style="padding:12px;border-bottom:1px solid #666;text-align:left;">open_time_ist</th>
          </tr>
        </thead>
        <tbody id="doorLogsTableBody"></tbody>
      </table>
    </div>`;

            // live filter as you type (with a tiny debounce)
            const box = document.getElementById('doorLogSearch');
            box.addEventListener('input', debounce(applyDoorLogsFilter, 150));

            fetchDoorLogs();
        }

        // Read ALL nested subcollections named "door_access"
        async function fetchDoorLogs() {
            const tbody = document.getElementById('doorLogsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;">Loading door logs...</td></tr>';

            try {
                const snap = await dbAttendance.collectionGroup('door_access').get();

                const logs = [];
                snap.forEach(docSnap => {
                    const d = docSnap.data();

                    // Normalize open_time (supports Firestore Timestamp or string)
                    let openTimeStr = d.open_time;
                    let sortKey = 0;
                    if (openTimeStr && typeof openTimeStr.toDate === 'function') {
                        const dt = openTimeStr.toDate();
                        openTimeStr = dt.toISOString().replace('T', ' ').slice(0, 19);
                        sortKey = dt.getTime();
                    } else {
                        sortKey = Date.parse(d.open_time || d.open_time_ist || 0) || 0;
                        if (typeof d.open_time === 'string') openTimeStr = d.open_time;
                    }

                    logs.push({
                        Branch: d.Branch || 'N/A',
                        DoorNo: d['Door No.'] || d.DoorNo || 'N/A',
                        Name: d.Name || 'N/A',
                        date_key: d.date_key || 'N/A',
                        device_id: d.device_id || 'N/A',
                        open_time: openTimeStr || 'N/A',
                        open_time_ist: d.open_time_ist || 'N/A',
                        _sort: sortKey
                    });
                });

                logs.sort((a, b) => b._sort - a._sort);   // newest first
                DOOR_LOGS_ALL = logs;                    // save full list
                applyDoorLogsFilter();                   // render with current filter (if any)
            } catch (err) {
                console.error('Error fetching door logs:', err);
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:red;">Failed to fetch door logs.</td></tr>`;
            }
        }

        // Apply search filter over all columns
        function applyDoorLogsFilter() {
            const q = (document.getElementById('doorLogSearch')?.value || '').trim().toLowerCase();
            const rows = !q ? DOOR_LOGS_ALL : DOOR_LOGS_ALL.filter(l => {
                return [
                    l.Branch, l.DoorNo, l.Name, l.date_key, l.device_id, l.open_time, l.open_time_ist
                ].join(' ').toLowerCase().includes(q);
            });

            const tbody = document.getElementById('doorLogsTableBody');
            if (!rows.length) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:#ccc;">No matches for “${escapeHtml(q)}”.</td></tr>`;
            } else {
                renderDoorLogs(rows);
            }
        }

        function clearDoorLogFilter() {
            const box = document.getElementById('doorLogSearch');
            if (box) box.value = '';
            applyDoorLogsFilter();
        }

        // ------- existing renderer (unchanged) -------
        function renderDoorLogs(list) {
            const tbody = document.getElementById('doorLogsTableBody');
            tbody.innerHTML = list.map(log => `
    <tr>
      <td style="padding:10px;">${log.Branch}</td>
      <td style="padding:10px;">${log.DoorNo}</td>
      <td style="padding:10px;">${log.Name}</td>
      <td style="padding:10px;">${log.date_key}</td>
      <td style="padding:10px;">${log.device_id}</td>

      <td style="padding:10px;">${log.open_time_ist}</td>
    </tr>
  `).join('');
        }

        // --- tiny helpers ---
        function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
        function escapeHtml(s) { return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }

        // OPTIONAL: quick write button for testing permissions
        async function testCreateDoorLog() {
            const today = new Date().toISOString().slice(0, 10);
            await dbAttendance
                .collection('door_access').doc(today)
                .collection('door_access')
                .add({
                    open_time: new Date(), DoorNo: 'D1', device_id: 'raspberrypi',
                    Name: 'Test User', status: 'OPEN', date_key: today
                });
            fetchDoorLogs();
        }

        // expose for existing onclick handlers (since you’re single-file)
        window.loadDoorLogsSection = loadDoorLogsSection;
        window.testCreateDoorLog = testCreateDoorLog;
        // === Roles Module ===
        async function loadRolesSection() {
            const html = `<h2 style="margin-bottom: 20px;">🛡️ Roles Management</h2>
            <div style="margin-bottom: 25px; display: flex; justify-content: flex-end;">
                <button onclick="openAddRoleModal()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                    + Add Role
                </button>
            </div>
            <div id="rolesListContainer" style="display: flex; flex-direction: column; gap: 20px;">
                <p style="color: #ccc; text-align: center;">Loading roles...</p>
            </div>`;
            document.getElementById('mainContent').innerHTML = html;

            const rolesListContainer = document.getElementById('rolesListContainer');
            try {
                const response = await fetch('/api/roles');
                const data = await response.json();
                if (data.status === 'success') {
                    rolesListContainer.innerHTML = ''; // Clear loading message
                    if (data.roles.length === 0) {
                        rolesListContainer.innerHTML = '<p style="color: #ccc; text-align: center;">No roles found.</p>';
                    } else {
                        // List of roles that cannot be deleted
                        const protected_roles = ['Admin', 'CEO', 'CTO', 'CFO', 'Director', 'Manager', 'Employee', 'Accounts', 'Finance', 'Procurement'];
                        data.roles.forEach(role => {
                            const isProtected = protected_roles.includes(role);
                            const deleteButtonHtml = isProtected
                                ? `<span style="color: #6c757d; font-size: 14px;">(Protected)</span>`
                                : `<button onclick="event.stopPropagation(); deleteRole('${role}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;" title="Delete Role">🗑️</button>`;

                            const roleCard = `
                            <div style="background-color: rgba(255, 255, 255, 0.12); padding: 25px 40px; border-radius: 18px; display: flex; align-items: center; gap: 25px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); transition: all 0.25s ease; cursor: pointer; position: relative;" onmouseover="this.style.backgroundColor='rgba(0,123,255,0.3)'; this.style.transform='scale(1.015)';" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.12)'; this.style.transform='scale(1)';">
                                <div style="flex-grow: 1;" onclick="showRolePermissions('${role}')">
                                    <div style="font-size: 20px; font-weight: bold;">${role}</div>
                                    <div style="font-size: 14px; color: #ccc;">Click to manage permissions for this role.</div>
                                </div>
                                ${deleteButtonHtml}
                            </div>`;
                            rolesListContainer.insertAdjacentHTML('beforeend', roleCard);
                        });
                    }
                } else {
                    rolesListContainer.innerHTML = `<p style="color:red; text-align: center;">Error loading roles: ${data.message}</p>`;
                }
            } catch (error) {
                rolesListContainer.innerHTML = `<p style="color:red; text-align: center;">Failed to fetch roles from server.</p>`;
            }
        }

        // Add this new function to the script tag
        function deleteRole(roleName) {
            if (confirm(`Are you sure you want to delete the role "${roleName}"? This action cannot be undone.`)) {
                fetch(`/api/delete_role/${roleName}`, {
                    method: 'DELETE'
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('✅ ' + data.message);
                            loadRolesSection(); // Refresh the role list
                        } else {
                            alert('❌ ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting role:', error);
                        alert('❌ Failed to delete role. Please try again.');
                    });
            }
        }

        function openAddRoleModal() {
            document.getElementById("addRoleModal").style.display = "flex";
            document.getElementById("newRoleName").value = '';
        }

        function closeAddRoleModal() {
            document.getElementById("addRoleModal").style.display = "none";
        }

        async function createRole() {
            const roleName = document.getElementById("newRoleName").value.trim();
            if (!roleName) {
                alert("Role name cannot be empty.");
                return;
            }

            try {
                const response = await fetch('/api/add_role', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role_name: roleName
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert(`Permissions for role "${roleName}" have been saved.`);
                    closeAddRoleModal();
                    loadRolesSection(); // Refresh the roles list
                } else {
                    alert("❌ " + data.message);
                }
            } catch (error) {
                console.error('Error adding role:', error);
                alert("❌ Failed to add role. Please try again.");
            }
        }

        async function showRolePermissions(roleName) {
            let currentPermissions = [];
            try {
                const response = await fetch(`/api/get_role_permissions/${roleName}`);
                const data = await response.json();
                if (data.status === 'success') {
                    currentPermissions = data.permissions;
                }
            } catch (error) {
                console.error('Error fetching role permissions:', error);
                alert('Failed to load role permissions.');
                return;
            }

            const moduleCheckboxesHtml = sidebarModules.map(module => {
                const isChecked = currentPermissions.includes(module) ? 'checked' : '';
                return `
                <label style="display: block; margin-bottom: 12px; font-size: 18px;">
                    <input type="checkbox" value="${module}" ${isChecked} style="margin-right: 10px; transform: scale(1.2); cursor: pointer;">
                    ${module}
                </label>`;
            }).join('');

            const html = `
                <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h2 style="margin-bottom: 25px;">Permissions for: <span style="color: #00d1ff;">${roleName}</span></h2>
                    <p style="color: #ccc; margin-bottom: 30px;">Select the modules this role can access.</p>
                    <div id="moduleCheckboxes" style="background-color: rgba(255, 255, 255, 0.1); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        ${moduleCheckboxesHtml}
                    </div>
                    <div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px;">
                        <button onclick="loadRolesSection()" style="padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; background: #6c757d; color: white;">Cancel</button>
                        <button onclick="saveRolePermissions('${roleName}')" style="padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);">Save</button>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        async function saveRolePermissions(roleName) {
            const selectedModules = Array.from(document.querySelectorAll('#moduleCheckboxes input[type="checkbox"]:checked')).map(cb => cb.value);

            try {
                const response = await fetch('/api/save_role_permissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role_name: roleName,
                        permissions: selectedModules
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert(`Permissions for role "${roleName}" have been saved.`);
                    loadRolesSection(); // Refresh the roles list
                } else {
                    alert("❌ " + data.message);
                }
            } catch (error) {
                console.error('Error saving permissions:', error);
                alert("❌ Failed to save permissions. Please try again.");
            }
        }

    

// dashboard.html

async function getFirstUserWithEmployeeInfo(users) {
    for (const user of users) {
        try {
            const response = await fetch(`/api/get_employee_info/${user.id}`);
            const data = await response.json();
            if (data.status === 'success' && data.employee.full_name) {
                return user; // Return the first user with full info
            }
        } catch (error) {
            console.error(`Error checking user ${user.id} for info:`, error);
        }
    }
    return null; // Return null if no users have info
}


function updateDesignation() {
    const designationSelect = document.getElementById('employeeDesignation');
    
    if (designationSelect) {
        // The select element itself shows the selected value, no need to update display
        // Just trigger save automatically when changed
        saveDesignation();
    }
}


async function saveDesignation() {
    const employeeSelect = document.getElementById('employeeNameSelect');
    const designationSelect = document.getElementById('employeeDesignation');
    
    if (!employeeSelect.value) {
        alert('Please select an employee first.');
        return;
    }
    
    if (!designationSelect.value) {
        alert('Please select a designation.');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('designation', designationSelect.value);
        
        const response = await fetch(`/api/update_employee_designation/${employeeSelect.value}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Success - no need to show alert for every change
            console.log('Designation updated successfully!');
        } else {
            alert('Error updating designation: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving designation:', error);
        alert('Error saving designation. Please try again.');
    }
}

function updateEmployeeInfo(userId) {
        if (!userId) {
            resetSalariesForm();
            return;
        }

        fetch(`/api/get_employee_info/${userId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success' && data.employee) {
                    const emp = data.employee;

                    // Update the top header details
                    document.getElementById('employeeId').textContent = emp.employee_id || `SSDEV-${emp.id.toString().padStart(2, '0')}-002`;
                    document.getElementById('employeeAccount').textContent = emp.account_number || 'N/A';
                    document.getElementById('employeePfNo').textContent = emp.pf_no || 'N/A';
                    document.getElementById('employeePfNoHidden').value = emp.pf_no || '';

                    // Populate designation field
                    const designationSelect = document.getElementById('employeeDesignation');
                    if (designationSelect) {
                        designationSelect.value = emp.designation || '';
                    }

                    // Populate form fields with data
                    document.getElementById('actualGrossSalary').value = (emp.actual_gross_salary || 0).toFixed(2);
                    document.getElementById('basic').value = (emp.basic || 0).toFixed(2);
                    document.getElementById('hra').value = (emp.hra || 0).toFixed(2);
                    document.getElementById('conveyance').value = (emp.conveyance || 0).toFixed(2);
                    document.getElementById('specialAllowance').value = (emp.special_allowance || 0).toFixed(2);

                    // Populate other fields from backend or set to 0.00
                    document.getElementById('vehicleMaintenance').value = (emp.vehicle_maintenance || 0).toFixed(2);
                    document.getElementById('addOthersActuals').value = (emp.add_others || 0).toFixed(2);
                    document.getElementById('providentFund').value = (emp.provident_fund || 0).toFixed(2);
                    document.getElementById('esi').value = (emp.esi || 0).toFixed(2);
                    document.getElementById('professionalTax').value = (emp.professional_tax || 0).toFixed(2);
                    document.getElementById('incomeTax').value = (emp.income_tax || 0).toFixed(2);
                    document.getElementById('advance').value = (emp.advance || 0).toFixed(2);
                    document.getElementById('otherDeductions').value = (emp.other_deductions || 0).toFixed(2);
                    document.getElementById('lossOfPay').value = (emp.loss_of_pay || 0).toFixed(2);
                    document.getElementById('totalLeaves').value = emp.total_leaves || '0';
                    document.getElementById('leaveAvailed').value = emp.leave_availed || '0';
                    document.getElementById('balanceLeaves').value = emp.balance_leaves || '0';
                    document.getElementById('noOfLopDays').value = emp.no_of_lop_days || '0';
                    document.getElementById('totalDays').value = emp.total_days || '30';
                    document.getElementById('ndp').value = emp.ndp || '0';
                    
                    // Populate Earnings section fields (from separate earnings fields)
                    document.getElementById('earningsBasic').value = (emp.earnings_basic || emp.basic || 0).toFixed(2);
                    document.getElementById('earningsHra').value = (emp.earnings_hra || emp.hra || 0).toFixed(2);
                    document.getElementById('earningsConveyance').value = (emp.earnings_conveyance || emp.conveyance || 0).toFixed(2);
                    document.getElementById('earningsVehicleMaintenance').value = (emp.earnings_vehicle_maintenance || emp.vehicle_maintenance || 0).toFixed(2);
                    document.getElementById('earningsSpecialAllowance').value = (emp.earnings_special_allowance || emp.special_allowance || 0).toFixed(2);
                    document.getElementById('addOthersEarnings').value = (emp.earnings_add_others || emp.add_others || 0).toFixed(2);
                    
                    // Call calculateTotals() here to ensure the summary fields are updated.
                    calculateTotals();

                } else {
                    console.error('Failed to load employee details, resetting form.');
                    resetSalariesForm();
                }
            })
            .catch(error => {
                console.error('Error fetching employee data:', error);
                resetSalariesForm();
            });
    }



        // === User Management Module ===
        async function populateRoleCheckboxes(elementId, selectedRoles = []) {
            const roleListDiv = document.getElementById(elementId);
            roleListDiv.innerHTML = '<p style="color:#ccc;">Loading roles...</p>';
            try {
                const response = await fetch('/api/roles');
                const data = await response.json();
                if (data.status === 'success' && data.roles) {
                    roleListDiv.innerHTML = ''; // Clear loading message
                    data.roles.forEach(role => {
                        const isChecked = selectedRoles.includes(role) ? 'checked' : '';
                        const checkboxHtml = `<label style="display: block; color: #eee; margin-bottom: 5px;"><input type="checkbox" value="${role}" ${isChecked} style="margin-right:5px;">${role}</label>`;
                        roleListDiv.insertAdjacentHTML('beforeend', checkboxHtml);
                    });
                } else {
                    roleListDiv.innerHTML = '<p style="color:red;">Failed to load roles.</p>';
                }
            } catch (error) {
                console.error('Error fetching roles:', error);
                roleListDiv.innerHTML = '<p style="color:red;">Failed to fetch roles from server.</p>';
            }
        }

        function openAddUserModal() {
            document.getElementById("addUserModal").style.display = "flex";
            populateRoleCheckboxes('roleList');
        }

        function closeAddUserModal() {
            document.getElementById("addUserModal").style.display = "none";
        }

        function generatePassword() {
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let password = "";
            for (let i = 0; i < 10; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById("userPass").value = password;
        }

        function submitUserForm() {
            const fullName = document.getElementById("fullName").value;
            const username = document.getElementById("username").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("userPass").value;
            const confirmPass = document.getElementById("confirmPass").value;
            const checkboxes = document.querySelectorAll("#roleList input[type=checkbox]:checked");
            const selectedRoles = Array.from(checkboxes).map(cb => cb.value);
            if (!fullName || !username || !email || selectedRoles.length === 0 || !password || !confirmPass) {
                alert("Please fill all fields.");
                return;
            }
            if (password !== confirmPass) {
                alert("Passwords do not match.");
                return;
            }
            fetch('/api/add_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    full_name: fullName,
                    username,
                    email,
                    roles: selectedRoles,
                    password
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        closeAddUserModal();
                        loadSubSection('Active Users');
                    } else {
                        alert("❌ " + data.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("❌ Failed to add user.");
                });
        }

        function deleteUser(email) {
            if (!confirm(`Are you sure you want to delete ${email}?`)) return;
            fetch('/api/delete_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') loadSubSection('Active Users');
                    else alert("❌ " + data.message);
                });
        }
       

        // Inside dashboard.html, within the <script> tags
async function manageUser(email) {
    try {
        const response = await fetch('/api/get_user?email=' + encodeURIComponent(email));
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server responded with an error:', response.status, errorText);
            throw new Error('Server responded with an error: ' + response.status);
        }

        const data = await response.json();

        if (data.status === 'success' && data.user) {
            document.getElementById('editUsername').value = data.user.username;
            document.getElementById('editEmail').value = data.user.email;
            document.getElementById('editPassword').value = '';
            currentUserEmail = data.user.email;
            await populateRoleCheckboxes('editRoleList', data.user.roles);
            document.getElementById('manageUserModal').style.display = 'flex';
        } else {
            console.error('API call was successful, but returned unexpected data:', data);
            alert("❌ Could not load user details. API response was malformed.");
        }
    } catch (error) {
        console.error('Error managing user:', error);
        // This will now show a more detailed message if the fetch failed
        alert("❌ An error occurred while fetching user details. See console for details.");
    }
}
        function closeManageUserModal() {
            document.getElementById("manageUserModal").style.display = "none";
            currentUserEmail = "";
        }

        function submitUserUpdate() {
            const updatedUsername = document.getElementById("editUsername").value.trim();
            const updatedEmail = document.getElementById("editEmail").value.trim();
            const newPassword = document.getElementById("editPassword").value.trim();
            const roleCheckboxes = document.querySelectorAll("#editRoleList input[type=checkbox]:checked");
            const selectedRoles = Array.from(roleCheckboxes).map(cb => cb.value);
            if (!updatedUsername || !updatedEmail) {
                alert("Please fill in username and email.");
                return;
            }
            fetch('/api/update_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    old_email: currentUserEmail,
                    new_username: updatedUsername,
                    new_email: updatedEmail,
                    new_password: newPassword || null,
                    roles: selectedRoles
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert("✅ User updated successfully!");
                        closeManageUserModal();
                        loadSubSection('Active Users');
                    } else {
                        alert("❌ " + data.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("❌ Failed to update user.");
                });
        }

        // === Teams & Groups Module ===

        // NEW: Global array to keep track of running timers to prevent memory leaks


        // NEW: Function to clear all previously running timers before redrawing the view
        function clearAllTimers() {
            activeTimers.forEach(timer => clearInterval(timer));
            activeTimers = [];
        }

        // NEW: The core function to calculate and display the countdown
        function startCountdown(endDateString, elementId) {
            const countDownDate = new Date(endDateString).getTime();
            const element = document.getElementById(elementId);

            // Ensure the element exists and the date is valid before starting
            if (!element || isNaN(countDownDate)) {
                if (element) {
                    element.innerHTML = '<span style="font-size: 12px; color: #aaa;">No deadline set</span>';
                }
                return;
            }

            const interval = setInterval(function () {
                const now = new Date().getTime();
                const distance = countDownDate - now;

                // If the deadline has passed
                if (distance < 0) {
                    clearInterval(interval);
                    element.innerHTML = '<span style="font-size: 14px; color: #dc3545;">Deadline Passed</span>';
                    return;
                }

                // Time calculations
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                // Format numbers to have a leading zero if they are less than 10
                const d = String(days).padStart(2, '0');
                const h = String(hours).padStart(2, '0');
                const m = String(minutes).padStart(2, '0');
                const s = String(seconds).padStart(2, '0');

                // Update the HTML of the timer element
                element.innerHTML = `
            <span class="time-segment">${d}<small>Days</small></span>
            <span class="time-colon">:</span>
            <span class="time-segment">${h}<small>Hrs</small></span>
            <span class="time-colon">:</span>
            <span class="time-segment">${m}<small>Min</small></span>
            <span class="time-colon">:</span>
            <span class="time-segment">${s}<small>Sec</small></span>
        `;
            }, 1000);

            activeTimers.push(interval);
        }

        function loadTeamsGroupsSection() {
            const html = `
    <div style="padding: 20px;">
        <h2 style="color: #00d1ff; margin-bottom: 30px;">🤝 Teams & Groups</h2>
        <div id="mainProjectsView">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h3 style="color: #00d1ff; margin: 0;">📋 All Projects</h3>
                <button onclick="showAddProjectForm()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">➕ Add New Team</button>
            </div>
            <div id="projectsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                <p style="color: #ccc; text-align: center;">Loading projects...</p>
            </div>
        </div>
        <div id="addProjectForm" style="display: none;">
            <h3 style="color: #00d1ff; margin-bottom: 20px;">Create New Team</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00d1ff; font-weight: bold;">Team Name *</label>
                <input type="text" id="projectName" placeholder="Enter Team Name" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00d1ff; font-weight: bold;">Set End Date and Time</label>
                <input type="datetime-local" id="projectDeadline" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white; color-scheme: dark;">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="createProject()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">Create Project</button>
                <button onclick="hideAddProjectForm()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 12px 24px; border-radius: 6px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>`;
            document.getElementById('mainContent').innerHTML = html;
            showMainProjectsView();
        }

        function showMainProjectsView() {
            document.getElementById('mainProjectsView').style.display = 'block';
            document.getElementById('addProjectForm').style.display = 'none';
            loadProjects();
        }

        function showAddProjectForm() {
            document.getElementById('mainProjectsView').style.display = 'none';
            document.getElementById('addProjectForm').style.display = 'block';
        }

        function hideAddProjectForm() {
            document.getElementById('mainProjectsView').style.display = 'block';
            document.getElementById('addProjectForm').style.display = 'none';
            document.getElementById('projectName').value = '';
            document.getElementById('projectDeadline').value = '';
        }

        async function loadProjects() {
            const projectsGrid = document.getElementById('projectsGrid');
            if (!projectsGrid) return;

            clearAllTimers();

            projectsGrid.innerHTML = '<p style="text-align:center; color: #ccc;">Loading projects...</p>';
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                if (data.status === 'success') {
                    projectsGrid.innerHTML = '';
                    if (data.projects.length === 0) {
                        projectsGrid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 40px;"><p style="color: #ccc; margin-bottom: 20px;">No projects found. Create your first project!</p><button onclick="showAddProjectForm()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">➕ Create Your First Project</button></div>`;
                        return;
                    }
                    data.projects.forEach(project => {
                        const projectCard = `
                <div class="project-card">
                    <div onclick="loadProjectGroups(${project.id}, '${project.project_name.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                             <h3 style="color: #00d1ff; font-size: 22px; margin: 0;">${project.project_name}</h3>
                             <span style="color: #ffa500; font-size: 14px; font-weight: bold;">${project.deadline ? formatDeadline(project.deadline) : 'No deadline'}</span>
                         </div>
                         
                         <div class="countdown-container" style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px;">
                             <div class="countdown-timer" id="timer-${project.id}">
                             </div>
                         </div>
                         
                         <p style="color: #ccc; font-size: 14px;">Click to manage groups</p>
                    </div>
                    <div style="position: absolute; bottom: 15px; right: 15px;">
                        <button onclick="event.stopPropagation(); deleteProject(${project.id}, '${project.project_name.replace(/'/g, "\\'")}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s ease;" title="Delete Project">🗑️</button>
                    </div>
                </div>`;
                        projectsGrid.insertAdjacentHTML("beforeend", projectCard);

                        if (project.deadline && project.deadline !== 'Not specified') {
                            startCountdown(project.deadline, `timer-${project.id}`);
                        } else {
                            const timerElement = document.getElementById(`timer-${project.id}`);
                            if (timerElement) {
                                timerElement.innerHTML = '<span style="font-size: 12px; color: #aaa;">No deadline set</span>';
                            }
                        }
                    });
                } else {
                    projectsGrid.innerHTML = `<p style="text-align:center; color:red;">Error loading projects: ${data.message}</p>`;
                }
            } catch (error) {
                console.error('Error fetching projects:', error);
                projectsGrid.innerHTML = '<p style="text-align:center; color:red;">Failed to connect to project service.</p>';
            }
        }

        async function createProject() {
            const projectName = document.getElementById('projectName').value.trim();
            const projectDeadline = document.getElementById('projectDeadline').value;

            if (!projectName) {
                alert('Please enter a Team Name');
                return;
            }
            try {
                const response = await fetch('/api/add_project', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_name: projectName,
                        budget_head: 'Not specified',
                        start_date: 'Not specified',
                        end_date: projectDeadline || 'Not specified',
                        deadline: projectDeadline || null  // Save to the new deadline field
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    hideAddProjectForm();
                    loadProjects();
                    alert('Project created successfully!');
                } else {
                    alert('Error creating project: ' + data.message);
                }
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Failed to create project. Please try again.');
            }
        }

        async function deleteProject(projectId, projectName) {
            if (!confirm(`Are you sure you want to delete the project "${projectName}"? This action cannot be undone.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/delete_project/${projectId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.status === 'success') {
                    loadProjects();
                    alert('Project deleted successfully!');
                } else {
                    alert('Error deleting project: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project. Please try again.');
            }
        }

        // === NEW FUNCTIONS FOR GROUP MANAGEMENT ===

        // Function to format deadline date for display
        function formatDeadline(deadline) {
            if (!deadline) return 'No deadline';

            try {
                const date = new Date(deadline);
                if (isNaN(date.getTime())) return 'Invalid date';

                const now = new Date();
                const diffTime = date.getTime() - now.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    return `Overdue (${Math.abs(diffDays)} days)`;
                } else if (diffDays === 0) {
                    return 'Due today';
                } else if (diffDays === 1) {
                    return 'Due tomorrow';
                } else if (diffDays <= 7) {
                    return `Due in ${diffDays} days`;
                } else {
                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });
                }
            } catch (error) {
                return 'Invalid date';
            }
        }

        async function loadProjectGroups(projectId, projectName) {
            const mainContent = document.getElementById('mainContent');
            // Clear old timers when navigating to the teams view
            clearAllTimers();
            mainContent.innerHTML = `
    <div style="padding: 20px;">
        <h2 style="color: #00d1ff; margin-bottom: 30px;">🤝 Project Teams for "${projectName}"</h2>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <button onclick="loadTeamsGroupsSection()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer;">← Back to All Projects</button>
            <button onclick="showAddGroupForm(${projectId}, '${projectName}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">➕ Add New Team</button>
        </div>
        <div id="groupsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
            <p style="color: #ccc; text-align: center;">Loading teams...</p>
        </div>
    </div>
    `;
            try {
                const response = await fetch(`/api/groups/${projectId}`);
                const data = await response.json();
                const groupsGrid = document.getElementById('groupsGrid');
                if (data.status === 'success') {
                    groupsGrid.innerHTML = '';
                    if (data.groups.length === 0) {
                        groupsGrid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 40px;"><p style="color: #ccc;">No teams found for this project. Add the first one!</p></div>`;
                    }
                    data.groups.forEach(group => {
                        // Team card now includes a deadline countdown timer
                        const groupCard = `
                <div class="project-card" style="position:relative;">
                    <div class="countdown-container">
                        <div class="countdown-timer" id="group-timer-${group.id}">
                           </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="color: #00d1ff; font-size: 20px; margin: 0;">${group.name}</h3>
                        <span style="color: #ffa500; font-size: 14px; font-weight: bold;">${group.deadline ? formatDeadline(group.deadline) : 'No deadline'}</span>
                    </div>
                    <p style="color: #ccc; font-size: 14px;"><strong>Team Type:</strong> ${group.group_type}</p>
                    <p style="color: #ccc; font-size: 14px;"><strong>Description:</strong> ${group.description || 'N/A'}</p>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <p style="color: #ccc; font-size: 14px;"><strong>Team Members:</strong> ${group.members.length > 0 ? group.members.join(', ') : 'No members assigned'}</p>
                    </div>

                    <div style="position: absolute; bottom: 15px; right: 15px;">
                        <button onclick="event.stopPropagation(); deleteGroup(${group.id}, '${group.name.replace(/'/g, "\\'")}', ${projectId}, '${projectName.replace(/'/g, "\\'")}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s ease;" title="Delete Team">🗑️</button>
                    </div>
                </div>
                `;
                        groupsGrid.insertAdjacentHTML("beforeend", groupCard);

                        // Start the countdown timer for the team if it has a deadline
                        if (group.deadline) {
                            startCountdown(group.deadline, `group-timer-${group.id}`);
                        } else {
                            const timerElement = document.getElementById(`group-timer-${group.id}`);
                            if (timerElement) {
                                timerElement.innerHTML = '<span style="font-size: 12px; color: #aaa;">No deadline set</span>';
                            }
                        }
                    });
                } else {
                    groupsGrid.innerHTML = `<p style="text-align:center; color:red;">Error loading teams: ${data.message}</p>`;
                }
            } catch (error) {
                console.error('Error fetching teams:', error);
                groupsGrid.innerHTML = '<p style="text-align:center; color:red;">Failed to load teams.</p>';
            }
        }

        function showAddGroupForm(projectId, projectName) {
            const mainContent = document.getElementById('mainContent');
            // MODIFIED: Added a deadline input field to the 'Add Team' form
            mainContent.innerHTML = `
    <div style="padding: 20px;">
        <h2 style="color: #00d1ff; margin-bottom: 30px;">➕ Add New Team for "${projectName}"</h2>
        <div style="max-width: 600px; margin: 0 auto; background: rgba(255,255,255,0.08); padding: 30px; border-radius: 12px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00d1ff; font-weight: bold;">Team Name *</label>
                <input type="text" id="groupName" placeholder="Enter team name" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00d1ff; font-weight: bold;">Team Type</label>
                <input type="text" id="groupType" placeholder="e.g., development, design" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00d1ff; font-weight: bold;">Description</label>
                <textarea id="groupDescription" placeholder="Add a short description" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white; height: 100px;"></textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00d1ff; font-weight: bold;">Set End Date and Time</label>
                <input type="datetime-local" id="groupDeadline" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.1); color: white; color-scheme: dark;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00d1ff; font-weight: bold;">Select Team Members</label>
                <div id="groupMembersList" class="member-select-container">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="createGroup(${projectId}, '${projectName}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">Add Team</button>
                <button onclick="loadProjectGroups(${projectId}, '${projectName}')" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 12px 24px; border-radius: 6px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>
    `;
            loadUsersForGroup();
        }

        async function loadUsersForGroup() {
            const membersListDiv = document.getElementById('groupMembersList');
            membersListDiv.innerHTML = '<p style="color:#ccc;">Loading team members...</p>';
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                if (data.status === 'success' && data.users) {
                    membersListDiv.innerHTML = '';
                    data.users.forEach(user => {
                        membersListDiv.insertAdjacentHTML('beforeend', `
                <label style="display: block; margin-bottom: 5px;">
                    <input type="checkbox" value="${user.id}" style="margin-right: 8px;">
                    ${user.name} (${user.email})
                </label>
            `);
                    });
                } else {
                    membersListDiv.innerHTML = '<p style="color:red;">Failed to load team members.</p>';
                }
            } catch (error) {
                membersListDiv.innerHTML = '<p style="color:red;">Failed to load team members.</p>';
            }
        }

        async function createGroup(projectId, projectName) {
            const groupName = document.getElementById('groupName').value.trim();
            const groupType = document.getElementById('groupType').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();
            const memberCheckboxes = document.querySelectorAll('#groupMembersList input[type="checkbox"]:checked');
            const memberIds = Array.from(memberCheckboxes).map(cb => cb.value);

            // Get the deadline value from the new input field
            const groupDeadline = document.getElementById('groupDeadline').value;

            if (!groupName) {
                alert('Please enter a team name.');
                return;
            }

            try {
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // Send the deadline to the backend
                    body: JSON.stringify({
                        name: groupName,
                        group_type: groupType,
                        description: groupDescription,
                        project_id: projectId,
                        member_ids: memberIds,
                        deadline: groupDeadline || null // Send null if no date is picked
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Team added successfully!');
                    loadProjectGroups(projectId, projectName);
                } else {
                    alert('Error adding team: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding team:', error);
                alert('Failed to add team. Please try again.');
            }
        }

        async function deleteGroup(groupId, groupName, projectId, projectName) {
            if (!confirm(`Are you sure you want to delete the team "${groupName}"? This action cannot be undone.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Team deleted successfully!');
                    loadProjectGroups(projectId, projectName);
                } else {
                    alert('Error deleting team: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting team:', error);
                alert('Failed to delete team. Please try again.');
            }
        }
        // === Attendance Module ===
        // === Settings Module ===
        function loadSettingsPage(title) {
            if (title === 'main') {
                const html = `
            <h2 style="margin-bottom: 20px;">⚙️ Settings</h2>
            <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 30px;">
                ${settingsPageLink('Appearance')}
                ${settingsPageLink('Profile Settings')}
                <div onclick="resetAllSettings()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,0,0,0.2); padding: 16px 22px; border-radius: 8px; margin-top: 14px; border: 1px solid rgba(255,0,0,0.3);">
                    <span style="color: #ff6b6b; font-size: 17px;">Undo All Settings</span>
                    <span style="color: #ff6b6b; font-size: 18px;">↻</span>
                </div>
            </div>`;
                document.getElementById('mainContent').innerHTML = html;
            } else if (title === 'Appearance') {
                const appearanceHtml = `
            <div class="salaries-container" style="max-width: 600px; padding: 20px;">
                <h2 style="margin-bottom: 20px;">🎨 Appearance Settings</h2>
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 16px;">
                    <span onclick="loadSection('Settings')" style="font-size: 26px; color: #fff; cursor: pointer; padding: 6px 12px;position:relative;right:0px;">✖️</span>
                </div>
                <div style="max-width: 950px;">
                    ${appearanceCard('Mode', `<select class="appearance-select" id="modeSelector" onchange="applyMode()"><option value="light">Light</option><option value="dark">Dark</option></select>`)}
                    ${appearanceCard('Side Panel Position', `<select class="appearance-select" id="sidePanelSelector" onchange="applySidePanelPosition()"><option value="left">Show on left</option><option value="right">Show on right</option></select>`)}
                    ${appearanceCard('Font Size', `<select class="appearance-select" id="fontSizeSelector" onchange="applyFontSize()"><option value="small">Small</option><option value="medium" selected>Medium</option><option value="large">Large</option></select>`)}
                    
                    <div class="appearance-card" id="customize-fonts-card">
                        <div class="appearance-label" style="cursor: pointer;">
                            <span>Customize Fonts</span>
                            <span id="customize-fonts-arrow" style="font-size: 18px; line-height: 1;">▶</span>
                        </div>
                        <div id="customize-fonts-content" class="appearance-content">
                            <ul id="font-list">
                                </ul>
                        </div>
                    </div>
                    
                    <div class="appearance-card" id="background-card">
                        <div class="appearance-label" style="cursor: pointer;">
                            <span>Background</span>
                            <span id="background-arrow" style="font-size: 18px; line-height: 1;">▶</span>
                        </div>
                        <div id="background-content" class="appearance-content">
                            <ul id="background-video-list">
                                </ul>
                        </div>
                    </div>
                    </div>
            </div>`;
                document.getElementById('mainContent').innerHTML = appearanceHtml;

                // Font Customization Logic (from previous task)
                const customizeFontsCard = document.getElementById('customize-fonts-card');
                const customizeFontsContent = document.getElementById('customize-fonts-content');
                const fontList = document.getElementById('font-list');
                const customizeFontsArrow = document.getElementById('customize-fonts-arrow');

                const availableFonts = [
                    'Arial, sans-serif',
                    'Verdana, sans-serif',
                    'Helvetica, sans-serif',
                    'Times New Roman, serif',
                    'Courier New, monospace',
                    'Georgia, serif',
                    'Palatino, serif',
                    'Garamond, serif',
                    'Trebuchet MS, sans-serif',
                    'Impact, sans-serif'
                ];

                if (customizeFontsCard && customizeFontsContent && fontList) {
                    customizeFontsCard.addEventListener('click', function () {
                        const isOpen = customizeFontsContent.style.display === 'block';
                        customizeFontsContent.style.display = isOpen ? 'none' : 'block';
                        customizeFontsArrow.textContent = isOpen ? '▶' : '▼';

                        if (!isOpen) {
                            fontList.innerHTML = '';
                            availableFonts.forEach(fontName => {
                                const listItem = document.createElement('li');
                                const displayName = fontName.split(',')[0].replace(/"/g, '');
                                listItem.textContent = displayName;
                                listItem.style.fontFamily = fontName;
                                fontList.appendChild(listItem);
                            });
                        }
                    });

                    fontList.addEventListener('click', function (event) {
                        if (event.target.tagName === 'LI') {
                            const selectedFont = event.target.style.fontFamily;
                            document.body.style.fontFamily = selectedFont;
                            localStorage.setItem('erpFont', selectedFont);
                            customizeFontsContent.style.display = 'none';
                            customizeFontsArrow.textContent = '▶';
                        }
                    });
                }

                // NEW: Background Video Customization Logic
                const backgroundCard = document.getElementById('background-card');
                const backgroundContent = document.getElementById('background-content');
                const backgroundVideoList = document.getElementById('background-video-list');
                const backgroundArrow = document.getElementById('background-arrow');

                const videoFiles = ['admindb.mp4', 'bg1.mp4', 'bg2.mp4', 'bg3.mp4', 'bg4.mp4', 'bg5.mp4', 'bg6.mp4', 'bg7.mp4', 'bg8.mp4', 'bg9.mp4', 'bg10.mp4', 'bg11.mp4'];

                if (backgroundCard && backgroundContent && backgroundVideoList) {
                    backgroundCard.addEventListener('click', function () {
                        const isOpen = backgroundContent.style.display === 'block';
                        backgroundContent.style.display = isOpen ? 'none' : 'block';
                        backgroundArrow.textContent = isOpen ? '▶' : '▼';

                        if (!isOpen) {
                            backgroundVideoList.innerHTML = '';
                            videoFiles.forEach(videoFile => {
                                // Exclude the 'admindb.mp4' which is the default welcome video
                                if (videoFile !== 'admindb.mp4') {
                                    const videoId = videoFile.split('.')[0];
                                    const listItem = document.createElement('li');
                                    listItem.textContent = `Background ${videoId.replace('bg', '')}`;
                                    listItem.dataset.videoSrc = `/static/videos/${videoFile}`;
                                    backgroundVideoList.appendChild(listItem);
                                }
                            });
                        }
                    });

                    backgroundVideoList.addEventListener('click', function (event) {
                        if (event.target.tagName === 'LI') {
                            const selectedVideoSrc = event.target.dataset.videoSrc;
                            applyBackgroundVideo(selectedVideoSrc);
                            // Save the user's choice to local storage
                            localStorage.setItem('erpBackgroundVideo', selectedVideoSrc);

                            backgroundContent.style.display = 'none';
                            backgroundArrow.textContent = '▶';
                        }
                    });
                }
            } else if (title === 'Profile Settings') {
                const profileSettingsHtml = `
            <div class="salaries-container" style="max-width: 600px; padding: 20px;">
                <h2 style="margin-bottom: 20px;">👤 Profile Settings</h2>
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 16px;">
                    <span onclick="loadSection('Settings')" style="font-size: 26px; color: #fff; cursor: pointer; padding: 6px 12px;position:relative;right:0px;">✖️</span>
                </div>
                <div class="appearance-card" id="profile-card" onclick="toggleDropdown('profile-content')">
                    <div class="appearance-label">
                        <span>Account Actions</span>
                        <span class="toggle-icon">▶</span>
                    </div>
                    <div id="profile-content" class="settings-dropdown">
                        <div onclick="openChangePasswordModal()">Change Password</div>
                    </div>
                </div>
            </div>`;
                document.getElementById('mainContent').innerHTML = profileSettingsHtml;
            }
        }

        function settingsPageLink(title) {
            return `<div onclick="loadSettingsPage('${title}')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.08); padding: 16px 22px; border-radius: 8px; margin-top: 14px;"><span style="color: white; font-size: 17px;">${title}</span><span style="color: white; font-size: 18px;">▶</span></div>`;
        }

        function appearanceCard(title, html) {
            const id = title.replace(/\s+/g, '-').toLowerCase();
            return `<div class="appearance-card"><div class="appearance-label" onclick="toggleAppearance('${id}')">${title} <span id="${id}-arrow">▶</span></div><div class="appearance-content" id="${id}-content" onclick="event.stopPropagation();">${html}</div></div>`;
        }

        function toggleAppearance(id) {
            const content = document.getElementById(`${id}-content`);
            const arrow = document.getElementById(`${id}-arrow`);
            const open = content.style.display === 'block';
            content.style.display = open ? 'none' : 'block';
            arrow.textContent = open ? '▶' : '▼';
        }

        function applyMode() {
            const mode = document.getElementById('modeSelector').value;
            localStorage.setItem('selectedMode', mode);
            const body = document.getElementById('body');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const welcomeBlock = document.getElementById('welcomeBlock');
            const bgVideo = document.getElementById('bgVideo');
            if (mode === 'light') {
                bgVideo.style.display = 'none';
                body.style.backgroundColor = '#ffffff';
                sidebar.style.backgroundColor = '#f0f0f0';
                sidebar.style.color = '#000000';
                if (mainContent) mainContent.style.backgroundColor = '#ffffff';
                if (mainContent) mainContent.style.color = '#000000';
                if (welcomeBlock) welcomeBlock.style.backgroundColor = '#ffffff';
                document.querySelectorAll('select, input, textarea, button').forEach(el => {
                    el.style.backgroundColor = '#ffffff';
                    el.style.color = '#000000';
                    el.style.border = '1px solid #ccc';
                });
                document.querySelectorAll('h1, h2, h3, p, span, label').forEach(el => {
                    el.style.color = '#000000';
                });
            } else {
                bgVideo.style.display = 'block';
                body.style.backgroundColor = '#000000';
                sidebar.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                sidebar.style.color = '#ffffff';
                if (mainContent) mainContent.style.backgroundColor = 'rgba(0,0,0,0.6)';
                if (mainContent) mainContent.style.color = '#ffffff';
                if (welcomeBlock) welcomeBlock.style.backgroundColor = 'rgba(0,0,0,0.6)';
                document.querySelectorAll('select, input, textarea').forEach(el => {
                    el.style.backgroundColor = '#111';
                    el.style.color = '#ffffff';
                    el.style.border = '1px solid #555';
                });
                document.querySelectorAll('.btn').forEach(el => {
                    el.style.backgroundColor = 'rgba(255, 50, 50, 0.85)';
                    el.style.color = '#ffffff';
                    el.style.border = 'none';
                });
                document.querySelectorAll('h1, h2, h3, p, span, label').forEach(el => {
                    el.style.color = '#ffffff';
                });
                // Re-apply specific colors for accents
                document.querySelectorAll('.salaries-total-field, h3, .product-card-item h3, .product-card-item ul li::before, .project-card h3').forEach(el => {
                    el.style.color = '#00d1ff';
                });
            }
        }

        function applySidePanelPosition() {
            const position = document.getElementById('sidePanelSelector').value;
            localStorage.setItem('sidePanelPosition', position);
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            if (position === 'right') {
                sidebar.style.left = 'auto';
                sidebar.style.right = '0';
                mainContent.style.marginLeft = '0';
                mainContent.style.paddingLeft = '40px';
                mainContent.style.paddingRight = '260px';
                
                // Enable sidebar toggle functionality for right position
                localStorage.setItem('sidebarToggleEnabled', 'true');
            } else {
                sidebar.style.left = '0';
                sidebar.style.right = 'auto';
                mainContent.style.marginLeft = '0';
                mainContent.style.paddingLeft = '260px';
                mainContent.style.paddingRight = '40px';
                
                // Disable sidebar toggle functionality for left position
                localStorage.setItem('sidebarToggleEnabled', 'false');
            }
        }

        function applyFontSize() {
            const size = document.getElementById('fontSizeSelector').value;
            localStorage.setItem('fontSize', size);
            let fontSizeValue;
            switch (size) {
                case 'small':
                    fontSizeValue = '13px';
                    break;
                case 'medium':
                    fontSizeValue = '15px';
                    break;
                case 'large':
                    fontSizeValue = '17px';
                    break;
            }
            document.body.style.fontSize = fontSizeValue;
            document.querySelectorAll('.card, .sidebar, .card h2, .card label, .appearance-select').forEach(el => {
                el.style.fontSize = fontSizeValue;
            });
        }
        function applyBackgroundVideo(videoSrc) {
            const bgVideo = document.getElementById('bgVideo');
            if (bgVideo) {
                // Update the video source and force it to reload
                bgVideo.src = videoSrc;
                bgVideo.load();
                bgVideo.play().catch(e => console.log('Video play failed:', e));
            }
        }

        // Function to load saved settings on page load
        function loadSavedSettings() {
            // Load sidebar position
            const savedPosition = localStorage.getItem('sidePanelPosition');
            if (savedPosition) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.getElementById('mainContent');
                if (savedPosition === 'right') {
                    sidebar.style.left = 'auto';
                    sidebar.style.right = '0';
                    sidebar.style.borderRight = 'none';
                    sidebar.style.borderLeft = '1px solid var(--lightest-bg)';
                    
                    // Enable sidebar toggle functionality for right position
                    localStorage.setItem('sidebarToggleEnabled', 'true');
                } else {
                    sidebar.style.left = '0';
                    sidebar.style.right = 'auto';
                    sidebar.style.borderLeft = 'none';
                    sidebar.style.borderRight = '1px solid var(--lightest-bg)';
                    
                    // Disable sidebar toggle functionality for left position
                    localStorage.setItem('sidebarToggleEnabled', 'false');
                }
            }
            
            // Load font size
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize) {
                let fontSizeValue;
                switch (savedFontSize) {
                    case 'small':
                        fontSizeValue = '13px';
                        break;
                    case 'medium':
                        fontSizeValue = '15px';
                        break;
                    case 'large':
                        fontSizeValue = '17px';
                        break;
                    default:
                        fontSizeValue = '15px';
                        break;
                }
                document.body.style.fontSize = fontSizeValue;
                document.querySelectorAll('.card, .sidebar, .card h2, .card label, .appearance-select').forEach(el => {
                    el.style.fontSize = fontSizeValue;
                });
            }
            
            // Load background video
            const savedBackgroundVideo = localStorage.getItem('erpBackgroundVideo');
            if (savedBackgroundVideo) {
                const bgVideo = document.getElementById('bgVideo');
                if (bgVideo) {
                    bgVideo.src = savedBackgroundVideo;
                    bgVideo.load();
                    bgVideo.play().catch(e => console.log('Video play failed:', e));
                }
            }
            
            // Load font family
            const savedFont = localStorage.getItem('erpFont');
            if (savedFont) {
                document.body.style.fontFamily = savedFont;
            }
        }

        // Function to reset all settings to default
        function resetAllSettings() {
            if (confirm('Are you sure you want to reset all settings to default? This action cannot be undone.')) {
                // Clear all localStorage settings
                localStorage.removeItem('selectedMode');
                localStorage.removeItem('sidePanelPosition');
                localStorage.removeItem('sidebarToggleEnabled');
                localStorage.removeItem('fontSize');
                localStorage.removeItem('erpFont');
                localStorage.removeItem('erpBackgroundVideo');
                
                // Reset to default values
                const sidebar = document.querySelector('.sidebar');
                // Reset sidebar position to left
                sidebar.style.left = '0';
                sidebar.style.right = 'auto';
                sidebar.style.borderLeft = 'none';
                sidebar.style.borderRight = '1px solid var(--lightest-bg)';
                
                // Reset font size
                document.body.style.fontSize = '15px';
                document.querySelectorAll('.card, .sidebar, .card h2, .card label, .appearance-select').forEach(el => {
                    el.style.fontSize = '15px';
                });
                
                // Reset background video
                const bgVideo = document.getElementById('bgVideo');
                if (bgVideo) {
                    bgVideo.src = '/static/videos/admindb.mp4';
                    bgVideo.load();
                    bgVideo.play().catch(e => console.log('Video play failed:', e));
                }
                
                alert('All settings have been reset to default values!');
                
                // Reload the page to ensure all changes take effect
                window.location.reload();
            }
        }
        function openChangePasswordModal() {
            document.getElementById("changePasswordModal").style.display = "flex";
            document.getElementById("messageBox").style.display = "none";
            document.getElementById("currentPassword").value = '';
            document.getElementById("newPassword").value = '';
            document.getElementById("confirmNewPassword").value = '';
        }

        function closeChangePasswordModal() {
            document.getElementById("changePasswordModal").style.display = "none";
        }

        function showMessageBox(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            if (type === 'error') {
                messageBox.style.color = '#ff3d00';
            } else if (type === 'success') {
                messageBox.style.color = '#00ff7f';
            } else {
                messageBox.style.color = '#ffeb3b';
            }
        }

        async function submitPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showMessageBox("All fields are required.", 'error');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showMessageBox("New passwords do not match.", 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessageBox("New password must be at least 6 characters long.", 'error');
                return;
            }

            try {
                const response = await fetch('/api/change_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    showMessageBox(data.message, 'success');
                    // Close the modal after a short delay for the user to read the message
                    setTimeout(closeChangePasswordModal, 2000);
                } else {
                    showMessageBox(data.message, 'error');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showMessageBox("Failed to change password. Please try again.", 'error');
            }
        }

        function initFontPicker() {
            // Expanded list of fonts to choose from.
            const fontList = ['Roboto', 'Open Sans', 'Lato', 'Montserrat', 'Oswald', 'Poppins', 'Merriweather', 'Playfair Display', 'Noto Sans', 'Ubuntu', 'Source Code Pro', 'Pacifico', 'Inconsolata', 'Raleway', 'Fira Sans', 'Cormorant Garamond', 'Bebas Neue', 'Lobster', 'Dancing Script'];

            // Target the correct container for the font selector
            const fontPickerContainer = $('#font-picker-container');
            fontPickerContainer.empty(); // Clear any existing content

            // Initialize the FontSelect plugin on a new select element
            const fontSelectElement = $('<select id="font-picker-select"></select>');
            fontPickerContainer.append(fontSelectElement);

            $(fontSelectElement).fontselect({
                style: 'dropdown',
                placeholder: 'Select a font',
                placeholderSize: '16px',
                placeholderColor: '#fff',
                fonts: fontList
            }).change(function () {
                const selectedFont = $(this).val().replace(/\+/g, ' ');

                // Dynamically load the Google Font stylesheet link if not already loaded
                let googleFontLink = document.getElementById('google-font-link');
                if (!googleFontLink) {
                    googleFontLink = document.createElement('link');
                    googleFontLink.id = 'google-font-link';
                    googleFontLink.rel = 'stylesheet';
                    document.head.appendChild(googleFontLink);
                }
                googleFontLink.href = `https://fonts.googleapis.com/css?family=${selectedFont.replace(/ /g, '+')}`;

                // Apply the selected font to the entire body
                document.body.style.fontFamily = `'${selectedFont}', sans-serif`;

                // Save the user's choice to local storage
                localStorage.setItem('erpFont', selectedFont);
            });

            // Set the saved font if it exists in local storage
            const savedFont = localStorage.getItem('erpFont');
            if (savedFont) {
                $(fontSelectElement).val(savedFont.replace(/ /g, '+')).change();
            }
        }

        // === Navigation from Project Page ===
        function navigateToSection(section) {
            localStorage.removeItem('goToTeamsGroups');
            localStorage.removeItem('goToUsers');
            localStorage.removeItem('goToRoles');
            localStorage.removeItem('goToBilling');
            localStorage.removeItem('goToSupport');
            localStorage.removeItem('goToReports');
            localStorage.removeItem('goToSettings');

            switch (section) {
                case 'teams-groups':
                    localStorage.setItem('goToTeamsGroups', '1');
                    break;
                case 'users':
                    localStorage.setItem('goToUsers', '1');
                    break;
                case 'roles':
                    localStorage.setItem('goToRoles', '1');
                    break;
                case 'billing':
                    localStorage.setItem('goToBilling', '1');
                    break;
                case 'support':
                    localStorage.setItem('goToSupport', '1');
                    break;
                case 'reports':
                    localStorage.setItem('goToReports', '1');
                    break;
                case 'settings':
                    localStorage.setItem('goToSettings', '1');
                    break;
                default:
                    break;
            }
            window.location.href = '/multi_dashboard';
        }


        // === Initial Load Logic ===
        document.addEventListener("DOMContentLoaded", () => {
            loadSavedSettings(); // Load saved settings
            calculateTotals(); // Initialize totals calculation
            let shouldShowWelcome = true;
            if (localStorage.getItem('goToTeamsGroups') === '1') {
                localStorage.removeItem('goToTeamsGroups');
                showDashboard();
                loadSection('Teams & Groups');
                shouldShowWelcome = false;
            } else if (localStorage.getItem('goToUsers') === '1') {
                localStorage.removeItem('goToUsers');
                showDashboard();
                loadSection('Users');
                shouldShowWelcome = false;
            } else if (localStorage.getItem('goToRoles') === '1') {
                localStorage.removeItem('goToRoles');
                showDashboard();
                loadSection('Roles');
                shouldShowWelcome = false;
            } else if (localStorage.getItem('goToBilling') === '1') {
                localStorage.removeItem('goToBilling');
                showDashboard();
                loadSection('Billing');
                shouldShowWelcome = false;
            } else if (localStorage.getItem('goToSupport') === '1') {
                localStorage.removeItem('goToSupport');
                showDashboard();
                loadSection('Support');
                shouldShowWelcome = false;
            } else if (localStorage.getItem('goToReports') === '1') {
                localStorage.removeItem('goToReports');
                showDashboard();
                loadSection('Reports');
                shouldShowWelcome = false;
            } else if (localStorage.getItem('goToSettings') === '1') {
                localStorage.removeItem('goToSettings');
                showDashboard();
                loadSection('Settings');
                shouldShowWelcome = false;
            }

            if (shouldShowWelcome) {
                document.getElementById('welcomeBlock').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
            } else {
                document.getElementById('welcomeBlock').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }
            document.querySelectorAll('.sidebar ul li').forEach(item => {
                item.addEventListener('click', e => {
                    const section = e.target.textContent.trim();
                    section === 'Home' ? loadHome() : loadSection(section);
                });
            });

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    ensureVideoPlaying();
                }
            });
            window.addEventListener('focus', () => {
                ensureVideoPlaying();
            });
            window.addEventListener('load', () => {
                ensureVideoPlaying();
                const savedMode = localStorage.getItem('selectedMode') || 'dark';
                if (savedMode === 'light') {
                    applyMode();
                }
                const savedPosition = localStorage.getItem('sidePanelPosition') || 'left';
                if (savedPosition === 'right') {
                    applySidePanelPosition();
                }
                const savedFont = localStorage.getItem('erpFont');
                if (savedFont) {
                    document.body.style.fontFamily = savedFont;
                    document.getElementById('google-font-link').href = `https://fonts.googleapis.com/css?family=${savedFont.replace(/ /g, '+')}`;
                }

                // Load announcements on page load
                setTimeout(() => {
                    showDashboardAnnouncements();
                }, 1000);
            });
        });

        // in your dashboard.html file

        // ... existing JavaScript code ...

        // New function to load the User Info page
       async function loadUserInfoPage() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <h2 style="margin-bottom: 20px;">📇 User Info</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <button onclick="loadSection('Users')" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer;">← Back to User Management</button>
                    <button onclick="loadAddEmployeeForm()" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);">+ Add New Employee</button>
                </div>
                <div id="employeeInfoList" style="margin-top: 30px; max-height: 60vh; overflow-y: auto; border-radius: 6px;">
                    <table style="width: 100%; border-collapse: collapse; background-color: rgba(255,255,255,0.05);">
                        <thead>
                            <tr style="background-color: rgba(255,255,255,0.1);">
                                <th style="padding: 12px; border-bottom: 1px solid #666; text-align: left;">Employee Name</th>
                                <th style="padding: 12px; border-bottom: 1px solid #666; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeInfoTableBody"></tbody>
                    </table>
                </div>
            `;
            fetchEmployeeInfoList();
        }

        async function fetchEmployeeInfoList() {
            const tbody = document.getElementById('employeeInfoTableBody');
            tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px;">Loading employee info...</td></tr>';
            try {
                const response = await fetch('/api/get_all_employee_info');
                const data = await response.json();
                console.log('Employee data received:', data);
                if (data.status === 'success') {
                    tbody.innerHTML = '';
                    if (data.employees.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px; color: #ccc;">No employee information found.</td></tr>';
                        return;
                    }
                    data.employees.forEach(emp => {
                        console.log('Processing employee:', emp);
                        if (!emp || !emp.id) {
                            console.error('Invalid employee data:', emp);
                            return;
                        }
                        const row = `
                        <tr>
                            <td style="padding: 10px; cursor: pointer;" onclick="viewEmployeeDetails(${emp.id})">${emp.full_name || 'N/A'}</td>
                            <td style="padding: 10px;">
                                <button onclick="event.stopPropagation(); deleteEmployeeInfo(${emp.id}, '${emp.full_name || 'Unknown'}')" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px;">Delete</button>
                            </td>
                        </tr>`;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="2" style="text-align: center; padding: 20px; color: red;">Error: ${data.message}</td></tr>`;
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="2" style="text-align: center; padding: 20px; color: red;">Failed to fetch employee data.</td></tr>`;
            }
        }

        


        // dashboard.html

        // ... in your dashboard.html file ...

        async function submitNewEmployeeForm() {
    // Collect all input values, ensuring to handle potential null values gracefully.
    const fullName = document.getElementById('addEmpFullName')?.value || '';
    const email = document.getElementById('addEmpEmail')?.value || '';
    const employeeId = document.getElementById('addEmpEmployeeId')?.value || '';
    const dob = document.getElementById('addEmpDOB')?.value || '';
    const phoneNo = document.getElementById('addEmpPhoneNo')?.value || '';
    const gender = document.getElementById('addEmpGender')?.value || '';
    const maritalStatus = document.getElementById('addEmpMaritalStatus')?.value || '';
    const designation = document.getElementById('addEmpDesignation')?.value || '';
    const probationFrom = document.getElementById('addEmpProbationFrom')?.value || '';
    const internshipFrom = document.getElementById('addEmpInternshipFrom')?.value || '';
    const internshipTo = document.getElementById('addEmpInternshipTo')?.value || '';
    const probationTo = document.getElementById('addEmpProbationTo')?.value || '';
    const dateOfJoining = document.getElementById('addEmpDateOfJoining')?.value || '';
    const confirmationDate = document.getElementById('addEmpConfirmationDate')?.value || '';
    const dateOfAnniversary = document.getElementById('addEmpDateOfAnniversary')?.value || '';
    const probationSalary = document.getElementById('addEmpProbationSalary')?.value || '';
    const confirmationSalary = document.getElementById('addEmpConfirmationSalary')?.value || '';
    const officeBranch = document.getElementById('addEmpOfficeBranch')?.value || '';
    const address = document.getElementById('addEmpAddress')?.value || '';
    const fatherName = document.getElementById('addEmpFatherName')?.value || '';
    const fatherContact = document.getElementById('addEmpFatherContact')?.value || '';
    const motherName = document.getElementById('addEmpMotherName')?.value || '';
    const motherContact = document.getElementById('addEmpMotherContact')?.value || '';
    const emergencyContactName = document.getElementById('addEmpEmergencyContactName')?.value || '';
    const emergencyPhoneNumber = document.getElementById('addEmpEmergencyPhoneNumber')?.value || '';
    const spouseName = document.getElementById('addEmpSpouseName')?.value || '';
    const spouseContactNumber = document.getElementById('addEmpSpouseContactNumber')?.value || '';
    const tenthCGPA = document.getElementById('addEmp10thCGPA')?.value || '';
    const interCGPA = document.getElementById('addEmpInterCGPA')?.value || '';
    const btechCGPA = document.getElementById('addEmpBtechCGPA')?.value || '';
    const postGraduationMarks = document.getElementById('addEmpPostGraduationMarks')?.value || '';
    const aadhaar = document.getElementById('addEmpAadhaar')?.value || '';
    const pan = document.getElementById('addEmpPAN')?.value || '';
    
    // NEW: Collect the Account Number value
    const accountNumber = document.getElementById('addEmpAccountNumber')?.value || '';

    // New Accounts Fields
    const actualGrossSalary = document.getElementById('addEmpGrossSalary')?.value || 0;
    const basic = document.getElementById('addEmpBasic')?.value || 0;
    const hra = document.getElementById('addEmpHra')?.value || 0;
    const conveyance = document.getElementById('addEmpConveyance')?.value || 0;
    const specialAllowance = document.getElementById('addEmpSpecialAllowance')?.value || 0;
    const providentFund = document.getElementById('addEmpProvidentFund')?.value || 0;
    const esi = document.getElementById('addEmpESI')?.value || 0;
    const professionalTax = document.getElementById('addEmpProfessionalTax')?.value || 0;
    const incomeTax = document.getElementById('addEmpIncomeTax')?.value || 0;
    const advance = document.getElementById('addEmpAdvance')?.value || 0;
    const totalLeaves = document.getElementById('addEmpTotalLeaves')?.value || 0;
    
    // New fields
    const pfNo = document.getElementById('addEmpPfNo')?.value || '';

    // Correctly get the filename from the file input element. Use optional chaining (?) for safety.
    const pdcFile = document.getElementById('addEmpPDC');
    const pdc = pdcFile?.files.length > 0 ? pdcFile.files[0].name : '';
    const aadhaarFile = document.getElementById('addEmpAadhaar');
    const aadhaarFileName = aadhaarFile?.files.length > 0 ? aadhaarFile.files[0].name : '';
    const panFile = document.getElementById('addEmpPAN');
    const panFileName = panFile?.files.length > 0 ? panFile.files[0].name : '';
    const resumeFile = document.getElementById('addEmpResume');
    const resume = resumeFile?.files.length > 0 ? resumeFile.files[0].name : '';
    const tenthCertFile = document.getElementById('addEmpTenthCertificate');
    const tenthCert = tenthCertFile?.files.length > 0 ? tenthCertFile.files[0].name : '';
    const twelfthCertFile = document.getElementById('addEmpTwelfthCertificate');
    const twelfthCert = twelfthCertFile?.files.length > 0 ? twelfthCertFile.files[0].name : '';
    const postGraduationCertFile = document.getElementById('addEmpPostGraduationCertificate');
    const postGraduationCert = postGraduationCertFile?.files.length > 0 ? postGraduationCertFile.files[0].name : '';

    // Check for required fields before proceeding.
    if (!fullName || !email) {
        alert("Full Name and Email are required.");
        return;
    }

    const formData = new FormData();
    formData.append('full_name', fullName);
    formData.append('email', email);
    formData.append('employee_id', employeeId);
    formData.append('dob', dob);
    formData.append('gender', gender);
    formData.append('marital_status', maritalStatus);
    formData.append('designation', designation);
    formData.append('probation_from', probationFrom);
    formData.append('internship_from', internshipFrom);
    formData.append('internship_to', internshipTo);
    formData.append('probation_to', probationTo);
    formData.append('date_of_joining', dateOfJoining);
    formData.append('confirmation_date', confirmationDate);
    formData.append('date_of_anniversary', dateOfAnniversary);
    formData.append('probation_salary', probationSalary);
    formData.append('confirmation_salary', confirmationSalary);
    formData.append('office_branch', officeBranch);
    formData.append('father_name', fatherName);
    formData.append('father_contact', fatherContact);
    formData.append('mother_name', motherName);
    formData.append('mother_contact', motherContact);
    formData.append('emergency_contact_name', emergencyContactName);
    formData.append('emergency_phone_number', emergencyPhoneNumber);
    formData.append('spouse_name', spouseName);
    formData.append('spouse_contact_number', spouseContactNumber);
    formData.append('phone_no', phoneNo);
    formData.append('address', address);
    formData.append('tenth_cgpa', tenthCGPA);
    formData.append('inter_cgpa', interCGPA);
    formData.append('btech_cgpa', btechCGPA);
    formData.append('post_graduation_marks', postGraduationMarks);
    formData.append('account_number', accountNumber);
    formData.append('actual_gross_salary', actualGrossSalary);
    formData.append('basic', basic);
    formData.append('hra', hra);
    formData.append('conveyance', conveyance);
    formData.append('special_allowance', specialAllowance);
    formData.append('provident_fund', providentFund);
    formData.append('esi', esi);
    formData.append('professional_tax', professionalTax);
    formData.append('income_tax', incomeTax);
    formData.append('advance', advance);
    formData.append('total_leaves', totalLeaves);
    formData.append('pf_no', pfNo);

    // Add file uploads
    if (pdcFile?.files.length > 0) formData.append('pdc', pdcFile.files[0]);
    if (aadhaarFile?.files.length > 0) formData.append('aadhaar_card', aadhaarFile.files[0]);
    if (panFile?.files.length > 0) formData.append('pan_card', panFile.files[0]);
    if (resumeFile?.files.length > 0) formData.append('resume', resumeFile.files[0]);
    if (tenthCertFile?.files.length > 0) formData.append('tenth_certificate', tenthCertFile.files[0]);
    if (twelfthCertFile?.files.length > 0) formData.append('twelfth_certificate', twelfthCertFile.files[0]);
    if (postGraduationCertFile?.files.length > 0) formData.append('post_graduation_certificate', postGraduationCertFile.files[0]);

    try {
        const response = await fetch('/api/add_employee_info', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.status === 'success') {
            alert('Employee information saved successfully!');
            loadUserInfoPage(); // Go back to the user info list
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving employee info:', error);
        alert('Failed to save employee information. Check the console for details.');
    }
}

// dashboard.html

// dashboard.html

async function viewEmployeeDetails(employeeId) {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `<p style="text-align: center; color: #ccc;">Loading employee details...</p>`;
    try {
        const response = await fetch(`/api/get_employee_info/${employeeId}`);
        const result = await response.json();

        if (result.status === 'success' && result.employee) {
            const emp = result.employee;
            mainContent.innerHTML = `
                <h2 style="margin-bottom: 20px;">👤 Employee Details: <span style="color: #00d1ff;">${emp.full_name}</span></h2>
                <div style="background: rgba(0, 209, 255, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #00d1ff;">
                    <strong style="color: #00d1ff;">📅 Updated Version - Includes Internship Fields</strong>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <button onclick="loadUserInfoPage()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer;">← Back to User Info</button>
                    <button onclick="editEmployeeDetails(${emp.id})" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Edit</button>
                </div>
                <div style="max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.08); padding: 30px; border-radius: 12px;">
                    <h4 style="color: #00d1ff; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Personal Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                        <div class="salaries-field-group"><strong>Full Name:</strong> ${emp.full_name || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Email:</strong> ${emp.email || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Employee ID:</strong> ${emp.employee_id || `SSDEV-${emp.id.toString().padStart(2, '0')}-002`}</div>
                        <div class="salaries-field-group"><strong>Date of Birth:</strong> ${emp.dob || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Phone Number:</strong> ${emp.phone_no || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Gender:</strong> ${emp.gender || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Marital Status:</strong> ${emp.marital_status || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Designation:</strong> ${emp.designation || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Probation From:</strong> ${emp.probation_from || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Probation To:</strong> ${emp.probation_to || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Internship Period From:</strong> ${emp.internship_from || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Internship Period To:</strong> ${emp.internship_to || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Date of Joining:</strong> ${emp.date_of_joining || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Confirmation Date:</strong> ${emp.confirmation_date || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Date of Anniversary:</strong> ${emp.date_of_anniversary || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Probation Salary:</strong> ${emp.probation_salary || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Confirmation Salary:</strong> ${emp.confirmation_salary || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Office Branch:</strong> ${emp.office_branch || 'N/A'}</div>
                        <div class="salaries-field-group" style="grid-column: 1 / -1;"><strong>Address:</strong> ${emp.address || 'N/A'}</div>
                    </div>
                    <h4 style="color: #00d1ff; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Family Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                        <div class="salaries-field-group"><strong>Father's Name:</strong> ${emp.father_name || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Father's Contact:</strong> ${emp.father_contact || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Mother's Name:</strong> ${emp.mother_name || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Mother's Contact:</strong> ${emp.mother_contact || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Emergency Contact Name:</strong> ${emp.emergency_contact_name || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Emergency Phone Number:</strong> ${emp.emergency_phone_number || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Spouse Name:</strong> ${emp.spouse_name || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Spouse Contact Number:</strong> ${emp.spouse_contact_number || 'N/A'}</div>
                    </div>
                    
                    <h4 style="color: #00d1ff; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Accounts Section</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                        <div class="salaries-field-group"><strong>Account Number:</strong> ${emp.account_number || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>PF No:</strong> ${emp.pf_no || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Actual Gross Salary:</strong> ${emp.actual_gross_salary || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Basic:</strong> ${emp.basic || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>HRA:</strong> ${emp.hra || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Conveyance:</strong> ${emp.conveyance || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Special Allowance:</strong> ${emp.special_allowance || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Provident Fund:</strong> ${emp.provident_fund || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>ESI:</strong> ${emp.esi || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Professional Tax:</strong> ${emp.professional_tax || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Income Tax:</strong> ${emp.income_tax || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Advance:</strong> ${emp.advance || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Total Leaves:</strong> ${emp.total_leaves || 'N/A'}</div>
                    </div>

                    <h4 style="color: #00d1ff; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Educational & Document Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                        <div class="salaries-field-group"><strong>10th CGPA:</strong> ${emp.tenth_cgpa || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Intermediate CGPA:</strong> ${emp.inter_cgpa || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Graduation CGPA:</strong> ${emp.btech_cgpa || 'N/A'}</div>
                        <div class="salaries-field-group"><strong>Post Graduation Marks:</strong> ${emp.post_graduation_marks || 'N/A'}</div>
                        <div class="salaries-field-group">
                            <strong>PDC:</strong> 
                            ${emp.pdc ? `<a href="/uploads/${emp.pdc}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.pdc}</a>` : 'N/A'}
                        </div>
                        <div class="salaries-field-group">
                            <strong>Aadhaar Card:</strong> 
                            ${emp.aadhaar_card ? `<a href="/uploads/${emp.aadhaar_card}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.aadhaar_card}</a>` : 'N/A'}
                        </div>
                        <div class="salaries-field-group">
                            <strong>Pan Card:</strong> 
                            ${emp.pan_card ? `<a href="/uploads/${emp.pan_card}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.pan_card}</a>` : 'N/A'}
                        </div>
                        <div class="salaries-field-group">
                            <strong>Resume:</strong> 
                            ${emp.resume ? `<a href="/uploads/${emp.resume}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.resume}</a>` : 'N/A'}
                        </div>
                        <div class="salaries-field-group">
                            <strong>10th Certificate:</strong> 
                            ${emp.tenth_certificate ? `<a href="/uploads/${emp.tenth_certificate}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.tenth_certificate}</a>` : 'N/A'}
                        </div>
                        <div class="salaries-field-group">
                            <strong>12th Certificate:</strong> 
                            ${emp.twelfth_certificate ? `<a href="/uploads/${emp.twelfth_certificate}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.twelfth_certificate}</a>` : 'N/A'}
                        </div>
                        <div class="salaries-field-group">
                            <strong>Post Graduation Certificate:</strong> 
                            ${emp.post_graduation_certificate ? `<a href="/uploads/${emp.post_graduation_certificate}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.post_graduation_certificate}</a>` : 'N/A'}
                        </div>
                        <div class="salaries-field-group">
                            <strong>Passport Size Photo:</strong> 
                            ${emp.passport_photo ? `<a href="/uploads/${emp.passport_photo}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.passport_photo}</a>` : 'N/A'}
                        </div>
                    </div>
                </div>
            `;
        } else {
            // If employee info is not found, show a message and prompt to add it
            mainContent.innerHTML = `
                <h2 style="margin-bottom: 20px;">❌ Employee Details Not Found</h2>
                <p style="text-align: center; color: #ccc; margin-bottom: 20px;">
                    Employee information for this user does not exist. Please add it.
                </p>
                <div style="display: flex; justify-content: center; gap: 10px;">
                    <button onclick="loadUserInfoPage()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer;">← Back to User Info</button>
                    <button onclick="loadAddEmployeeForm()" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">➕ Add Employee Info</button>
                </div>
            `;
        }
    } catch (error) {
        alert('Failed to fetch employee details.');
        loadUserInfoPage();
    }
}
        async function editEmployeeDetails(employeeId) {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `<p style="text-align: center; color: #ccc;">Loading employee details...</p>`;
            try {
                const response = await fetch(`/api/get_employee_info/${employeeId}`);
                const result = await response.json();
                if (result.status === 'success') {
                    const emp = result.employee;
                    mainContent.innerHTML = `
                        <h2 style="margin-bottom: 20px;">📝 Edit Employee Info: <span style="color: #00d1ff;">${emp.full_name}</span></h2>
                        <div style="max-width: 800px; margin: 0 auto; background: rgba(0, 0, 0, 0.6); padding: 30px; border-radius: 12px; box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);">
                            
                            <div class="form-section">
                                <h4>Personal Details</h4>
                                <div class="form-fields-grid">
                                    <div class="form-field-group">
                                        <label for="editEmpFullName">Full Name *</label>
                                        <input type="text" id="editEmpFullName" value="${emp.full_name}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpEmail">Email *</label>
                                        <input type="email" id="editEmpEmail" value="${emp.email}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpEmployeeId">Employee ID</label>
                                        <input type="text" id="editEmpEmployeeId" value="${emp.employee_id || `SSDEV-${emp.id.toString().padStart(2, '0')}-002`}" placeholder="e.g., SSDEV-01-001">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpDOB">Date of Birth</label>
                                        <input type="date" id="editEmpDOB" value="${emp.dob || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpPhoneNo">Phone Number</label>
                                        <input type="tel" id="editEmpPhoneNo" value="${emp.phone_no || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpGender">Gender</label>
                                        <input type="text" id="editEmpGender" value="${emp.gender || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpMaritalStatus">Marital Status</label>
                                        <select id="editEmpMaritalStatus">
                                            <option value="Single" ${emp.marital_status === 'Single' ? 'selected' : ''}>Single</option>
                                            <option value="Married" ${emp.marital_status === 'Married' ? 'selected' : ''}>Married</option>
                                        </select>
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpDesignation">Designation</label>
                                        <input type="text" id="editEmpDesignation" value="${emp.designation || ''}" placeholder="Designation">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpProbationFrom">Probation Period From</label>
                                        <input type="date" id="editEmpProbationFrom" value="${emp.probation_from || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpProbationTo">Probation Period To</label>
                                        <input type="date" id="editEmpProbationTo" value="${emp.probation_to || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpInternshipFrom">Internship Period From</label>
                                        <input type="date" id="editEmpInternshipFrom" value="${emp.internship_from || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpInternshipTo">Internship Period To</label>
                                        <input type="date" id="editEmpInternshipTo" value="${emp.internship_to || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpDateOfJoining">Date of Joining</label>
                                        <input type="date" id="editEmpDateOfJoining" value="${emp.date_of_joining || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpConfirmationDate">Confirmation Date</label>
                                        <input type="date" id="editEmpConfirmationDate" value="${emp.confirmation_date || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpDateOfAnniversary">Date of Anniversary</label>
                                        <input type="date" id="editEmpDateOfAnniversary" value="${emp.date_of_anniversary || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpProbationSalary">Probation Salary</label>
                                        <input type="text" id="editEmpProbationSalary" value="${emp.probation_salary || ''}" placeholder="Probation Salary">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpConfirmationSalary">Confirmation Salary</label>
                                        <input type="text" id="editEmpConfirmationSalary" value="${emp.confirmation_salary || ''}" placeholder="Confirmation Salary">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpOfficeBranch">Office Branch</label>
                                        <select id="editEmpOfficeBranch">
                                            <option value="">-- Select Branch --</option>
                                            <option value="SSEV" ${emp.office_branch === 'SSEV' ? 'selected' : ''}>SSEV</option>
                                            <option value="SSEV SOFTSOLS" ${emp.office_branch === 'SSEV SOFTSOLS' ? 'selected' : ''}>SSEV SOFTSOLS</option>
                                        </select>
                                    </div>
                                    <div class="form-field-group" style="grid-column: 1 / -1;">
                                        <label for="editEmpAddress">Address</label>
                                        <textarea id="editEmpAddress">${emp.address || ''}</textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h4>Family Details</h4>
                                <div class="form-fields-grid">
                                    <div class="form-field-group">
                                        <label for="editEmpFatherName">Father's Name</label>
                                        <input type="text" id="editEmpFatherName" value="${emp.father_name || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpFatherContact">Father's Contact</label>
                                        <input type="tel" id="editEmpFatherContact" value="${emp.father_contact || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpMotherName">Mother's Name</label>
                                        <input type="text" id="editEmpMotherName" value="${emp.mother_name || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpMotherContact">Mother's Contact</label>
                                        <input type="tel" id="editEmpMotherContact" value="${emp.mother_contact || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpEmergencyContactName">Emergency Contact Name</label>
                                        <input type="text" id="editEmpEmergencyContactName" value="${emp.emergency_contact_name || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpEmergencyPhoneNumber">Emergency Phone Number</label>
                                        <input type="tel" id="editEmpEmergencyPhoneNumber" value="${emp.emergency_phone_number || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpSpouseName">Spouse Name</label>
                                        <input type="text" id="editEmpSpouseName" value="${emp.spouse_name || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpSpouseContactNumber">Spouse Contact Number</label>
                                        <input type="tel" id="editEmpSpouseContactNumber" value="${emp.spouse_contact_number || ''}">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h4>Accounts Section</h4>
                                <div class="form-fields-grid">
                                    <div class="form-field-group">
                                        <label for="editEmpPfNo">PF No</label>
                                        <input type="text" id="editEmpPfNo" value="${emp.pf_no || ''}" placeholder="e.g., PF/12345/678">
                                    </div>
                                    <div class="form-field-group" style="grid-column: 1 / -1;">
                                        <label for="editEmpAccountNumber">Account Number</label>
                                        <input type="text" id="editEmpAccountNumber" value="${emp.account_number || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpGrossSalary">Actual Gross Salary</label>
                                        <input type="number" id="editEmpGrossSalary" value="${emp.actual_gross_salary || ''}" oninput="calculateEditSalaryComponents()">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpBasic">Basic</label>
                                        <input type="number" id="editEmpBasic" value="${emp.basic || ''}" readonly>
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpHra">HRA</label>
                                        <input type="number" id="editEmpHra" value="${emp.hra || ''}" readonly>
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpConveyance">Conveyance</label>
                                        <input type="number" id="editEmpConveyance" value="${emp.conveyance || ''}" readonly>
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpSpecialAllowance">Special Allowance</label>
                                        <input type="number" id="editEmpSpecialAllowance" value="${emp.special_allowance || ''}" readonly>
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpProvidentFund">Provident Fund</label>
                                        <input type="number" id="editEmpProvidentFund" value="${emp.provident_fund || ''}" readonly>
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpESI">ESI</label>
                                        <input type="number" id="editEmpESI" value="${emp.esi || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpProfessionalTax">Professional Tax</label>
                                        <input type="number" id="editEmpProfessionalTax" value="${emp.professional_tax || ''}" readonly>
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpIncomeTax">Income Tax</label>
                                        <input type="number" id="editEmpIncomeTax" value="${emp.income_tax || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpAdvance">Advance</label>
                                        <input type="number" id="editEmpAdvance" value="${emp.advance || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpTotalLeaves">Total Leaves</label>
                                        <input type="number" id="editEmpTotalLeaves" value="${emp.total_leaves || ''}">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h4>Educational & Document Details</h4>
                                <div class="form-fields-grid">
                                    <div class="form-field-group">
                                        <label for="editEmp10thCGPA">10th CGPA</label>
                                        <input type="text" id="editEmp10thCGPA" value="${emp.tenth_cgpa || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpInterCGPA">Intermediate CGPA</label>
                                        <input type="text" id="editEmpInterCGPA" value="${emp.inter_cgpa || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpBtechCGPA">Graduation CGPA</label>
                                        <input type="text" id="editEmpBtechCGPA" value="${emp.btech_cgpa || ''}">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpPostGraduationMarks">Post Graduation Marks (Optional)</label>
                                        <input type="text" id="editEmpPostGraduationMarks" value="${emp.post_graduation_marks || ''}" placeholder="Post graduation marks">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpPDC">PDC</label>
                                        <input type="file" id="editEmpPDC" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpAadhaar">Aadhaar Card</label>
                                        <input type="file" id="editEmpAadhaar" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpPAN">Pan Card</label>
                                        <input type="file" id="editEmpPAN" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpResume">Resume</label>
                                        <input type="file" id="editEmpResume" accept=".pdf, .doc, .docx">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpTenthCertificate">10th Certificate</label>
                                        <input type="file" id="editEmpTenthCertificate" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpTwelfthCertificate">12th Certificate</label>
                                        <input type="file" id="editEmpTwelfthCertificate" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpPostGraduationCertificate">Post Graduation Certificate (Optional)</label>
                                        <input type="file" id="editEmpPostGraduationCertificate" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                                    </div>
                                    <div class="form-field-group">
                                        <label for="editEmpPassportPhoto">Passport Size Photo</label>
                                        <input type="file" id="editEmpPassportPhoto" accept=".jpg, .jpeg, .png">
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                                <button onclick="loadUserInfoPage()" style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Cancel</button>
                                <button onclick="saveEmployeeDetails(${emp.id})" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Save</button>
                            </div>
                        </div>
                    `;
                } else {
                    alert('Error: ' + result.message);
                    loadUserInfoPage();
                }
            } catch (error) {
                alert('Failed to load employee details for editing.');
                loadUserInfoPage();
            }
        }

        async function saveEmployeeDetails(employeeId) {
            const fullName = document.getElementById('editEmpFullName').value;
            const email = document.getElementById('editEmpEmail').value;
            const employeeIdField = document.getElementById('editEmpEmployeeId').value;
            const dob = document.getElementById('editEmpDOB').value;
            const phoneNo = document.getElementById('editEmpPhoneNo').value;
            const gender = document.getElementById('editEmpGender').value;
            const maritalStatus = document.getElementById('editEmpMaritalStatus').value;
            const designation = document.getElementById('editEmpDesignation').value;
            const probationFrom = document.getElementById('editEmpProbationFrom').value;
            const internshipFrom = document.getElementById('editEmpInternshipFrom').value;
            const internshipTo = document.getElementById('editEmpInternshipTo').value;
            const probationTo = document.getElementById('editEmpProbationTo').value;
            const dateOfJoining = document.getElementById('editEmpDateOfJoining').value;
            const confirmationDate = document.getElementById('editEmpConfirmationDate').value;
            const dateOfAnniversary = document.getElementById('editEmpDateOfAnniversary').value;
            const probationSalary = document.getElementById('editEmpProbationSalary').value;
            const confirmationSalary = document.getElementById('editEmpConfirmationSalary').value;
            const officeBranch = document.getElementById('editEmpOfficeBranch').value;
            const address = document.getElementById('editEmpAddress').value;
            const fatherName = document.getElementById('editEmpFatherName').value;
            const fatherContact = document.getElementById('editEmpFatherContact').value;
            const motherName = document.getElementById('editEmpMotherName').value;
            const motherContact = document.getElementById('editEmpMotherContact').value;
            const emergencyContactName = document.getElementById('editEmpEmergencyContactName').value;
            const emergencyPhoneNumber = document.getElementById('editEmpEmergencyPhoneNumber').value;
            const spouseName = document.getElementById('editEmpSpouseName').value;
            const spouseContactNumber = document.getElementById('editEmpSpouseContactNumber').value;
            const tenthCGPA = document.getElementById('editEmp10thCGPA').value;
            const interCGPA = document.getElementById('editEmpInterCGPA').value;
            const btechCGPA = document.getElementById('editEmpBtechCGPA').value;
            const postGraduationMarks = document.getElementById('editEmpPostGraduationMarks').value;
            
            // Accounts fields
            const accountNumber = document.getElementById('editEmpAccountNumber').value;
            const actualGrossSalary = document.getElementById('editEmpGrossSalary').value;
            const basic = document.getElementById('editEmpBasic').value;
            const hra = document.getElementById('editEmpHra').value;
            const conveyance = document.getElementById('editEmpConveyance').value;
            const specialAllowance = document.getElementById('editEmpSpecialAllowance').value;
            const providentFund = document.getElementById('editEmpProvidentFund').value;
            const esi = document.getElementById('editEmpESI').value;
            const professionalTax = document.getElementById('editEmpProfessionalTax').value;
            const incomeTax = document.getElementById('editEmpIncomeTax').value;
            const advance = document.getElementById('editEmpAdvance').value;
            const totalLeaves = document.getElementById('editEmpTotalLeaves').value;
            
            // New fields
            const pfNo = document.getElementById('editEmpPfNo').value;

            if (!fullName || !email) {
                alert("Full Name and Email are required.");
                return;
            }

            const formData = new FormData();
            formData.append('id', employeeId);
            formData.append('full_name', fullName);
            formData.append('email', email);
            formData.append('dob', dob);
            formData.append('gender', gender);
            formData.append('marital_status', maritalStatus);
            formData.append('designation', designation);
            formData.append('probation_from', probationFrom);
            formData.append('internship_from', internshipFrom);
            formData.append('internship_to', internshipTo);
            formData.append('probation_to', probationTo);
            formData.append('date_of_joining', dateOfJoining);
            formData.append('confirmation_date', confirmationDate);
            formData.append('date_of_anniversary', dateOfAnniversary);
            formData.append('probation_salary', probationSalary);
            formData.append('confirmation_salary', confirmationSalary);
            formData.append('office_branch', officeBranch);
            formData.append('employee_id', employeeIdField);
            formData.append('father_name', fatherName);
            formData.append('father_contact', fatherContact);
            formData.append('mother_name', motherName);
            formData.append('mother_contact', motherContact);
            formData.append('emergency_contact_name', emergencyContactName);
            formData.append('emergency_phone_number', emergencyPhoneNumber);
            formData.append('spouse_name', spouseName);
            formData.append('spouse_contact_number', spouseContactNumber);
            formData.append('phone_no', phoneNo);
            formData.append('address', address);
            formData.append('tenth_cgpa', tenthCGPA);
            formData.append('inter_cgpa', interCGPA);
            formData.append('btech_cgpa', btechCGPA);
            formData.append('post_graduation_marks', postGraduationMarks);
            formData.append('account_number', accountNumber);
            formData.append('actual_gross_salary', actualGrossSalary);
            formData.append('basic', basic);
            formData.append('hra', hra);
            formData.append('conveyance', conveyance);
            formData.append('special_allowance', specialAllowance);
            formData.append('provident_fund', providentFund);
            formData.append('esi', esi);
            formData.append('professional_tax', professionalTax);
            formData.append('income_tax', incomeTax);
            formData.append('advance', advance);
            formData.append('total_leaves', totalLeaves);
            formData.append('pf_no', pfNo);

            // Add file uploads
            const pdcFile = document.getElementById('editEmpPDC').files[0];
            if (pdcFile) formData.append('pdc', pdcFile);
            
            const aadhaarFile = document.getElementById('editEmpAadhaar').files[0];
            if (aadhaarFile) formData.append('aadhaar_card', aadhaarFile);
            
            const panFile = document.getElementById('editEmpPAN').files[0];
            if (panFile) formData.append('pan_card', panFile);
            
            const resumeFile = document.getElementById('editEmpResume').files[0];
            if (resumeFile) formData.append('resume', resumeFile);
            
            const tenthCertFile = document.getElementById('editEmpTenthCertificate').files[0];
            if (tenthCertFile) formData.append('tenth_certificate', tenthCertFile);
            
            const twelfthCertFile = document.getElementById('editEmpTwelfthCertificate').files[0];
            if (twelfthCertFile) formData.append('twelfth_certificate', twelfthCertFile);
            
            const postGraduationCertFile = document.getElementById('editEmpPostGraduationCertificate').files[0];
            if (postGraduationCertFile) formData.append('post_graduation_certificate', postGraduationCertFile);

            try {
                const response = await fetch('/api/update_employee_info', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Employee information updated successfully!');
                    viewEmployeeDetails(employeeId); // Show the updated details
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Failed to update employee information.');
            }
        }


        function deleteEmployeeInfo(employeeId, employeeName) {
  if (!confirm(`Are you sure you want to delete the user info for ${employeeName}? This will move the user account to the deleted users section.`)) {
    return;
  }
  fetch(`/api/delete_employee_info/${employeeId}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        alert('Employee info deleted successfully.');
        // Refresh the list so the deleted user disappears from the UI
        fetchEmployeeInfoList(); 
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error deleting employee info:', error);
      alert('Failed to delete employee info.');
    });
}

        function loadDeletedUsersPage() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
            <h2 style="margin-bottom: 20px;">🗑️ Deleted Users</h2>
            <p style="color:#ccc;">Users who have been deleted from the system. They can be restored.</p>
            <div style="margin-top: 30px; max-height: 60vh; overflow-y: auto; border-radius: 6px;">
                <table style="width: 100%; border-collapse: collapse; background-color: rgba(255,255,255,0.05);">
                    <thead><tr style="background-color: rgba(255,255,255,0.1);">
                        <th style="padding: 12px; border-bottom: 1px solid #666;">Name</th>
                        <th style="padding: 12px; border-bottom: 1px solid #666;">Email</th>
                        <th style="padding: 12px; border-bottom: 1px solid #666;">Roles</th>
                        <th style="padding: 12px; border-bottom: 1px solid #666;">Actions</th>
                    </tr></thead>
                    <tbody id="deletedUserTableBody">
                        <tr><td colspan="4" style="text-align:center; padding: 20px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        `;

            fetch('/api/deleted_users')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('deletedUserTableBody');
                    tbody.innerHTML = '';
                    if (data.status === 'success' && data.users.length > 0) {
                        data.users.forEach(user => {
                            const roles = Array.isArray(user.roles) ? user.roles.join(', ') : user.roles;
                            const row = `<tr>
                            <td style="padding: 10px;">${user.name}</td>
                            <td style="padding: 10px;">${user.email}</td>
                            <td style="padding: 10px;">${roles}</td>
                            <td style="padding: 10px;">
                                <button onclick="restoreUser('${user.email}')" style="padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 4px;">Restore</button>
                            </td>
                        </tr>`;
                            tbody.insertAdjacentHTML('beforeend', row);
                        });
                    } else {
                        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px; color:#ccc;">No deleted users found.</td></tr>`;
                    }
                });
        }

        function restoreUser(email) {
            if (!confirm(`Are you sure you want to restore the user ${email}?`)) return;

            fetch('/api/restore_user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('✅ User restored successfully!');
                        loadDeletedUsersPage(); // Refresh the list
                    } else {
                        alert("❌ " + data.message);
                    }
                });
        }
        // REPLACE your old loadAssetsSection function in dashboard.html

        function loadAssetsSection() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
        <h2 style="margin-bottom: 20px;">Assets Management</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div onclick="loadAssetList()" class="shortcut-card" style="cursor: pointer; background-color: rgba(0, 0, 0, 0.4); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 209, 255, 0.3);">
                <div style="font-size: 3rem; margin-bottom: 15px;">📦</div>
                <h3>Assets</h3><p style="color: #ccc;">Click to manage assets.</p>
            </div>
            <div onclick="loadIndentsSection()" class="shortcut-card" style="cursor: pointer; background-color: rgba(0, 0, 0, 0.4); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 209, 255, 0.3);">
                <div style="font-size: 3rem; margin-bottom: 15px;">📝</div>
                <h3>Indents</h3><p style="color: #ccc;">Click to manage indents.</p>
            </div>
            <div onclick="loadRequestsSection()" class="shortcut-card" style="cursor: pointer; background-color: rgba(0, 0, 0, 0.4); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 209, 255, 0.3);">
                <div style="font-size: 3rem; margin-bottom: 15px;">📋</div>
                <h3>Requests</h3><p style="color: #ccc;">Click to view all requests.</p>
            </div>
            <div onclick="loadNotificationsSection()" class="shortcut-card" style="cursor: pointer; background-color: rgba(0, 0, 0, 0.4); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 209, 255, 0.3);">
                <div style="font-size: 3rem; margin-bottom: 15px;">🔔</div>
                <h3>Notifications</h3><p style="color: #ccc;">Click to manage notifications.</p>
            </div>
        </div>
    `;
        }

        function loadRequestsSection() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <button onclick="loadAssetsSection()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer;">← Back to Assets Management</button>
                <h2>📋 My Approved Requests</h2>
                <div style="margin-bottom: 20px;">
                    <button onclick="refreshAllRequests()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">🔄 Refresh</button>
                    <button onclick="exportAllRequests()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">📥 Export</button>
                </div>
                <div style="margin-bottom: 20px;">
                    <div class="search-bar-container">
                        <input type="text" id="requestSearch" placeholder="Search my approved requests..." oninput="filterRequests()" style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white;">
                    </div>
                </div>
                <div id="allRequestsContainer">
                    <p style="text-align:center; color: #ccc;">Loading all requests...</p>
                </div>
            `;
            loadAllRequests();
        }

        // Global variable to store all requests
        let allRequestsData = [];

        async function loadAllRequests() {
            try {
                const response = await fetch('/api/my_approved_requests');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allRequestsData = data.requests || [];
                    displayAllRequests(allRequestsData);
                } else {
                    document.getElementById('allRequestsContainer').innerHTML = `
                        <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                            <p>❌ Error loading requests: ${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading all requests:', error);
                document.getElementById('allRequestsContainer').innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                        <p>❌ Error loading requests. Please try again.</p>
                    </div>
                `;
            }
        }

        function displayAllRequests(requests) {
            const container = document.getElementById('allRequestsContainer');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #ccc; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">📋</div>
                        <h3>No Approved Requests Found</h3>
                        <p>You haven't approved any requests yet.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #00d1ff; margin-bottom: 15px;">📊 Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(0,209,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #00d1ff;">${requests.length}</div>
                            <div style="color: #ccc; font-size: 0.9rem;">Total Approved</div>
                        </div>
                        <div style="background: rgba(40,167,69,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #28a745;">${requests.filter(r => r.status === 'Completed').length}</div>
                            <div style="color: #ccc; font-size: 0.9rem;">Completed</div>
                        </div>
                        <div style="background: rgba(220,53,69,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #dc3545;">${requests.filter(r => r.status === 'Rejected').length}</div>
                            <div style="color: #ccc; font-size: 0.9rem;">Rejected</div>
                        </div>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden;">
                        <thead>
                            <tr style="background: rgba(0,209,255,0.2);">
                                <th style="padding: 15px; text-align: left; color: #00d1ff; border-bottom: 1px solid rgba(0,209,255,0.3);">ID</th>
                                <th style="padding: 15px; text-align: left; color: #00d1ff; border-bottom: 1px solid rgba(0,209,255,0.3);">Date</th>
                                <th style="padding: 15px; text-align: left; color: #00d1ff; border-bottom: 1px solid rgba(0,209,255,0.3);">Indenter</th>
                                <th style="padding: 15px; text-align: left; color: #00d1ff; border-bottom: 1px solid rgba(0,209,255,0.3);">Team Lead</th>
                                <th style="padding: 15px; text-align: left; color: #00d1ff; border-bottom: 1px solid rgba(0,209,255,0.3);">Status</th>
                                <th style="padding: 15px; text-align: left; color: #00d1ff; border-bottom: 1px solid rgba(0,209,255,0.3);">Items</th>
                                <th style="padding: 15px; text-align: left; color: #00d1ff; border-bottom: 1px solid rgba(0,209,255,0.3);">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            requests.forEach(request => {
                const statusColor = getStatusColor(request.status);
                const itemsText = request.item_details && request.item_details.length > 0 
                    ? request.item_details.map(item => item.itemName || 'Unknown').join(', ')
                    : 'No items';
                
                html += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 15px; color: #fff;">#${request.id}</td>
                        <td style="padding: 15px; color: #ccc;">${request.request_date}</td>
                        <td style="padding: 15px; color: #fff;">${request.indenter_name}</td>
                        <td style="padding: 15px; color: #fff;">${request.team_lead_name}</td>
                        <td style="padding: 15px;">
                            <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                                ${request.status}
                            </span>
                        </td>
                        <td style="padding: 15px; color: #ccc; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${itemsText}">
                            ${itemsText}
                        </td>
                        <td style="padding: 15px;">
                            <button onclick="viewRequestDetails(${request.id})" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                👁️ View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function getStatusColor(status) {
            const statusColors = {
                'Pending TL Approval': '#ffc107',
                'Pending Procurement Approval': '#17a2b8',
                'Pending TL Final Approval': '#ffc107',
                'Pending Director Approval': '#6f42c1',
                'Pending managing director Approval': '#fd7e14',
                'Pending Procurement Type Approval': '#17a2b8',
                'Pending Accounts Approval': '#20c997',
                'Pending Final Delivery': '#6c757d',
                'Completed': '#28a745',
                'Rejected': '#dc3545'
            };
            return statusColors[status] || '#6c757d';
        }

        function filterRequests() {
            const searchTerm = document.getElementById('requestSearch').value.toLowerCase();
            
            let filteredRequests = allRequestsData.filter(request => {
                const matchesSearch = !searchTerm || 
                    (request.indenter_name && request.indenter_name.toLowerCase().includes(searchTerm)) ||
                    (request.item_details && request.item_details.some(item => 
                        item.itemName && item.itemName.toLowerCase().includes(searchTerm)
                    ));
                
                return matchesSearch;
            });
            
            displayAllRequests(filteredRequests);
        }

        function refreshAllRequests() {
            document.getElementById('allRequestsContainer').innerHTML = '<p style="text-align:center; color: #ccc;">Loading all requests...</p>';
            loadAllRequests();
        }

        function exportAllRequests() {
            if (!allRequestsData || allRequestsData.length === 0) {
                alert('No requests to export.');
                return;
            }
            
            const csv = generateRequestsCSV(allRequestsData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `approved_requests_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function generateRequestsCSV(requests) {
            const headers = ['ID', 'Date', 'Indenter', 'Team Lead', 'Status', 'Items', 'Justification', 'Procurement Type'];
            const rows = requests.map(request => {
                const itemsText = request.item_details && request.item_details.length > 0 
                    ? request.item_details.map(item => item.itemName || 'Unknown').join('; ')
                    : 'No items';
                
                return [
                    request.id,
                    request.request_date,
                    request.indenter_name,
                    request.team_lead_name,
                    request.status,
                    itemsText,
                    request.justification || '',
                    request.procurement_type || ''
                ];
            });
            
            return [headers, ...rows].map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        }

        async function viewRequestDetails(requestId) {
            try {
                const response = await fetch(`/api/asset_requests/${requestId}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const request = result.request;
                    
                    // Create a modal or detailed view
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                        align-items: center; justify-content: center; padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: #1a1a1a; border-radius: 10px; padding: 30px; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto; border: 1px solid #333;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="color: #00d1ff; margin: 0;">Request Details #${request.id}</h2>
                                <button onclick="this.closest('.modal').remove()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">✕ Close</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <h4 style="color: #00d1ff; margin-bottom: 10px;">Basic Information</h4>
                                    <p><strong>Date:</strong> ${request.request_date}</p>
                                    <p><strong>Indenter:</strong> ${request.indenter_name}</p>
                                    <p><strong>Team Lead:</strong> ${request.team_lead_name}</p>
                                    <p><strong>Status:</strong> <span style="background: ${getStatusColor(request.status)}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">${request.status}</span></p>
                                </div>
                                <div>
                                    <h4 style="color: #00d1ff; margin-bottom: 10px;">Approval Details</h4>
                                    <p><strong>Procurement Type:</strong> ${request.procurement_type || 'Not specified'}</p>
                                    <p><strong>Director PI:</strong> ${request.director_pi_approval ? '✅ Approved' : '❌ Not approved'}</p>
                                    <p><strong>Director PD:</strong> ${request.director_pd_approval ? '✅ Approved' : '❌ Not approved'}</p>
                                    <p><strong>Director Chairman:</strong> ${request.director_chairman_approval ? '✅ Approved' : '❌ Not approved'}</p>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #00d1ff; margin-bottom: 10px;">Items Requested</h4>
                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px;">
                                    ${request.item_details && request.item_details.length > 0 
                                        ? request.item_details.map(item => `
                                            <div style="border-bottom: 1px solid #333; padding: 10px 0;">
                                                <strong>${item.itemName || 'Unknown Item'}</strong><br>
                                                <small style="color: #ccc;">Quantity: ${item.quantity || 'N/A'} | Specification: ${item.specification || 'N/A'}</small>
                                            </div>
                                        `).join('')
                                        : '<p style="color: #ccc;">No items specified</p>'
                                    }
                                </div>
                            </div>
                            
                            ${request.justification ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #00d1ff; margin-bottom: 10px;">Justification</h4>
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; color: #ccc;">
                                        ${request.justification}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${request.director_comments ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #00d1ff; margin-bottom: 10px;">Director Comments</h4>
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; color: #ccc;">
                                        ${request.director_comments}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${request.md_comments ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #00d1ff; margin-bottom: 10px;">Managing Director Comments</h4>
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; color: #ccc;">
                                        ${request.md_comments}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    modal.className = 'modal';
                    document.body.appendChild(modal);
                    
                    // Close modal when clicking outside
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                    
                } else {
                    alert('Error loading request details: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading request details:', error);
                alert('Error loading request details. Please try again.');
            }
        }

        function loadAssetList() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="loadAssetsSection()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer;">← Back to Assets Management</button>
            <button onclick="showAddAssetForm()" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);">+ Add New Asset</button>
        </div>
        <h2 style="margin-bottom: 20px;">Assets List</h2>
        <div class="search-bar-container">
            <input type="text" id="assetSearch" placeholder="Search for assets by name or tag..." oninput="filterAssets()">
            <button class="filter-button" onclick="toggleFilters()">Filters ▼</button>
        </div>
        <div id="filterOptions" class="filter-options" style="display: none;">
            <div class="filter-dropdown">
                <label for="assignedToFilter">Assigned to:</label>
                <select id="assignedToFilter" onchange="applyFilters()">
                    <option value="">All</option>
                </select>
            </div>
            <div class="filter-dropdown">
                <label for="purchasedFromFilter">Purchased from:</label>
                <select id="purchasedFromFilter" onchange="applyFilters()">
                    <option value="">All</option>
                </select>
            </div>
        </div>
        <div id="assetsListContainer" class="assets-list-container">
            <p style="text-align:center; color: #ccc;">Loading assets...</p>
        </div>
        <div id="addAssetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.65); justify-content: center; align-items: center; z-index: 9999;">
            <div style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 500px; box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);">
                <h3 style="margin-bottom: 20px; color: #fff;">Add New Asset</h3>
                <div class="salaries-field-group" style="margin-bottom: 15px;">
                    <label for="assetName" style="margin-bottom: 5px;">Asset Name *</label>
                    <input type="text" id="assetName" placeholder="e.g., Dell XPS 15">
                </div>
                <div class="salaries-field-group" style="margin-bottom: 15px;">
                    <label for="assetTag" style="margin-bottom: 5px;">Asset Tag *</label>
                    <input type="text" id="assetTag" placeholder="e.g., SOFTSOL-LAP-001">
                </div>
                <div class="salaries-field-group" style="margin-bottom: 15px;">
                    <label for="assetOwner" style="margin-bottom: 5px;">Assigned To</label>
                    <select id="assetOwner" style="width: 100%; padding: 10px; border-radius: 5px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;"></select>
                </div>
                <div class="salaries-field-group" style="margin-bottom: 15px;">
                    <label for="purchaseDate" style="margin-bottom: 5px;">Purchase Date</label>
                    <input type="date" id="purchaseDate">
                </div>
                <div class="salaries-field-group" style="margin-bottom: 15px;">
                    <label for="warrantyEnd" style="margin-bottom: 5px;">Warranty End Date</label>
                    <input type="date" id="warrantyEnd">
                </div>
                <div class="salaries-field-group" style="margin-bottom: 15px;">
                    <label for="assetCondition" style="margin-bottom: 5px;">Condition</label>
                    <select id="assetCondition" style="width: 100%; padding: 10px; border-radius: 5px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                        <option value="new">New</option>
                        <option value="used">Used</option>
                        <option value="damaged">Damaged</option>
                    </select>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button onclick="hideAddAssetForm()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button onclick="submitAddAssetForm()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">Save Asset</button>
                </div>
            </div>
        </div>
    `;
            fetchAssets();
            populateAssetOwnerDropdown();
        }

        async function populateAssetOwnerDropdown() {
            // This function is a placeholder for now. It will eventually fetch users from your Flask API.
            console.log("Populating asset owner dropdown...");
            const ownerSelect = document.getElementById('assetOwner');
            ownerSelect.innerHTML = `<option value="">Unassigned</option>`;

            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                if (data.status === 'success' && data.users) {
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.name;
                        option.textContent = user.name;
                        ownerSelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.error("Error fetching users for dropdown:", e);
                ownerSelect.innerHTML = `<option value="">Error loading users</option>`;
            }
        }

        // Renamed and updated fetchAssets function
        async function fetchAssets() {
            const assetsListContainer = document.getElementById('assetsListContainer');
            assetsListContainer.innerHTML = '<p style="text-align:center; color: #ccc;">Loading assets from Firebase...</p>';
            allAssets = []; // Clear previous assets
            try {
                const assetsCollection = db.collection('assigned_assets');
                const snapshot = await assetsCollection.get();

                if (snapshot.empty) {
                    assetsListContainer.innerHTML = `<p style="text-align: center; color: #ccc;">No assets found.</p>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const asset = doc.data();
                    allAssets.push({ id: doc.id, ...asset });
                });

                renderAssets(allAssets); // Render all assets initially
            } catch (error) {
                console.error('Error fetching assets from Firebase:', error);
                assetsListContainer.innerHTML = '<p style="text-align:center; color:red;">Failed to fetch assets. Check console for details.</p>';
            }
        }

        // New function to filter and render assets
        function filterAssets() {
            const searchTerm = document.getElementById('assetSearch').value.toLowerCase();
            const filteredAssets = allAssets.filter(asset =>
                (asset.assetName && asset.assetName.toLowerCase().includes(searchTerm)) ||
                (asset.serialNumber && asset.serialNumber.toLowerCase().includes(searchTerm))
            );
            renderAssets(filteredAssets);
        }

        // New function to render the assets in the new UI
        function renderAssets(assetsToRender) {
            const assetsListContainer = document.getElementById('assetsListContainer');
            assetsListContainer.innerHTML = '';

            if (assetsToRender.length === 0) {
                assetsListContainer.innerHTML = `<p style="text-align: center; color: #ccc;">No assets found matching your search.</p>`;
                return;
            }

            assetsToRender.forEach(asset => {
                assetsListContainer.insertAdjacentHTML('beforeend', buildAssetCard(asset));
            });
        }

        // New function to build the HTML for an individual asset card
        // New function to build the HTML for an individual asset card
        function buildAssetCard(asset) {
            const assetId = asset.id;
            return `
        <div class="asset-item-card" id="asset-card-${assetId}">
            <div class="asset-header" onclick="toggleAssetDetails('${assetId}')">
                <span>${asset.assetName || 'N/A'}</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>Tag: ${asset.serialNumber || 'N/A'}</span>
                    <span class="toggle-icon">▶</span>
                </div>
            </div>
            <div class="asset-details" id="details-${assetId}">
                <p><strong>Assigned to:</strong> ${asset.assignedTo || 'Unassigned'}</p>
                <p><strong>Cost (with GST):</strong> ${asset.costGst ? `₹${asset.costGst}` : 'N/A'}</p>
                <p><strong>Invoice Number:</strong> ${asset.invoiceNumber || 'N/A'}</p>
                <p><strong>Purchased From:</strong> ${asset.purchasedThrough || 'N/A'}</p>
                <p><strong>Purchase Date:</strong> ${asset.inventoryDate || 'N/A'}</p>
                <p><strong>Location:</strong> ${asset.location || 'N/A'}</p>
                <p><strong>Vendor:</strong> ${asset.vendorName || 'N/A'}</p>
                <p><strong>Payment Mode:</strong> ${asset.paymentMode || 'N/A'}</p>
                <p><strong>Quantity:</strong> ${asset.quantity || 'N/A'}</p>
                <p><strong>Remarks:</strong> ${asset.remarks || 'N/A'}</p>
                <p><strong>Warranty End:</strong> ${asset.warrantyEnd || 'N/A'}</p>
                <p><strong>Condition:</strong> ${asset.condition || 'N/A'}</p>
                <div style="margin-top: 15px; text-align: right;">
                    <button onclick="deleteAsset('${assetId}')">Delete</button>
                </div>
            </div>
        </div>
    `;
        }

        // New function to toggle the visibility of asset details
        function toggleAssetDetails(cardId) {
            const detailsElement = document.getElementById(`details-${cardId}`);
            const headerElement = document.getElementById(`asset-card-${cardId}`).querySelector('.asset-header');

            if (detailsElement.style.display === 'block') {
                detailsElement.style.display = 'none';
                headerElement.classList.remove('expanded');
            } else {
                detailsElement.style.display = 'block';
                headerElement.classList.add('expanded');
            }
        }

        function showAddAssetForm() {
            document.getElementById('addAssetModal').style.display = 'flex';
        }

        function hideAddAssetForm() {
            document.getElementById('addAssetModal').style.display = 'none';
        }

        async function submitAddAssetForm() {
            const name = document.getElementById('assetName').value.trim();
            const tag = document.getElementById('assetTag').value.trim();
            const owner = document.getElementById('assetOwner').value;
            const purchaseDate = document.getElementById('purchaseDate').value;
            const warrantyEnd = document.getElementById('warrantyEnd').value;
            const condition = document.getElementById('assetCondition').value;

            if (!name || !tag) {
                alert("Asset Name and Asset Tag are required.");
                return;
            }

            try {
                await db.collection('assigned_assets').add({
                    assetName: name,
                    serialNumber: tag,
                    assignedTo: owner,
                    inventoryDate: purchaseDate,
                    warrantyEnd: warrantyEnd,
                    condition: condition,
                    cost: 'N/A',
                    invoiceNumber: 'N/A',
                    location: 'N/A',
                    paymentMode: 'N/A',
                    purchasedThrough: 'N/A',
                    quantity: 'N/A'
                });
                alert('Asset added successfully!');
                hideAddAssetForm();
                loadAssetList(); // Refresh the list
            } catch (error) {
                console.error('Error adding asset to Firebase:', error);
                alert('Failed to add asset. Check console for details.');
            }
        }

        async function deleteAsset(docId) {
            if (!confirm(`Are you sure you want to delete this asset? This cannot be undone.`)) {
                return;
            }

            try {
                await db.collection('assigned_assets').doc(docId).delete();
                alert('Asset deleted successfully!');
                loadAssetList(); // Refresh the list
            } catch (error) {
                console.error('Error deleting asset from Firebase:', error);
                alert('Failed to delete asset. Check console for details.');
            }
        }

        // // === Indents Module ===
        // function loadIndentsSection() {
        //     const mainContent = document.getElementById('mainContent');
        //     mainContent.innerHTML = `
        //         <h2 style="margin-bottom: 20px;">📝 Indents Management</h2>
        //         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        //             <button onclick="loadAssetsSection()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer;">← Back to Assets Management</button>
        //             <button onclick="showCreateIndentForm()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">+ Create New Indent</button>
        //         </div>
        //         <div id="indentsListContainer">
        //             <p style="text-align: center; color: #ccc;">No indents found.</p>
        //         </div>
        //     `;
        // }

        // function showCreateIndentForm() {
        //     // This function will render a form to create a new indent
        //     alert("Function to create new indent is not yet implemented.");
        // }

        function loadSubSection_Assets(subsection) {
            if (subsection === 'Indents') {
                loadIndentsSection(); // This function now lives in scripts.js
            } else if (subsection === 'AssetsList') {
                // The logic for loading the asset list is already in dashboard.html
                loadAssetList();
            } else if (subsection === 'Notifications') {
                // You can create a loadNotificationsSection() in scripts.js for this
                document.getElementById('mainContent').innerHTML = `<h2>🔔 Notifications</h2><p>Notifications content goes here.</p>`;
            }
        }

        // New function to toggle the filter options visibility
        function toggleFilters() {
            const filterOptions = document.getElementById('filterOptions');
            filterOptions.style.display = filterOptions.style.display === 'flex' ? 'none' : 'flex';
        }

        // Updated fetchAssets function to populate filter dropdowns
        async function fetchAssets() {
            const assetsListContainer = document.getElementById('assetsListContainer');
            assetsListContainer.innerHTML = '<p style="text-align:center; color: #ccc;">Loading assets from Firebase...</p>';
            allAssets = []; // Clear previous assets

            try {
                const assetsCollection = db.collection('assigned_assets');
                const snapshot = await assetsCollection.get();

                if (snapshot.empty) {
                    assetsListContainer.innerHTML = `<p style="text-align: center; color: #ccc;">No assets found.</p>`;
                    return;
                }

                snapshot.forEach(doc => {
                    allAssets.push({ id: doc.id, ...doc.data() });
                });

                // Populate filter dropdowns with unique values
                populateFilterDropdowns(allAssets);

                renderAssets(allAssets); // Render all assets initially
            } catch (error) {
                console.error('Error fetching assets from Firebase:', error);
                assetsListContainer.innerHTML = '<p style="text-align:center; color:red;">Failed to fetch assets. Check console for details.</p>';
            }
        }

        // New function to populate filter dropdowns
        function populateFilterDropdowns(assets) {
            const assignedToFilter = document.getElementById('assignedToFilter');
            const purchasedFromFilter = document.getElementById('purchasedFromFilter');

            // Get unique values for Assigned To and Purchased From
            const assignedToList = [...new Set(assets.map(a => a.assignedTo).filter(Boolean))];
            const purchasedFromList = [...new Set(assets.map(a => a.purchasedThrough).filter(Boolean))];

            // Clear existing options and add 'All'
            assignedToFilter.innerHTML = '<option value="">All</option>';
            purchasedFromFilter.innerHTML = '<option value="">All</option>';

            // Add new options to the dropdowns
            assignedToList.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                assignedToFilter.appendChild(option);
            });

            purchasedFromList.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                purchasedFromFilter.appendChild(option);
            });
        }

        // Updated filterAssets function to handle both search and dropdown filters
        function filterAssets() {
            const searchTerm = document.getElementById('assetSearch').value.toLowerCase();
            const assignedTo = document.getElementById('assignedToFilter').value;
            const purchasedFrom = document.getElementById('purchasedFromFilter').value;

            const filteredAssets = allAssets.filter(asset => {
                const matchesSearch = (asset.assetName && asset.assetName.toLowerCase().includes(searchTerm)) ||
                    (asset.serialNumber && asset.serialNumber.toLowerCase().includes(searchTerm));
                const matchesAssignedTo = assignedTo === '' || asset.assignedTo === assignedTo;
                const matchesPurchasedFrom = purchasedFrom === '' || asset.purchasedThrough === purchasedFrom;

                return matchesSearch && matchesAssignedTo && matchesPurchasedFrom;
            });

            renderAssets(filteredAssets);
        }

        // New function to apply filters from dropdowns
        function applyFilters() {
            // This function is the same as filterAssets, but named for clarity.
            // It is called by the `onchange` event of the filter dropdowns.
            filterAssets();
        }




        //support function
        //support function

        function loadSupportSection() {
            const html = `
    <h2 style="margin-bottom: 20px; flex-shrink: 0;">💬 Support</h2>
    
    <div class="query-box">
        <form id="supportQueryForm">
            <textarea id="supportQueryText" placeholder="Type your query here..."></textarea>
            <button type="submit" class="submit-btn">Send Query</button>
        </form>
    </div>

    <div class="faq-section">
        <h3 style="text-align: center; color: #00d1ff; margin-bottom: 20px;">Frequently Asked Questions</h3>
        <div class="faq-container">
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>1. What is the purpose of this ERP system?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>This ERP (Enterprise Resource Planning) platform centralizes company operations, enabling efficient management of users, attendance, teams, roles, salaries, assets, billing, and support—all from a single dashboard.</p></div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>2. Who can use the ERP system?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>Only authorized employees with valid login credentials can access the ERP. Access levels and permissions are controlled through role-based authentication.</p></div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>3. How is attendance managed in the system?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>Attendance can be marked manually or through integrated attendance systems. Admins and authorized managers can view, edit, and generate attendance reports.</p></div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>4. How are salaries handled?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>The Salaries module allows payroll teams to calculate, manage, and disburse employee salaries. It also maintains payment records for future reference.</p></div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>5. Can I manage company assets here?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>Yes. The Assets module lets you track company-owned assets, assign them to employees, and maintain their lifecycle history.</p></div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>6. What is the Billing module used for?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>The Billing section handles client invoices, payments, and expense tracking to streamline financial management.</p></div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>7. How does role management work?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>The Roles module assigns specific access permissions and functionalities to different users, ensuring data security and workflow control.</p></div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>8. How can I raise a support request?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>Use the Support module to submit technical or operational issues. The support team will address your request as per company SLA.</p></div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>9. Can I customize settings in the ERP?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>Yes. The Settings module lets you configure system preferences, notification settings, and other custom parameters.</p></div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>10. Is my data secure in this ERP?</span><span class="faq-toggle">▼</span>
                </div>
                <div class="faq-answer"><p>Yes. The ERP uses role-based access control, encrypted data storage, and secure login protocols to ensure that sensitive business data remains protected.</p></div>
            </div>

        </div>
    </div>
    `;
            document.getElementById('mainContent').innerHTML = html;

            document.getElementById('supportQueryForm').addEventListener('submit', function (event) {
                event.preventDefault();
                const queryText = document.getElementById('supportQueryText').value;
                if (queryText.trim() === "") {
                    alert("Please enter your query before sending.");
                    return;
                }
                const subject = "New Support Query from ERP Dashboard";
                const body = encodeURIComponent(queryText);
                window.location.href = `mailto:admin@ssev.co.in?subject=${subject}&body=${body}`;
            });
        }
        function toggleFaq(element) {
            const answer = element.nextElementSibling;
            element.classList.toggle('active');

            if (answer.style.maxHeight) {
                answer.style.maxHeight = null;
                answer.style.padding = "0 20px";
            } else {
                answer.style.padding = "0 20px";
                // Add a little extra height (40px) to account for the top/bottom padding inside the <p> tag
                answer.style.maxHeight = answer.scrollHeight + 40 + "px";
            }
        }
        //reports function

        // ========= Reports Section =========
        function loadReportsSection() {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="reports-container">
            <h2>Reports</h2>
            <p style="color:#ccc; text-align:center;">Generate a PDF report of the attendance data.</p>
            <div class="report-field-group">
                <label for="reportType">Choose Report Type:</label>
                <select id="reportType" onchange="updateReportUI()">
                    <option value="day">Day-wise</option>
                    <option value="month">Month-wise</option>
                    <option value="year">Year-wise</option>
                </select>
            </div>

            <div id="day-picker-container" class="report-field-group">
                <label for="reportDate">Choose Date:</label>
                <input type="date" id="reportDate">
            </div>

            <div id="month-picker-container" class="report-field-group hidden">
                <label for="monthStartDate">Select Date Range (within month):</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="date" id="monthStartDate">
                    <span>to</span>
                    <input type="date" id="monthEndDate">
                </div>
            </div>

            <div id="year-picker-container" class="report-field-group hidden">
                <label for="reportYear">Select Year:</label>
                <select id="reportYear"></select>
            </div>

            <div class="report-actions">
                <button onclick="downloadReport('ssev')">Download SSEV Report</button>
                <button onclick="downloadReport('softsols')">Download SOFTSOLS Report</button>
            </div>
            
            <div id="pdf-output-container" style="margin-top: 30px;">
                <p style="text-align: center; color: #ccc;">Select a date and click "Load" in the Attendance section to preview the data for your report.</p>
                <div id="pdfContent"></div>
            </div>
        </div>
    `;

    populateYearPicker();
    updateReportUI();
}

// ---------- Helpers ----------
if (typeof fmtTime !== 'function') {
    // Fallback if not already defined elsewhere
    function fmtTime(ts) {
        if (!ts) return '—';
        try {
            const d = (ts.seconds) ? new Date(ts.seconds * 1000) : new Date(ts);
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            const ss = String(d.getSeconds()).padStart(2, '0');
            return `${hh}:${mm}:${ss}`;
        } catch (e) {
            return '—';
        }
    }
}

function updateReportUI() {
    const reportType = document.getElementById('reportType').value;
    const dayPicker = document.getElementById('day-picker-container');
    const monthPicker = document.getElementById('month-picker-container');
    const yearPicker = document.getElementById('year-picker-container');

    dayPicker.classList.add('hidden');
    monthPicker.classList.add('hidden');
    yearPicker.classList.add('hidden');

    if (reportType === 'day') {
        dayPicker.classList.remove('hidden');
    } else if (reportType === 'month') {
        monthPicker.classList.remove('hidden');
    } else if (reportType === 'year') {
        yearPicker.classList.remove('hidden');
    }
}

function populateYearPicker() {
    const yearSelect = document.getElementById('reportYear');
    if (!yearSelect) return;
    const currentYear = new Date().getFullYear();
    yearSelect.innerHTML = '';
    for (let i = 0; i < 10; i++) {
        const year = currentYear - i;
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
}

// ---------- PDF (html2canvas + jsPDF with pagination) ----------
async function generatePDFFromTable(elementId, filename, fontSize = '16px') {
    const element = document.getElementById(elementId);

    // Create a clean printable container
    const printableContainer = document.createElement('div');
    printableContainer.style.fontFamily = 'Helvetica, Arial, sans-serif';
    printableContainer.style.fontSize = fontSize;
    printableContainer.style.padding = '20px';
    printableContainer.style.color = '#000';

    const style = document.createElement('style');
    style.textContent = `
  #print-root h1 { margin:0 0 12px; font-size: 24px; text-align:center; }
  #print-root table { border-collapse: collapse; width: 100%; font-size: 15px; } /* was 13px */
  #print-root th, #print-root td { border:1px solid #444; padding:10px 12px; text-align:left; } /* more padding helps legibility */
  #print-root thead th { background:#efefef; font-size: 16px; } /* was 14px */
  #print-root tbody tr:nth-child(even) { background:#fafafa; }
`;

    printableContainer.appendChild(style);

    const root = document.createElement('div');
    root.id = 'print-root';
    root.innerHTML = element.innerHTML;
    printableContainer.appendChild(root);

    document.body.appendChild(printableContainer);

    try {
        const canvas = await html2canvas(printableContainer, {
            scale: 3,
            useCORS: true,
            backgroundColor: '#ffffff'
        });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4', true);

        const reportTitleElement = document.getElementById('reportTitle');
        const title = reportTitleElement ? reportTitleElement.textContent : 'Attendance Report';

        const marginTop = 20;
        const marginLeft = 10;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        pdf.setFontSize(18);
        pdf.text(title, pageWidth / 2, 15, { align: 'center' });

        const imgWidth = pageWidth - marginLeft * 2;
        const ratio = imgWidth / canvas.width;
        const slicePixelHeight = Math.floor((pageHeight - marginTop - 8) / ratio);

        let sy = 0;
        let firstPage = true;

        while (sy < canvas.height) {
            const sh = Math.min(slicePixelHeight, canvas.height - sy);
            const sliceCanvas = document.createElement('canvas');
            sliceCanvas.width = canvas.width;
            sliceCanvas.height = sh;
            const ctx = sliceCanvas.getContext('2d');
            ctx.drawImage(canvas, 0, sy, canvas.width, sh, 0, 0, canvas.width, sh);
            const imgData = sliceCanvas.toDataURL('image/png');

            if (!firstPage) {
                pdf.addPage();
                pdf.setFontSize(14);
                pdf.text(title, pageWidth / 2, 12, { align: 'center' });
            }

            const drawHeight = sh * ratio;
            const y = firstPage ? marginTop : 16;
            pdf.addImage(imgData, 'PNG', marginLeft, y, imgWidth, drawHeight, undefined, 'FAST');

            firstPage = false;
            sy += sh;
        }

        pdf.save(filename);
        alert(`✅ ${filename} downloaded successfully!`);
    } catch (error) {
        console.error("PDF generation failed:", error);
        alert("❌ Failed to generate PDF. Please check the console for errors.");
    } finally {
        document.body.removeChild(printableContainer);
    }
}

async function downloadReport(type) {
    const reportType = document.getElementById('reportType').value;
    let selectedValue = '';
    let reportTitle = '';
    let dateRange = '';

    if (reportType === 'day') {
        selectedValue = document.getElementById('reportDate').value;
        if (!selectedValue) {
            alert('Please select a date.');
            return;
        }
        reportTitle = `${type.toUpperCase()} • Day-wise Attendance Report • ${selectedValue}`;
        dateRange = selectedValue;
    } else if (reportType === 'month') {
        const startDate = document.getElementById('monthStartDate').value;
        const endDate = document.getElementById('monthEndDate').value;
        if (!startDate || !endDate) {
            alert('Please select a start and end date (within the same month).');
            return;
        }
        const [y, m] = startDate.split('-');
        selectedValue = `${y}-${m}`;
        reportTitle = `${type.toUpperCase()} • Month-wise Attendance Report • ${startDate} to ${endDate}`;
        dateRange = `${startDate} to ${endDate}`;
    } else if (reportType === 'year') {
        selectedValue = document.getElementById('reportYear').value;
        if (!selectedValue) {
            alert('Please select a year.');
            return;
        }
        reportTitle = `${type.toUpperCase()} • Year-wise Attendance Report • ${selectedValue}`;
        dateRange = selectedValue;
    }

    const data = await fetchReportData(reportType, selectedValue, dateRange);

    // 🔹 Branch filter
    let branchFilter = '';
    if (type === 'ssev') branchFilter = 'SSEV';
    if (type === 'softsols') branchFilter = 'SSEVSOFTSOLS';
    const filteredData = data.filter(r => (r.branch || '').toUpperCase() === branchFilter);

    const pdfContainer = document.createElement('div');
    pdfContainer.id = 'pdf-content-container';
    pdfContainer.style.position = 'absolute';
    pdfContainer.style.left = '-9999px';
    pdfContainer.style.top = '0';
    document.body.appendChild(pdfContainer);

    let tableHtml = '';
    if (filteredData.length > 0) {
        tableHtml = `
            <table id="report-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Date</th>
                        <th>Branch</th>
                        <th>Designation</th>
                        <th>Check-In</th>
                        <th>Check-Out</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredData.map(r => `
                        <tr>
                            <td>${r.name}</td>
                            <td>${r.date || 'N/A'}</td>
                            <td>${r.branch}</td>
                            <td>${r.designation}</td>
                            <td>${r.checkin}</td>
                            <td>${r.checkout}</td>
                            <td>${r.status}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
    } else {
        tableHtml = `<p style="text-align: center;">No attendance records found for ${branchFilter} in this period.</p>`;
    }

    pdfContainer.innerHTML = `
        <h1 id="reportTitle" style="text-align:center;">${reportTitle}</h1>
        ${tableHtml}
    `;

    const filename = `${type}_${reportType}_report_${selectedValue}.pdf`;
    await generatePDFFromTable('pdf-content-container', filename);
    document.body.removeChild(pdfContainer);
}

// ---------- Data fetchers ----------
async function fetchReportData(reportType, selectedValue, dateRange) {
    const rows = [];
    const monthNames = ["january","february","march","april","may","june","july","august","september","october","november","december"];

    // Normalize helper to month collection name
    function monthCollectionName(yyyy_mm) {
        const [year, monthStr] = yyyy_mm.split('-');
        const idx = parseInt(monthStr, 10) - 1;
        const monthString = monthNames[idx];
        return `${monthString}_${year}`;
    }

    if (reportType === 'day') {
        const [year, month] = selectedValue.split('-');
        const coll = monthCollectionName(`${year}-${month}`);
        const snap = await dbAttendance.collection(coll).where('date_key', '==', selectedValue).get();

        snap.forEach(doc => {
            const d = doc.data();
            const checkIn = d.check_in || null;
            const checkOut = d.check_out || null;
            let status = '—';
            if (checkOut) status = 'Checked Out';
            else if (checkIn) status = d.late ? 'Late' : 'On Duty';

            rows.push({
                name: d.Name || d.name || '—',
                branch: d.Branch || d.branch || '—',
                designation: d.Designation || d.designation || '—',
                checkin: fmtTime(checkIn),
                checkout: fmtTime(checkOut),
                status,
                date: d.date_key || selectedValue
            });
        });

    } else if (reportType === 'month') {
        // dateRange = "YYYY-MM-DD to YYYY-MM-DD"
        const [start, end] = dateRange.split(' to ').map(s => s.trim());
        const [sy, sm] = start.split('-');
        const [ey, em] = end.split('-');

        // safety: ensure same month/year
        if (sy !== ey || sm !== em) {
            console.warn('Month-wise report expects a range within the same month.');
        }

        const coll = monthCollectionName(`${sy}-${sm}`);
        const snap = await dbAttendance.collection(coll).get();

        snap.forEach(doc => {
            const d = doc.data();
            const dk = d.date_key; // "YYYY-MM-DD"
            if (!dk) return;
            if (dk >= start && dk <= end) {
                const checkIn = d.check_in || null;
                const checkOut = d.check_out || null;
                let status = '—';
                if (checkOut) status = 'Checked Out';
                else if (checkIn) status = d.late ? 'Late' : 'On Duty';

                rows.push({
                    name: d.Name || d.name || '—',
                    branch: d.Branch || d.branch || '—',
                    designation: d.Designation || d.designation || '—',
                    checkin: fmtTime(checkIn),
                    checkout: fmtTime(checkOut),
                    status,
                    date: dk
                });
            }
        });

    } else if (reportType === 'year') {
        const year = selectedValue;
        for (let i = 0; i < 12; i++) {
            const monthNum = String(i + 1).padStart(2, '0');
            const coll = monthCollectionName(`${year}-${monthNum}`);

            try {
                const snap = await dbAttendance.collection(coll).get();
                snap.forEach(doc => {
                    const d = doc.data();
                    const checkIn = d.check_in || null;
                    const checkOut = d.check_out || null;
                    let status = '—';
                    if (checkOut) status = 'Checked Out';
                    else if (checkIn) status = d.late ? 'Late' : 'On Duty';

                    rows.push({
                        name: d.Name || d.name || '—',
                        branch: d.Branch || d.branch || '—',
                        designation: d.Designation || d.designation || '—',
                        checkin: fmtTime(checkIn),
                        checkout: fmtTime(checkOut),
                        status,
                        date: d.date_key || `${year}-${monthNum}`
                    });
                });
            } catch (e) {
                // If a month collection doesn't exist, just skip it.
                console.warn(`No data for collection ${coll}`, e?.message || e);
            }
        }
    }

    // Sort: date asc, then name asc
    rows.sort((a, b) => {
        const dcmp = String(a.date || '').localeCompare(String(b.date || ''));
        if (dcmp !== 0) return dcmp;
        return String(a.name || '').localeCompare(String(b.name || ''));
    });

    return rows;
}
        // Add this new function within your existing <script> block
// Add this new function within your existing <script> block
function calculateSalaryComponents() {
    const grossSalaryInput = document.getElementById('addEmpGrossSalary');
    const basicInput = document.getElementById('addEmpBasic');
    const hraInput = document.getElementById('addEmpHra');
    const conveyanceInput = document.getElementById('addEmpConveyance');
    const specialAllowanceInput = document.getElementById('addEmpSpecialAllowance');
    const providentFundInput = document.getElementById('addEmpProvidentFund');
    const professionalTaxInput = document.getElementById('addEmpProfessionalTax');

    // Set fixed conveyance value
    const conveyance = 1600;
    conveyanceInput.value = conveyance.toFixed(2);

    const grossSalary = parseFloat(grossSalaryInput.value) || 0;

    if (grossSalary > 0) {
        // Calculate Basic (60% of gross salary)
        const basic = grossSalary * 0.60;
        basicInput.value = basic.toFixed(2);

        // Calculate HRA (40% of gross salary)
        const hra = basic * 0.40;
        hraInput.value = hra.toFixed(2);
        
        // Calculate Special Allowance using the corrected formula
        // Special Allowance = Annual Gross Salary - (Basic + HRA + Conveyance)
        const specialAllowance = grossSalary - (basic + hra + conveyance);
        specialAllowanceInput.value = specialAllowance.toFixed(2);

        // Calculate Provident Fund based on basic salary
        let providentFund = 0;
        if (basic >= 15000) {
            // If basic is 15000 or above, PF is 12% of 15000 only
            providentFund = 15000 * 0.12;
        } else {
            // If basic is below 15000, PF is 12% of basic amount
            providentFund = basic * 0.12;
        }
        providentFundInput.value = providentFund.toFixed(2);

        // Calculate Professional Tax based on gross salary
        let professionalTax = 0;
        if (grossSalary >= 15001 && grossSalary <= 20000) {
            professionalTax = 150;
        } else if (grossSalary > 20000) {
            professionalTax = 200;
        }
        professionalTaxInput.value = professionalTax.toFixed(2);

    } else {
        // Reset fields if gross salary is not a positive number
        basicInput.value = '0.00';
        hraInput.value = '0.00';
        specialAllowanceInput.value = '0.00';
        providentFundInput.value = '0.00';
        professionalTaxInput.value = '0.00';
    }
}
// Modify your existing loadAddEmployeeForm function
function loadAddEmployeeForm() {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <h2 style="margin-bottom: 20px;">➕ Add New Employee Info</h2>
        <div style="max-width: 800px; margin: 0 auto; background: rgba(0, 0, 0, 0.6); padding: 30px; border-radius: 12px; box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);">
            
            <div class="form-section">
                <h4>Personal Details</h4>
                <div class="form-fields-grid">
                    <div class="form-field-group">
                        <label for="addEmpFullName">Full Name *</label>
                        <input type="text" id="addEmpFullName" placeholder="Full Name">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpEmail">Email *</label>
                        <input type="email" id="addEmpEmail" placeholder="Email">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpEmployeeId">Employee ID</label>
                        <input type="text" id="addEmpEmployeeId" placeholder="e.g., SSDEV-01-001">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpDOB">Date of Birth</label>
                        <input type="date" id="addEmpDOB">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpPhoneNo">Phone Number</label>
                        <input type="tel" id="addEmpPhoneNo" placeholder="Phone Number">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpGender">Gender</label>
                        <input type="text" id="addEmpGender" placeholder="Gender">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpMaritalStatus">Marital Status</label>
                        <select id="addEmpMaritalStatus">
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                        </select>
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpDesignation">Designation</label>
                        <input type="text" id="addEmpDesignation" placeholder="Designation">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpProbationFrom">Probation Period From</label>
                        <input type="date" id="addEmpProbationFrom">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpProbationTo">Probation Period To</label>
                        <input type="date" id="addEmpProbationTo">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpInternshipFrom">Internship Period From</label>
                        <input type="date" id="addEmpInternshipFrom">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpInternshipTo">Internship Period To</label>
                        <input type="date" id="addEmpInternshipTo">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpDateOfJoining">Date of Joining</label>
                        <input type="date" id="addEmpDateOfJoining">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpConfirmationDate">Confirmation Date</label>
                        <input type="date" id="addEmpConfirmationDate">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpDateOfAnniversary">Date of Anniversary</label>
                        <input type="date" id="addEmpDateOfAnniversary">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpProbationSalary">Probation Salary</label>
                        <input type="text" id="addEmpProbationSalary" placeholder="Probation Salary">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpConfirmationSalary">Confirmation Salary</label>
                        <input type="text" id="addEmpConfirmationSalary" placeholder="Confirmation Salary">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpOfficeBranch">Office Branch</label>
                        <select id="addEmpOfficeBranch">
                            <option value="">-- Select Branch --</option>
                            <option value="SSEV">SSEV</option>
                            <option value="SSEV SOFTSOLS">SSEV SOFTSOLS</option>
                        </select>
                    </div>
                    <div class="form-field-group" style="grid-column: 1 / -1;">
                        <label for="addEmpAddress">Address</label>
                        <textarea id="addEmpAddress" placeholder="Address"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>Family Details</h4>
                <div class="form-fields-grid">
                    <div class="form-field-group">
                        <label for="addEmpFatherName">Father's Name</label>
                        <input type="text" id="addEmpFatherName" placeholder="Father's Name">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpFatherContact">Father's Contact</label>
                        <input type="tel" id="addEmpFatherContact" placeholder="Father's Contact">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpMotherName">Mother's Name</label>
                        <input type="text" id="addEmpMotherName" placeholder="Mother's Name">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpMotherContact">Mother's Contact</label>
                        <input type="tel" id="addEmpMotherContact" placeholder="Mother's Contact">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpEmergencyContactName">Emergency Contact Name</label>
                        <input type="text" id="addEmpEmergencyContactName" placeholder="Emergency Contact Name">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpEmergencyPhoneNumber">Emergency Phone Number</label>
                        <input type="tel" id="addEmpEmergencyPhoneNumber" placeholder="Emergency Phone Number">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpSpouseName">Spouse Name</label>
                        <input type="text" id="addEmpSpouseName" placeholder="Spouse Name">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpSpouseContactNumber">Spouse Contact Number</label>
                        <input type="tel" id="addEmpSpouseContactNumber" placeholder="Spouse Contact Number">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h4>Accounts Section</h4>
                <div class="form-fields-grid">
                    <div class="form-field-group">
                        <label for="addEmpPfNo">PF No</label>
                        <input type="text" id="addEmpPfNo" placeholder="e.g., PF/12345/678">
                    </div>
                    <div class="form-field-group" style="grid-column: 1 / -1;">
                        <label for="addEmpAccountNumber">Account Number</label>
                        <input type="text" id="addEmpAccountNumber" placeholder="e.g., 123456789012">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpGrossSalary">Actual Gross Salary</label>
                        <input type="number" id="addEmpGrossSalary" placeholder="e.g., 50000" oninput="calculateSalaryComponents()">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpBasic">Basic</label>
                        <input type="number" id="addEmpBasic" placeholder="e.g., 25000" readonly>
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpHra">HRA</label>
                        <input type="number" id="addEmpHra" placeholder="e.g., 10000" readonly>
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpConveyance">Conveyance</label>
                        <input type="number" id="addEmpConveyance" placeholder="e.g., 800" value="1600" readonly>
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpSpecialAllowance">Special Allowance</label>
                        <input type="number" id="addEmpSpecialAllowance" placeholder="e.g., 1000" readonly>
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpProvidentFund">Provident Fund</label>
                        <input type="number" id="addEmpProvidentFund" placeholder="e.g., 1800" readonly>
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpESI">ESI</label>
                        <input type="number" id="addEmpESI" placeholder="e.g., 500">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpProfessionalTax">Professional Tax</label>
                        <input type="number" id="addEmpProfessionalTax" placeholder="e.g., 200" readonly>
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpIncomeTax">Income Tax</label>
                        <input type="number" id="addEmpIncomeTax" placeholder="e.g., 1500">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpAdvance">Advance</label>
                        <input type="number" id="addEmpAdvance" placeholder="e.g., 2000">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpTotalLeaves">Total Leaves</label>
                        <input type="number" id="addEmpTotalLeaves" placeholder="e.g., 12">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h4>Educational & Document Details</h4>
                <div class="form-fields-grid">
                    <div class="form-field-group">
                        <label for="addEmp10thCGPA">10th CGPA</label>
                        <input type="text" id="addEmp10thCGPA" placeholder="10th CGPA">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpInterCGPA">Intermediate CGPA</label>
                        <input type="text" id="addEmpInterCGPA" placeholder="Intermediate CGPA">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpBtechCGPA">Graduation CGPA</label>
                        <input type="text" id="addEmpBtechCGPA" placeholder="Graduation CGPA">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpPostGraduationMarks">Post Graduation Marks (Optional)</label>
                        <input type="text" id="addEmpPostGraduationMarks" placeholder="Post graduation marks">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpPDC">PDC</label>
                        <input type="file" id="addEmpPDC" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpAadhaar">Aadhaar Card</label>
                        <input type="file" id="addEmpAadhaar" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpPAN">Pan Card</label>
                        <input type="file" id="addEmpPAN" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpResume">Resume</label>
                        <input type="file" id="addEmpResume" accept=".pdf, .doc, .docx">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpTenthCertificate">10th Certificate</label>
                        <input type="file" id="addEmpTenthCertificate" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpTwelfthCertificate">12th Certificate</label>
                        <input type="file" id="addEmpTwelfthCertificate" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpPostGraduationCertificate">Post Graduation Certificate (Optional)</label>
                        <input type="file" id="addEmpPostGraduationCertificate" accept=".pdf, .doc, .docx, .jpg, .jpeg, .png">
                    </div>
                    <div class="form-field-group">
                        <label for="addEmpPassportPhoto">Passport Size Photo</label>
                        <input type="file" id="addEmpPassportPhoto" accept=".jpg, .jpeg, .png">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                <button onclick="loadUserInfoPage()" style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Cancel</button>
                <button onclick="submitNewEmployeeForm()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Save</button>
            </div>
        </div>
    `;
    // You can add logic here to prepopulate email and full name if the user was just added
}

window.calculateSalaryComponents = calculateSalaryComponents;

// Function for edit form salary calculation
function calculateEditSalaryComponents() {
    const grossSalary = parseFloat(document.getElementById('editEmpGrossSalary').value) || 0;
    
    if (grossSalary > 0) {
        // Calculate components (same logic as add form)
        const basic = grossSalary * 0.6; // 60% of gross salary
        const hra = basic * 0.4; // 40% of basic salary
        const conveyance = 1600; // Fixed conveyance
        const specialAllowance = Math.max(0, grossSalary - basic - hra - conveyance);
        
        // Update the fields
        document.getElementById('editEmpBasic').value = basic.toFixed(2);
        document.getElementById('editEmpHra').value = hra.toFixed(2);
        document.getElementById('editEmpConveyance').value = conveyance.toFixed(2);
        document.getElementById('editEmpSpecialAllowance').value = specialAllowance.toFixed(2);

        // Calculate Provident Fund based on basic salary
        let providentFund = 0;
        if (basic >= 15000) {
            // If basic is 15000 or above, PF is 12% of 15000 only
            providentFund = 15000 * 0.12;
        } else {
            // If basic is below 15000, PF is 12% of basic amount
            providentFund = basic * 0.12;
        }
        document.getElementById('editEmpProvidentFund').value = providentFund.toFixed(2);

        // Calculate Professional Tax based on gross salary
        let professionalTax = 0;
        if (grossSalary >= 15001 && grossSalary <= 20000) {
            professionalTax = 150;
        } else if (grossSalary > 20000) {
            professionalTax = 200;
        }
        document.getElementById('editEmpProfessionalTax').value = professionalTax.toFixed(2);
    } else {
        // Reset fields if gross salary is not a positive number
        document.getElementById('editEmpBasic').value = '0.00';
        document.getElementById('editEmpHra').value = '0.00';
        document.getElementById('editEmpConveyance').value = '1600.00';
        document.getElementById('editEmpSpecialAllowance').value = '0.00';
        document.getElementById('editEmpProvidentFund').value = '0.00';
        document.getElementById('editEmpProfessionalTax').value = '0.00';
    }
}

window.calculateEditSalaryComponents = calculateEditSalaryComponents;
        // Locate this function in your dashboard.html file


        //userMSI report function

        // Add these new functions inside the <script> tag

            function loadUserMsiReportsSection() {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="reports-container">
            <h2 style="text-align: center; color: #00d1ff; margin-bottom: 30px;">User Reports</h2>

            <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; margin-bottom: 30px;">
                <div class="report-field-group" style="flex-grow: 1; min-width: 250px;">
                    <label for="msiEmployeeSelect">Select an Employee</label>
                    <select id="msiEmployeeSelect" onchange="loadEmployeeReportForm()"></select>
                </div>
                <div class="report-field-group">
                    <label for="msiFromDate">From Date</label>
                    <input type="date" id="msiFromDate" onchange="loadEmployeeReportForm()">
                </div>
                <div class="report-field-group">
                    <label for="msiToDate">To Date</label>
                    <input type="date" id="msiToDate" onchange="loadEmployeeReportForm()">
                </div>
            </div>

            <!-- Bar Graph Section -->
            <div id="barGraphSection" style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.08); border-radius: 10px; display: none; border: 1px solid rgba(0, 209, 255, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #00d1ff; margin: 0;">📊 Attendance Comparison Chart</h3>
                    <button onclick="refreshAttendanceChart()" style="background: #00d1ff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        🔄 Refresh Chart
                    </button>
                </div>
                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <canvas id="attendanceChart" width="800" height="400" style="max-width: 100%; height: auto;"></canvas>
                </div>
                <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #00d1ff; border-radius: 3px;"></div>
                        <span style="color: #ccc;">Selected Period</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #ff6b6b; border-radius: 3px;"></div>
                        <span style="color: #ccc;">Previous Week</span>
                    </div>
                </div>
            </div>

            <div id="employeeReportForm" style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.08); border-radius: 10px; display: none; border: 1px solid rgba(0, 209, 255, 0.2);">
                <h3 style="color: #00d1ff; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Employee Report Form</h3>
                <div id="reportPeriodInfo" style="color: #ccc; margin-bottom: 20px; font-size: 14px;">
                    <span id="selectedEmployeeName"></span> | 
                    <span id="selectedDateRange"></span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="report-field-group">
                        <label for="ndpField">NDP (Number of Days Present)</label>
                        <input type="number" id="ndpField" placeholder="Enter number of days present" style="background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 8px 12px;">
                    </div>
                    
                    <div class="report-field-group">
                        <label for="noOfLeavesField">Number of Leaves</label>
                        <input type="number" id="noOfLeavesField" placeholder="Enter number of leaves" style="background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 8px 12px;">
                    </div>
                    
                    <div class="report-field-group">
                        <label for="noOfPermissionsField">Number of Permissions</label>
                        <input type="number" id="noOfPermissionsField" placeholder="Enter number of permissions" style="background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 8px 12px;">
                    </div>
                    
                    <div class="report-field-group">
                        <label for="advancesField">Advances</label>
                        <input type="number" id="advancesField" placeholder="Calculated from account info" step="0.01" readonly style="background: rgba(255,255,255,0.05); color: #ccc; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 8px 12px;">
                    </div>
                    
                    <div class="report-field-group">
                        <label for="salaryField">Salary</label>
                        <input type="number" id="salaryField" placeholder="Enter salary amount" step="0.01" style="background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 8px 12px;">
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button onclick="generateReportForPeriod()" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Generate Report</button>
                    <button onclick="saveEmployeeReport()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Save Report</button>
                    <button onclick="clearEmployeeReportForm()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Clear Form</button>
                </div>
            </div>
        </div>
    `;
    populateMsiEmployeeDropdown();
}

// Corrected function to populate the employee dropdown dynamically
async function populateMsiEmployeeDropdown() {
    console.log('Populating MSI employee dropdown...');
    const employeeSelect = document.getElementById('msiEmployeeSelect');
    if (!employeeSelect) {
        console.error('Employee select element not found!');
        return;
    }
    employeeSelect.innerHTML = '<option value="">-- Select an Employee --</option>';

    try {
        // Use the existing get_all_employee_info endpoint instead
        const response = await fetch('/api/get_all_employee_info');
        const data = await response.json();

        console.log('Employee data received for dropdown:', data);
        if (data.status === 'success' && data.employees) {
            console.log(`Found ${data.employees.length} employees`);
            data.employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id; // Use the employee ID as the value
                option.textContent = emp.full_name;
                option.dataset.email = emp.email;
                option.dataset.roles = JSON.stringify(emp.roles || []);
                // Pass salary and leave info via data attributes
                option.dataset.totalLeaves = emp.total_leaves || 0;
                option.dataset.salary = emp.actual_gross_salary || 0;
                employeeSelect.appendChild(option);
            });
            console.log('Employee dropdown populated successfully');
        } else {
            console.error('Failed to load employees for MSI dropdown:', data.message);
            employeeSelect.innerHTML = '<option value="">-- Error Loading Users --</option>';
        }
    } catch (error) {
        console.error('Error fetching employees for MSI dropdown:', error);
        employeeSelect.innerHTML = '<option value="">-- Error Loading Users --</option>';
    }
}

// Function to load the employee report form when an employee is selected
function loadEmployeeReportForm() {
    const employeeSelect = document.getElementById('msiEmployeeSelect');
    const fromDate = document.getElementById('msiFromDate');
    const toDate = document.getElementById('msiToDate');
    const reportForm = document.getElementById('employeeReportForm');
    const barGraphSection = document.getElementById('barGraphSection');
    
    if (employeeSelect.value && fromDate.value && toDate.value) {
        reportForm.style.display = 'block';
        barGraphSection.style.display = 'block';
        
        // Update header information
        const selectedOption = employeeSelect.options[employeeSelect.selectedIndex];
        const employeeName = selectedOption.textContent;
        document.getElementById('selectedEmployeeName').textContent = employeeName;
        document.getElementById('selectedDateRange').textContent = `${fromDate.value} to ${toDate.value}`;
        
        // Pre-populate salary field if available
        const salary = selectedOption.dataset.salary || 0;
        document.getElementById('salaryField').value = salary;
        
        // Fetch and populate data for the selected date range
        console.log('Loading employee report form for:', employeeSelect.value, fromDate.value, toDate.value);
        fetchEmployeeDataForPeriod(employeeSelect.value, fromDate.value, toDate.value);
        
        // Generate bar chart
        generateAttendanceChart(employeeSelect.value, fromDate.value, toDate.value);
    } else {
        reportForm.style.display = 'none';
        barGraphSection.style.display = 'none';
    }
}

// Function to save the employee report
async function saveEmployeeReport() {
    const employeeSelect = document.getElementById('msiEmployeeSelect');
    const ndp = document.getElementById('ndpField').value;
    const noOfLeaves = document.getElementById('noOfLeavesField').value;
    const noOfPermissions = document.getElementById('noOfPermissionsField').value;
    const advances = document.getElementById('advancesField').value;
    const salary = document.getElementById('salaryField').value;
    
    if (!employeeSelect.value) {
        alert('Please select an employee first.');
        return;
    }
    
    if (!ndp || !noOfLeaves || !noOfPermissions || !salary) {
        alert('Please fill in all required fields.');
        return;
    }
    
    try {
        const reportData = {
            employee_id: employeeSelect.value,
            employee_name: employeeSelect.options[employeeSelect.selectedIndex].textContent,
            ndp: parseInt(ndp),
            no_of_leaves: parseInt(noOfLeaves),
            no_of_permissions: parseInt(noOfPermissions),
            advances: parseFloat(advances),
            salary: parseFloat(salary)
        };
        
        // Here you can add API call to save the report data
        console.log('Saving employee report:', reportData);
        
        // For now, just show a success message
        alert('Employee report saved successfully!');
        
        // You can add actual API call here:
        // const response = await fetch('/api/save_employee_report', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify(reportData)
        // });
        
    } catch (error) {
        console.error('Error saving employee report:', error);
        alert('Error saving report. Please try again.');
    }
}

// Function to clear the employee report form
function clearEmployeeReportForm() {
    document.getElementById('ndpField').value = '';
    document.getElementById('noOfLeavesField').value = '';
    document.getElementById('noOfPermissionsField').value = '';
    document.getElementById('advancesField').value = '';
    document.getElementById('salaryField').value = '';
}

// Function to generate report for the selected period
function generateReportForPeriod() {
    const employeeSelect = document.getElementById('msiEmployeeSelect');
    const fromDate = document.getElementById('msiFromDate');
    const toDate = document.getElementById('msiToDate');
    
    if (!employeeSelect.value || !fromDate.value || !toDate.value) {
        alert('Please select an employee and date range first.');
        return;
    }
    
    // Update header information
    const selectedOption = employeeSelect.options[employeeSelect.selectedIndex];
    const employeeName = selectedOption.textContent;
    document.getElementById('selectedEmployeeName').textContent = employeeName;
    document.getElementById('selectedDateRange').textContent = `${fromDate.value} to ${toDate.value}`;
    
    // Fetch data for the period
    fetchEmployeeDataForPeriod(employeeSelect.value, fromDate.value, toDate.value);
}

// Function to fetch employee data for a specific period
async function fetchEmployeeDataForPeriod(employeeId, fromDate, toDate) {
    try {
        // Show loading state
        document.getElementById('ndpField').value = 'Loading...';
        document.getElementById('noOfLeavesField').value = 'Loading...';
        document.getElementById('noOfPermissionsField').value = 'Loading...';
        document.getElementById('advancesField').value = 'Loading...';
        
        // Make API call to fetch real data
        const response = await fetch('/api/get_employee_report_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                employee_id: employeeId,
                from_date: fromDate,
                to_date: toDate
            })
        });
        
        const data = await response.json();
        console.log('API Response:', data);
        
        if (data.status === 'success') {
            // Populate the form with real data
            document.getElementById('ndpField').value = data.data.ndp;
            document.getElementById('noOfLeavesField').value = data.data.no_of_leaves;
            document.getElementById('noOfPermissionsField').value = data.data.no_of_permissions;
            document.getElementById('advancesField').value = data.data.advances;
            document.getElementById('salaryField').value = data.data.salary;
            
            // Try to fetch actual attendance data from Firebase
            await fetchActualAttendanceData(employeeId, fromDate, toDate);
            
            console.log(`Fetched real data for employee ${employeeId} from ${fromDate} to ${toDate}:`);
            console.log(`- Working days (NDP): ${data.data.ndp}`);
            console.log(`- Leaves: ${data.data.no_of_leaves}`);
            console.log(`- Permissions: ${data.data.no_of_permissions}`);
            console.log(`- Advances: ${data.data.advances}`);
            console.log(`- Salary: ${data.data.salary}`);
        } else {
            throw new Error(data.message || 'Failed to fetch data');
        }
        
    } catch (error) {
        console.error('Error fetching employee data for period:', error);
        alert('Error fetching data for the selected period. Please try again.');
        
        // Clear the form on error
        document.getElementById('ndpField').value = '';
        document.getElementById('noOfLeavesField').value = '';
        document.getElementById('noOfPermissionsField').value = '';
        document.getElementById('advancesField').value = '';
    }
}

// Function to fetch actual attendance data from Firebase
async function fetchActualAttendanceData(employeeId, fromDate, toDate) {
    try {
        // Get employee name for Firebase lookup
        const employeeSelect = document.getElementById('msiEmployeeSelect');
        const selectedOption = employeeSelect.options[employeeSelect.selectedIndex];
        const employeeName = selectedOption.textContent;
        
        // Convert date range to individual dates
        const startDate = new Date(fromDate);
        const endDate = new Date(toDate);
        const dates = [];
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            // Skip weekends
            if (d.getDay() !== 0 && d.getDay() !== 6) {
                dates.push(d.toISOString().split('T')[0]);
            }
        }
        
        // Check Firebase for each date
        let presentDays = 0;
        const monthNames = ["january", "february", "march", "april", "may", "june", 
                           "july", "august", "september", "october", "november", "december"];
        
        for (const dateStr of dates) {
            const [year, month] = dateStr.split('-');
            const monthString = monthNames[parseInt(month, 10) - 1];
            const collectionName = `${monthString}_${year}`;
            
            try {
                const snap = await dbAttendance.collection(collectionName)
                    .where('date_key', '==', dateStr)
                    .where('Name', '==', employeeName)
                    .get();
                
                if (!snap.empty) {
                    const doc = snap.docs[0];
                    const data = doc.data();
                    if (data.check_in || data.check_out) {
                        presentDays++;
                    }
                }
            } catch (firebaseError) {
                console.log(`Firebase error for ${dateStr}:`, firebaseError.message);
                // Continue with other dates
            }
        }
        
        // Update NDP field with actual Firebase data if found
        if (presentDays > 0) {
            document.getElementById('ndpField').value = presentDays;
            console.log(`Updated NDP with Firebase data: ${presentDays} days`);
        }
        
    } catch (error) {
        console.log('Firebase attendance fetch error:', error);
        // Don't show error to user, just use fallback data
    }
}

// This is the improved version of the function from the previous response.
// This is the improved version of the function from the previous response.
async function fetchMsiReportData() {
    const userId = document.getElementById('msiEmployeeSelect').value;
    const fromDateStr = document.getElementById('msiFromDate').value;
    const toDateStr = document.getElementById('msiToDate').value;

    if (!userId || !fromDateStr || !toDateStr) {
        alert('Please select an employee and a date range.');
        return;
    }

    const fromDate = new Date(fromDateStr);
    const toDate = new Date(toDateStr);
    if (fromDate > toDate) {
        alert('Start date cannot be after end date.');
        return;
    }

    // Check if the selected date range is within a single month and year
    if (fromDate.getMonth() !== toDate.getMonth() || fromDate.getFullYear() !== toDate.getFullYear()) {
        alert('For accurate results, please select a date range within a single month.');
        return;
    }

    // Show loading state
    const reportContainer = document.getElementById('msiReportDataContainer');
    const detailsContainer = document.getElementById('msiEmployeeDetailsContainer');
    reportContainer.style.display = 'grid';
    detailsContainer.style.display = 'block';
    reportContainer.querySelectorAll('input').forEach(input => input.value = 'Calculating...');
    
    try {
        const employeeSelect = document.getElementById('msiEmployeeSelect');
        const selectedOption = employeeSelect.options[employeeSelect.selectedIndex];

        // Get employee info from the selected option's data attributes
        const totalLeaves = parseInt(selectedOption.dataset.totalLeaves) || 0;
        const salary = parseFloat(selectedOption.dataset.salary) || 0;
        const employeeName = selectedOption.textContent;

        let daysWorked = 0;
        let noOfLates = 0;
        let attendedDates = new Set();
        
        const monthNames = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
        const month = monthNames[fromDate.getMonth()];
        const year = fromDate.getFullYear();
        const collectionName = `${month}_${year}`;

        // Query the attendance collection for the entire month
        const attendanceSnapshot = await dbAttendance.collection(collectionName)
            .where('user_id', '==', parseInt(userId))
            .get();

        if (!attendanceSnapshot.empty) {
            attendanceSnapshot.forEach(doc => {
                const data = doc.data();
                const recordDate = new Date(data.date_key);
                
                // Process records only within the selected date range
                if (recordDate >= fromDate && recordDate <= toDate) {
                    if (data.check_in && !attendedDates.has(data.date_key)) {
                        // A user checked in, so they worked that day
                        daysWorked++;
                        attendedDates.add(data.date_key);
                        if (data.late) {
                            // If check-in was late, increment the late counter
                            noOfLates++;
                        }
                    }
                }
            });
        }
        
        // --- START UPDATED LOGIC ---
        // 'Leaves Availed' should be directly fetched from the employee info
        // and 'Leaves Balance' should be the difference between total and availed.
        const leavesAvailed = 0; // Default value since we don't have this in the current data
        const leavesBalance = totalLeaves - leavesAvailed;
        // --- END UPDATED LOGIC ---

        // Populate employee details
        document.getElementById('msiEmployeeId').textContent = `SSDEV-${String(userId).padStart(2, '0')}-002`;
        document.getElementById('msiEmployeeEmail').textContent = selectedOption.dataset.email || 'N/A';
        const roles = JSON.parse(selectedOption.dataset.roles || '[]');
        document.getElementById('msiEmployeeDesignation').textContent = roles.join(', ') || 'Employee';
        document.getElementById('msiEmployeeJoinedDate').textContent = 'N/A'; // Default value since we don't have this in the current data

        // Populate the report data fields
        document.getElementById('msiDaysWorked').value = daysWorked;
        document.getElementById('msiLates').value = noOfLates;
        document.getElementById('msiLeavesAvailed').value = leavesAvailed; // Corrected line
        document.getElementById('msiLeavesBalance').value = leavesBalance; // Corrected line
        document.getElementById('msiSalary').value = `₹${parseFloat(salary).toFixed(2)}`;

    } catch (error) {
        console.error('Error fetching MSI report data:', error);
        alert('An error occurred while generating the report.');
        reportContainer.style.display = 'none';
        
    }
}
        async function downloadPayslip() {
    const employeeSelect = document.getElementById('employeeNameSelect');
    const selectedEmployeeId = employeeSelect.value;
    const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
    const employeeId = document.getElementById('employeeId').textContent;
    const designation = document.getElementById('employeeDesignation').value;
    const bankAc = document.getElementById('employeeAccount').textContent;
    
    // Fetch employee data to get PF No
    let pfNo = 'N/A';
    try {
        const response = await fetch(`/api/get_employee_info/${selectedEmployeeId}`);
        const data = await response.json();
        if (data.status === 'success' && data.employee) {
            pfNo = data.employee.pf_no || 'N/A';
        }
    } catch (error) {
        console.error('Error fetching employee data:', error);
    }
    
    // Get form values from Earnings section (as requested by user)
    const basic = document.getElementById('earningsBasic').value;
    const hra = document.getElementById('earningsHra').value;
    const conveyance = document.getElementById('earningsConveyance').value;
    const vehicleMaintenance = document.getElementById('earningsVehicleMaintenance').value;
    const specialAllowance = document.getElementById('earningsSpecialAllowance').value;
    const addOthersEarnings = document.getElementById('addOthersEarnings').value;
    const totalEarnings = parseFloat(document.getElementById('totalEarnings').textContent) || 0;
    
    const providentFund = parseFloat(document.getElementById('providentFund').value) || 0;
    const esi = parseFloat(document.getElementById('esi').value) || 0;
    const professionalTax = parseFloat(document.getElementById('professionalTax').value) || 0;
    const incomeTax = parseFloat(document.getElementById('incomeTax').value) || 0;
    const advance = parseFloat(document.getElementById('advance').value) || 0;
    const otherDeductions = parseFloat(document.getElementById('otherDeductions').value) || 0;
    const lossOfPay = parseFloat(document.getElementById('lossOfPay').value) || 0;
    const totalDeductions = parseFloat(document.getElementById('totalDeductions').textContent) || 0;

    const totalLeaves = document.getElementById('totalLeaves').value;
    const leaveAvailed = document.getElementById('leaveAvailed').value;
    const balanceLeaves = document.getElementById('balanceLeaves').value;
    const lopDays = document.getElementById('noOfLopDays').value;
    const totalDays = document.getElementById('totalDays').value || '30';
    const ndp = document.getElementById('ndp').value || '0';

    const netSalary = totalEarnings - totalDeductions;

    // Determine watermark for individual payslip (default to SSEV watermark)
    const watermarkSrc = 'static/images/watermark-ssev.png';
    
    // Generate payslip title with current month and year
    const payslipTitle = getCurrentMonthYear();

    // Build the payslip HTML string
    const payslipHtml = `
    <div class="payslip-container" style="position: relative;">
        <!-- Watermark -->
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; display: flex; align-items: center; justify-content: center; background-image: url('${watermarkSrc}'); background-repeat: no-repeat; background-position: center; background-size: contain;">
        </div>
        
        <table class="payslip-header-table">
            <tr>
                <td style="width: 15%; border: none;">
                    <img src="static/images/logo.png" alt="Company Logo" class="payslip-logo">
                </td>
                <td style="width: 85%; border: none; padding: 0;">
                    <div class="company-name">SSEV SOFTWARE SOLUTIONS PRIVATE LIMITED</div>
                    <div class="company-details">Corporate office: #2-057/A/112, 1st Floor, VSS Nandadeep,<br>Near Medchal RTA Office, Petbasheerabad Village, Kompally Road,<br>Medchal District Telangana Hyderabad 500067.<br>Ph.040-35042301.</div>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="payslip-title" style="border-left: none; border-right: none;">${payslipTitle}</td>
            </tr>
        </table>
        
        <table class="payslip-main-table" style="margin-top: 20px;">
            <tr>
                <td style="width: 25%;">Employee No</td>
                <td style="width: 25%;">${employeeId || 'N/A'}</td>
                <td style="width: 25%;">Designation</td>
                <td style="width: 25%;">${designation || 'N/A'}</td>
            </tr>
            <tr>
                <td>Name</td>
                <td>${employeeName || 'N/A'}</td>
                <td>Total Days</td>
                <td>${totalDays || '30'}</td>
            </tr>
            <tr>
                <td>Bank A/c No</td>
                <td>${bankAc || 'N/A'}</td>
                <td>LOP</td>
                <td>${lopDays || '0'}</td>
            </tr>
            <tr>
                <td>PF No.</td>
                <td>${pfNo}</td>
                <td>Effective work days</td>
                <td>${ndp || '0'}</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: center;">Total Leaves : ${totalLeaves || '0'} | Leave Availed : ${leaveAvailed || '0'} | Balance : ${balanceLeaves || '0'}</td>
            </tr>
            <tr>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Earnings</th>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Deductions</th>
            </tr>
            <tr>
                <td>BASIC</td>
                <td>${basic || '0.00'}</td>
                <td>PF</td>
                <td>${providentFund || '0'}</td>
            </tr>
            <tr>
                <td>HRA</td>
                <td>${hra || '0.00'}</td>
                <td>ESI</td>
                <td>${esi || '0.00'}</td>
            </tr>
            <tr>
                <td>CONVEYANCE</td>
                <td>${conveyance || '0.00'}</td>
                <td>P. Tax</td>
                <td>${professionalTax || '0.00'}</td>
            </tr>
            <tr>
                <td>VEHICLE MAINTENANCE</td>
                <td>${vehicleMaintenance || '0.00'}</td>
                <td>Income Tax</td>
                <td>${incomeTax || '0.00'}</td>
            </tr>
            <tr>
                <td>SPL ALLOWANCE</td>
                <td>${specialAllowance || '0.00'}</td>
                <td>Advance</td>
                <td>${advance || '0.00'}</td>
            </tr>
            <tr>
                <td>Add Others</td>
                <td>${addOthersEarnings || '0.00'}</td>
                <td>Others Deduction</td>
                <td>${otherDeductions || '0.00'}</td>
            </tr>
            <tr>
                <td colspan="2" style="border: none;"></td>
                <td>Loss of Pay</td>
                <td>${lossOfPay || '0.00'}</td>
            </tr>
            <tr class="payslip-total-row">
                <td>Total Earnings</td>
                <td>${totalEarnings}</td>
                <td>Total Deduction</td>
                <td>${totalDeductions}</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: right; font-weight: bold; font-size: 12pt;">Net Salary: ${netSalary}</td>
            </tr>
        </table>
        
        <!-- System Generated Disclaimer -->
        <div style="margin-top: 20px; text-align: left; font-size: 10pt; color: #666;">
            It is System generated, Signature not required
        </div>
    </div>`;

    // Use html2pdf to generate the PDF
    const element = document.createElement('div');
    element.innerHTML = payslipHtml;

    html2pdf().from(element).save('payslip.pdf');
}

// Add calculateGrandTotal function for Indents module
function calculateGrandTotal() {
    const tableBody = document.getElementById('itemDetailsTableBody');
    if (!tableBody) return;
    
    let grandTotal = 0;
    const rows = tableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const totalInput = row.querySelector('[name="total"]');
        if (totalInput && totalInput.value) {
            grandTotal += parseFloat(totalInput.value) || 0;
        }
    });
    
    // Update the grand total display
    const grandTotalElement = document.getElementById('grandTotalDisplay');
    if (grandTotalElement) {
        grandTotalElement.textContent = `Grand Total: ₹${grandTotal.toFixed(2)}`;
    }
}

// Update recalculateTotal function to also calculate grand total
function recalculateTotal(row) {
    const cost = parseFloat(row.querySelector('[name="tentativeCost"]').value) || 0;
    const qty = parseFloat(row.querySelector('[name="qty"]').value) || 0;
    const tax = parseFloat(row.querySelector('[name="tax"]').value) || 0;
    const totalInput = row.querySelector('[name="total"]');
    if (cost && qty) {
        const total = cost * qty * (1 + tax / 100);
        totalInput.value = total.toFixed(2);
    } else {
        totalInput.value = '';
    }
    
    // Calculate and update grand total
    calculateGrandTotal();
}

// Function to generate attendance comparison chart
async function generateAttendanceChart(employeeId, fromDate, toDate) {
    try {
        // Show loading state
        const canvas = document.getElementById('attendanceChart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#00d1ff';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Loading chart data...', canvas.width / 2, canvas.height / 2);
        
        // Calculate previous week dates
        const prevWeekDates = calculatePreviousWeekDates(fromDate, toDate);
        
        console.log('Generating chart for:', {
            employeeId,
            currentPeriod: { from: fromDate, to: toDate },
            previousPeriod: prevWeekDates
        });
        
        // Fetch data for both periods
        const [currentPeriodData, previousWeekData] = await Promise.all([
            fetchAttendanceDataForPeriod(employeeId, fromDate, toDate),
            fetchAttendanceDataForPeriod(employeeId, prevWeekDates.from, prevWeekDates.to)
        ]);
        
        console.log('Chart data fetched:', {
            current: currentPeriodData,
            previous: previousWeekData
        });
        
        // Create the chart
        createAttendanceBarChart(currentPeriodData, previousWeekData, fromDate, toDate, prevWeekDates.from, prevWeekDates.to);
        
    } catch (error) {
        console.error('Error generating attendance chart:', error);
        // Show error message in chart area
        const canvas = document.getElementById('attendanceChart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#ff6b6b';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Error loading chart data', canvas.width / 2, canvas.height / 2);
    }
}

// Function to calculate previous week dates
function calculatePreviousWeekDates(fromDate, toDate) {
    const from = new Date(fromDate);
    const to = new Date(toDate);
    
    // Calculate the number of days in the selected period
    const daysDiff = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;
    
    // Calculate previous week start date
    const prevWeekFrom = new Date(from);
    prevWeekFrom.setDate(prevWeekFrom.getDate() - daysDiff);
    
    // Calculate previous week end date
    const prevWeekTo = new Date(prevWeekFrom);
    prevWeekTo.setDate(prevWeekTo.getDate() + daysDiff - 1);
    
    return {
        from: prevWeekFrom.toISOString().split('T')[0],
        to: prevWeekTo.toISOString().split('T')[0]
    };
}

// Function to fetch attendance data for a period
async function fetchAttendanceDataForPeriod(employeeId, fromDate, toDate) {
    try {
        const response = await fetch('/api/get_employee_report_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                employee_id: employeeId,
                from_date: fromDate,
                to_date: toDate
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            const reportData = data.data;
            return {
                ndp: reportData.ndp || 0,
                leaves: reportData.no_of_leaves || 0,
                permissions: reportData.no_of_permissions || 0,
                workingDays: reportData.ndp || 0
            };
        } else {
            throw new Error(data.message || 'Failed to fetch data');
        }
    } catch (error) {
        console.error('Error fetching attendance data:', error);
        return {
            ndp: 0,
            leaves: 0,
            permissions: 0,
            workingDays: 0
        };
    }
}

// Function to create the bar chart
function createAttendanceBarChart(currentData, previousData, currentFrom, currentTo, prevFrom, prevTo) {
    const canvas = document.getElementById('attendanceChart');
    const ctx = canvas.getContext('2d');
    
    // Clear previous chart if it exists
    if (window.attendanceChartInstance) {
        window.attendanceChartInstance.destroy();
    }
    
    // Format date ranges for display
    const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    };
    
    const currentPeriodLabel = `${formatDate(currentFrom)} - ${formatDate(currentTo)}`;
    const previousPeriodLabel = `${formatDate(prevFrom)} - ${formatDate(prevTo)}`;
    
    window.attendanceChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Days Present', 'Leaves Taken', 'Permissions', 'Working Days'],
            datasets: [
                {
                    label: currentPeriodLabel,
                    data: [currentData.ndp, currentData.leaves, currentData.permissions, currentData.workingDays],
                    backgroundColor: 'rgba(0, 209, 255, 0.8)',
                    borderColor: 'rgba(0, 209, 255, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                },
                {
                    label: previousPeriodLabel,
                    data: [previousData.ndp, previousData.leaves, previousData.permissions, previousData.workingDays],
                    backgroundColor: 'rgba(255, 107, 107, 0.8)',
                    borderColor: 'rgba(255, 107, 107, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Attendance Comparison: Current vs Previous Period',
                    color: '#00d1ff',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    labels: {
                        color: '#ccc',
                        font: {
                            size: 12
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#ccc',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#ccc',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

// Function to refresh the attendance chart
function refreshAttendanceChart() {
    const employeeSelect = document.getElementById('msiEmployeeSelect');
    const fromDate = document.getElementById('msiFromDate');
    const toDate = document.getElementById('msiToDate');
    
    if (employeeSelect.value && fromDate.value && toDate.value) {
        generateAttendanceChart(employeeSelect.value, fromDate.value, toDate.value);
    } else {
        alert('Please select an employee and date range first.');
    }
}
    </script>



    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
</body>

</html>
