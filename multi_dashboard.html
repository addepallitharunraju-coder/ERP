<!DOCTYPE html>
<!-- Cache bust v5.0 - Fixed PF No fetching in downloadPayslip function -->
<html lang="en">

<head>
   
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ERP Dashboard</title>
   
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fontselect@0.1.2/css/fontselect.css">
   
  <script src="https://cdn.jsdelivr.net/npm/fontselect@0.1.2/js/jquery.fontselect.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
   
  <link id="google-font-link" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <style>
    /* ... (all your existing CSS styles from the original file) ... */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
body {
  height: 100%;
  font-family: 'Poppins', 'Segoe UI', sans-serif; /* Use the new font */
  background-color: var(--dark-bg); /* Change from black */
  color: var(--text-primary); /* Change from white */
  overflow: hidden;
}
    /* 1. FONT IMPORT & ROOT VARIABLES */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

:root {
  --dark-bg: #0a192f;        /* A very dark navy blue */
  --light-bg: #112240;       /* A slightly lighter navy for cards */
  --lightest-bg: #233554;    /* For hover effects and borders */
  --text-primary: #ccd6f6;   /* Light blue-ish white for body text */
  --text-secondary: #8892b0; /* Muted light blue for subtitles */
  --accent: #64ffda;         /* The glowing teal/cyan accent color */
  --accent-tint: rgba(100, 255, 218, 0.1); /* A transparent version of the accent */
  --border-radius: 8px;
  --transition-speed: 0.3s;
}

    #bgVideo {
      position: fixed;
      top: 0;
      left: 0;
      min-width: 100%;
      min-height: 100%;
      object-fit: cover;
      z-index: 0;
      opacity: 0.05;
      filter: brightness(1.5);
      pointer-events: none;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 230px;
      height: 100vh;
     background: rgba(2, 12, 27, 0.8);
     backdrop-filter: blur(10px);
     border-right: 1px solid var(--lightest-bg);
      z-index: 10;
      display: flex;
      flex-direction: column;
    }

    .user-greet {
      padding: 15px 20px;
      font-size: 16px;
      color: var(--accent);
      font-weight: 600;
      border-bottom: 1px solid var(--lightest-bg);
      text-align: center;
      flex-shrink: 0;
    }

    .sidebar ul {
      list-style: none;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .sidebar ul li {
      padding: 12px 16px;
      margin-bottom: 0;
      cursor: pointer;
      border-radius: var(--border-radius);
      transition: all var(--transition-speed) ease;
      color: var(--text-secondary);
      font-weight: 500;
      border-left: 3px solid transparent;
      text-align: center;
      min-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

.sidebar ul li:hover {
  background: var(--accent-tint);
  color: var(--accent);
  transform: translateX(3px);
  box-shadow: 0 2px 8px rgba(100, 255, 218, 0.2);
}

.sidebar ul li.active {
  background: var(--accent-tint);
  color: var(--accent);
  border-left: 3px solid var(--accent);
}

    .topbar {
      position: fixed;
      left: 230px;
      right: 0;
      top: 0;
      height: 60px;
      background: rgba(15, 15, 15, 0.9);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }


    .logout-btn {
      background: #dc3545;
      padding: 8px 16px;
      color: white;
      border: none;
      border-radius: 4px;
      text-decoration: none;
      transition: 0.2s;
    }

    .logout-btn:hover {
      background: #b52d3a;
    }

    .main {
      margin-left: 230px;
      margin-top: 30px;
      padding: 2px 20px;
      position: relative;
      z-index: 5;
      overflow-y: auto;
      height: calc(100vh - 40px);
    }

    .tab-section {
      display: none;
    }

    .tab-section.active {
      display: block;
    }

    h2 {
      color: #00d1ff;
      margin-bottom: 1px;
    }

    .dashboard-widgets {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-top: 3px;
      justify-content: space-between;
      align-items: stretch;
    }

    .widget {
      background: var(--light-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      border: 1px solid var(--lightest-bg);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      color: var(--text-primary);
      text-align: center;
      transition: all var(--transition-speed) ease;
      flex: 1;
      min-width: 0;
    }
.widget:hover {
  transform: translateY(-5px);
  border-color: var(--accent);
}

   .widget h3 {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
  font-size: 16px;
  font-weight: 400;
  color: var(--text-secondary);
}
/* This ::before creates the colored square from your image */
.widget h3::before {
  content: '';
  display: inline-block;
  width: 10px;
  height: 10px;
  margin-right: 10px;
  border-radius: 2px;
}

/* Assigning colors to each widget's square */
#calendar-widget h3::before { background-color: #e6b800; }
#clock-widget h3::before { background-color: #64ffda; }
#projects-widget h3::before { background-color: #ff9f43; }
#tasks-widget h3::before { background-color: #3498db; }

   .stat-number {
  font-size: 2rem;
  font-weight: 600;
  margin-top: 10px;
  color: var(--text-primary);
  text-align: center;
}
    #liveClock {
      font-size: 28px;
      font-weight: bold;
        color: var(--accent);
    }

    #calendar {
      padding: 4px;
      border-radius: 6px;
      font-size: 16px;
      background-color: #111;
      color: white;
      border: 1px solid #555;
    }

    .tab-content {
      background: rgba(255, 255, 255, 0.05);
      padding: 25px;
      border-radius: 12px;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .project-card {
      background: rgba(0, 123, 255, 0.1);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .salaries-container {
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 15px;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
    }

    .salaries-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .salaries-section {
      background: rgba(255, 255, 255, 0.08);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid rgba(0, 209, 255, 0.1);
    }

    .salaries-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 15px;
    }

    .salaries-section-header h3 {
      color: #00d1ff;
      font-size: 22px;
      margin: 0;
    }

    .salaries-section-content {
      display: grid;
      /* Use a single column for all fields to ensure they stack vertically */
      grid-template-columns: 1fr;
      gap: 15px;
      transition: all 0.3s ease-out;
      max-height: 500px;
      overflow: hidden;
      opacity: 1;
    }

    .salaries-section-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .salaries-section-content.collapsed {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      opacity: 0;
    }

    .salaries-field-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      /* Align text and input to the left */
    }

    .salaries-field-group label {
      margin-bottom: 5px;
      /* Add a small gap between label and input */
    }

    .salaries-field-group input,
    .salaries-field-group div.salaries-total-field {
      width: 100%;
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    /* Add a new, specific rule for the dropdown in the header */
    .salaries-header select {
      background-color: #333 !important;
      color: #fff !important;
      border: 1px solid #666 !important;
      padding: 8px 12px;
      border-radius: 5px;
    }

    .salaries-total-field {
      background: rgba(0, 209, 255, 0.15);
      border: 1px solid #00d1ff;
      font-weight: bold;
      text-align: center;
      margin-top: 15px;
    }

    .salaries-main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .salaries-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
    }

    .salaries-actions button {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .salaries-actions .save-btn {
      background: linear-gradient(135deg, #28a745 0%, #218838 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
    }

    .salaries-actions .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(40, 167, 69, 0.6);
    }

    .salaries-actions .download-btn {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
    }

    .salaries-actions .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 123, 255, 0.6);
    }

    .salaries-actions .download-sheet-btn {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #333;
      box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);
    }

    .salaries-actions .download-sheet-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 193, 7, 0.6);
    }

    /* Payslip Styles */
    .payslip-container {
        width: 190mm; /* This is fine, keep it */
        /* Remove the 'height' property completely */
        padding: 10mm;
        font-family: Arial, sans-serif;
        font-size: 10pt;
        border: 1px solid #000;
        margin: auto;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        background: #fff;
        color: #000;
    }
    .payslip-header-table, .payslip-main-table {
        width: 100%;
        border-collapse: collapse;
    }
    .payslip-header-table th, .payslip-header-table td,
    .payslip-main-table th, .payslip-main-table td {
        border: 1px solid #000;
        padding: 5px;
        text-align: left;
        vertical-align: top;
    }
    .payslip-header-table .company-name {
        text-align: center;
        font-size: 14pt;
        font-weight: bold;
    }
    .payslip-header-table .company-details {
        font-size: 8pt;
        text-align: center;
    }
    .payslip-header-table .payslip-title {
        text-align: center;
        font-size: 12pt;
        font-weight: bold;
    }
    .payslip-logo {
        width: 80px;
    }
    .payslip-total-row {
        font-weight: bold;
    }

    .appearance-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      margin-bottom: 16px;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: 0.3s ease;
    }

    .appearance-card:hover {
      background: rgba(0, 123, 255, 0.2);
      transform: scale(1.01);
    }

    .appearance-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 17px;
      font-weight: 600;
      color: #fff;
    }

    .appearance-content {
      margin-top: 12px;
      display: none;
    }

    .appearance-select,
    .appearance-input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 6px;
      background: #111;
      color: #fff;
      border: 1px solid #555;
    }

    .member-select-container {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      padding: 4px;
    }

    .work-nav-buttons {
      display: flex;
      flex-direction: row;
      gap: 8px;
      justify-content: flex-start;
      align-items: stretch;
      margin-left: 5px;
      padding-left: 0;
      position: relative;
      left: 0;
    }

    .work-nav-card {
      background-color: rgba(45, 85, 255, 0.2);
      padding: 25px 30px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      transition: all 0.25s ease;
      cursor: pointer;
      border: 1px solid rgba(45, 85, 255, 0.4);
      flex: 0 0 auto;
      min-width: 250px;
      max-width: 300px;
    }

    .work-nav-card:hover {
      background-color: rgba(45, 85, 255, 0.4);
      transform: scale(1.015);
    }

    .work-nav-card h3 {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #fff;
    }

    .work-nav-card p {
      font-size: 15px;
      color: #ccc;
    }

    #work-content-display {
      min-height: 300px;
    }

    .task-list-container h3 {
      color: #00d1ff;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }

    .task-item {
      background: rgba(25, 30, 50, 0.7);
      padding: 20px 20px 20px 25px;
      border-radius: 12px;
      margin-bottom: 15px;
      border-left: 5px solid #00aaff;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .task-item .task-title {
      font-size: 22px;
      font-weight: bold;
      color: #ffffff;
      margin-bottom: 8px;
    }

    .task-item .task-details {
      font-size: 15px;
      color: #bbccff;
      line-height: 1.5;
    }

    .back-button {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 30px;
      transition: background-color 0.2s;
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .header-with-button {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .add-button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: background-color 0.2s;
    }

    .add-button:hover {
      background: #218838;
    }

    .project-list-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .project-list-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .task-item-container {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .task-item-visible {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .task-item-visible input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .task-name {
      font-size: 18px;
      flex-grow: 1;
      transition: all 0.2s;
    }

    .task-name.completed {
      text-decoration: line-through;
      color: #8a92a9;
    }

    .task-details-toggle {
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .task-details-toggle.open {
      transform: rotate(180deg);
    }

    .task-hidden-details {
      display: none;
      padding-left: 35px;
      margin-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 15px;
      color: #ccc;
    }

    .query-box {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 25px;
    }

    .faq-section {
      flex-grow: 1;
    }

    /* New styles for form layout */
    .purchase-indent-form {
      background: rgba(0, 0, 0, 0.6);
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(0, 209, 255, 0.2);
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .form-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .form-header h2 {
      color: #fff;
      font-size: 24px;
    }

    .form-section {
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .form-section h4 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #00d1ff;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 0.5rem;
    }

    .form-fields-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .form-field-group {
      display: flex;
      flex-direction: column;
    }

    .form-field-group label {
      margin-bottom: 0.5rem;
      color: #ccc;
      font-size: 14px;
    }

    .purchase-indent-form input,
    .purchase-indent-form select,
    .purchase-indent-form textarea,
    .table-bordered td input,
    .table-bordered td select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 15px;
    }

    .table-responsive {
      overflow-x: auto;
    }

    .table-bordered {
      width: 100%;
      border-collapse: collapse;
    }

    .table-bordered th,
    .table-bordered td {
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 12px;
      text-align: left;
      white-space: nowrap;
    }

    .table-bordered th {
      background-color: rgba(0, 209, 255, 0.1);
    }

    .table-bordered td input {
      min-width: 150px;
    }

    /* Button Styles for Form */
    .btn-add {
      background-color: #28a745 !important;
    }

    .btn-next {
      background-color: #007bff !important;
    }

    .btn-success {
      background-color: #28a745 !important;
    }

    .btn-secondary {
      background-color: #6c757d !important;
    }

    .btn-danger {
      background-color: #dc3545 !important;
    }

    .d-flex {
      display: flex;
    }

    .justify-content-between {
      justify-content: space-between;
    }

    .justify-content-end {
      justify-content: flex-end;
    }

    .mt-4 {
      margin-top: 1.5rem;
    }

    .mt-3 {
      margin-top: 1rem;
    }






    .leave-table select#teamLeadSelect {
      width: 250px;
      /* Adjust this value as needed */
    }

    /* New CSS for Team Lead View */
    .teamlead-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background: rgba(0, 0, 0, 0.4);
      padding: 20px;
      border-radius: 15px;
      border: 1px solid rgba(0, 209, 255, 0.3);
    }

    .request-card-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .request-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #00d1ff;
      transition: all 0.2s ease-in-out;
    }

    .request-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .request-card strong {
      color: #00d1ff;
    }

    .request-card .status {
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .status-pending {
      background-color: #ffc107;
      color: #333;
    }

    .status-approved {
      background-color: #28a745;
      color: white;
    }

    .status-rejected {
      background-color: #dc3545;
      color: white;
    }
    
    support-container {
            padding: 0;
            /* Remove padding from here */
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            /* Add flex properties */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            
        }

        /* Support Module Styles */
        .query-box {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(0, 209, 255, 0.3);
            padding: 30px;
            margin-bottom: 25px;
            flex-shrink: 0;
            /* Prevents this box from shrinking */
        }

        .query-box textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 1);
            color: #333;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 20px;
        }

        .query-box .submit-btn {
            padding: 10px 25px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            color: #111;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .query-box .submit-btn:hover {
            background: #fff;
            border-color: #fff;
            transform: translateY(-1px);
        }

        .faq-section {
    flex-grow: 1;
    /* This makes this section fill available space */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* IMPORTANT: Hides overflow on the section itself */
}

        .faq-section h3 {
            color: #00d1ff;
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
            /* Prevents this header from shrinking */
        }

        .faq-container {
            overflow-y: auto;
            /* IMPORTANT: Adds scrolling ONLY to the question list */
            flex-grow: 1;
            padding-right: 15px;
        }

        .faq-item {
            background: rgba(0, 0, 0, 0.7);
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid rgba(0, 209, 255, 0.2);
            overflow: hidden;
        }

        .faq-question {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 17px;
            color: #eee;
            transition: background-color 0.3s ease;
        }

        .faq-question:hover {
            background-color: rgba(0, 209, 255, 0.1);
        }

        .faq-toggle {
            font-size: 24px;
            transition: transform 0.3s ease;
            transform: rotate(0deg);
            color: #00d1ff;
        }

        .faq-question.active .faq-toggle {
            transform: rotate(180deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            background: rgba(0, 0, 0, 0.3);
            padding: 0 20px;
            color: #ccc;
            font-size: 16px;
            line-height: 1.6;
        }

        .faq-answer p {
            padding: 20px 0;
        }



        /* Request forms  */
         /* Scoped styles for this specific form */
    .form-container { 
        max-width: 100%; 
        margin: 20px auto 0 auto; 
        background: rgba(0,0,0,0.4); 
        border: 1px solid rgba(0,209,255,0.3); 
        border-radius: 15px; 
        padding: 30px; 
    }
    .form-header { text-align: center; margin-bottom: 20px; }
    .form-header img { max-width: 120px; margin-bottom: 10px; }
    .form-header h3 { color: #fff; font-weight: bold; margin: 5px 0; letter-spacing: 1px; }
    .leave-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .leave-table td { 
        border: 1px solid rgba(255,255,255,0.3); 
        padding: 10px; 
        vertical-align: top; 
    }
    .leave-table strong { color: #00d1ff; }
    .leave-table input, .leave-table textarea, .leave-table select { 
        width: 100%; 
        padding: 4px; 
        background: rgba(0,0,0,0.5); 
        border: 1px solid #555; 
        border-radius: 4px; 
        color: #fff; 
        font-size: 14px; 
    }
    /* This is the new style to make the dropdown match the rest of the form */
    .leave-table select#teamLeadSelect {
        width: 250px;
    }
    .leave-table .centered-text { text-align: center; font-weight: bold; vertical-align: middle; }
    .form-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; }
    .form-btn { padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
    .btn-submit { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
    .btn-back { background: #6c757d; }
    /* Leave Form Specifics */
.leave-form-wrapper .leave-table .centered-text {
    text-align: center;
    font-weight: bold;
    vertical-align: middle;
}

/* Permission Form Specifics */
.permission-form-wrapper .form-table th,
.permission-form-wrapper .form-table td {
    padding: 12px;
}

.permission-form-wrapper .form-table input,
.permission-form-wrapper .form-table textarea,
.permission-form-wrapper .form-table select {
    padding: 4px;
}

/* Travel Form Specifics */
.travel-form-wrapper .form-table th,
.travel-form-wrapper .form-table td {
    font-size: 12px;
}

.travel-form-wrapper .signature-block {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

/* Conveyance Form Specifics */
.conveyance-form-wrapper .form-table th,
.conveyance-form-wrapper .form-table td {
    padding: 12px;
}


/* Styling for the new dashboard layout */
.attendance-dashboard {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: auto auto;
    gap: 20px;
    margin-top: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 15px;
    position: relative;
    overflow: hidden;
}

.attendance-dashboard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.03)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.02)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.03)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    pointer-events: none;
}

.attendance-card {
    background: rgba(30, 40, 60, 0.8);
    padding: 25px;
    border-radius: 15px;
    border: 1px solid rgba(0, 209, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    backdrop-filter: blur(10px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 180px;
}

.attendance-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 209, 255, 0.2);
    border-color: rgba(0, 209, 255, 0.4);
}

.card-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
    opacity: 0.8;
}

.card-content {
    width: 100%;
}

.attendance-card h3 {
    margin-bottom: 15px;
    font-size: 1.1rem;
    color: #ffffff;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.time-display {
    font-size: 1.8rem;
    font-weight: 700;
    color: #00ff88;
    margin-bottom: 8px;
    font-family: 'Courier New', monospace;
}

.status-display {
    font-size: 0.9rem;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-display.checked-in {
    color: #00ff88;
    background: rgba(0, 255, 136, 0.1);
    border: 1px solid rgba(0, 255, 136, 0.3);
}

.status-display.checked-out {
    color: #00ff88;
    background: rgba(0, 255, 136, 0.1);
    border: 1px solid rgba(0, 255, 136, 0.3);
}

.number-display {
    font-size: 2.5rem;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 8px;
    line-height: 1;
}

.description {
    font-size: 0.85rem;
    color: #b0b0b0;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.btn-request {
    background: var(--accent);
    color: var(--dark-bg);
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
}
.btn-request:hover {
    background: #47efb9;
}

/* Task Management Styles */
.task-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  overflow: hidden;
}

.task-table th,
.task-table td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.task-table th {
  background: rgba(0, 0, 0, 0.3);
  color: #00d1ff;
  font-weight: bold;
  font-size: 14px;
}

.task-table td {
  color: #fff;
  font-size: 14px;
}

.task-row.completed {
  opacity: 0.7;
}

.task-row.completed td:first-child {
  text-decoration: line-through;
  color: #888;
}

.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
  text-transform: uppercase;
}

.status-badge.pending {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
  border: 1px solid #ffc107;
}

.status-badge.completed {
  background: rgba(40, 167, 69, 0.2);
  color: #28a745;
  border: 1px solid #28a745;
}

.complete-button {
  background: linear-gradient(135deg, #28a745 0%, #218838 100%);
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
  transition: all 0.3s ease;
}

.complete-button:hover {
  background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
  transform: translateY(-1px);
}

.completed-text {
  color: #28a745;
  font-size: 12px;
  font-style: italic;
}

.strikethrough {
  text-decoration: line-through;
  color: #888;
}

/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: #1a1a1a;
  border-radius: 15px;
  padding: 0;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 25px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(0, 0, 0, 0.2);
}

.modal-header h3 {
  margin: 0;
  color: #00d1ff;
  font-size: 20px;
}

.modal-close {
  background: none;
  border: none;
  color: #fff;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.3s ease;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
}

.modal-body {
  padding: 25px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #fff;
  font-weight: bold;
  font-size: 14px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 25px;
  padding-top: 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.cancel-button {
  background: #6c757d;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.3s ease;
}

.cancel-button:hover {
  background: #5a6268;
}

.save-button {
  background: linear-gradient(135deg, #28a745 0%, #218838 100%);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  transition: all 0.3s ease;
}

.save-button:hover {
  background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
  transform: translateY(-1px);
}

/* Project Task Management Styles */
.project-task-list {
  margin-top: 20px;
}

.project-task-row.completed {
  opacity: 0.7;
}

.task-checkbox-label {
  display: flex;
  align-items: center;
  cursor: pointer;
  gap: 10px;
}

.task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.task-text {
  color: #fff;
  font-size: 14px;
}

.task-text.strikethrough {
  text-decoration: line-through;
  color: #888;
}

.project-list-item {
  background: rgba(255, 255, 255, 0.05);
  padding: 15px 20px;
  margin-bottom: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.project-list-item:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Assets UI Styles */
.assets-list-container {
    padding-top: 1rem;
    max-height: 75vh;
    overflow-y: auto;
}

.asset-item-card {
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    margin-bottom: 10px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.asset-item-card:hover {
    background-color: rgba(255, 255, 255, 0.15);
    border-color: rgba(0, 209, 255, 0.5);
}

.asset-header {
    padding: 15px 20px;
    background-color: rgba(0, 0, 0, 0.2);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    color: #fff;
}

.asset-header:hover {
    background-color: rgba(0, 0, 0, 0.3);
}

.asset-details {
    padding: 15px 20px;
    background-color: rgba(0, 0, 0, 0.1);
    display: none;
}

.asset-details.expanded {
    display: block;
}

.asset-detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.asset-detail-label {
    font-weight: bold;
    color: #00d1ff;
    min-width: 120px;
}

.asset-detail-value {
    color: #fff;
    flex: 1;
    text-align: right;
}

.asset-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.asset-action-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-edit {
    background-color: #007bff;
    color: white;
}

.btn-edit:hover {
    background-color: #0056b3;
}

.btn-delete {
    background-color: #dc3545;
    color: white;
}

.btn-delete:hover {
    background-color: #c82333;
}

.search-bar-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
}

.search-bar-container input {
    flex: 1;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: white;
    font-size: 16px;
}

.search-bar-container input::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.search-bar-container input:focus {
    outline: none;
    border-color: #00d1ff;
    box-shadow: 0 0 0 2px rgba(0, 209, 255, 0.2);
}

.filter-button {
    padding: 12px 20px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.filter-button:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: #00d1ff;
}

.filter-options {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.filter-dropdown {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-dropdown label {
    color: #00d1ff;
    font-weight: bold;
    font-size: 14px;
}

.filter-dropdown select {
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    color: white;
    font-size: 14px;
}

.filter-dropdown select:focus {
    outline: none;
    border-color: #00d1ff;
}

.back-button {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.back-button:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: #00d1ff;
}

.add-button {
    background: linear-gradient(135deg, #28a745 0%, #218838 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    transition: all 0.3s ease;
}

.add-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
}

/* Time and Date input styling - make icons white */
input[type="time"]::-webkit-calendar-picker-indicator,
input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
}

input[type="time"]::-webkit-calendar-picker-indicator:hover,
input[type="date"]::-webkit-calendar-picker-indicator:hover {
    filter: invert(1) brightness(1.2);
}

/* For Firefox */
input[type="time"]::-moz-calendar-picker-indicator,
input[type="date"]::-moz-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
}

input[type="time"]::-moz-calendar-picker-indicator:hover,
input[type="date"]::-moz-calendar-picker-indicator:hover {
    filter: invert(1) brightness(1.2);
}
  </style>
</head>

<body>
    <video autoplay muted loop playsinline id="bgVideo">
       
    <source src="{{ url_for('static', filename='videos/mdbbg.mp4') }}" type="video/mp4">
     
  </video>

    <div class="sidebar">
        <div class="user-greet">Hi, {{ username }}</div>
        <ul id="menuList"></ul>
      </div>

   <div class="topbar">
      <a href="/logout" class="logout-btn">Logout</a>
   </div>

    <div class="main">
              <div id="dashboard" class="tab-section active">
            <h2>📊 Dashboard</h2>
                   <div class="dashboard-widgets">
         <div class="widget" id="calendar-widget">
           <h3>📅 Today</h3>
           <div id="todayDate">--/--/----</div>
         </div>
         <div class="widget" id="clock-widget">
           <h3>🕒 Clock</h3>
           <div id="liveClock">--:--:--</div>
         </div>
         <div class="widget" id="total-tasks-widget">
           <h3>📋 Total Tasks</h3>
           <div class="stat-number" id="totalTasks">0</div>
         </div>
         <div class="widget" id="projects-widget">
           <h3>📁 Total Projects</h3>
           <div class="stat-number" id="totalProjects">0</div>
         </div>
         <div class="widget" id="tasks-widget">
           <h3>✅ Tasks Pending</h3>
           <div class="stat-number" id="pendingTasks">0</div>
         </div>
       </div>
            
            <div id="announcementNotifications"
        style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                <p style="text-align: center; color: #ccc;">Loading announcements...</p>
              </div>
          </div>
            
                     <div id="projects" class="tab-section">
       <div id="my-work-main-view">
         <h2>My Work</h2>
         <div class="work-nav-buttons" id="work-nav-buttons">
           <!-- Cards will be dynamically generated based on user role -->
         </div>
       </div>
       <div id="my-work-details-view" style="display: none;"></div>
       </div>
            
            <div id="assets" class="tab-section"></div>
            
    <div id="attendance" class="tab-section">
        <h2>📅 Attendance Module</h2>
        <div id="attendanceMainView">
            </div>
        <div id="attendanceFormView" style="display: none;">
            </div>
    </div>


    <div id="evaluation" class="tab-section">
        <h2>📊 Employee Evaluation</h2>
        <p style="color:#ccc; margin-bottom: 30px;">Access and manage employee evaluation reports</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:30px;">
            <div onclick="openEvaluationPage('start')" style="background-color: rgba(255, 255, 255, 0.12); padding: 30px; border-radius: 15px; display: flex; align-items: center; gap: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); transition: all 0.25s ease; cursor: pointer;" onmouseover="this.style.backgroundColor='rgba(0,123,255,0.3)'; this.style.transform='scale(1.02)';" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.12)'; this.style.transform='scale(1)';">
                <div style="font-size: 40px;">📝</div>
                <div>
                    <div style="font-size: 20px; font-weight: bold;">Start Report</div>
                    <div style="font-size: 14px; color: #ccc;">Begin your self-evaluation report</div>
                </div>
            </div>
            <div onclick="openEvaluationPage('evaluate')" id="evaluateReportBtn" style="display: none; background-color: rgba(255, 255, 255, 0.12); padding: 30px; border-radius: 15px; display: flex; align-items: center; gap: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); transition: all 0.25s ease; cursor: pointer;" onmouseover="this.style.backgroundColor='rgba(0,123,255,0.3)'; this.style.transform='scale(1.02)';" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.12)'; this.style.transform='scale(1)';">
                <div style="font-size: 40px;">📋</div>
                <div>
                    <div style="font-size: 20px; font-weight: bold;">Evaluate Report</div>
                    <div style="font-size: 14px; color: #ccc;">Review and evaluate employee reports</div>
                </div>
            </div>
        </div>
    </div>
      
      <div id="permissions" class="tab-section">
            </div>
            
            <div id="roles" class="tab-section">
                  <h2 style="margin-bottom: 20px;">🛡️ Roles Management</h2>
                  <div style="margin-bottom: 25px; display: flex; justify-content: flex-end;">
                        <button onclick="openAddRoleModal()"          
          style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">+
                    Add Role</button>
                      </div>
                  <div id="rolesListContainer" style="display: flex; flex-direction: column; gap: 20px;">
                        <p style="color: #ccc; text-align: center;">Loading roles...</p>
                      </div>
                </div>
            
            <div id="salaries" class="tab-section">
    <div class="salaries-container">
        <div class="salaries-header">
            <h2>💰 Salaries</h2>
            <label style="color: #eee; margin-right: 10px;">Employee Name:</label>
            <select id="employeeNameSelect" class="salaries-input" style="width: 200px; margin-bottom: 0;"></select>
            <button onclick="window.location.href='/logout'" style="padding: 10px 20px; background-color: rgba(255, 50, 50, 0.85); color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">Logout</button>
        </div>
        <div class="employee-info">
            <p style="color: #ccc; margin-bottom: 5px;">Employee ID: <span id="employeeId"></span></p>
            <p style="color: #ccc; margin-bottom: 5px;">Designation: <span id="employeeDesignation"></span></p>
            <p style="color: #ccc;">Account Number: <span id="employeeAccount"></span></p>
        </div>
        <div class="salaries-main-grid">
            <div class="salaries-section">
                <div class="salaries-section-header" onclick="toggleDropdown('actualsContent')">
                    <h3>Actuals</h3><span class="toggle-icon">▼</span>
                </div>
                <div id="actualsContent" class="salaries-section-content">
                    <div class="salaries-field-group">
                        <label for="actualGrossSalary">Actual Gross Salary:</label>
                        <input type="number" id="actualGrossSalary" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="basic">Basic:</label>
                        <input type="number" id="basic" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="hra">HRA:</label>
                        <input type="number" id="hra" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="conveyance">Conveyance:</label>
                        <input type="number" id="conveyance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="vehicleMaintenance">Vehicle Maintenance:</label>
                        <input type="number" id="vehicleMaintenance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="specialAllowance">Special Allowance:</label>
                        <input type="number" id="specialAllowance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="addOthersActuals">Add Others:</label>
                        <input type="number" id="addOthersActuals" value="0.00" oninput="calculateTotals()">
                    </div>
                </div>
            </div>
            <div class="salaries-section">
                <div class="salaries-section-header" onclick="toggleDropdown('earningsContent')">
                    <h3>Earnings</h3><span class="toggle-icon">▼</span>
                </div>
                <div id="earningsContent" class="salaries-section-content">
                    <div class="salaries-field-group">
                        <label for="earningsBasic">Basic:</label>
                        <input type="number" id="earningsBasic" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="earningsHra">HRA:</label>
                        <input type="number" id="earningsHra" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="earningsConveyance">Conveyance:</label>
                        <input type="number" id="earningsConveyance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="earningsVehicleMaintenance">Vehicle Maintenance:</label>
                        <input type="number" id="earningsVehicleMaintenance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="earningsSpecialAllowance">Special Allowance:</label>
                        <input type="number" id="earningsSpecialAllowance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="addOthersEarnings">Add Others:</label>
                        <input type="number" id="addOthersEarnings" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label>Total Earnings:</label>
                        <div id="totalEarnings" class="salaries-total-field">0.00</div>
                    </div>
                </div>
            </div>
            <div class="salaries-section">
                <div class="salaries-section-header" onclick="toggleDropdown('deductionsContent')">
                    <h3>Deductions</h3><span class="toggle-icon">▼</span>
                </div>
                <div id="deductionsContent" class="salaries-section-content">
                    <div class="salaries-field-group">
                        <label for="providentFund">Provident Fund:</label>
                        <input type="number" id="providentFund" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="esi">ESI:</label>
                        <input type="number" id="esi" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="professionalTax">Professional Tax:</label>
                        <input type="number" id="professionalTax" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="incomeTax">Income Tax:</label>
                        <input type="number" id="incomeTax" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="advance">Advance:</label>
                        <input type="number" id="advance" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="otherDeductions">Other Deductions:</label>
                        <input type="number" id="otherDeductions" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="lossOfPay">Loss of Pay:</label>
                        <input type="number" id="lossOfPay" value="0.00" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label>Total Deductions:</label>
                        <div id="totalDeductions" class="salaries-total-field">0.00</div>
                    </div>
                </div>
            </div>
            <div class="salaries-section">
                <div class="salaries-section-header" onclick="toggleDropdown('leavesContent')">
                    <h3>Leaves</h3><span class="toggle-icon">▼</span>
                </div>
                <div id="leavesContent" class="salaries-section-content">
                    <div class="salaries-field-group">
                        <label for="totalLeaves">Total Leaves:</label>
                        <input type="number" id="totalLeaves" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="leaveAvailed">Leave Availed:</label>
                        <input type="number" id="leaveAvailed" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="balanceLeaves">Balance:</label>
                        <input type="number" id="balanceLeaves" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="noOfLopDays">No. of LOP Days:</label>
                        <input type="number" id="noOfLopDays" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="totalDays">Total Days:</label>
                        <input type="number" id="totalDays" value="30" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label for="ndp">NDP:</label>
                        <input type="number" id="ndp" value="0" oninput="calculateTotals()">
                    </div>
                    <div class="salaries-field-group">
                        <label>Net Salary:</label>
                        <div id="netSalary" class="salaries-total-field">0.00</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="salaries-actions">
            <button class="save-btn" onclick="saveSalaryData()">Save Salary Data</button>
            <button class="download-btn" onclick="downloadPayslip()">Download Payslip</button>
            <button class="download-sheet-btn" id="downloadSsevSheet">Download SSEV Salary Sheet</button>
            <button class="download-sheet-btn" id="downloadSoftsolsSheet">Download Softsols Salary Sheet</button>
        </div>
    </div>
</div>
           
            
            <div id="vendor_payments" class="tab-section">
            <h2>💸 Vendor Payments</h2>
            <p>Manage vendor payments.</p>
          </div>
            <div id="vendor_details" class="tab-section">
            <h2>🏢 Vendor Details</h2>
            <p>Procurement vendor info.</p>
          </div>
            <div id="investment_plans" class="tab-section">
            <h2>📈 Investment Plans</h2>
            <p>Finance investment tracking.</p>
          </div>
            <div id="manage_employees" class="tab-section"></div>
            <div id="announcements" class="tab-section">
            <h2>📢 Announcements</h2>
            <p>HR announcements area.</p>
          </div>

            <div id="support" class="tab-section">
        <div id="supportContentContainer"></div>
    </div>
            <div id="billing" class="tab-section"></div>
            <div id="expenses" class="tab-section"></div>


            <div id="settings" class="tab-section">
    <h2 style="margin-bottom: 1px;">⚙️ Settings</h2>
    <div id="settings-main-content">
        <div onclick="loadSettingsPage('Appearance')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.08); padding: 16px 22px; border-radius: 8px; margin-top: 14px;">
            <span style="color: white; font-size: 17px;">Appearance</span>
            <span style="color: white; font-size: 18px;">▶</span>
        </div>
        <div onclick="loadSettingsPage('Profile Settings')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.08); padding: 16px 22px; border-radius: 8px; margin-top: 14px;">
            <span style="color: white; font-size: 17px;">Profile Settings</span>
            <span style="color: white; font-size: 18px;">▶</span>
        </div>
        <div onclick="resetAllSettings()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,0,0,0.2); padding: 16px 22px; border-radius: 8px; margin-top: 14px; border: 1px solid rgba(255,0,0,0.3);">
            <span style="color: #ff6b6b; font-size: 17px;">Undo All Settings</span>
            <span style="color: #ff6b6b; font-size: 18px;">↻</span>
        </div>
    </div>
</div>

      <div id="addRoleModal"    
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.65); display: none; justify-content: center; align-items: center; z-index: 9999;">
            <div      
      style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 400px; box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);">
                  <h3 style="margin-bottom: 20px; color: #fff;">Enter New Role Name</h3>
                  <input type="text" id="newRoleName" placeholder="e.g., Administrator"        
        style="margin-bottom:20px;width:100%;padding:10px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                  <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                        <button onclick="closeAddRoleModal()"          
          style="padding: 8px 16px; border: none; background: #6c757d; color: white; border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="createRole()"          
          style="padding: 8px 16px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">Save</button>
                      </div>
                </div>
          </div>

      <div id="addProjectModal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.75); display: none; justify-content: center; align-items: center; z-index: 9999;">
        <div style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 450px; box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);">
            <h3 style="margin-bottom: 20px; color: #fff;">Create New Project</h3>
            <input type="text" id="newProjectName" placeholder="Enter Project Name" style="margin-bottom:20px;width:100%;padding:12px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 16px;">
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                <button onclick="closeAddProjectModal()" style="padding: 10px 20px; border: none; background: #6c757d; color: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                <button onclick="saveNewProject()" style="padding: 10px 20px; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer;">Save</button>
            </div>
        </div>
    </div>
    
    <div id="addTaskModal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.75); display: none; justify-content: center; align-items: center; z-index: 9999;">
        <div style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 500px; box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);">
            <h3 style="margin-bottom: 20px; color: #fff;">Add New Task</h3>
            <input type="text" id="newTaskName" placeholder="Enter Task Name" style="margin-bottom:15px;width:100%;padding:12px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 16px;">
            <textarea id="newTaskDesc" placeholder="Enter Task Description" style="margin-bottom:15px;width:100%;padding:12px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 16px; height: 80px;"></textarea>
            <input type="datetime-local" id="newTaskDeadline" style="margin-bottom:20px;width:100%;padding:12px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 16px; color-scheme: dark;">
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                <button onclick="closeAddTaskModal()" style="padding: 10px 20px; border: none; background: #6c757d; color: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                <button id="saveTaskButton" onclick="" style="padding: 10px 20px; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer;">Save Task</button>
            </div>
        </div>
    </div>

      <div id="addUserModal"    
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.65); display: none; justify-content: center; align-items: center; z-index: 9999;">
            <div style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 400px;">
                  <h3 style="margin-bottom: 20px; color: #fff;">Add New User</h3>
                  <input type="text" id="fullName" placeholder="Full Name"        
        style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                  <input type="text" id="username" placeholder="Username"        
        style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                  <input type="email" id="email" placeholder="Email ID"        
        style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                  <div style="margin-bottom: 10px;">
                        <label style="color: #ccc; font-size: 14px;">Select Roles:</label><br>
                        <div id="roleList" style="margin-top: 5px;"></div>
                      </div>
                  <input type="password" id="userPass" placeholder="Password"        
        style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                  <input type="password" id="confirmPass" placeholder="Re-enter Password"        
        style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button onclick="generatePassword()"          
          style="padding:6px 12px;border:none;background:#17a2b8;color:white;border-radius:4px;">Auto Generate</button>
                        <div>
                              <button onclick="closeAddUserModal()"            
            style="margin-right:10px;padding:6px 12px;border:none;background:#6c757d;color:white;border-radius:4px;">Cancel</button>
                              <button onclick="submitUserForm()"            
            style="padding:6px 12px;border:none;background:#28a745;color:white;border-radius:4px;">Save</button>
                          </div>
                    </div>
              </div>

          <div id="manageUserModal"      
      style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.65); display: none; justify-content: center; align-items: center; z-index: 9999;">
                <div style="background: #1e1e1e; padding: 30px; border-radius: 10px; width: 400px;">
                      <h3 style="margin-bottom: 20px; color: #fff;">Manage User</h3>
                      <input type="text" id="editUsername" placeholder="Username"          
          style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                      <input type="email" id="editEmail" placeholder="Email ID"          
          style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                      <input type="password" id="editPassword" placeholder="New Password (optional)"          
          style="margin-bottom:10px;width:100%;padding:8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                      <div style="margin-bottom: 10px;">
                            <label style="color: #ccc; font-size: 14px;">Roles:</label><br>
                            <div id="editRoleList" style="margin-top: 5px;"></div>
                          </div>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="closeManageUserModal()"            
            style="margin-right:10px;padding:6px 12px;border:none;background:#6c757d;color:white;border-radius:4px;">Cancel</button>
                            <button onclick="submitUserUpdate()"            
            style="padding:6px 12px;border:none;background:#007bff;color:white;border-radius:4px;">Update</button>
                          </div>
                    </div>
              </div>


       
    <script>
      // Global variables to be used across all functions
      let userRoles = [];
      let currentProjectId = null;
      let currentProjectName = null;
      let currentUserId = null;
      // Assuming user_id is passed from the server

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDxKk8K8K8K8K8K8K8K8K8K8K8K8K8K8K8",
        authDomain: "lexicon-1a.firebaseapp.com",
        projectId: "lexicon-1a",
        storageBucket: "lexicon-1a.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:abcdefghijklmnop"
      };

      // Assets Firebase Configuration
      const assetsConfig = {
        apiKey: "AIzaSyC0PhruO5vbjdu8WMLWexXfJoICV86ysRE",
        authDomain: "assets-app-ssev.firebaseapp.com",
        projectId: "assets-app-ssev",
        storageBucket: "assets-app-ssev.appspot.com",
        messagingSenderId: "628586705896",
        appId: "1:628586705896:web:8c7bb831ad56222e2e6a5d"
      };

      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);                            // default app
        firebase.initializeApp(assetsConfig, "assetsApp");                 // assets app
      }
      const db = firebase.firestore();
      const dbAssets = firebase.firestore(firebase.app("assetsApp"));

      const permissionMap = {
        'Home': { id: 'dashboard', name: 'Dashboard' },
        'Users': { id: 'manage_employees', name: 'Users' },
        'Teams & Groups': { id: 'projects', name: 'Projects' },
        'Attendance (Admin)': { id: 'attendance', name: 'Attendance' },
        'Attendance (Employee)': { id: 'attendance', name: 'Attendance' },
        'Evaluation': { id: 'evaluation', name: 'Evaluation' },
        'Roles': { id: 'roles', name: 'Roles' },
        'Salaries': { id: 'salaries', name: 'Salaries' },
        'Assets': { id: 'assets', name: 'Assets' },
        'Billing': { id: 'billing', name: 'Billing' },
        'Support': { id: 'support', name: 'Support' },
        'Settings': { id: 'settings', name: 'Settings' },
        'Accounts': { id: 'expenses', name: 'Expenses' },
        'Finance': { id: 'investment_plans', name: 'Investment Plans' },
        'Procurement': { id: 'vendor_details', name: 'Vendor Details' },
        'Vendor Payments': { id: 'vendor_payments', name: 'Vendor Payments' }
      };

      async function populateSidebar() {
        try {
          const response = await fetch('/api/user_modules');
          const data = await response.json();
          
          if (data.status === 'success') {
            const menuList = document.getElementById('menuList');
            if (!menuList) {
              console.error('menuList element not found');
              return;
            }
            
            menuList.innerHTML = '';
            const displayedSections = new Set();
            userRoles = data.roles; // Set the global userRoles variable
            
            // Generate work navigation cards based on user role
            generateWorkNavigationCards();

            // Show/hide evaluation buttons based on user role
            updateEvaluationButtons();

            const dashboardItem = document.createElement('li');
            dashboardItem.textContent = 'Dashboard';
            dashboardItem.onclick = () => showSection('dashboard');
            menuList.appendChild(dashboardItem);
            displayedSections.add('dashboard');


            data.modules.forEach(permissionName => {
              const mapEntry = permissionMap[permissionName];
              if (mapEntry && !displayedSections.has(mapEntry.id)) {
                const listItem = document.createElement('li');
                listItem.textContent = mapEntry.name;
                listItem.onclick = () => showSection(mapEntry.id);
                menuList.appendChild(listItem);
                displayedSections.add(mapEntry.id);
              }
            });

            if (menuList.children.length > 0) menuList.children[0].click();
          } else {
            console.error('Failed to fetch user modules:', data.message);
          }
        } catch (error) {
          console.error('Error fetching modules:', error);
        }
      }

      function showSection(id) {
        document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
        const sectionEl = document.getElementById(id);
        if (sectionEl) sectionEl.classList.add('active');

        document.querySelectorAll('.sidebar ul li').forEach(li => li.classList.remove('active'));
        const menuItems = document.querySelectorAll('#menuList li');
        menuItems.forEach(item => {
          const displayName = item.textContent.trim();
          for (const perm in permissionMap) {
            if (permissionMap[perm].name === displayName && permissionMap[perm].id === id) {
              item.classList.add('active');
              break;
            }

          }
        });

        switch (id) {
          case 'dashboard': showDashboardAnnouncements(); break;
          case 'projects': showMyWorkMainView(); break;
          case 'roles': loadRolesSection(); break;
          case 'manage_employees': loadUsersSection(); break;
          case 'salaries': loadSalariesSection(); break;
          case 'attendance': loadPermissionsSection(); break;
          case 'settings': loadSettingsPage('main'); break;
          case 'support': loadSupportSection(); break;
          case 'assets': loadAssetsMenu(); break;
          case 'evaluation': updateEvaluationButtons(); break;
          default: break;
        }
      }

      // Function to update evaluation buttons based on user role
      function updateEvaluationButtons() {
        const evaluateBtn = document.getElementById('evaluateReportBtn');
        if (evaluateBtn) {
          const roles = Array.isArray(userRoles) ? userRoles : [];
          const canEvaluate = roles.some(role => 
            ['Team Lead', 'HR', 'Director', 'Managing Director'].includes(role)
          );
          evaluateBtn.style.display = canEvaluate ? 'flex' : 'none';
        }
      }

      // Function to open evaluation pages
      function openEvaluationPage(type) {
        if (type === 'start') {
          // Open in same tab for Start Report
          window.location.href = '/evaluation/start';
        } else if (type === 'evaluate') {
          // Open in same tab for Evaluate Report
          window.location.href = '/evaluation/evaluate';
        }
      }

      // --- SUPPORT SECTION ---
      function loadSupportSection() {
        const supportContainer = document.getElementById('support');
        if (!supportContainer) return;

        supportContainer.innerHTML = `
            <h2 style="margin-bottom: 20px;">💬 Support</h2>
            <div class="query-box">
                <form id="supportQueryForm">
                    <textarea id="supportQueryText" placeholder="Type your query here..." style="width: 100%; height: 120px; padding: 10px; border-radius: 5px; border: 1px solid #555; background: #222; color: #fff;"></textarea>
                    <button type="submit" class="add-button" style="margin-top: 15px;">Send Query</button>
                </form>
            </div>
            <div class="faq-section">
                <h3 style="text-align: center; color: #00d1ff; margin-bottom: 20px;">Frequently Asked Questions</h3>
                <div class="faq-container">
                    <p style="text-align:center; color: #ccc;">FAQs will be displayed here.</p>
                </div>
            </div>
        `;
        document.getElementById('supportQueryForm').addEventListener('submit', function (event) {
          event.preventDefault();
          const queryText = document.getElementById('supportQueryText').value;
          if (queryText.trim() === "") {
            alert("Please enter your query.");
            return;
          }
          const subject = "New Support Query from ERP Dashboard";
          const body = encodeURIComponent(queryText);
          window.location.href = `mailto:admin@ssev.co.in?subject=${subject}&body=${body}`;
        });
      }

      // --- ROLES SECTION ---
      async function loadRolesSection() {
        const rolesListContainer = document.getElementById('rolesListContainer');
        rolesListContainer.innerHTML = '<p style="color: #ccc; text-align: center;">Loading roles...</p>';
        try {
          const response = await fetch('/api/roles');
          const data = await response.json();
          if (data.status === 'success') {
            rolesListContainer.innerHTML = '';
            if (data.roles.length === 0) {
              rolesListContainer.innerHTML = '<p style="color: #ccc; text-align: center;">No roles found.</p>';
            } else {
              data.roles.forEach(role => {
                const roleCard = `<div onclick="showRolePermissions('${role}')" style="background-color: rgba(255, 255, 255, 0.12); padding: 25px 40px; border-radius: 18px; display: flex; align-items: center; gap: 25px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); transition: all 0.25s ease; cursor: pointer; position: relative;" onmouseover="this.style.backgroundColor='rgba(0,123,255,0.3)';" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.12)';">
                  <div style="font-size: 32px;">🛡️</div>
                  <div>
                    <div style="font-size: 20px; font-weight: bold;">${role}</div>
                    <div style="font-size: 14px; color: #ccc;">Click to manage permissions for this role.</div>
                  </div>
                </div>`;
                rolesListContainer.insertAdjacentHTML('beforeend', roleCard);
              });
            }
          } else {
            rolesListContainer.innerHTML = `<p style="color:red; text-align: center;">Error loading roles: ${data.message}</p>`;
          }
        } catch (error) {
          rolesListContainer.innerHTML = `<p style="color:red; text-align: center;">Failed to fetch roles from server.</p>`;
        }
      }

      function openAddRoleModal() { document.getElementById("addRoleModal").style.display = "flex"; }
      function closeAddRoleModal() { document.getElementById("addRoleModal").style.display = "none"; }




      // ==================================================================
      // 1. USERS MODULE
      // ==================================================================
      let currentUserEmail = "";
      function getContentContainer() { return document.getElementById('manage_employees') || document.getElementById('mainContent'); }
      function loadUsersSection() {
        const html = `
          <h2 style="margin-bottom: 20px;">👥 User Management</h2>
          <div style="display:flex; flex-wrap:wrap; gap:20px; justify-content:flex-start;">
            <div onclick="loadActiveUsers()" style="cursor:pointer; background-color: rgba(255, 255, 255, 0.12); padding: 35px 40px; border-radius: 18px; display: flex; align-items: center; gap: 25px;"><div style="font-size: 48px;">✅</div><div><div style="font-size: 22px; font-weight: bold;">Active Users</div><div style="font-size: 15px; color: #ccc;">Manage active users.</div></div></div>
            <div onclick="loadUserInfoPage()" style="cursor:pointer; background-color: rgba(255, 255, 255, 0.12); padding: 35px 40px; border-radius: 18px; display: flex; align-items: center; gap: 25px;"><div style="font-size: 48px;">📇</div><div><div style="font-size: 22px; font-weight: bold;">User Info</div><div style="font-size: 15px; color: #ccc;">Manage user info.</div></div></div>
            <div onclick="loadDeletedUsersPage()" style="cursor:pointer; background-color: rgba(255, 255, 255, 0.12); padding: 35px 40px; border-radius: 18px; display: flex; align-items: center; gap: 25px;"><div style="font-size: 48px;">🗑️</div><div><div style="font-size: 22px; font-weight: bold;">Deleted Users</div><div style="font-size: 15px; color: #ccc;">Manage deleted users.</div></div></div>
            <div onclick="loadAnnouncementsPage()" style="cursor:pointer; background-color: rgba(255, 255, 255, 0.12); padding: 35px 40px; border-radius: 18px; display: flex; align-items: center; gap: 25px;"><div style="font-size: 48px;">📢</div><div><div style="font-size: 22px; font-weight: bold;">Announcements</div><div style="font-size: 15px; color: #ccc;">Manage announcements.</div></div></div>
          </div>`;
        const container = getContentContainer();
        if (container) container.innerHTML = html;
      }
      function loadActiveUsers() { /* ... function code ... */ }
      async function loadUserInfoPage() { /* ... function code ... */ }
      async function fetchEmployeeInfoList() { /* ... function code ... */ }
      function loadAddEmployeeForm() { /* ... function code ... */ }
      function loadDeletedUsersPage() { /* ... function code ... */ }
      function restoreUser(email) { /* ... function code ... */ }
      async function populateRoleCheckboxes(elementId, selectedRoles = []) { /* ... function code ... */ }

      // ========= Employee Edit Functions =========
      async function editEmployeeDetails(employeeId) {
            const container = getContentContainer();
            container.innerHTML = `<p style="text-align: center; color: #ccc;">Loading employee details...</p>`;
            try {
                const response = await fetch(`/api/get_employee_info/${employeeId}`);
                const result = await response.json();
                if (result.status === 'success') {
                    const emp = result.employee;
                    container.innerHTML = `
                        <h2 style="margin-bottom: 20px;">📝 Edit Employee Info: <span style="color: #00d1ff;">${emp.full_name}</span></h2>
                        <div style="max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.08); padding: 30px; border-radius: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="salaries-field-group">
                                    <label for="editEmpFullName">Full Name *</label>
                                    <input type="text" id="editEmpFullName" value="${emp.full_name}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpEmail">Email *</label>
                                    <input type="email" id="editEmpEmail" value="${emp.email}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpDOB">Date of Birth</label>
                                    <input type="date" id="editEmpDOB" value="${emp.dob || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpPhoneNo">Phone Number</label>
                                    <input type="tel" id="editEmpPhoneNo" value="${emp.phone_no || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpGender">Gender</label>
                                    <input type="text" id="editEmpGender" value="${emp.gender || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpAddress">Address</label>
                                    <textarea id="editEmpAddress">${emp.address || ''}</textarea>
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpFatherName">Father's Name</label>
                                    <input type="text" id="editEmpFatherName" value="${emp.father_name || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpFatherContact">Father's Contact</label>
                                    <input type="tel" id="editEmpFatherContact" value="${emp.father_contact || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpMotherName">Mother's Name</label>
                                    <input type="text" id="editEmpMotherName" value="${emp.mother_name || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpMotherContact">Mother's Contact</label>
                                    <input type="tel" id="editEmpMotherContact" value="${emp.mother_contact || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmp10thCGPA">10th CGPA</label>
                                    <input type="text" id="editEmp10thCGPA" value="${emp.tenth_cgpa || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpInterCGPA">Intermediate CGPA</label>
                                    <input type="text" id="editEmpInterCGPA" value="${emp.inter_cgpa || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpBtechCGPA">Graduation CGPA</label>
                                    <input type="text" id="editEmpBtechCGPA" value="${emp.btech_cgpa || ''}">
                                </div>
                                <div class="salaries-field-group">
                                    <label for="editEmpEmployeeId">Employee ID</label>
                                    <input type="text" id="editEmpEmployeeId" value="SSDEV-${emp.id.toString().padStart(2, '0')}-002" readonly style="background: rgba(255,255,255,0.1); color: #ccc;">
                                </div>
                            </div>
                            
                            <!-- Accounts Section -->
                            <div style="margin-top: 30px;">
                                <h3 style="color: #00d1ff; margin-bottom: 20px; border-bottom: 2px solid #00d1ff; padding-bottom: 10px;">💰 Accounts Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="salaries-field-group">
                                        <label for="editEmpAccountNumber">Account Number</label>
                                        <input type="text" id="editEmpAccountNumber" value="${emp.account_number || ''}">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpActualGrossSalary">Actual Gross Salary</label>
                                        <input type="number" id="editEmpActualGrossSalary" value="${emp.actual_gross_salary || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpBasic">Basic Salary</label>
                                        <input type="number" id="editEmpBasic" value="${emp.basic || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpHRA">HRA</label>
                                        <input type="number" id="editEmpHRA" value="${emp.hra || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpConveyance">Conveyance</label>
                                        <input type="number" id="editEmpConveyance" value="${emp.conveyance || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpSpecialAllowance">Special Allowance</label>
                                        <input type="number" id="editEmpSpecialAllowance" value="${emp.special_allowance || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpProvidentFund">Provident Fund</label>
                                        <input type="number" id="editEmpProvidentFund" value="${emp.provident_fund || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpESI">ESI</label>
                                        <input type="number" id="editEmpESI" value="${emp.esi || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpProfessionalTax">Professional Tax</label>
                                        <input type="number" id="editEmpProfessionalTax" value="${emp.professional_tax || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpIncomeTax">Income Tax</label>
                                        <input type="number" id="editEmpIncomeTax" value="${emp.income_tax || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpAdvance">Advance</label>
                                        <input type="number" id="editEmpAdvance" value="${emp.advance || ''}" step="0.01">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpTotalLeaves">Total Leaves</label>
                                        <input type="number" id="editEmpTotalLeaves" value="${emp.total_leaves || ''}">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Documents Section -->
                            <div style="margin-top: 30px;">
                                <h3 style="color: #00d1ff; margin-bottom: 20px; border-bottom: 2px solid #00d1ff; padding-bottom: 10px;">📄 Documents</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="salaries-field-group">
                                        <label for="editEmpResume">Upload Resume</label>
                                        <input type="file" id="editEmpResume" accept=".pdf, .doc, .docx" style="padding: 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpAadhaar">Aadhaar Card</label>
                                        <input type="file" id="editEmpAadhaar" accept=".pdf, .jpg, .jpeg, .png" style="padding: 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpPAN">PAN Card</label>
                                        <input type="file" id="editEmpPAN" accept=".pdf, .jpg, .jpeg, .png" style="padding: 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
                                    </div>
                                    <div class="salaries-field-group">
                                        <label for="editEmpPassportPhoto">Passport Photo</label>
                                        <input type="file" id="editEmpPassportPhoto" accept=".jpg, .jpeg, .png" style="padding: 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
                                    </div>
                                </div>
                            </div>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                                <button onclick="viewEmployeeDetails(${emp.id})" style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Cancel</button>
                                <button onclick="saveEmployeeDetails(${emp.id})" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Save</button>
                            </div>
                        </div>
                    `;
                } else {
                    alert('Error: ' + result.message);
                    loadUserInfoPage();
                }
            } catch (error) {
                alert('Failed to load employee details for editing.');
                loadUserInfoPage();
            }
        }

        async function saveEmployeeDetails(employeeId) {
            const fullName = document.getElementById('editEmpFullName').value;
            const email = document.getElementById('editEmpEmail').value;
            const dob = document.getElementById('editEmpDOB').value;
            const phoneNo = document.getElementById('editEmpPhoneNo').value;
            const gender = document.getElementById('editEmpGender').value;
            const address = document.getElementById('editEmpAddress').value;
            const fatherName = document.getElementById('editEmpFatherName').value;
            const fatherContact = document.getElementById('editEmpFatherContact').value;
            const motherName = document.getElementById('editEmpMotherName').value;
            const motherContact = document.getElementById('editEmpMotherContact').value;
            const tenthCGPA = document.getElementById('editEmp10thCGPA').value;
            const interCGPA = document.getElementById('editEmpInterCGPA').value;
            const btechCGPA = document.getElementById('editEmpBtechCGPA').value;
            
            // Accounts fields
            const accountNumber = document.getElementById('editEmpAccountNumber').value;
            const actualGrossSalary = document.getElementById('editEmpActualGrossSalary').value;
            const basic = document.getElementById('editEmpBasic').value;
            const hra = document.getElementById('editEmpHRA').value;
            const conveyance = document.getElementById('editEmpConveyance').value;
            const specialAllowance = document.getElementById('editEmpSpecialAllowance').value;
            const providentFund = document.getElementById('editEmpProvidentFund').value;
            const esi = document.getElementById('editEmpESI').value;
            const professionalTax = document.getElementById('editEmpProfessionalTax').value;
            const incomeTax = document.getElementById('editEmpIncomeTax').value;
            const advance = document.getElementById('editEmpAdvance').value;
            const totalLeaves = document.getElementById('editEmpTotalLeaves').value;

            if (!fullName || !email) {
                alert("Full Name and Email are required.");
                return;
            }

            const formData = new FormData();
            formData.append('id', employeeId);
            formData.append('full_name', fullName);
            formData.append('email', email);
            formData.append('dob', dob);
            formData.append('gender', gender);
            formData.append('father_name', fatherName);
            formData.append('father_contact', fatherContact);
            formData.append('mother_name', motherName);
            formData.append('mother_contact', motherContact);
            formData.append('phone_no', phoneNo);
            formData.append('address', address);
            formData.append('tenth_cgpa', tenthCGPA);
            formData.append('inter_cgpa', interCGPA);
            formData.append('btech_cgpa', btechCGPA);
            formData.append('account_number', accountNumber);
            formData.append('actual_gross_salary', actualGrossSalary);
            formData.append('basic', basic);
            formData.append('hra', hra);
            formData.append('conveyance', conveyance);
            formData.append('special_allowance', specialAllowance);
            formData.append('provident_fund', providentFund);
            formData.append('esi', esi);
            formData.append('professional_tax', professionalTax);
            formData.append('income_tax', incomeTax);
            formData.append('advance', advance);
            formData.append('total_leaves', totalLeaves);

            // Add file uploads
            const pdcFile = document.getElementById('editEmpPDC').files[0];
            if (pdcFile) formData.append('pdc', pdcFile);
            
            const aadhaarFile = document.getElementById('editEmpAadhaar').files[0];
            if (aadhaarFile) formData.append('aadhaar_card', aadhaarFile);
            
            const panFile = document.getElementById('editEmpPAN').files[0];
            if (panFile) formData.append('pan_card', panFile);
            
            const resumeFile = document.getElementById('editEmpResume').files[0];
            if (resumeFile) formData.append('resume', resumeFile);

            try {
                const response = await fetch('/api/update_employee_info', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Employee information updated successfully!');
                    viewEmployeeDetails(employeeId); // Show the updated details
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Failed to update employee information.');
            }
        }

        // Version 2.0 - Updated with Internship Fields
        async function viewEmployeeDetails(employeeId) {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `<p style="text-align: center; color: #ccc;">Loading employee details... (v2.0)</p>`;
            try {
                const response = await fetch(`/api/get_employee_info/${employeeId}?v=${Date.now()}`);
                const result = await response.json();

                if (result.status === 'success' && result.employee) {
                    const emp = result.employee;
                    
                    // Debug: Log the employee data to console
                    console.log('Employee data received:', emp);
                    console.log('Internship From:', emp.internship_from);
                    console.log('Internship To:', emp.internship_to);
                    mainContent.innerHTML = `
                        <h2 style="margin-bottom: 20px;">👤 Employee Details: <span style="color: #00d1ff;">${emp.full_name}</span></h2>
                        <div style="background: rgba(0, 209, 255, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #00d1ff;">
                            <strong style="color: #00d1ff;">📅 Updated Version - Includes Internship Fields</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                            <button onclick="loadUserInfoPage()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer;">← Back to User Info</button>
                            <button onclick="editEmployeeDetails(${emp.id})" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Edit</button>
                        </div>
                        <div style="max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.08); padding: 30px; border-radius: 12px;">
                            <h4 style="color: #00d1ff; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Personal Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                                <div class="salaries-field-group"><strong>Full Name:</strong> ${emp.full_name || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Email:</strong> ${emp.email || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Employee ID:</strong> SSDEV-${emp.id.toString().padStart(2, '0')}-002</div>
                                <div class="salaries-field-group"><strong>Date of Birth:</strong> ${emp.dob || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Phone Number:</strong> ${emp.phone_no || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Gender:</strong> ${emp.gender || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Office Branch:</strong> ${emp.office_branch || 'N/A'}</div>
                                <div class="salaries-field-group" style="grid-column: 1 / -1;"><strong>Address:</strong> ${emp.address || 'N/A'}</div>
                            </div>
                            <h4 style="color: #00d1ff; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Employment Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                                <div class="salaries-field-group"><strong>Designation:</strong> ${emp.designation || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Marital Status:</strong> ${emp.marital_status || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Date of Joining:</strong> ${emp.date_of_joining || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Confirmation Date:</strong> ${emp.confirmation_date || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Date of Anniversary:</strong> ${emp.date_of_anniversary || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Probation Period From:</strong> ${emp.probation_from || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Probation Period To:</strong> ${emp.probation_to || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Internship Period From:</strong> ${emp.internship_from || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Internship Period To:</strong> ${emp.internship_to || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Probation Salary:</strong> ${emp.probation_salary || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Confirmation Salary:</strong> ${emp.confirmation_salary || 'N/A'}</div>
                            </div>
                            <h4 style="color: #00d1ff; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Family Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                                <div class="salaries-field-group"><strong>Father's Name:</strong> ${emp.father_name || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Father's Contact:</strong> ${emp.father_contact || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Mother's Name:</strong> ${emp.mother_name || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Mother's Contact:</strong> ${emp.mother_contact || 'N/A'}</div>
                            </div>
                            
                            <h4 style="color: #00d1ff; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Accounts Section</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                                <div class="salaries-field-group" style="grid-column: 1 / -1;"><strong>Account Number:</strong> ${emp.account_number || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Actual Gross Salary:</strong> ${emp.actual_gross_salary || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Basic:</strong> ${emp.basic || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>HRA:</strong> ${emp.hra || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Conveyance:</strong> ${emp.conveyance || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Special Allowance:</strong> ${emp.special_allowance || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Provident Fund:</strong> ${emp.provident_fund || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>ESI:</strong> ${emp.esi || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Professional Tax:</strong> ${emp.professional_tax || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Income Tax:</strong> ${emp.income_tax || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Advance:</strong> ${emp.advance || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Total Leaves:</strong> ${emp.total_leaves || 'N/A'}</div>
                            </div>

                            <h4 style="color: #00d1ff; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Educational & Document Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                                <div class="salaries-field-group"><strong>10th CGPA:</strong> ${emp.tenth_cgpa || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Intermediate CGPA:</strong> ${emp.inter_cgpa || 'N/A'}</div>
                                <div class="salaries-field-group"><strong>Graduation CGPA:</strong> ${emp.btech_cgpa || 'N/A'}</div>
                                <div class="salaries-field-group">
                                    <strong>PDC:</strong> 
                                    ${emp.pdc ? `<a href="/uploads/${emp.pdc}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.pdc}</a>` : 'N/A'}
                                </div>
                                <div class="salaries-field-group">
                                    <strong>Aadhaar Card:</strong> 
                                    ${emp.aadhaar_card ? `<a href="/uploads/${emp.aadhaar_card}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.aadhaar_card}</a>` : 'N/A'}
                                </div>
                                <div class="salaries-field-group">
                                    <strong>Pan Card:</strong> 
                                    ${emp.pan_card ? `<a href="/uploads/${emp.pan_card}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.pan_card}</a>` : 'N/A'}
                                </div>
                                <div class="salaries-field-group">
                                    <strong>Resume:</strong> 
                                    ${emp.resume ? `<a href="/uploads/${emp.resume}" target="_blank" style="color: #00d1ff; text-decoration: underline;">${emp.resume}</a>` : 'N/A'}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // If employee info is not found, show a message and prompt to add it
                    mainContent.innerHTML = `
                        <h2 style="margin-bottom: 20px;">❌ Employee Details Not Found</h2>
                        <p style="text-align: center; color: #ccc; margin-bottom: 20px;">
                            Employee information for this user does not exist. Please add it.
                        </p>
                        <div style="display: flex; justify-content: center; gap: 10px;">
                            <button onclick="loadUserInfoPage()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer;">← Back to User Info</button>
                        </div>
                    `;
                }
            } catch (error) {
                alert('Failed to fetch employee details.');
                loadUserInfoPage();
            }
        }

      // ========= Announcements =========
      function loadAnnouncementsPage() {
        const container = getContentContainer();
        if (!container) return;

        fetch('/api/user/roles')
          .then(res => res.json())
          .then(data => {
            const userRoles = data.status === 'success' ? data.roles : [];
            const canCreate = userRoles.some(role => ['Admin', 'Manager', 'Team Lead'].includes(role));

            let createButton = '';
            if (canCreate) {
              createButton = `
                <button onclick="openCreateAnnouncementModal()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                  📝 Create Announcement
                </button>
              `;
            }

            container.innerHTML = `
              <h2>📢 Announcements</h2>
              <p style="color:#ccc;">${canCreate ? 'Manage and view system announcements' : 'View system announcements'}</p>
              
              <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
                ${createButton}
                <button onclick="refreshAnnouncements()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                  🔄 Refresh
                </button>
              </div>

              <div style="margin-top: 30px;">
                <h3>📋 ${canCreate ? 'All Announcements' : 'Announcements'}</h3>
                <div id="announcementsList" style="margin-top: 20px;"></div>
              </div>
            `;

            loadAnnouncements(canCreate);
          })
          .catch(error => {
            container.innerHTML = '<h2>❌ Error</h2><p>Failed to load user permissions.</p>';
          });
      }

      function loadAnnouncements(canCreate = false) {
        const endpoint = canCreate ? '/api/announcements/all' : '/api/announcements';
        fetch(endpoint)
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              displayAnnouncements(data.announcements, canCreate);
            } else {
              document.getElementById('announcementsList').innerHTML = `<p style="color: #ff6b6b;">Error: ${data.message}</p>`;
            }
          })
          .catch(error => {
            document.getElementById('announcementsList').innerHTML = `<p style="color: #ff6b6b;">Error loading announcements: ${error.message}</p>`;
          });
      }

      function displayAnnouncements(announcements, canCreate = false) {
        const container = document.getElementById('announcementsList');
        if (announcements.length === 0) {
          container.innerHTML = '<p style="color: #ccc;">No announcements found.</p>';
          return;
        }

        let html = '<div style="display: grid; gap: 20px;">';
        announcements.forEach(announcement => {
          const priorityColor = getPriorityColor(announcement.priority);
          const statusBadge = announcement.is_active ?
            '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Active</span>' :
            '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Inactive</span>';

          let actionButtons = '';
          if (canCreate) {
            actionButtons = `
              <div style="display: flex; gap: 10px;">
                <button onclick="editAnnouncement(${announcement.id})" style="padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Edit</button>
                <button onclick="deleteAnnouncement(${announcement.id})" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
              </div>
            `;
          }

          html += `
            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; border-left: 4px solid ${priorityColor};">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                <h4 style="margin: 0; color: white;">${announcement.title}</h4>
                <div style="display: flex; gap: 10px; align-items: center;">
                  ${statusBadge}
                  <span style="background: ${priorityColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">${announcement.priority}</span>
                </div>
              </div>
              <p style="color: #ccc; margin-bottom: 15px; line-height: 1.5;">${announcement.content}</p>
              <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #999;">
                <div>
                  <span>👤 ${announcement.author_name}</span>
                  <span style="margin-left: 15px;">📅 ${announcement.created_at}</span>
                  ${announcement.expires_at ? `<span style="margin-left: 15px;">⏰ Expires: ${announcement.expires_at}</span>` : ''}
                  ${announcement.target_roles && announcement.target_roles.length > 0 ? `<span style="margin-left: 15px;">🎯 ${announcement.target_roles.join(', ')}</span>` : ''}
                  ${announcement.target_users && announcement.target_users.length > 0 ? `<span style="margin-left: 15px;">👥 ${announcement.target_users.length} user(s)</span>` : ''}
                </div>
                ${actionButtons}
              </div>
            </div>
          `;
        });
        html += '</div>';
        container.innerHTML = html;
      }

      function getPriorityColor(priority) {
        switch (priority.toLowerCase()) {
          case 'urgent': return '#dc3545';
          case 'high': return '#fd7e14';
          case 'normal': return '#007bff';
          case 'low': return '#6c757d';
          default: return '#007bff';
        }
      }

      function openCreateAnnouncementModal() {
        const modal = document.createElement('div');
        modal.id = 'createAnnouncementModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
          align-items: center; justify-content: center;
        `;

        modal.innerHTML = `
          <div style="background: rgba(0,0,0,0.9); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; color: white;">📝 Create New Announcement</h3>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 5px; color: white;">Announcement Title *</label>
              <input type="text" id="announcementTitle" required placeholder="Enter announcement title" style="width: 100%; padding: 10px; border: 1px solid #666; border-radius: 5px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
              <button type="button" onclick="closeCreateAnnouncementModal()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button type="button" onclick="saveAnnouncementTitle()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Save</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      function saveAnnouncementTitle() {
        const title = document.getElementById('announcementTitle').value.trim();
        if (!title) {
          alert('Please enter an announcement title');
          return;
        }
        sessionStorage.setItem('pendingAnnouncementTitle', title);
        showRecipientSelection();
      }

      function showRecipientSelection() {
        const modal = document.getElementById('createAnnouncementModal');
        if (!modal) return;
        modal.innerHTML = `
          <div style="background: rgba(0,0,0,0.9); padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; color: white;">📢 Select Recipients</h3>
            <p style="color: #ccc; margin-bottom: 20px;">Who should receive this announcement?</p>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 10px; color: white;">Recipient Type:</label>
              <select id="recipientType" onchange="handleRecipientTypeChange()" style="width: 100%; padding: 10px; border: 1px solid #666; border-radius: 5px; background: rgba(255,255,255,0.1); color: white;">
                <option value="">-- Select Recipient Type --</option>
                <option value="teamleader">Team Leader</option>
                <option value="allusers">All Users</option>
                <option value="individual">Individual Users</option>
              </select>
            </div>
            
            <div id="individualUsersSection" style="display: none; margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 10px; color: white;">Select Individual Users:</label>
              <div id="activeUsersList" style="max-height: 200px; overflow-y: auto; border: 1px solid #666; border-radius: 5px; padding: 10px; background: rgba(255,255,255,0.05);">
                <p style="color: #ccc; text-align: center;">Loading users...</p>
              </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
              <button type="button" onclick="closeCreateAnnouncementModal()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button type="button" onclick="createAnnouncementWithRecipients()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Send Announcement</button>
            </div>
          </div>
        `;
        loadActiveUsersForSelection();
      }

      function handleRecipientTypeChange() {
        const recipientType = document.getElementById('recipientType').value;
        const individualSection = document.getElementById('individualUsersSection');
        if (recipientType === 'individual') {
          individualSection.style.display = 'block';
        } else {
          individualSection.style.display = 'none';
        }
      }

      function loadActiveUsersForSelection() {
        fetch('/api/users')
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              const usersList = document.getElementById('activeUsersList');
              let html = '';
              data.users.forEach(user => {
                html += `
                  <div style="margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; color: white; cursor: pointer;">
                      <input type="checkbox" name="selectedUsers" value="${user.email}" style="transform: scale(1.2);">
                      <span>${user.name} (${user.email})</span>
                    </label>
                </div>
                `;
              });
              usersList.innerHTML = html;
            } else {
              document.getElementById('activeUsersList').innerHTML = '<p style="color: #ff6b6b;">Error loading users</p>';
            }
          })
          .catch(error => {
            document.getElementById('activeUsersList').innerHTML = '<p style: #ff6b6b;">Error: ' + error.message + '</p>';
          });
      }

      function createAnnouncementWithRecipients() {
        const recipientType = document.getElementById('recipientType').value;
        const title = sessionStorage.getItem('pendingAnnouncementTitle');
        if (!recipientType) {
          alert('Please select a recipient type');
          return;
        }
        let targetRoles = [];
        let targetUsers = [];
        if (recipientType === 'teamleader') {
          targetRoles = ['Team Lead'];
        } else if (recipientType === 'allusers') {
          targetRoles = [];
        } else if (recipientType === 'individual') {
          const selectedCheckboxes = document.querySelectorAll('input[name="selectedUsers"]:checked');
          if (selectedCheckboxes.length === 0) {
            alert('Please select at least one user');
            return;
          }
          targetUsers = Array.from(selectedCheckboxes).map(cb => cb.value);
        }
        const data = {
          title: title,
          content: title,
          priority: 'Normal',
          target_roles: targetRoles,
          target_users: targetUsers,
          expires_at: null
        };
        fetch('/api/announcements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              alert('✅ Announcement sent successfully!');
              sessionStorage.removeItem('pendingAnnouncementTitle');
              closeCreateAnnouncementModal();
              loadAnnouncements();
            } else {
              alert('❌ Error: ' + data.message);
            }
          })
          .catch(error => {
            alert('❌ Error sending announcement: ' + error.message);
          });
      }

      function closeCreateAnnouncementModal() {
        const modal = document.getElementById('createAnnouncementModal');
        if (modal) {
          modal.remove();
        }
      }

      function editAnnouncement(announcementId) {
        alert('Edit functionality will be implemented here');
      }

      function deleteAnnouncement(announcementId) {
        if (confirm('Are you sure you want to delete this announcement?')) {
          fetch(`/api/announcements/${announcementId}`, {
            method: 'DELETE'
          })
            .then(res => res.json())
            .then(data => {
              if (data.status === 'success') {
                alert('✅ Announcement deleted successfully!');
                loadAnnouncements();
              } else {
                alert('❌ Error: ' + data.message);
              }
            })
            .catch(error => {
              alert('❌ Error deleting announcement: ' + error.message);
            });
        }
      }

      function refreshAnnouncements() {
        loadAnnouncements();
      }





      function showDashboardAnnouncements() {
        // Load dashboard counts first
        loadDashboardCounts();
        
        // Then load announcements
        fetch('/api/announcements')
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success' && data.announcements.length > 0) {
              const announcementContainer = document.getElementById('announcementNotifications');
              if (announcementContainer) {
                let html = '<h3 style="margin-bottom: 15px; color: white;">📢 Recent Announcements</h3>';
                data.announcements.slice(0, 3).forEach(announcement => {
                  const priorityColor = getPriorityColor(announcement.priority);
                  html += `
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid ${priorityColor}; margin-bottom: 10px;">
                      <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">${announcement.title}</h4>
                      <p style="color: #ccc; margin-bottom: 10px; font-size: 14px; line-height: 1.4;">${announcement.content.substring(0, 100)}${announcement.content.length > 100 ? '...' : ''}</p>
                      <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #999;">
                        <span>👤 ${announcement.author_name}</span>
                        <span>📅 ${announcement.created_at}</span>
                        <span style="background: ${priorityColor}; color: white; padding: 2px 6px; border-radius: 3px;">${announcement.priority}</span>
                      </div>
                    </div>
                  `;
                });
                if (data.announcements.length > 3) {
                  html += `<p style="text-align: center; color: #ccc; font-size: 14px;">View all announcements in User Management → Announcements</p>`;
                }
                announcementContainer.innerHTML = html;
              }
            }
          })
          .catch(error => {
            console.error('Error loading dashboard announcements:', error);
          });
      }

      // Function to load dashboard counts
      async function loadDashboardCounts() {
        try {
          // Load task counts
          const taskResponse = await fetch('/api/dashboard/task_counts');
          const taskData = await taskResponse.json();
          
          if (taskData.status === 'success') {
            document.getElementById('totalTasks').textContent = taskData.total_tasks;
            document.getElementById('pendingTasks').textContent = taskData.pending_tasks;
          }
          
          // Load project counts
          const projectResponse = await fetch('/api/dashboard/project_counts');
          const projectData = await projectResponse.json();
          
          if (projectData.status === 'success') {
            document.getElementById('totalProjects').textContent = projectData.total_projects;
          }
          
        } catch (error) {
          console.error('Error loading dashboard counts:', error);
        }
      }


























      // ==================================================================
      // ==================================================================
// 2. PERMISSIONS (ATTENDANCE SUB-MODULE)
// ==================================================================
//Permissions view
    
//Permissions view
//Permissions view
async function loadPermissionsSection() {
    // Show the dashboard and hide the form view
    const dashboardView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');
    dashboardView.style.display = 'block';
    formView.style.display = 'none';

    // Build the new dashboard HTML
    dashboardView.innerHTML = `
        <div class="attendance-dashboard">
            <div class="attendance-card today-checkin">
                <div class="card-icon">📅</div>
                <div class="card-content">
                    <h3>Today's Check-In</h3>
                    <div class="time-display" id="checkInTime">Loading...</div>
                    <div class="status-display" id="checkInStatus">Loading...</div>
                </div>
            </div>
            <div class="attendance-card today-checkout">
                <div class="card-icon">🕐</div>
                <div class="card-content">
                    <h3>Today's Check-Out</h3>
                    <div class="time-display" id="checkOutTime">Loading...</div>
                    <div class="status-display" id="checkOutStatus">Loading...</div>
                </div>
            </div>
            <div class="attendance-card request-forms">
                <div class="card-icon">📄</div>
                <div class="card-content">
                    <h3>Request Forms</h3>
                    <button onclick="loadAttendanceFormView()" class="btn-request">Open Forms</button>
                </div>
            </div>
            <div class="attendance-card holidays">
                <div class="card-icon">🎉</div>
                <div class="card-content">
                    <h3>Holidays</h3>
                    <button onclick="loadHolidaysView()" class="btn-request">View Holidays</button>
                </div>
            </div>
            <div class="attendance-card total-leaves">
                <div class="card-icon">📊</div>
                <div class="card-content">
                    <h3>Total Leaves</h3>
                    <div class="number-display" id="totalLeavesValue">0</div>
                    <div class="description">Annual Allocation</div>
                </div>
            </div>
            <div class="attendance-card leaves-balance">
                <div class="card-icon">👤</div>
                <div class="card-content">
                    <h3>Leaves Balance</h3>
                    <div class="number-display" id="leavesBalanceValue">0</div>
                    <div class="description">Remaining Days</div>
                </div>
            </div>
            <div class="attendance-card leaves-availed">
                <div class="card-icon">✅</div>
                <div class="card-content">
                    <h3>Leaves Availed</h3>
                    <div class="number-display" id="leavesAvailedValue">0</div>
                    <div class="description">Used This Year</div>
                </div>
            </div>
            <div class="attendance-card permissions-availed">
                <div class="card-icon">📜</div>
                <div class="card-content">
                    <h3>Permission Availed</h3>
                    <div class="number-display" id="permissionsAvailedValue">0</div>
                    <div class="description">Approved This Year</div>
                </div>
            </div>
        </div>
    `;

    // Call the new functions to populate the data
    await fetchAttendanceTimes();
    await fetchLeaveInfo();
    await fetchPermissionsInfo();
}
async function fetchAttendanceTimes() {
    try {
        // Get current user info
        const userResponse = await fetch('/api/get_current_user');
        const userData = await userResponse.json();
        
        if (userData.status !== 'success' || !userData.user) {
            console.error('User not authenticated');
            document.getElementById('checkInTime').textContent = 'Not Available';
            document.getElementById('checkOutTime').textContent = 'Not Available';
            document.getElementById('checkInStatus').textContent = 'Login Required';
            document.getElementById('checkOutStatus').textContent = 'Login Required';
            return;
        }

        const userName = userData.user.name; // Get the actual user name (e.g., "prabhas", "Varun")
        
        // Get today's date in YYYY-MM-DD format
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
        
        console.log(`Fetching attendance for user: ${userName}, date: ${todayStr}`);

        // Get current month and year for collection name
        const currentDate = new Date();
        const monthNames = ["january", "february", "march", "april", "may", "june", 
                           "july", "august", "september", "october", "november", "december"];
        const monthName = monthNames[currentDate.getMonth()];
        const year = currentDate.getFullYear();
        const collectionName = `${monthName}_${year}`; // e.g., "september_2025"
        
        console.log(`Looking in collection: ${collectionName}`);

        // Query Firebase for attendance data - try multiple name variations
        const attendanceRef = db.collection(collectionName);
        
        // First try exact match
        let query = attendanceRef.where('Name', '==', userName)
                                .where('date_key', '==', todayStr)
                                .limit(1);
        
        let snapshot = await query.get();
        
        // If no match found, try with full name patterns
        if (snapshot.empty) {
            // Try case variations and common name patterns
            const nameVariations = [
                userName.toLowerCase(),
                userName.charAt(0).toUpperCase() + userName.slice(1).toLowerCase(),
                userName.toUpperCase(),
                `${userName} Kumar Konjeti`, // For Varun -> Varun Kumar Konjeti
                `${userName.charAt(0).toUpperCase() + userName.slice(1).toLowerCase()} Kumar Konjeti`,
                // Special case for prabhas -> Prabhas
                userName === 'prabhas' ? 'Prabhas' : userName,
                userName === 'Prabhas' ? 'prabhas' : userName
            ];
            
            for (const nameVariation of nameVariations) {
                console.log(`Trying name variation: ${nameVariation}`);
                query = attendanceRef.where('Name', '==', nameVariation)
                                   .where('date_key', '==', todayStr)
                                   .limit(1);
                snapshot = await query.get();
                if (!snapshot.empty) {
                    console.log(`Found match with name: ${nameVariation}`);
                    break;
                }
            }
        }
        
        if (snapshot.empty) {
            console.log(`No attendance record found for ${userName} on ${todayStr}`);
            
            // Debug: Let's see what documents actually exist in the collection
            console.log('DEBUG: Fetching all documents in collection to see what names exist...');
            const allDocsQuery = attendanceRef.where('date_key', '==', todayStr).limit(10);
            const allDocsSnapshot = await allDocsQuery.get();
            
            console.log(`Found ${allDocsSnapshot.size} documents for date ${todayStr}:`);
            allDocsSnapshot.forEach(doc => {
                const data = doc.data();
                console.log(`Document ID: ${doc.id}, Name: "${data.Name}", Date: ${data.date_key}`);
            });
            
            document.getElementById('checkInTime').textContent = 'Not Found in Firebase';
            document.getElementById('checkOutTime').textContent = 'Not Found in Firebase';
            document.getElementById('checkInStatus').textContent = 'Check Console';
            document.getElementById('checkOutStatus').textContent = 'Check Console';
            return;
        }

        const attendanceData = snapshot.docs[0].data();
        console.log('Attendance data found:', attendanceData);

        // Update check-in time
        if (attendanceData.check_in && attendanceData.check_in !== '') {
            console.log('Raw check_in data:', attendanceData.check_in);
            
            let checkInTime;
            // Handle Firebase timestamp objects
            if (attendanceData.check_in.toDate && typeof attendanceData.check_in.toDate === 'function') {
                checkInTime = attendanceData.check_in.toDate();
            } else if (attendanceData.check_in.seconds) {
                // Handle Firebase timestamp with seconds
                checkInTime = new Date(attendanceData.check_in.seconds * 1000);
            } else {
                // Handle string timestamps
                checkInTime = new Date(attendanceData.check_in);
            }
            
            console.log('Parsed check_in time:', checkInTime);
            
            if (!isNaN(checkInTime.getTime())) {
                const formattedCheckIn = checkInTime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                document.getElementById('checkInTime').textContent = formattedCheckIn;
                document.getElementById('checkInStatus').textContent = 'Checked In';
            } else {
                console.error('Invalid check_in time:', attendanceData.check_in);
                document.getElementById('checkInTime').textContent = 'Invalid Time';
                document.getElementById('checkInStatus').textContent = 'Error';
            }
        } else {
            document.getElementById('checkInTime').textContent = 'Not Checked In';
            document.getElementById('checkInStatus').textContent = 'Not Checked In';
        }

        // Update check-out time
        if (attendanceData.check_out && attendanceData.check_out !== '' && attendanceData.check_out !== 'te') {
            console.log('Raw check_out data:', attendanceData.check_out);
            
            let checkOutTime;
            // Handle Firebase timestamp objects
            if (attendanceData.check_out.toDate && typeof attendanceData.check_out.toDate === 'function') {
                checkOutTime = attendanceData.check_out.toDate();
            } else if (attendanceData.check_out.seconds) {
                // Handle Firebase timestamp with seconds
                checkOutTime = new Date(attendanceData.check_out.seconds * 1000);
            } else {
                // Handle string timestamps
                checkOutTime = new Date(attendanceData.check_out);
            }
            
            console.log('Parsed check_out time:', checkOutTime);
            
            if (!isNaN(checkOutTime.getTime())) {
                const formattedCheckOut = checkOutTime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                document.getElementById('checkOutTime').textContent = formattedCheckOut;
                document.getElementById('checkOutStatus').textContent = 'Checked Out';
            } else {
                console.error('Invalid check_out time:', attendanceData.check_out);
                document.getElementById('checkOutTime').textContent = 'Invalid Time';
                document.getElementById('checkOutStatus').textContent = 'Error';
            }
        } else {
            if (attendanceData.check_out === 'te') {
                console.log('Check-out data appears to be truncated:', attendanceData.check_out);
                document.getElementById('checkOutTime').textContent = 'Data Incomplete';
                document.getElementById('checkOutStatus').textContent = 'Check Firebase';
            } else {
                document.getElementById('checkOutTime').textContent = 'Not Checked Out';
                document.getElementById('checkOutStatus').textContent = 'Not Checked Out';
            }
        }

    } catch (error) {
        console.error('Error fetching attendance times:', error);
        document.getElementById('checkInTime').textContent = 'Error Loading';
        document.getElementById('checkOutTime').textContent = 'Error Loading';
        document.getElementById('checkInStatus').textContent = 'Error';
        document.getElementById('checkOutStatus').textContent = 'Error';
    }
}
async function fetchLeaveInfo() {
    try {
        const response = await fetch('/api/user_leave_info');
        const data = await response.json();

        if (data.status === 'success' && data.leaves) {
            document.getElementById('totalLeavesValue').textContent = data.leaves.total_leaves || 0;
            document.getElementById('leavesBalanceValue').textContent = data.leaves.leaves_balance || 0;
            document.getElementById('leavesAvailedValue').textContent = data.leaves.leaves_availed || 0;
        } else {
            console.error('Failed to fetch leave info:', data.message);
        }
    } catch (error) {
        console.error('Error fetching leave info:', error);
    }
}

async function fetchPermissionsInfo() {
    try {
        const response = await fetch('/api/user_permissions_count');
        const data = await response.json();

        if (data.status === 'success') {
            document.getElementById('permissionsAvailedValue').textContent = data.approved_permissions || 0;
        } else {
            console.error('Failed to fetch permissions info:', data.message);
            document.getElementById('permissionsAvailedValue').textContent = '0';
        }
    } catch (error) {
        console.error('Error fetching permissions info:', error);
        document.getElementById('permissionsAvailedValue').textContent = '0';
    }
}
async function loadAttendanceFormView() {
    // Hide the dashboard and show the form view
    const dashboardView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');
    dashboardView.style.display = 'none';
    formView.style.display = 'block';

    // This section contains the HTML and logic from your original 'Employee' view.
    // It is modified to include a back button to the dashboard.
    // Get user roles to determine what view to show
    let userRoles = [];
    try {
        const response = await fetch('/api/user/roles');
        const data = await response.json();
        if (data.status === 'success') {
            userRoles = data.roles;
        }
    } catch (error) {
        console.error('Failed to fetch user roles:', error);
    }

    const roles = Array.isArray(userRoles) ? userRoles : [];
    const isTeamLead = roles.includes('Team Lead');
    const isHR = roles.includes('HR');
    const isDirector = roles.includes('Director');
    const isAccounts = roles.includes('Accounts');

    if (isTeamLead) {
        const html = `
            <button onclick="loadPermissionsSection()" class="back-button">← Back to Dashboard</button>
            <div class="teamlead-header">
                <div style="width: 48%;">
                    <h3>Make a Request</h3>
                    <select id="requestTypeSelector" onchange="loadRequestForm(this.value)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="">-- Select a request type --</option>
                        <option value="Leave">Request Leave</option>
                        <option value="Permission">Request Permission</option>
                        <option value="Travel">Request Travel Requisition</option>
                        <option value="Conveyance">Request Local Conveyance</option>
                    </select>
                </div>
                <div style="width: 48%;">
                    <h3>View Requests</h3>
                    <select id="teamLeadViewSelector" onchange="handleTeamLeadView(this.value)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="employeeRequests">View employee requests</option>
                        <option value="myRequests">View your requests</option>
                        <option value="allRequests">View all requests</option>
                    </select>
                </div>
            </div>
            <div id="requestsDisplayContainer" class="request-card-list" style="margin-top: 20px;">
                <p style="text-align:center; color: #ccc;">Select a view type above.</p>
            </div>
        `;
        formView.innerHTML = html;
        await handleTeamLeadView('employeeRequests');
    } else if (isHR) {
        const html = `
            <button onclick="loadPermissionsSection()" class="back-button">← Back to Dashboard</button>
            <div class="hr-header">
                <div style="width: 48%;">
                    <h3>Make a Request</h3>
                    <select id="requestTypeSelector" onchange="loadRequestForm(this.value)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="">-- Select a request type --</option>
                        <option value="Leave">Request Leave</option>
                        <option value="Permission">Request Permission</option>
                        <option value="Travel">Request Travel Requisition</option>
                        <option value="Conveyance">Request Local Conveyance</option>
                    </select>
                </div>
                <div style="width: 48%;">
                    <h3>View Requests</h3>
                    <select id="hrViewSelector" onchange="handleHRView(this.value)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="employeeRequests">View employee requests</option>
                        <option value="myRequests">View your requests</option>
                        <option value="finalizedRequests">View all requests</option>
                        <option value="conveyancePending">Pending Conveyance Claims</option>
                        <option value="conveyanceSeen">Seen Conveyance Claims</option>
                    </select>
                </div>
            </div>
            <div id="requestsDisplayContainer" class="request-card-list" style="margin-top: 20px;">
                <p style="text-align:center; color: #ccc;">Select a view type above.</p>
            </div>
        `;
        formView.innerHTML = html;
        await handleHRView('employeeRequests');
    } else if (isDirector) {
        const html = `
            <button onclick="loadPermissionsSection()" class="back-button">← Back to Dashboard</button>
            <div class="director-header">
                <div style="width: 48%;">
                    <h3>Make a Request</h3>
                    <select id="requestTypeSelector" onchange="loadRequestForm(this.value)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="">-- Select a request type --</option>
                        <option value="Leave">Request Leave</option>
                        <option value="Permission">Request Permission</option>
                        <option value="Travel">Request Travel Requisition</option>
                        <option value="Conveyance">Request Local Conveyance</option>
                    </select>
                </div>
                <div style="width: 48%;">
                    <h3>View Requests</h3>
                    <select id="directorViewSelector" onchange="handleDirectorView(this.value)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="employeeRequests">View employee requests</option>
                        <option value="myRequests">View your requests</option>
                        <option value="allRequests">View all requests</option>
                    </select>
                </div>
            </div>
            <div id="requestsDisplayContainer" class="request-card-list" style="margin-top: 20px;">
                <p style="text-align:center; color: #ccc;">Select a view type above.</p>
            </div>
        `;
        formView.innerHTML = html;
        await handleDirectorView('employeeRequests'); 
    } else if (isAccounts) {
        const html = `
            <button onclick="loadPermissionsSection()" class="back-button">← Back to Dashboard</button>
            <div class="accounts-header">
                <div style="width: 48%;">
                    <h3>Make a Request</h3>
                    <select id="requestTypeSelector" onchange="loadRequestForm(this.value)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="">-- Select a request type --</option>
                        <option value="Leave">Request Leave</option>
                        <option value="Permission">Request Permission</option>
                        <option value="Travel">Request Travel Requisition</option>
                        <option value="Conveyance">Request Local Conveyance</option>
                    </select>
                </div>
                <div style="width: 48%;">
                    <h3>View Requests</h3>
                    <select id="accountsViewSelector" onchange="handleAccountsView(this.value)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="myRequests">View your requests</option>
                        <option value="pendingClaims">Pending Conveyance Claims</option>
                        <option value="seenClaims">Seen Conveyance Claims</option>
                    </select>
                </div>
            </div>
            <div id="requestsDisplayContainer" class="request-card-list" style="margin-top: 20px;">
                <p style="text-align:center; color: #ccc;">Select a view type above.</p>
            </div>
        `;
        formView.innerHTML = html;
        await handleAccountsView('pendingClaims');
    } else { // Standard Employee section
        const html = `
            <button onclick="loadPermissionsSection()" class="back-button">← Back to Dashboard</button>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div style="background: rgba(0,0,0,0.4); padding: 25px; border-radius: 15px;">
                    <h3>Make a Request</h3>
                    <select id="requestTypeSelector" onchange="loadRequestForm(this.value)" style="width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="">-- Select a request type --</option>
                        <option value="Leave">Request Leave</option>
                        <option value="Permission">Request Permission</option>
                        <option value="Travel">Request Travel Requisition</option>
                        <option value="Conveyance">Request Local Conveyance</option>
                    </select>
                </div>
                <div style="background: rgba(0,0,0,0.4); padding: 25px; border-radius: 15px;">
                    <h3>View Your Requests</h3>
                    <select id="myRequestsDropdown" onchange="displaySelectedRequest(this.value)" style="width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 1px solid rgba(0,209,255,0.5); background: rgba(0,20,30,0.8); color: white; font-size: 1em;">
                        <option value="">-- Select a request date --</option>
                    </select>
                    <div id="requestsDisplayContainer">
                        <p style="text-align:center; color: #ccc;">Select a date to view a request.</p>
                    </div>
                </div>
            </div>
        `;
        formView.innerHTML = html;
        
        // Only populate the dropdown for standard employees
        await populateMyRequestsDropdown();
    }
}

async function loadHolidaysView() {
    // Hide the dashboard and show the holidays view
    const dashboardView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');
    dashboardView.style.display = 'none';
    formView.style.display = 'block';

    // Check user roles to determine if they can add holidays
    let canAddHolidays = false;
    try {
        const response = await fetch('/api/user/roles');
        const data = await response.json();
        if (data.status === 'success') {
            const roles = data.roles || [];
            canAddHolidays = roles.includes('Admin') || roles.includes('HR');
        }
    } catch (error) {
        console.error('Error fetching user roles:', error);
    }

    let html = `
        <div class="holidays-container">
            <div class="holidays-header">
                <h2>🎉 Holidays</h2>
                <button onclick="loadPermissionsSection()" class="btn-back">← Back to Dashboard</button>
            </div>
    `;
    
    if (canAddHolidays) {
        html += `
            <div style="margin-bottom: 20px; text-align: center;">
                <button onclick="openAddHolidayModal()" class="btn-request" style="background: #00d1ff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    + Add New Holiday
                </button>
            </div>
        `;
    }
    
    html += `
            <div class="holidays-content">
                <div class="holidays-list" id="holidaysList">
                    <p style="color: #ccc; text-align: center;">Loading holidays...</p>
                </div>
            </div>
        </div>
    `;

    formView.innerHTML = html;

    // Load holidays data
    await loadHolidaysData(canAddHolidays);
}

async function loadHolidaysData(canDelete = false) {
    try {
        const response = await fetch('/api/holidays');
        const result = await response.json();
        
        const holidaysList = document.getElementById('holidaysList');
        if (result.status === 'success') {
            if (result.holidays.length === 0) {
                holidaysList.innerHTML = '<p style="color: #ccc; text-align: center;">No holidays added yet.</p>';
            } else {
                const holidaysHtml = result.holidays.map(holiday => {
                    let deleteButton = '';
                    if (canDelete) {
                        deleteButton = `<button onclick="deleteHoliday(${holiday.id})" style="background: #ff4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">Delete</button>`;
                    }
                    
                    return `
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0; color: #fff;">${holiday.name}</h4>
                                <p style="margin: 5px 0 0 0; color: #ccc; font-size: 14px;">${holiday.date} | Added by: ${holiday.created_by}</p>
                            </div>
                            ${deleteButton}
                        </div>
                    `;
                }).join('');
                holidaysList.innerHTML = holidaysHtml;
            }
        } else {
            holidaysList.innerHTML = '<p style="color: #ff4444; text-align: center;">Error loading holidays: ' + result.message + '</p>';
        }
    } catch (error) {
        const holidaysList = document.getElementById('holidaysList');
        holidaysList.innerHTML = '<p style="color: #ff4444; text-align: center;">Error loading holidays: ' + error.message + '</p>';
    }
}

// Global holiday functions for multi_dashboard
function openAddHolidayModal() {
    console.log('openAddHolidayModal called'); // Debug log
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Holiday</h3>
                <button onclick="closeModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addHolidayForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #fff;">Holiday Name:</label>
                        <input type="text" id="holidayName" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #666; background: rgba(255,255,255,0.1); color: #fff;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #fff;">Date:</label>
                        <input type="date" id="holidayDate" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #666; background: rgba(255,255,255,0.1); color: #fff;">
                    </div>
                    <div style="text-align: right;">
                        <button type="button" onclick="closeModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-right: 10px;">Cancel</button>
                        <button type="submit" style="background: #00d1ff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Save Holiday</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    document.getElementById('addHolidayForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('holidayName').value;
        const date = document.getElementById('holidayDate').value;
        
        try {
            const response = await fetch('/api/holidays', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, date })
            });
            
            const result = await response.json();
            if (result.status === 'success') {
                alert('Holiday added successfully!');
                closeModal();
                loadHolidaysData(true); // Refresh with delete capability
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            alert('Error adding holiday: ' + error.message);
        }
    });
}

function closeModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

async function deleteHoliday(holidayId) {
    if (confirm('Are you sure you want to delete this holiday?')) {
        try {
            const response = await fetch(`/api/holidays/${holidayId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            if (result.status === 'success') {
                alert('Holiday deleted successfully!');
                loadHolidaysData(true); // Refresh with delete capability
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            alert('Error deleting holiday: ' + error.message);
        }
    }
}

// MODIFIED handleTeamLeadView
async function handleTeamLeadView(viewType) {
    const container = document.getElementById('requestsDisplayContainer');
    if (!container) return;

    container.innerHTML = '<p style="text-align: center; color: #ccc;">Loading requests...</p>';

    try {
        let response;
        if (viewType === 'myRequests') {
            response = await fetch('/api/my_requests');
        } else if (viewType === 'employeeRequests') {
            response = await fetch('/api/teamlead/requests');
        } else if (viewType === 'allRequests') { // CORRECTED: This now calls the new endpoint
            response = await fetch('/api/teamlead/all_requests');
        } else {
            container.innerHTML = `<p style="text-align: center; color: #ccc;">Select an option above to view requests.</p>`;
            return;
        }

        const data = await response.json();
        if (data.status === 'success') {
            renderRequestsList(data.requests, container);
        } else {
            container.innerHTML = `<p style="text-align: center; color: red;">Failed to load requests.</p>`;
        }
    } catch (error) {
        console.error('Error fetching requests:', error);
        container.innerHTML = `<p style="text-align: center; color: red;">An error occurred while fetching requests.</p>`;
    }
}


async function handleHRView(viewType) {
    const container = document.getElementById('requestsDisplayContainer');
    if (!container) return;

    container.innerHTML = '<p style="text-align: center; color: #ccc;">Loading requests...</p>';

    try {
        let response;
        if (viewType === 'myRequests') {
            response = await fetch('/api/my_requests');
        } else if (viewType === 'employeeRequests') {
            response = await fetch('/api/hr/requests');  
        } else if (viewType === 'finalizedRequests') {
            // 🟢 Corrected to fetch all finalized requests
            response = await fetch('/api/hr/finalized_all_requests'); 
        } else if (viewType === 'conveyancePending') {
            response = await fetch('/api/hr/conveyance_requests');
        } else if (viewType === 'conveyanceSeen') {
            response = await fetch('/api/hr/seen_conveyance_requests');
        } else {
            container.innerHTML = `<p style="text-align: center; color: #ccc;">Select an option above to view requests.</p>`;
            return;
        }

        const data = await response.json();
        if (data.status === 'success') {
            renderRequestsList(data.requests, container);
        } else {
            container.innerHTML = `<p style="text-align: center; color: red;">Failed to load requests.</p>`;
        }
    } catch (error) {
        console.error('Error fetching requests:', error);
        container.innerHTML = `<p style="text-align: center; color: red;">An error occurred while fetching requests.</p>`;
    }
}

async function handleDirectorView(viewType) {
    const container = document.getElementById('requestsDisplayContainer');
    if (!container) return;

    container.innerHTML = '<p style="text-align: center; color: #ccc;">Loading requests...</p>';

    try {
        let response;
        if (viewType === 'myRequests') {
            response = await fetch('/api/my_requests');
        } else if (viewType === 'employeeRequests') {
            // New endpoint for Director to view pending requests for approval
            response = await fetch('/api/director/requests');
        } else if (viewType === 'allRequests') { 
            // New endpoint for Director to view all requests (approved/rejected)
            response = await fetch('/api/director/all_requests'); 
        } else {
            container.innerHTML = `<p style="text-align: center; color: #ccc;">Select an option above to view requests.</p>`;
            return;
        }

        const data = await response.json();
        if (data.status === 'success') {
            renderRequestsList(data.requests, container);
        } else {
            container.innerHTML = `<p style="text-align: center; color: red;">Failed to load requests.</p>`;
        }
    } catch (error) {
        console.error('Error fetching requests:', error);
        container.innerHTML = `<p style="text-align: center; color: red;">An error occurred while fetching requests.</p>`;
    }
}

// MODIFIED function to render a list of requests dynamically
function renderRequestsList(requests, container) {
    container.innerHTML = '';
    if (requests.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: #ccc;">No requests found.</p>`;
        return;
    }

    let html = requests.map(req => {
        let statusDisplay = req.status;
        if (req.request_type === 'Conveyance') {
            statusDisplay = req.status; // already formatted in the backend
        } else {
            statusDisplay = `<span class="status status-${req.status.toLowerCase().replace(/ /g, '-')}">${req.status}</span>`;
        }

        // Correctly pass both the request ID and type to the openRequestForm function
        return `
            <div class="request-card" onclick="openRequestForm('${req.request_type}', ${req.id})">
                <p><strong>Applicant:</strong> ${req.applicant_name}</p>
                <p><strong>Request Type:</strong> ${req.request_type}</p>
                <p><strong>Date:</strong> ${req.from_date}</p>
                <p><strong>Reason:</strong> ${req.reason}</p>
                <p><strong>Status:</strong> ${statusDisplay}</p>
            </div>
        `;
    }).join('');
    container.innerHTML = html;
}

async function openLeaveRequestForm(requestId) {
    const container = document.getElementById('requestsDisplayContainer') || document.getElementById('viewRequestsContainer');
    if (!container) return;

    container.innerHTML = '<p style="text-align: center; color: #ccc;">Loading form...</p>';

    try {
        if (currentUserId === null) {
            await getCurrentUserId();
        }

        const response = await fetch(`/api/leave_request/${requestId}`);
        const data = await response.json();

        if (data.status === 'success') {
            renderFullLeaveForm(data.request);
        } else {
            container.innerHTML = `<p style="text-align: center; color: red;">Failed to load request: ${data.message}</p>`;
        }
    } catch (error) {
        console.error('Error fetching full leave request:', error);
        container.innerHTML = `<p style="text-align: center; color: red;">An error occurred while fetching the request.</p>`;
    }
}

async function renderFullLeaveForm(request) {
    const mainView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');
    
    if (mainView) mainView.style.display = 'none';
    if (formView) formView.style.display = 'block';

    let userRoles = [];
    try {
        const roleResponse = await fetch('/api/user/roles');
        const roleData = await roleResponse.json();
        if (roleData.status === 'success') {
            userRoles = roleData.roles;
        }
    } catch (error) {
        console.error('Error fetching user roles:', error);
    }
    
    let localCurrentUserId = null;
    try {
        const idResponse = await fetch('/api/user_id');
        const idData = await idResponse.json();
        if (idData.status === 'success') {
            localCurrentUserId = idData.user_id;
        }
    } catch (error) {
        console.error('Error fetching user ID:', error);
    }

    const roles = Array.isArray(userRoles) ? userRoles : [];
    
    // Pass the fetched request data and false for isNew
    formView.innerHTML = generateLeaveFormHTML(request, false, roles, localCurrentUserId);

    // Call populateTeamLeadDropdown here if the field is not disabled
    if (!document.getElementById('teamLeadSelect').disabled) {
        await populateTeamLeadDropdown();
    }
}

async function submitApprovalAction(requestId, roleType, action) {
    const form = document.getElementById('leaveApprovalForm');
    
    let endpoint = '';
    let formData = { action: action };

    if (roleType === 'teamlead') {
        endpoint = `/api/approve_leave_request_teamlead/${requestId}`;
        formData.reporting_authority_sign = form.querySelector('#reportingAuthoritySign').value;
        formData.reporting_authority_date = form.querySelector('#reportingAuthorityDate').value;
        formData.remarks = form.querySelector('#remarks').value;

        if (action === 'approve' && (!formData.reporting_authority_sign || !formData.reporting_authority_date)) {
            alert('Please fill in your signature and date to approve.');
            return;
        }
    } else if (roleType === 'hr') {
        endpoint = `/api/approve_leave_request_hr/${requestId}`;
        formData.hr_sign = form.querySelector('#hrSign').value;
        formData.hr_date = form.querySelector('#hrDate').value;

        if (action === 'approve' && (!formData.hr_sign || !formData.hr_date)) {
            alert('Please fill in your signature and date to approve.');
            return;
        }
    } else if (roleType === 'director') { 
        endpoint = `/api/approve_leave_request_director/${requestId}`;
        formData.director_sign = form.querySelector('#directorSign').value;
        formData.director_date = form.querySelector('#directorDate').value;
        formData.remarks = form.querySelector('#remarks').value;

        if (action === 'approve' && (!formData.director_sign || !formData.director_date)) {
            alert('Please fill in your signature and date to approve.');
            return;
        }
    } else {
        alert('You do not have permission to perform this action.');
        return;
    }

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });
        const result = await response.json();

        if (result.status === 'success') {
            alert('✅ Form saved successfully and employee can see the updates !!');
            loadPermissionsSection();
        } else {
            alert('❌ Failed to ' + action + ' request: ' + result.message);
        }
    } catch (error) {
        console.error('Error submitting approval action:', error);
        alert('An error occurred. Please try again.');
    }
}
// This is the updated render function for a permission form.
// It will now generate a form using the same styling as your other forms.
// This is the updated render function for a permission form, using the standardized design.
async function renderFullPermissionForm(request) {
    const mainView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');
    
    // Hide main view and show form view
    if (mainView) mainView.style.display = 'none';
    if (formView) formView.style.display = 'block';

    let userRoles = [];
    try {
        const roleResponse = await fetch('/api/user/roles');
        const roleData = await roleResponse.json();
        if (roleData.status === 'success') {
            userRoles = roleData.roles;
        }
    } catch (error) {
        console.error('Error fetching user roles:', error);
    }
    
    let localCurrentUserId = null;
    try {
        const idResponse = await fetch('/api/user_id');
        const idData = await idResponse.json();
        if (idData.status === 'success') {
            localCurrentUserId = idData.user_id;
        }
    } catch (error) {
        console.error('Error fetching user ID:', error);
    }

    const roles = Array.isArray(userRoles) ? userRoles : [];
    const isTeamLead = roles.includes('Team Lead');
    const isHR = roles.includes('HR');
    const isDirector = roles.includes('Director');

    const isAssignedTeamLead = isTeamLead && request.team_lead_id === parseInt(localCurrentUserId);

    const applicantFieldsReadOnly = 'readonly disabled';
    const teamLeadFieldsDisabled = (isAssignedTeamLead && request.status === 'Pending') ? '' : 'disabled readonly';
    const hrFieldsDisabled = (isHR && request.status === 'Pending HR Approval') ? '' : 'disabled readonly';
    const directorFieldsDisabled = (isDirector && request.status === 'Pending Director Approval') ? '' : 'disabled readonly';

    let approvalButtonsHtml = '';
    if (isAssignedTeamLead && request.status === 'Pending') {
        approvalButtonsHtml = `
            <div class="form-actions">
                <button type="button" class="form-btn btn-submit" onclick="submitPermissionApprovalAction(${request.id}, 'teamlead', 'approve', '${request.status}')">Approve & Submit</button>
                <button type="button" class="form-btn btn-danger" onclick="submitPermissionApprovalAction(${request.id}, 'teamlead', 'reject', '${request.status}')">Reject</button>
            </div>`;
    } else if (isHR && request.status === 'Pending HR Approval') {
        approvalButtonsHtml = `
            <div class="form-actions">
                <button type="button" class="form-btn btn-submit" onclick="submitPermissionApprovalAction(${request.id}, 'hr', 'approve', '${request.status}')">Approve & Submit</button>
                <button type="button" class="form-btn btn-danger" onclick="submitPermissionApprovalAction(${request.id}, 'hr', 'reject', '${request.status}')">Reject</button>
            </div>`;
    } else if (isDirector && request.status === 'Pending Director Approval') {
        approvalButtonsHtml = `
            <div class="form-actions">
                <button type="button" class="form-btn btn-submit" onclick="submitPermissionApprovalAction(${request.id}, 'director', 'approve', '${request.status}')">Approve & Submit</button>
                <button type="button" class="form-btn btn-danger" onclick="submitPermissionApprovalAction(${request.id}, 'director', 'reject', '${request.status}')">Reject</button>
            </div>`;
    }

    formView.innerHTML = `
        <style>
            .form-container{max-width:100%; margin:0 auto; background:rgba(0,0,0,0.4); border:1px solid rgba(0,209,255,0.3); border-radius:15px; padding:30px;}
            .form-header{text-align:center; margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.2);}
            .form-header img{max-width:150px; margin-bottom:10px;}
            .form-header h3{color:#00d1ff; font-weight:bold; margin:5px 0;}
            .form-table{width:100%; border-collapse:collapse; margin-top:20px;}
            .form-table th, .form-table td{border:1px solid rgba(255,255,255,0.3); padding:12px; text-align:left; vertical-align:middle;}
            .form-table input, .form-table textarea, .form-table select {width:100%; padding:8px; background:rgba(0,0,0,0.5); border:1px solid #555; border-radius:4px; color:#fff; font-size:14px;}
            .form-actions{display:flex; justify-content:flex-end; gap:15px; margin-top:30px;}
            .form-btn{padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; color:white; text-align:center;}
            .btn-submit{background:linear-gradient(135deg,#28a745 0%,#218838 100%);}
            .btn-back{background:#6c757d;}
            input[type="time"]::-webkit-calendar-picker-indicator,
            input[type="date"]::-webkit-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-webkit-calendar-picker-indicator:hover,
            input[type="date"]::-webkit-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
            input[type="time"]::-moz-calendar-picker-indicator,
            input[type="date"]::-moz-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-moz-calendar-picker-indicator:hover,
            input[type="date"]::-moz-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
        </style>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0;">Permission Request Details (#${request.id})</h2>
            <button type="button" class="form-btn btn-back" onclick="loadPermissionsSection()">← Back</button>
        </div>
        <div class="form-container">
            <div class="form-header">
                <img src="/static/images/logo.png" alt="SSEV Logo">
                <h3>SS ENERGY VENTURES PRIVATE LIMITED</h3>
                <h3 style="text-align:center; margin-top:20px;">PERMISSION SLIP</h3>
                <p>Status: <span class="status status-${request.status.toLowerCase().replace(/ /g, '-')}">${request.status}</span></p>
            </div>
            <form id="permissionApprovalForm">
                <input type="hidden" id="requestId" value="${request.id}">
                <table class="form-table">
                    <tr><th style="width:30%;">SPV Name:</th><td colspan="3"><select ${applicantFieldsReadOnly}><option value="">-- Select SPV --</option><option value="SSEV" ${request.spv_name === 'SSEV' ? 'selected' : ''}>SSEV</option><option value="SSEV SOFT SOLS" ${request.spv_name === 'SSEV SOFT SOLS' ? 'selected' : ''}>SSEV SOFT SOLS</option></select></td></tr>
                    <tr><th>Date:</th><td colspan="3"><input type="date" value="${request.date || ''}" ${applicantFieldsReadOnly}></td></tr>
                    <tr><th>Name:</th><td colspan="3"><input type="text" value="${request.applicant_name || ''}" ${applicantFieldsReadOnly}></td></tr>
                    <tr><th>Permission for Official Duty / Personal Work:</th><td colspan="3"><textarea rows="3" ${applicantFieldsReadOnly}>${request.reason || ''}</textarea></td></tr>
                    <tr><th>Time Out:</th><td colspan="3"><input type="time" value="${request.time_out || ''}" ${applicantFieldsReadOnly}></td></tr>
                    <tr><th>Time In:</th><td colspan="3">
                        <select ${applicantFieldsReadOnly} style="width: 100%; padding: 4px; background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px; color: #fff; font-size: 14px; margin-bottom: 5px;">
                            <option value="">-- Select or Enter Time --</option>
                            <option value="Early Checkout" ${request.time_in === 'Early Checkout' ? 'selected' : ''}>Early Checkout</option>
                            <option value="Half Day Permission" ${request.time_in === 'Half Day Permission' ? 'selected' : ''}>Half Day Permission</option>
                            <option value="manual" ${request.time_in && request.time_in !== 'Early Checkout' && request.time_in !== 'Half Day Permission' ? 'selected' : ''}>Enter Time Manually</option>
                        </select>
                        <input type="time" value="${request.time_in && request.time_in !== 'Early Checkout' && request.time_in !== 'Half Day Permission' ? request.time_in : ''}" ${applicantFieldsReadOnly} style="width: 100%; padding: 4px; background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px; color: #fff; font-size: 14px; ${request.time_in && request.time_in !== 'Early Checkout' && request.time_in !== 'Half Day Permission' ? '' : 'display: none;'}">
                    </td></tr>
                    <tr><th>Going To:</th><td colspan="3"><input type="text" value="${request.going_to || ''}" ${applicantFieldsReadOnly}></td></tr>
                    <tr>
                        <th colspan="1">Signature</th>
                        <th colspan="1">Team Lead Signature</th>
                        <th colspan="1">HR Signature</th>
                        <th colspan="1">Director Signature</th>
                    </tr>
                    <tr>
                        <td><input type="text" placeholder="Type name to sign..." value="${request.applicant_sign || ''}" ${applicantFieldsReadOnly}></td>
                        <td><input type="text" id="teamLeadSign" placeholder="Type approver name..." value="${request.team_lead_sign || ''}" ${teamLeadFieldsDisabled}></td>
                        <td><input type="text" id="hrSign" placeholder="Type HR name..." value="${request.hr_sign || ''}" ${hrFieldsDisabled}></td>
                        <td><input type="text" id="directorSign" placeholder="Type Director name..." value="${request.director_sign || ''}" ${directorFieldsDisabled}></td>
                    </tr>
                    <tr>
                        <td colspan="4">
                            <strong>Selected Team Lead:</strong><br>
                            <select id="teamLeadSelect" disabled>
                                <option value="${request.team_lead_id}">${request.team_lead_name || '-- Select a Team Lead --'}</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </form>
            ${approvalButtonsHtml}
        </div>
    `;
}
// This function now returns the HTML for a NEW permission form, using the standardized design.
function generatePermissionFormHTML() {
    return `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0;">Permission Slip</h2>
            <button type="button" class="form-btn btn-back" onclick="loadPermissionsSection()">← Back</button>
        </div>
        <div class="form-container">
            <div class="form-header">
                <img src="/static/images/logo.png" alt="SSEV Logo">
                <h3>SS ENERGY VENTURES PRIVATE LIMITED</h3>
            </div>
            <h3 style="text-align:center; margin-top:20px;">PERMISSION SLIP</h3>
            <form id="permissionRequestForm">
                <table class="form-table">
                    <tr><th style="width:30%;">SPV Name:</th><td colspan="3"><select id="spvName"><option value="">-- Select SPV --</option><option value="SSEV">SSEV</option><option value="SSEV SOFT SOLS">SSEV SOFT SOLS</option></select></td></tr>
                    <tr><th>Date:</th><td colspan="3"><input type="date" id="date"></td></tr>
                    <tr><th>Name:</th><td colspan="3"><input type="text" id="applicantName"></td></tr>
                    <tr><th>Permission for Official Duty / Personal Work:</th><td colspan="3"><textarea rows="3" id="reason"></textarea></td></tr>
                    <tr><th>Time Out:</th><td colspan="3"><input type="time" id="timeOut"></td></tr>
                    <tr><th>Time In:</th><td colspan="3">
                        <select id="timeInDropdown" onchange="handleTimeInSelection()" style="width: 100%; padding: 4px; background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px; color: #fff; font-size: 14px; margin-bottom: 5px;">
                            <option value="">-- Select or Enter Time --</option>
                            <option value="Early Checkout">Early Checkout</option>
                            <option value="Half Day Permission">Half Day Permission</option>
                            <option value="manual">Enter Time Manually</option>
                        </select>
                        <input type="time" id="timeIn" style="width: 100%; padding: 4px; background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px; color: #fff; font-size: 14px; display: none;">
                    </td></tr>
                    <tr><th>Going To:</th><td colspan="3"><input type="text" id="goingTo"></td></tr>
                    
                    <tr>
                        <th colspan="1">Signature</th>
                        <th colspan="1">Team Lead Signature</th>
                        <th colspan="1">HR Signature</th>
                        <th colspan="1">Director Signature</th>
                    </tr>
                    <tr>
                        <td><input type="text" id="applicantSign" placeholder="Type name to sign..."></td>
                        <td><input type="text" id="teamLeadSign" placeholder="Type name to sign..." readonly disabled></td>
                        <td><input type="text" id="hrSign" placeholder="Type name to sign..." readonly disabled></td>
                        <td><input type="text" id="directorSign" placeholder="Type name to sign..." readonly disabled></td>
                    </tr>
                    <tr>
                        <td colspan="4">
                            <strong>Select Team Lead:</strong><br>
                            <select id="teamLeadSelect"></select>
                        </td>
                    </tr>
                </table>
                <div class="form-actions">
                    <button type="button" class="form-btn btn-submit" onclick="submitPermissionRequest()">Submit Request</button>
                </div>
            </form>
        </div>
    `;
}
async function populateTeamLeadDropdown() {
    const selectElement = document.getElementById('teamLeadSelect');
    // Check if the element exists. If not, log an error and exit.
    if (!selectElement) {
        console.error("The 'teamLeadSelect' element was not found in the DOM.");
        return;
    }
    
    try {
        const response = await fetch('/api/team_leads');
        const data = await response.json();
        if (data.status === 'success') {
            selectElement.innerHTML = '<option value="">-- Select Team Lead --</option>';
            data.team_leads.forEach(lead => {
                const option = document.createElement('option');
                option.value = lead.id;
                option.textContent = lead.name;
                selectElement.appendChild(option);
            });
        } else {
            console.error('Failed to fetch team leads:', data.message);
            selectElement.innerHTML = '<option value="">Error loading team leads</option>';
        }
    } catch (error) {
        console.error('Error fetching team leads:', error);
        selectElement.innerHTML = '<option value="">Error loading team leads</option>';
    }
}
async function submitApprovalAction(requestId, roleType, action) {
    const form = document.getElementById('leaveApprovalForm');
    
    let endpoint = '';
    let formData = { action: action };

    if (roleType === 'teamlead') {
        endpoint = `/api/approve_leave_request_teamlead/${requestId}`;
        formData.reporting_authority_sign = form.querySelector('#reportingAuthoritySign').value;
        formData.reporting_authority_date = form.querySelector('#reportingAuthorityDate').value;
        formData.remarks = form.querySelector('#remarks').value;

        if (action === 'approve' && (!formData.reporting_authority_sign || !formData.reporting_authority_date)) {
            alert('Please fill in your signature and date to approve.');
            return;
        }
    } else if (roleType === 'hr') {
        endpoint = `/api/approve_leave_request_hr/${requestId}`;
        formData.hr_sign = form.querySelector('#hrSign').value;
        formData.hr_date = form.querySelector('#hrDate').value;

        if (action === 'approve' && (!formData.hr_sign || !formData.hr_date)) {
            alert('Please fill in your signature and date to approve.');
            return;
        }
    } else if (roleType === 'director') { 
        endpoint = `/api/approve_leave_request_director/${requestId}`;
        formData.director_sign = form.querySelector('#directorSign').value;
        formData.director_date = form.querySelector('#directorDate').value;
        formData.remarks = form.querySelector('#remarks').value;

        if (action === 'approve' && (!formData.director_sign || !formData.director_date)) {
            alert('Please fill in your signature and date to approve.');
            return;
        }
    } else {
        alert('You do not have permission to perform this action.');
        return;
    }

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });
        const result = await response.json();

        if (result.status === 'success') {
            alert('✅ Form saved successfully and employee can see the updates !!');
            loadPermissionsSection();
        } else {
            alert('❌ Failed to ' + action + ' request: ' + result.message);
        }
    } catch (error) {
        console.error('Error submitting approval action:', error);
        alert('An error occurred. Please try again.');
    }
}

// MODIFIED loadRequestForm function
async function loadRequestForm(requestType) {
    const container = document.getElementById('attendanceFormView'); // CORRECTED: Target the formView container

    if (!container) {
        console.error("Target container '#attendanceFormView' not found.");
        return;
    }

    // Hide the main view and show the form view to prepare for rendering
    const mainView = document.getElementById('attendanceMainView');
    if (mainView) mainView.style.display = 'none';
    if (container) container.style.display = 'block';

    let formHtml = '';
    switch (requestType) {
        case 'Leave':
            formHtml = generateLeaveFormHTML({}, true, userRoles);
            container.innerHTML = formHtml;
            await populateTeamLeadDropdown();
            break;
        case 'Permission':
            formHtml = generatePermissionFormHTML();
            container.innerHTML = formHtml;
            await populateTeamLeadDropdown();
            break;
        case 'Travel':
            // CORRECTED: Call the function and set innerHTML
            formHtml = generateTravelFormHTML();
            container.innerHTML = formHtml;
            break;
        case 'Conveyance':
            formHtml = generateConveyanceFormHTML();
            container.innerHTML = formHtml;
            break;
        default:
            loadPermissionsSection();
            return;
    }
}


// This function now returns only the HTML string.
function generateLeaveFormHTML(request = {}, isNew = true, roles = [], currentUserId = null) {
    const isTeamLead = roles.includes('Team Lead');
    const isHR = roles.includes('HR');
    const isDirector = roles.includes('Director');

    const isAssignedTeamLead = isTeamLead && request.team_lead_id === parseInt(currentUserId);

    const applicantFieldsReadOnly = 'readonly disabled';
    const teamLeadFieldsReadOnly = (isAssignedTeamLead && request.status === 'Pending') ? '' : 'readonly disabled';
    const hrFieldsReadOnly = (isHR && request.status === 'Pending HR Approval') ? '' : 'readonly disabled';
    const directorFieldsReadOnly = (isDirector && request.status === 'Pending Director Approval') ? '' : 'readonly disabled';
    const isAllowedToEditRemarks = isAssignedTeamLead || isHR || isDirector;
    const remarksReadOnly = isAllowedToEditRemarks ? '' : 'readonly disabled';

    const showApprovalButton = !isNew && (
        (isTeamLead && request.status === 'Pending') ||
        (isHR && request.status === 'Pending HR Approval') ||
        (isDirector && request.status === 'Pending Director Approval')
    );

    let approvalRole = '';
    if (isAssignedTeamLead) approvalRole = 'teamlead';
    else if (isHR) approvalRole = 'hr';
    else if (isDirector) approvalRole = 'director';

    return `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0;">${isNew ? 'Application For Leave' : `Leave Request Details (#${request.id})`}</h2>
            <button type="button" class="form-btn btn-back" onclick="loadPermissionsSection()">← Back</button>
        </div>
        <div class="form-container">
            <div class="form-header">
                <img src="/static/images/logo.png" alt="SSEV Logo">
                <h3>SSEV SOFTSOLS</h3>
                ${!isNew ? `<p>Status: <span class="status status-${request.status.toLowerCase().replace(/ /g, '-')}">${request.status}</span></p>` : ''}
            </div>
            <form id="${isNew ? 'leaveRequestForm' : 'leaveApprovalForm'}">
                <input type="hidden" id="requestId" value="${request.id || ''}">
                <table class="leave-table">
                    <tr>
                        <td colspan="2"><strong>SPV Name:</strong><br><select id="spvName" ${isNew ? '' : 'disabled'}><option value="">-- Select SPV --</option><option value="SSEV" ${request.spv_name === 'SSEV' ? 'selected' : ''}>SSEV</option><option value="SSEV SOFT SOLS" ${request.spv_name === 'SSEV SOFT SOLS' ? 'selected' : ''}>SSEV SOFT SOLS</option></select></td>
                        <td colspan="2"><strong>Department:</strong><br><input type="text" id="department" value="${request.department || ''}" ${isNew ? '' : 'readonly disabled'}></td>
                        <td><strong>Emp. No:</strong><br><input type="text" id="empNo" value="${request.emp_no || ''}" ${isNew ? '' : 'readonly disabled'}></td>
                    </tr>
                    <tr>
                        <td colspan="2"><strong>Contact Details while on Leave:</strong><br><input type="text" id="contactDetails" value="${request.contact_details || ''}" ${isNew ? '' : 'readonly disabled'}></td>
                        <td colspan="3"><strong>Name:</strong><br><input type="text" id="applicantName" value="${request.applicant_name || ''}" ${isNew ? '' : 'readonly disabled'}></td>
                    </tr>
                    <tr>
                        <td colspan="5"><strong>Select Team Lead:</strong><br>
                            <select id="teamLeadSelect" ${isNew ? '' : 'readonly disabled'}>
                                <option>${request.team_lead_name || '-- Select a Team Lead --'}</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="5" class="centered-text">APPLICATION FOR LEAVE</td>
                    </tr>
                    <tr>
                        <td colspan="2"><strong>Leave Details</strong><br>
                            <strong>Total Leaves:</strong><br><input type="number" id="totalLeaves" value="${request.total_leaves || '0'}" ${isNew ? '' : 'readonly disabled'}><br>
                            <strong>Leave Availed:</strong><br><input type="number" id="leaveAvailed" value="${request.leave_availed || '0'}" ${isNew ? '' : 'readonly disabled'}><br>
                            <strong>Balance:</strong><br><input type="number" id="balanceLeaves" value="${request.balance_leaves || '0'}" ${isNew ? '' : 'readonly disabled'}>
                        </td>
                        <td><strong>FROM</strong><br>
                            <strong>Date:</strong><br><input type="date" id="fromDate" value="${request.from_date || ''}" ${isNew ? '' : 'readonly disabled'}>
                            <strong>Time:</strong><br><input type="time" id="fromTime" value="${(request.from_time && request.from_time.length === 5) ? request.from_time : (request.from_time || '')}" ${isNew ? '' : 'readonly disabled'}>
                        </td>
                        <td><strong>TO</strong><br>
                            <strong>Date:</strong><br><input type="date" id="toDate" value="${request.to_date || ''}" ${isNew ? '' : 'readonly disabled'}>
                            <strong>Time:</strong><br><input type="time" id="toTime" value="${(request.to_time && request.to_time.length === 5) ? request.to_time : (request.to_time || '')}" ${isNew ? '' : 'readonly disabled'}>
                        </td>
                        <td><strong>Reason For Leave</strong><br><textarea rows="5" id="reason" ${isNew ? '' : 'readonly disabled'}>${request.reason || ''}</textarea></td>
                    </tr>
                    <tr>
                        <td><strong>Route</strong></td>
                        <td><strong>Applicant</strong></td>
                        <td><strong>Reporting Authority</strong></td>
                        <td><strong>HR Dept.</strong></td>
                        <td><strong>Director</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Sign.</strong></td>
                        <td><input type="text" id="applicantSign" placeholder="Sign here..." value="${request.applicant_sign || ''}" ${isNew ? '' : 'readonly disabled'}></td>
                        <td><input type="text" id="reportingAuthoritySign" placeholder="Sign here..." value="${request.reporting_authority_sign || ''}" ${teamLeadFieldsReadOnly}></td>
                        <td><input type="text" id="hrSign" placeholder="Sign here..." value="${request.hr_sign || ''}" ${hrFieldsReadOnly}></td>
                        <td><input type="text" id="directorSign" placeholder="Sign here..." value="${request.director_sign || ''}" ${directorFieldsReadOnly}></td>
                    </tr>
                    <tr>
                        <td><strong>Date</strong></td>
                        <td><input type="date" id="applicantSignDate" value="${request.applicant_sign_date || ''}" ${isNew ? '' : 'readonly disabled'}></td>
                        <td><input type="date" id="reportingAuthorityDate" value="${request.reporting_authority_date || ''}" ${teamLeadFieldsReadOnly}></td>
                        <td><input type="date" id="hrDate" value="${request.hr_date || ''}" ${hrFieldsReadOnly}></td>
                        <td><input type="date" id="directorDate" value="${request.director_date || ''}" ${directorFieldsReadOnly}></td>
                    </tr>
                    <tr>
                        <td colspan="5"><strong>Remarks: Sanction / Reject:</strong><br><textarea rows="3" id="remarks" onblur="saveRemarks(${request.id}, this.value)" ${remarksReadOnly}>${request.remarks || ''}</textarea></td>

                    </tr>
                </table>
            </form>
            ${isNew ? `
            <div class="form-actions">
                <button type="button" class="form-btn btn-submit" onclick="submitLeaveRequest()">Submit Request</button>
            </div>
            ` : ''}
            ${showApprovalButton ? `
            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" class="form-btn btn-submit" onclick="submitApprovalAction(${request.id}, '${approvalRole}', 'approve')">Approve & Submit</button>
                <button type="button" class="form-btn btn-danger" onclick="submitApprovalAction(${request.id}, '${approvalRole}', 'reject')">Reject</button>
            </div>
            ` : ''}
        </div>
    `;
}

async function submitLeaveRequest() {
    const form = document.getElementById('leaveRequestForm');
    const formData = {
        spv_name: form.querySelector('#spvName').value,
        department: form.querySelector('#department').value,
        emp_no: form.querySelector('#empNo').value,
        contact_details: form.querySelector('#contactDetails').value,
        applicant_name: form.querySelector('#applicantName').value,
        total_leaves: form.querySelector('#totalLeaves').value,
        leave_availed: form.querySelector('#leaveAvailed').value,
        balance_leaves: form.querySelector('#balanceLeaves').value,
        from_date: form.querySelector('#fromDate').value,
        from_time: form.querySelector('#fromTime').value,
        to_date: form.querySelector('#toDate').value,
        to_time: form.querySelector('#toTime').value,
        reason: form.querySelector('#reason').value,
        applicant_sign: form.querySelector('#applicantSign').value,
        applicant_sign_date: form.querySelector('#applicantSignDate').value,
        team_lead_id: form.querySelector('#teamLeadSelect').value,
    };
    if (!formData.team_lead_id) {
        alert('Please select a Team Lead.');
        return;
    }
    if (!formData.from_date || !formData.to_date || !formData.reason) {
        alert('Please fill in the required leave details.');
        return;
    }
    try {
        const response = await fetch('/api/submit_leave_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });
        const result = await response.json();
        if (result.status === 'success') {
            alert('✅ Leave request submitted successfully!');
            // Show the submitted request with all details
            if (result.request_id) {
                loadRequestDetails(result.request_id, 'Leave');
            } else {
                loadPermissionsSection();
            }
            // Refresh the view requests section to show the new request
            await refreshCurrentViewRequests();
        } else {
            alert('❌ Failed to submit leave request: ' + result.message);
        }
    } catch (error) {
        console.error('Error submitting leave request:', error);
        alert('An error occurred. Please try again.');
    }
}

// Function to load and display request details after submission
async function loadRequestDetails(requestId, requestType) {
    const mainView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');
    
    if (mainView) mainView.style.display = 'none';
    if (formView) formView.style.display = 'block';
    
    formView.innerHTML = '<p style="text-align: center; color: #ccc;">Loading request details...</p>';
    
    try {
        let response;
        if (requestType === 'Leave') {
            response = await fetch(`/api/leave_request/${requestId}`);
        } else if (requestType === 'Permission') {
            response = await fetch(`/api/permission_request/${requestId}`);
        } else if (requestType === 'Travel') {
            response = await fetch(`/api/travel_request/${requestId}`);
        } else if (requestType === 'Conveyance') {
            response = await fetch(`/api/conveyance_request/${requestId}`);
        } else {
            formView.innerHTML = `<p style="text-align: center; color: red;">Unsupported request type.</p>`;
            return;
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Get user roles and ID for proper form rendering
            let userRoles = [];
            let localCurrentUserId = null;
            
            try {
                const [roleResponse, idResponse] = await Promise.all([
                    fetch('/api/user/roles'),
                    fetch('/api/user_id')
                ]);
                
                const roleData = await roleResponse.json();
                const idData = await idResponse.json();
                
                if (roleData.status === 'success') {
                    userRoles = roleData.roles;
                }
                if (idData.status === 'success') {
                    localCurrentUserId = idData.user_id;
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
            
            // Render the form with the fetched data
            if (requestType === 'Leave') {
                console.log('Request data:', data.request);
                console.log('From Date:', data.request.from_date);
                console.log('From Time:', data.request.from_time);
                console.log('To Date:', data.request.to_date);
                console.log('To Time:', data.request.to_time);
                formView.innerHTML = generateLeaveFormHTML(data.request, false, userRoles, localCurrentUserId);
                
                // Force populate the date/time fields after form is rendered
                setTimeout(() => {
                    const fromDateField = document.getElementById('fromDate');
                    const fromTimeField = document.getElementById('fromTime');
                    const toDateField = document.getElementById('toDate');
                    const toTimeField = document.getElementById('toTime');
                    
                    if (fromDateField && data.request.from_date) {
                        fromDateField.value = data.request.from_date;
                        console.log('Set fromDate to:', data.request.from_date);
                    }
                    if (fromTimeField && data.request.from_time) {
                        fromTimeField.value = data.request.from_time;
                        console.log('Set fromTime to:', data.request.from_time);
                    }
                    if (toDateField && data.request.to_date) {
                        toDateField.value = data.request.to_date;
                        console.log('Set toDate to:', data.request.to_date);
                    }
                    if (toTimeField && data.request.to_time) {
                        toTimeField.value = data.request.to_time;
                        console.log('Set toTime to:', data.request.to_time);
                    }
                }, 100);
            } else {
                formView.innerHTML = `<p style="text-align: center; color: #ccc;">Request details loaded for ${requestType}</p>`;
            }
        } else {
            formView.innerHTML = `<p style="text-align: center; color: red;">Failed to load request: ${data.message}</p>`;
        }
    } catch (error) {
        console.error('Error fetching request details:', error);
        formView.innerHTML = `<p style="text-align: center; color: red;">An error occurred while fetching the request.</p>`;
    }
}

// NEW/MODIFIED function
function generatePermissionFormHTML() {
    return `
        <style>
    .form-container{max-width:100%; margin:0 auto; background:rgba(0,0,0,0.4); border:1px solid rgba(0,209,255,0.3); border-radius:15px; padding:30px;}
    .form-header{text-align:center; margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.2);}
    .form-header img{max-width:150px; margin-bottom:10px;}
    .form-header h3{color:#00d1ff; font-weight:bold; margin:5px 0;}
    .form-table{width:100%; border-collapse:collapse; margin-top:20px;}
    .form-table th, .form-table td{border:1px solid rgba(255,255,255,0.3); padding:12px; text-align:left; vertical-align:middle;}
    .form-table input, .form-table textarea, .form-table select {width:100%; padding:8px; background:rgba(0,0,0,0.5); border:1px solid #555; border-radius:4px; color:#fff; font-size:14px;}
    .form-actions{display:flex; justify-content:flex-end; gap:15px; margin-top:30px;}
    .form-btn{padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; color:white; text-align:center;}
    .btn-submit{background:linear-gradient(135deg,#28a745 0%,#218838 100%);}
    .btn-back{background:#6c757d;}
    input[type="time"]::-webkit-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
    input[type="time"]::-webkit-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
    input[type="time"]::-moz-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
    input[type="time"]::-moz-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
</style>

<div class="form-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0;">Permission Slip</h2>
        <button type="button" class="form-btn btn-back" onclick="loadPermissionsSection()">← Back</button>
    </div>
    <div class="form-header">
        <img src="/static/images/logo.png" alt="SSEV Logo">
        <h3>SS ENERGY VENTURES PRIVATE LIMITED</h3>
    </div>
    <h3 style="text-align:center; margin-top:20px;">PERMISSION SLIP</h3>
    <form id="permissionRequestForm">
        <table class="form-table">
            <tr><th style="width:30%;">SPV Name:</th><td colspan="3"><select id="spvName"><option value="">-- Select SPV --</option><option value="SSEV">SSEV</option><option value="SSEV SOFT SOLS">SSEV SOFT SOLS</option></select></td></tr>
            <tr><th>Date:</th><td colspan="3"><input type="date" id="date"></td></tr>
            <tr><th>Name:</th><td colspan="3"><input type="text" id="applicantName"></td></tr>
            <tr><th>Permission for Official Duty / Personal Work:</th><td colspan="3"><textarea rows="3" id="reason"></textarea></td></tr>
            <tr><th>Time Out:</th><td colspan="3"><input type="time" id="timeOut"></td></tr>
            <tr><th>Time In:</th><td colspan="3">
                <select id="timeInDropdown" onchange="handleTimeInSelection()" style="width: 100%; padding: 4px; background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px; color: #fff; font-size: 14px; margin-bottom: 5px;">
                    <option value="">-- Select or Enter Time --</option>
                    <option value="Early Checkout">Early Checkout</option>
                    <option value="Half Day Permission">Half Day Permission</option>
                    <option value="manual">Enter Time Manually</option>
                </select>
                <input type="time" id="timeIn" style="width: 100%; padding: 4px; background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px; color: #fff; font-size: 14px; display: none;">
            </td></tr>
            <tr><th>Going To:</th><td colspan="3"><input type="text" id="goingTo"></td></tr>
            
            <!-- Updated table section for signatures and roles -->
            <tr>
                <th colspan="1">Signature</th>
                <th colspan="1">Team Lead Signature</th>
                <th colspan="1">HR Signature</th>
                <th colspan="1">Director Signature</th>
            </tr>
            <tr>
                <td><input type="text" id="applicantSign" placeholder="Type name to sign..."></td>
                <td><input type="text" id="teamLeadSign" placeholder="Type name to sign..." readonly disabled></td>
                <td><input type="text" id="hrSign" placeholder="Type name to sign..." readonly disabled></td>
                <td><input type="text" id="directorSign" placeholder="Type name to sign..." readonly disabled></td>
            </tr>
            <tr>
                <td colspan="4">
                    <strong>Select Team Lead:</strong><br>
                    <select id="teamLeadSelect"></select>
                </td>
            </tr>
        </table>
        <div class="form-actions">
            <button type="button" class="form-btn btn-submit" onclick="submitPermissionRequest()">Submit Request</button>
        </div>
    </form>
</div>

    `;
}

// Function to handle Time In dropdown selection
function handleTimeInSelection() {
    const dropdown = document.getElementById('timeInDropdown');
    const timeInput = document.getElementById('timeIn');
    
    if (dropdown.value === 'manual') {
        // Show the time input field for manual entry
        timeInput.style.display = 'block';
        timeInput.value = '';
        timeInput.focus();
    } else if (dropdown.value === 'Early Checkout' || dropdown.value === 'Half Day Permission') {
        // Hide the time input field and clear its value
        timeInput.style.display = 'none';
        timeInput.value = '';
    } else {
        // Default state - hide time input
        timeInput.style.display = 'none';
        timeInput.value = '';
    }
}

// Function to get the Time In value from either dropdown or manual input
function getTimeInValue() {
    const dropdown = document.getElementById('timeInDropdown');
    const timeInput = document.getElementById('timeIn');
    
    if (dropdown.value === 'manual') {
        // Return the manually entered time
        return timeInput.value;
    } else if (dropdown.value === 'Early Checkout' || dropdown.value === 'Half Day Permission') {
        // Return the dropdown selection
        return dropdown.value;
    } else {
        // Return empty if nothing is selected
        return '';
    }
}

// Function to refresh the current view requests section
async function refreshCurrentViewRequests() {
    // Get the current user's role and refresh the appropriate view
    const isTeamLead = document.getElementById('teamLeadViewSelector');
    const isHR = document.getElementById('hrViewSelector');
    const isDirector = document.getElementById('directorViewSelector');
    const isAccounts = document.getElementById('accountsViewSelector');
    
    if (isTeamLead) {
        const currentValue = isTeamLead.value || 'myRequests';
        await handleTeamLeadView(currentValue);
    } else if (isHR) {
        const currentValue = isHR.value || 'myRequests';
        await handleHRView(currentValue);
    } else if (isDirector) {
        const currentValue = isDirector.value || 'myRequests';
        await handleDirectorView(currentValue);
    } else if (isAccounts) {
        const currentValue = isAccounts.value || 'myRequests';
        await handleAccountsView(currentValue);
    }
}

// NEW function
async function submitPermissionRequest() {
    const form = document.getElementById('permissionRequestForm');
    const formData = {
        spv_name: form.querySelector('#spvName').value,
        date: form.querySelector('#date').value,
        applicant_name: form.querySelector('#applicantName').value,
        reason: form.querySelector('#reason').value,
        time_out: form.querySelector('#timeOut').value,
        time_in: getTimeInValue(),
        going_to: form.querySelector('#goingTo').value,
        applicant_sign: form.querySelector('#applicantSign').value,
        team_lead_id: form.querySelector('#teamLeadSelect').value,
    };
    if (!formData.team_lead_id) {
        alert('Please select a Team Lead.');
        return;
    }
    try {
        const response = await fetch('/api/submit_permission_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });
        const result = await response.json();
        if (result.status === 'success') {
            alert('✅ Permission request submitted successfully!');
            loadPermissionsSection();
            // Refresh the view requests section to show the new request
            await refreshCurrentViewRequests();
        } else {
            alert('❌ Failed to submit permission request: ' + result.message);
        }
    } catch (error) {
        console.error('Error submitting permission request:', error);
        alert('An error occurred. Please try again.');
    }
}

// MODIFIED openRequestForm to handle Conveyance claims
// MODIFIED openRequestForm to handle all request types
async function openRequestForm(requestType, requestId) {
    const mainView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');

    if (mainView) mainView.style.display = 'none';
    if (formView) formView.style.display = 'block';

    if (!formView) {
        console.error("The 'attendanceFormView' element was not found in the DOM.");
        return;
    }

    formView.innerHTML = '<p style="text-align: center; color: #ccc;">Loading form...</p>';

    try {
        let response;
        if (requestType === 'Leave') {
            response = await fetch(`/api/leave_request/${requestId}`);
        } else if (requestType === 'Permission') {
            response = await fetch(`/api/permission_request/${requestId}`);
        } else if (requestType === 'Travel') {
            // This is the added block for Travel requests
            response = await fetch(`/api/travel_request/${requestId}`);
        } else if (requestType === 'Conveyance') {
            response = await fetch(`/api/conveyance_request/${requestId}`);
        } else {
            formView.innerHTML = `<p style="text-align: center; color: red;">Unsupported request type.</p>`;
            return;
        }

        const data = await response.json();

        if (data.status === 'success') {
            if (requestType === 'Leave') {
                await renderFullLeaveForm(data.request);
            } else if (requestType === 'Permission') {
                await renderFullPermissionForm(data.request);
            } else if (requestType === 'Travel') {
                // Call the render function for the Travel form
                await renderFullTravelForm(data.request); 
            } else if (requestType === 'Conveyance') {
                await renderFullConveyanceForm(data.request);
            }
        } else {
            formView.innerHTML = `<p style="text-align: center; color: red;">Failed to load request: ${data.message}</p>`;
        }
    } catch (error) {
        console.error('Error fetching full request:', error);
        formView.innerHTML = `<p style="text-align: center; color: red;">An error occurred while fetching the request.</p>`;
    }
}

// NEW function

// async function renderFullPermissionForm(request) {
//     const container = document.getElementById('requestsDisplayContainer') || document.getElementById('viewRequestsContainer');
//     let userRoles = [];
//     try {
//         const roleResponse = await fetch('/api/user/roles');
//         const roleData = await roleResponse.json();
//         if (roleData.status === 'success') {
//             userRoles = roleData.roles;
//         }
//     } catch (error) {
//         console.error('Error fetching user roles:', error);
//     }
//     let localCurrentUserId = null;
//     try {
//         const idResponse = await fetch('/api/user_id');
//         const idData = await idResponse.json();
//         if (idData.status === 'success') {
//             localCurrentUserId = idData.user_id;
//         }
//     } catch (error) {
//         console.error('Error fetching user ID:', error);
//     }
//     const isTeamLead = userRoles.includes('Team Lead');
//     const isHR = userRoles.includes('HR');
//     const isDirector = userRoles.includes('Director');

//     const isAssignedTeamLead = isTeamLead && request.team_lead_id === parseInt(localCurrentUserId);

//     const teamLeadFieldsDisabled = (isAssignedTeamLead && request.status === 'Pending') ? '' : 'disabled readonly';
//     const hrFieldsDisabled = (isHR && request.status === 'Pending HR Approval') ? '' : 'disabled readonly';
//     const directorFieldsDisabled = (isDirector && request.status === 'Pending Director Approval') ? '' : 'disabled readonly';

//     let approvalButtonsHtml = '';
// if (isAssignedTeamLead && request.status === 'Pending') {
//     approvalButtonsHtml = `
//         <div class="form-actions">
//             <button type="button" class="form-btn btn-submit" onclick="submitPermissionApprovalAction(${request.id}, 'teamlead', 'approve', '${request.status}')">Approve</button>
//             <button type="button" class="form-btn btn-danger" onclick="submitPermissionApprovalAction(${request.id}, 'teamlead', 'reject', '${request.status}')">Reject</button>
//         </div>`;
// } else if (isHR && request.status === 'Pending HR Approval') {
//     approvalButtonsHtml = `
//         <div class="form-actions">
//             <button type="button" class="form-btn btn-submit" onclick="submitPermissionApprovalAction(${request.id}, 'hr', 'approve', '${request.status}')">Approve</button>
//             <button type="button" class="form-btn btn-danger" onclick="submitPermissionApprovalAction(${request.id}, 'hr', 'reject', '${request.status}')">Reject</button>
//         </div>`;
// } else if (isDirector && request.status === 'Pending Director Approval') {
//     approvalButtonsHtml = `
//         <div class="form-actions">
//             <button type="button" class="form-btn btn-submit" onclick="submitPermissionApprovalAction(${request.id}, 'director', 'approve', '${request.status}')">Approve</button>
//             <button type="button" class="form-btn btn-danger" onclick="submitPermissionApprovalAction(${request.id}, 'director', 'reject', '${request.status}')">Reject</button>
//         </div>`;
// }

// container.innerHTML = `
//     <button type="button" class="back-button" onclick="loadPermissionsSection()">← Back to Requests</button>
//     <div class="form-container" style="padding: 20px;">
//         <div class="form-header">
//             <h3>Permission Slip (#${request.id})</h3>
//             <p>Status: <span class="status status-${request.status.toLowerCase().replace(/ /g, '-')}">${request.status}</span></p>
//         </div>
//         <form id="permissionApprovalForm">
//             <input type="hidden" id="requestId" value="${request.id}">
//             <table class="form-table">
//                 <tr><th style="width:30%;">SPV Name:</th><td><input type="text" value="${request.spv_name || ''}" disabled readonly></td></tr>
//                 <tr><th>Date:</th><td><input type="date" value="${request.date || ''}" disabled readonly></td></tr>
//                 <tr><th>Name:</th><td><input type="text" value="${request.applicant_name || ''}" disabled readonly></td></tr>
//                 <tr><th>Permission for Official Duty / Personal Work:</th><td><textarea rows="3" disabled readonly>${request.reason || ''}</textarea></td></tr>
//                 <tr><th>Time Out:</th><td><input type="time" value="${request.time_out || ''}" disabled readonly></td></tr>
//                 <tr><th>Time In:</th><td><input type="time" value="${request.time_in || ''}" disabled readonly></td></tr>
//                 <tr><th>Going To:</th><td><input type="text" value="${request.going_to || ''}" disabled readonly></td></tr>
//                 <tr>
//                     <th>Signature</th>
//                     <th>Team Lead Signature</th>
//                     <th>HR Signature</th>
//                     <th>Director Signature</th>
//                 </tr>
//                 <tr>
//                     <td><input type="text" placeholder="Type name to sign..." value="${request.applicant_sign || ''}" disabled readonly></td>
//                     <td><input type="text" id="teamLeadSign" placeholder="Type approver name..." value="${request.team_lead_sign || ''}" ${teamLeadFieldsDisabled}></td>
//                     <td><input type="text" id="hrSign" placeholder="Type HR name..." value="${request.hr_sign || ''}" ${hrFieldsDisabled}></td>
//                     <td><input type="text" id="directorSign" placeholder="Type Director name..." value="${request.director_sign || ''}" ${directorFieldsDisabled}></td>
//                 </tr>
//             </table>
//         </form>
//         ${approvalButtonsHtml}
//     </div>
// `;
// }
function loadSalariesSection() {
    console.log('Loading salaries section...');
    
    // For multi-dashboard, we just need to populate the existing salaries section
    // The salaries section should already be visible via the tab system
    console.log('Salaries section loaded');
    
    // Populate the employee dropdown
    populateEmployeeDropdown();

    // Add event listeners for the download buttons if they exist
    const downloadSsevSheet = document.getElementById('downloadSsevSheet');
    const downloadSoftsolsSheet = document.getElementById('downloadSoftsolsSheet');
    
    if (downloadSsevSheet) {
        downloadSsevSheet.addEventListener('click', () => {
            downloadSalarySheetTable('SSEV');
        });
    }
    
    if (downloadSoftsolsSheet) {
        downloadSoftsolsSheet.addEventListener('click', () => {
            downloadSalarySheetTable('SSEV Softsols');
        });
    }
}

function toggleDropdown(contentId) {
    const content = document.getElementById(contentId);
    const header = content.previousElementSibling;
    content.classList.toggle('collapsed');
    header.classList.toggle('collapsed');
}

function calculateTotals() {
    // Actuals section - no total calculation needed

    // Get values from all Earnings inputs
    const earningsBasic = parseFloat(document.getElementById('earningsBasic').value) || 0;
    const earningsHra = parseFloat(document.getElementById('earningsHra').value) || 0;
    const earningsConveyance = parseFloat(document.getElementById('earningsConveyance').value) || 0;
    const earningsVehicleMaintenance = parseFloat(document.getElementById('earningsVehicleMaintenance').value) || 0;
    const earningsSpecialAllowance = parseFloat(document.getElementById('earningsSpecialAllowance').value) || 0;
    const addOthersEarnings = parseFloat(document.getElementById('addOthersEarnings').value) || 0;

    // Calculate and display Total Earnings
    const totalEarnings = earningsBasic + earningsHra + earningsConveyance + earningsVehicleMaintenance + earningsSpecialAllowance + addOthersEarnings;
    document.getElementById('totalEarnings').textContent = totalEarnings.toFixed(2);
    
    // Get values from all Deductions inputs
    const providentFund = parseFloat(document.getElementById('providentFund').value) || 0;
    const esi = parseFloat(document.getElementById('esi').value) || 0;
    const professionalTax = parseFloat(document.getElementById('professionalTax').value) || 0;
    const incomeTax = parseFloat(document.getElementById('incomeTax').value) || 0;
    const advance = parseFloat(document.getElementById('advance').value) || 0;
    const otherDeductions = parseFloat(document.getElementById('otherDeductions').value) || 0;
    const lossOfPay = parseFloat(document.getElementById('lossOfPay').value) || 0;

    // Calculate and display Total Deductions
    const totalDeductions = providentFund + esi + professionalTax + incomeTax + advance + otherDeductions + lossOfPay;
    console.log('DEBUG: Deductions values:', {
        providentFund, esi, professionalTax, incomeTax, advance, otherDeductions, lossOfPay, totalDeductions
    });
    document.getElementById('totalDeductions').textContent = totalDeductions.toFixed(2);
    
    // Calculate and display Net Salary (using Earnings total)
    const netSalary = totalEarnings - totalDeductions;
    document.getElementById('netSalary').textContent = netSalary.toFixed(2);
}

// NEW function
// Corrected submitPermissionApprovalAction function in your script
async function submitPermissionApprovalAction(requestId, roleType, action, requestStatus) {
    const form = document.getElementById('permissionApprovalForm');
    let endpoint = '';
    let formData = { action: action };

    // Determine the role submitting the action based on the 'roleType' parameter
    if (roleType === 'teamlead' && requestStatus === 'Pending') {
        endpoint = `/api/approve_permission_request_teamlead/${requestId}`;
        formData.approver_sign = form.querySelector('#teamLeadSign').value; // Corrected payload field name
        
        if (action === 'approve' && !formData.approver_sign) {
            alert('Please fill in your signature to approve.');
            return;
        }
    } else if (roleType === 'hr' && requestStatus === 'Pending HR Approval') {
        endpoint = `/api/approve_permission_request_hr/${requestId}`;
        formData.approver_sign = form.querySelector('#hrSign').value;
        
        if (action === 'approve' && !formData.approver_sign) {
            alert('Please fill in your signature to approve.');
            return;
        }
    } else if (roleType === 'director' && requestStatus === 'Pending Director Approval') {
        endpoint = `/api/approve_permission_request_director/${requestId}`;
        formData.approver_sign = form.querySelector('#directorSign').value;
        
        if (action === 'approve' && !formData.approver_sign) {
            alert('Please fill in your signature to approve.');
            return;
        }
    } else {
        alert('You do not have permission or the request is not at the correct stage to perform this action.');
        return;
    }

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });
        const result = await response.json();

        if (result.status === 'success') {
            alert('✅ Permission request ' + action + ' successfully!');
            loadPermissionsSection();
        } else {
            alert('❌ Failed to ' + action + ' request: ' + result.message);
        }
    } catch (error) {
        console.error('Error submitting permission approval:', error);
        alert('An error occurred. Please try again.');
    }
}
function generateTravelFormHTML() {
    return `
        <style>
            .form-container{max-width:100%; margin:0 auto; background:rgba(0,0,0,0.4); border:1px solid rgba(0,209,255,0.3); border-radius:15px; padding:30px;}
            .form-header{text-align:center; margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.2);}
            .form-header img{max-width:150px; margin-bottom:10px;}
            .form-header h3{color:#00d1ff; font-weight:bold; margin:5px 0;}
            .form-table{width:100%; border-collapse:collapse; margin-top:20px; font-size:12px;}
            .form-table th, .form-table td{border:1px solid rgba(255,255,255,0.3); padding:8px; text-align:left; vertical-align:middle;}
            .form-table input, .form-table textarea{width:100%; padding:8px; background:rgba(0,0,0,0.5); border:1px solid #555; border-radius:4px; color:#fff; font-size:14px;}
            .form-actions{display:flex; justify-content:flex-end; gap:15px; margin-top:30px;}
            .form-btn{padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; color:white; text-align:center;}
            .btn-submit{background:linear-gradient(135deg,#28a745 0%,#218838 100%);}
            .btn-back{background:#6c757d;}
            .signature-block {display:flex; flex-direction:column; align-items:flex-start;}
            .signature-input {width:80%; padding:5px; margin-top:5px; background:rgba(0,0,0,0.5); border:1px solid #555; border-radius:4px; color:#fff; font-size:14px;}
            input[type="time"]::-webkit-calendar-picker-indicator,
            input[type="date"]::-webkit-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-webkit-calendar-picker-indicator:hover,
            input[type="date"]::-webkit-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
            input[type="time"]::-moz-calendar-picker-indicator,
            input[type="date"]::-moz-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-moz-calendar-picker-indicator:hover,
            input[type="date"]::-moz-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
        </style>
        <div class="form-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin:0;">Travel Requisition</h2>
                <button type="button" class="form-btn btn-back" onclick="loadPermissionsSection()">← Back</button>
            </div>
            <div class="form-header">
                <img src="/static/images/logo.png" alt="SSEV Logo">
                <h3>SSEV SOFTSOL'S</h3>
                <p>TRAVEL REQUISTION FORM <br> AIR / TRAIN / BUS</p>
            </div>
            <form id="travelRequestForm">
                <table class="form-table">
                    <tr>
                        <td><strong>COMPANY</strong></td>
                        <td><input type="text" id="company"></td>
                        <td><strong>DATE</strong></td>
                        <td><input type="date" id="date"></td>
                    </tr>
                </table>
                <h4 style="text-align:center; margin-top:20px;">PARTICULARS OF JOURNEY</h4>
                <table class="form-table" id="journeyTable">
                    <thead>
                        <tr>
                            <th>S.NO</th>
                            <th>DATE OF THE JOURNEY</th>
                            <th>NAME OF THE PASSENGER</th>
                            <th colspan="2">SECTORS</th>
                            <th>AGE</th>
                            <th>CLASS</th>
                            <th>FLIGHT NO / TRAIN NO</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th>FROM</th>
                            <th>TO</th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" value="1" readonly></td>
                            <td><input type="date" class="journeyDate"></td>
                            <td><input type="text" class="passengerName"></td>
                            <td><input type="text" class="fromSector"></td>
                            <td><input type="text" class="toSector"></td>
                            <td><input type="number" class="passengerAge"></td>
                            <td><input type="text" class="passengerClass"></td>
                            <td><input type="text" class="flightNo"></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="2" readonly></td>
                            <td><input type="date" class="journeyDate"></td>
                            <td><input type="text" class="passengerName"></td>
                            <td><input type="text" class="fromSector"></td>
                            <td><input type="text" class="toSector"></td>
                            <td><input type="number" class="passengerAge"></td>
                            <td><input type="text" class="passengerClass"></td>
                            <td><input type="text" class="flightNo"></td>
                        </tr>
                    </tbody>
                </table>
                <table class="form-table">
                    <tr>
                        <th>PURPOSE OF THE TRIP</th>
                        <td><textarea rows="3" id="purpose"></textarea></td>
                    </tr>
                </table>
                <table class="form-table" style="height:150px;">
                    <tr style="vertical-align: bottom;">
                        <td style="width:50%; padding-bottom: 10px;">
                            <div class="signature-block">
                                SIGNATURE OF THE PERSON BOOKED
                                <input type="text" id="applicantSign" class="signature-input" placeholder="Type your name">
                            </div>
                        </td>
                        <td style="width:50%; padding-bottom: 10px;">
                            <div class="signature-block">
                                SIGNATURE OF Director
                                <input type="text" id="directorSign" class="signature-input" placeholder="Type Director's name" readonly disabled>
                            </div>
                        </td>
                    </tr>
                </table>
            </form>
            <div class="form-actions">
                <button type="button" class="form-btn btn-submit" onclick="submitTravelRequest()">Submit Request</button>
            </div>
        </div>
    `;
}
function generateConveyanceFormHTML() {
    return `
        <style>
            .form-container{max-width:100%; margin:0 auto; background:rgba(0,0,0,0.4); border:1px solid rgba(0,209,255,0.3); border-radius:15px; padding:30px;}
            .form-header{text-align:center; margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.2);}
            .form-header img{max-width:150px; margin-bottom:10px;}
            .form-header h3{color:#00d1ff; font-weight:bold; margin:5px 0;}
            .form-table{width:100%; border-collapse:collapse; margin-top:20px;}
            .form-table th, .form-table td{border:1px solid rgba(255,255,255,0.3); padding:12px; text-align:left; vertical-align:middle;}
            .form-table input{width:100%; padding:8px; background:rgba(0,0,0,0.5); border:1px solid #555; border-radius:4px; color:#fff; font-size:14px;}
            .form-actions{display:flex; justify-content:flex-end; gap:15px; margin-top:30px;}
            .form-btn{padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; color:white; text-align:center;}
            .btn-submit{background:linear-gradient(135deg,#28a745 0%,#218838 100%);}
            .btn-back{background:#6c757d;}
            input[type="time"]::-webkit-calendar-picker-indicator,
            input[type="date"]::-webkit-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-webkit-calendar-picker-indicator:hover,
            input[type="date"]::-webkit-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
            input[type="time"]::-moz-calendar-picker-indicator,
            input[type="date"]::-moz-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-moz-calendar-picker-indicator:hover,
            input[type="date"]::-moz-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
        </style>
        <div class="form-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin:0;">Local Conveyance Claim</h2>
                <button type="button" class="form-btn btn-back" onclick="loadPermissionsSection()">← Back</button>
            </div>
            <div class="form-header">
                <img src="/static/images/logo.png" alt="SSEV Logo">
                <h3>SSEV SOFTSOL'S</h3>
            </div>
            <h3 style="text-align:center; margin-top:20px;">LOCAL CONVEYANCE CLAIM FORM</h3>
            <form id="conveyanceForm">  <table class="form-table" id="conveyanceTable">
                    <thead><tr><th>DATE</th><th>FROM</th><th>TO</th><th>MODE</th><th>KMS</th><th>AMOUNT</th></tr></thead>
                    <tbody>
                        <tr><td><input type="date" class="claimDate"></td><td><input type="text" class="claimFrom"></td><td><input type="text" class="claimTo"></td><td><input type="text" class="claimMode"></td><td><input type="number" class="claimKms"></td><td><input type="number" class="claimAmount"></td></tr>
                        <tr><td><input type="date" class="claimDate"></td><td><input type="text" class="claimFrom"></td><td><input type="text" class="claimTo"></td><td><input type="text" class="claimMode"></td><td><input type="number" class="claimKms"></td><td><input type="number" class="claimAmount"></td></tr>
                    </tbody>
                </table>
                <div class="form-actions">
                    <button type="button" class="form-btn btn-submit" onclick="submitConveyanceClaim()">Submit Claim</button>
                </div>
            </form>
        </div>
    `;
}
// NEW FUNCTION
// MODIFIED function
// NEW/MODIFIED function
async function renderFullTravelForm(request) {
    const mainView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');
    
    // Hide main view and show form view
    if (mainView) mainView.style.display = 'none';
    if (formView) formView.style.display = 'block';

    let userRoles = [];
    try {
        const roleResponse = await fetch('/api/user/roles');
        const roleData = await roleResponse.json();
        if (roleData.status === 'success') {
            userRoles = roleData.roles;
        }
    } catch (error) {
        console.error('Error fetching user roles:', error);
    }
    
    let localCurrentUserId = null;
    try {
        const idResponse = await fetch('/api/user_id');
        const idData = await idResponse.json();
        if (idData.status === 'success') {
            localCurrentUserId = idData.user_id;
        }
    } catch (error) {
        console.error('Error fetching user ID:', error);
    }

    const roles = Array.isArray(userRoles) ? userRoles : [];
    const isDirector = roles.includes('Director');
    const directorFieldsDisabled = (isDirector && request.status === 'Pending Director Approval') ? '' : 'disabled readonly';
    const showApprovalButtons = isDirector && request.status === 'Pending Director Approval';

    let journeyHtml = request.journey_details.map((item, index) => `
        <tr>
            <td><input type="text" value="${index + 1}" readonly disabled></td>
            <td><input type="date" value="${item.date || ''}" disabled readonly></td>
            <td><input type="text" value="${item.passengerName || ''}" disabled readonly></td>
            <td><input type="text" value="${item.from || ''}" disabled readonly></td>
            <td><input type="text" value="${item.to || ''}" disabled readonly></td>
            <td><input type="number" value="${item.age || ''}" disabled readonly></td>
            <td><input type="text" value="${item.class || ''}" disabled readonly></td>
            <td><input type="text" value="${item.flightNo || ''}" disabled readonly></td>
        </tr>
    `).join('');

    let approvalButtonsHtml = '';
    if (showApprovalButtons) {
        approvalButtonsHtml = `
            <div class="form-actions">
                <button type="button" class="form-btn btn-submit" onclick="submitTravelApprovalAction(${request.id}, 'approve')">Approve</button>
                <button type="button" class="form-btn btn-danger" onclick="submitTravelApprovalAction(${request.id}, 'reject')">Reject</button>
            </div>`;
    }

    formView.innerHTML = `
        <style>
            .form-container{max-width:100%; margin:0 auto; background:rgba(0,0,0,0.4); border:1px solid rgba(0,209,255,0.3); border-radius:15px; padding:30px;}
            .form-header{text-align:center; margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.2);}
            .form-header img{max-width:150px; margin-bottom:10px;}
            .form-header h3{color:#00d1ff; font-weight:bold; margin:5px 0;}
            .form-table{width:100%; border-collapse:collapse; margin-top:20px;}
            .form-table th, .form-table td{border:1px solid rgba(255,255,255,0.3); padding:12px; text-align:left; vertical-align:middle;}
            .form-table input, .form-table textarea, .form-table select {width:100%; padding:8px; background:rgba(0,0,0,0.5); border:1px solid #555; border-radius:4px; color:#fff; font-size:14px;}
            .form-actions{display:flex; justify-content:flex-end; gap:15px; margin-top:30px;}
            .form-btn{padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; color:white; text-align:center;}
            .btn-submit{background:linear-gradient(135deg,#28a745 0%,#218838 100%);}
            .btn-back{background:#6c757d;}
            input[type="time"]::-webkit-calendar-picker-indicator,
            input[type="date"]::-webkit-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-webkit-calendar-picker-indicator:hover,
            input[type="date"]::-webkit-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
            input[type="time"]::-moz-calendar-picker-indicator,
            input[type="date"]::-moz-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-moz-calendar-picker-indicator:hover,
            input[type="date"]::-moz-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
        </style>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0;">Travel Requisition (#${request.id})</h2>
            <button type="button" class="form-btn btn-back" onclick="loadPermissionsSection()">← Back</button>
        </div>
        <div class="form-container">
            <div class="form-header">
                <img src="/static/images/logo.png" alt="SSEV Logo">
                <h3>SS ENERGY VENTURES PRIVATE LIMITED</h3>
                <h3 style="text-align:center; margin-top:20px;">TRAVEL REQUISITION FORM <br> AIR / TRAIN / BUS</h3>
                <p>Status: <span class="status status-${request.status.toLowerCase().replace(/ /g, '-')}">${request.status}</span></p>
            </div>
            <form id="travelApprovalForm">
                <input type="hidden" id="requestId" value="${request.id}">
                <table class="form-table">
                    <tr>
                        <td><strong>COMPANY</strong></td>
                        <td><input type="text" value="${request.company || ''}" disabled readonly></td>
                        <td><strong>DATE</strong></td>
                        <td><input type="date" value="${request.date || ''}" disabled readonly></td>
                    </tr>
                </table>
                <h4 style="text-align:center; margin-top:20px;">PARTICULARS OF JOURNEY</h4>
                <table class="form-table">
                    <thead>
                        <tr>
                            <th>S.NO</th>
                            <th>DATE OF THE JOURNEY</th>
                            <th>NAME OF THE PASSENGER</th>
                            <th colspan="2">SECTORS</th>
                            <th>AGE</th>
                            <th>CLASS</th>
                            <th>FLIGHT NO / TRAIN NO</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th>FROM</th>
                            <th>TO</th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${journeyHtml}
                    </tbody>
                </table>
                <table class="form-table">
                    <tr>
                        <th>PURPOSE OF THE TRIP</th>
                        <td colspan="3"><textarea rows="3" disabled readonly>${request.purpose || ''}</textarea></td>
                    </tr>
                </table>
                <table class="form-table" style="height:150px;">
                    <tr style="vertical-align: bottom;">
                        <td style="width:50%; padding-bottom: 10px;">
                            <div class="signature-block">
                                SIGNATURE OF THE PERSON BOOKED
                                <input type="text" value="${request.applicant_sign || ''}" disabled readonly>
                            </div>
                        </td>
                        <td style="width:50%; padding-bottom: 10px;">
                            <div class="signature-block">
                                SIGNATURE OF Director
                                <input type="text" id="directorSign" placeholder="Type Director's name" value="${request.director_sign || ''}" ${directorFieldsDisabled}>
                            </div>
                        </td>
                    </tr>
                </table>
            </form>
            ${approvalButtonsHtml}
        </div>
    `;
}
// NEW FUNCTION
async function submitTravelApprovalAction(requestId, action) {
    const form = document.getElementById('travelApprovalForm');
    const directorSign = form.querySelector('#directorSign').value;

    if (action === 'approve' && !directorSign) {
        alert('Please fill in your signature to approve.');
        return;
    }

    try {
        const response = await fetch(`/api/approve_travel_request_director/${requestId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action, director_sign: directorSign }),
        });
        const result = await response.json();

        if (result.status === 'success') {
            alert('✅ Travel request ' + action + ' successfully!');
            loadPermissionsSection();
        } else {
            alert('❌ Failed to ' + action + ' request: ' + result.message);
        }
    } catch (error) {
        console.error('Error submitting travel approval:', error);
        alert('An error occurred. Please try again.');
    }
}

// Updated renderUserRequests function
async function renderUserRequests() {
    const container = document.getElementById('viewRequestsContainer');
    if (!container) return;

    container.innerHTML = '<p style="text-align: center; color: #ccc;">Loading your requests...</p>';

    try {
        const response = await fetch('/api/my_requests');
        const data = await response.json();

        if (data.status === 'success' && data.requests.length > 0) {
            let html = data.requests.map(req => `
                <div class="request-card" onclick="openLeaveRequestForm(${req.id})">
                    <p><strong>Applicant:</strong> ${req.applicant_name}</p>
                    <p><strong>From:</strong> ${req.from_date}</p>
                    <p><strong>To:</strong> ${req.to_date}</p>
                    <p><strong>Reason:</strong> ${req.reason}</p>
                    <p><strong>Status:</strong> <span class="status status-${req.status.toLowerCase().replace(/ /g, '-')}">${req.status}</span></p>
                </div>
            `).join('');
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="text-align:center; color: #ccc;">No requests submitted yet.</p>';
        }
    } catch (error) {
        console.error('Error fetching user requests:', error);
        container.innerHTML = '<p style="text-align:center; color: red;">Error loading requests. Please try again.</p>';
    }
}

// Function to fetch the user's requests and populate the dropdown
async function populateMyRequestsDropdown() {
    const selectElement = document.getElementById('myRequestsDropdown');
    if (!selectElement) {
        console.log('myRequestsDropdown element not found - user may not be a standard employee');
        return;
    }
    selectElement.innerHTML = '<option value="">Loading requests...</option>';

    try {
        const response = await fetch('/api/my_requests');
        const data = await response.json();

        if (data.status === 'success' && data.requests.length > 0) {
            selectElement.innerHTML = '<option value="">-- Select a request date --</option>';
            data.requests.forEach(req => {
                const option = document.createElement('option');
                option.value = req.id + '|' + req.request_type; 
                const dateText = req.request_type === 'Leave' ? `${req.from_date} to ${req.to_date}` : req.from_date;
                const requestName = req.request_type === 'Travel' ? `Travel Request` : `Request`;
                option.textContent = `${requestName} from ${dateText} (${req.request_type} - ${req.status})`;
                selectElement.appendChild(option);
            });
        } else {
            selectElement.innerHTML = '<option value="">No requests submitted yet.</option>';
        }
    } catch (error) {
        console.error('Error fetching user requests:', error);
        selectElement.innerHTML = '<option value="">Error loading requests</option>';
    }
}


async function getCurrentUserId() {
    try {
        const response = await fetch('/api/user_id');
        const data = await response.json();
        if (data.status === 'success') {
            currentUserId = data.user_id; // Set the global variable
            console.log('User ID fetched:', currentUserId);
        } else {
            console.error('Failed to fetch user ID:', data.message);
        }
    } catch (error) {
        console.error('Error fetching user ID:', error);
    }
}

// MODIFIED function

// MODIFIED function
async function displaySelectedRequest(requestValue) {
    const mainView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');
    const container = document.getElementById('requestsDisplayContainer');

    if (!requestValue) {
        container.innerHTML = '<p style="text-align:center; color: #ccc;">Select a date to view a request.</p>';
        return;
    }

    const [requestId, requestType] = requestValue.split('|');

    // Hide the main view and show the form view container
    if (mainView) mainView.style.display = 'none';
    if (formView) formView.style.display = 'block';
    formView.innerHTML = '<p style="text-align: center; color: #ccc;">Loading form...</p>';

    try {
        let response;
        if (requestType === 'Leave') {
            response = await fetch(`/api/leave_request/${requestId}`);
        } else if (requestType === 'Permission') {
            response = await fetch(`/api/permission_request/${requestId}`);
        } else if (requestType === 'Travel') {
            response = await fetch(`/api/travel_request/${requestId}`);
        } else if (requestType === 'Conveyance') {
            response = await fetch(`/api/conveyance_request/${requestId}`);
        } else {
            formView.innerHTML = `<p style="text-align: center; color: red;">Unsupported request type.</p>`;
            return;
        }

        const data = await response.json();

        if (data.status === 'success') {
            if (requestType === 'Leave') {
                await renderFullLeaveForm(data.request);
            } else if (requestType === 'Permission') {
                await renderFullPermissionForm(data.request);
            } else if (requestType === 'Travel') {
                // Call the render function for the Travel form
                await renderFullTravelForm(data.request);
            } else if (requestType === 'Conveyance') {
                await renderFullConveyanceForm(data.request);
            }
        } else {
            formView.innerHTML = `<p style="text-align: center; color: red;">Failed to load request: ${data.message}</p>`;
        }
    } catch (error) {
        console.error('Error fetching full request:', error);
        formView.innerHTML = `<p style="text-align: center; color: red;">An error occurred while fetching the request.</p>`;
    }
}

// NEW FUNCTION (MODIFIED)
async function submitTravelRequest() {
    const form = document.getElementById('travelRequestForm');
    const journeyRows = form.querySelectorAll('#journeyTable tbody tr');
    const journeyDetails = [];
    journeyRows.forEach(row => {
        journeyDetails.push({
            date: row.querySelector('.journeyDate').value,
            passengerName: row.querySelector('.passengerName').value,
            from: row.querySelector('.fromSector').value,
            to: row.querySelector('.toSector').value,
            age: row.querySelector('.passengerAge').value,
            class: row.querySelector('.passengerClass').value,
            flightNo: row.querySelector('.flightNo').value
        });
    });

    const formData = {
        company: form.querySelector('#company').value,
        date: form.querySelector('#date').value,
        purpose: form.querySelector('#purpose').value,
        applicant_sign: form.querySelector('#applicantSign').value,
        journey_details: journeyDetails
    };

    if (!formData.applicant_sign) {
        alert('Please provide your signature.');
        return;
    }

    try {
        const response = await fetch('/api/submit_travel_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });
        const result = await response.json();
        if (result.status === 'success') {
            alert('✅ Travel requisition submitted successfully!');
            loadPermissionsSection();
            // Refresh the view requests section to show the new request
            await refreshCurrentViewRequests();
        } else {
            alert('❌ Failed to submit travel request: ' + result.message);
        }
    } catch (error) {
        console.error('Error submitting travel request:', error);
        alert('An error occurred. Please try again.');
    }
}

async function handleAccountsView(viewType) {
    const container = document.getElementById('requestsDisplayContainer');
    if (!container) return;

    container.innerHTML = '<p style="text-align: center; color: #ccc;">Loading requests...</p>';

    try {
        let response;
        if (viewType === 'myRequests') {
            response = await fetch('/api/my_requests');
        } else if (viewType === 'pendingClaims') {
            response = await fetch('/api/accounts/conveyance_requests');
        } else if (viewType === 'seenClaims') {
            response = await fetch('/api/accounts/seen_conveyance_requests');
        } else {
            container.innerHTML = `<p style="text-align: center; color: #ccc;">Select an option above to view requests.</p>`;
            return;
        }

        const data = await response.json();
        if (data.status === 'success') {
            renderRequestsList(data.requests, container);
        } else {
            container.innerHTML = `<p style="text-align: center; color: red;">Failed to load requests.</p>`;
        }
    } catch (error) {
        console.error('Error fetching requests:', error);
        container.innerHTML = `<p style="text-align: center; color: red;">An error occurred while fetching requests.</p>`;
    }
}

// NEW function to submit the conveyance claim
async function submitConveyanceClaim() {
    const form = document.getElementById('conveyanceForm');
    const rows = form.querySelectorAll('#conveyanceTable tbody tr');
    const claimDetails = [];

    rows.forEach(row => {
        claimDetails.push({
            date: row.querySelector('.claimDate').value,
            from: row.querySelector('.claimFrom').value,
            to: row.querySelector('.claimTo').value,
            mode: row.querySelector('.claimMode').value,
            kms: row.querySelector('.claimKms').value,
            amount: row.querySelector('.claimAmount').value,
        });
    });

    const formData = {
        claim_details: claimDetails,
    };

    if (claimDetails.length === 0) {
        alert('Please add at least one claim item.');
        return;
    }

    try {
        const response = await fetch('/api/submit_conveyance_claim', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });
        const result = await response.json();
        if (result.status === 'success') {
            alert('✅ Conveyance claim submitted successfully!');
            loadPermissionsSection();
            // Refresh the view requests section to show the new request
            await refreshCurrentViewRequests();
        } else {
            alert('❌ Failed to submit claim: ' + result.message);
        }
    } catch (error) {
        console.error('Error submitting conveyance claim:', error);
        alert('An error occurred. Please try again.');
    }
}
// NEW function to render the full conveyance claim form
// This function renders an EXISTING conveyance claim, filling it with data
// and applying the correct disabled attributes based on status.
async function renderFullConveyanceForm(request) {
    const mainView = document.getElementById('attendanceMainView');
    const formView = document.getElementById('attendanceFormView');

    if (mainView) mainView.style.display = 'none';
    if (formView) formView.style.display = 'block';

    let userRoles = [];
    try {
        const roleResponse = await fetch('/api/user/roles');
        const roleData = await roleResponse.json();
        if (roleData.status === 'success') {
            userRoles = roleData.roles;
        }
    } catch (error) {
        console.error('Error fetching user roles:', error);
    }
    
    const isHR = userRoles.includes('HR');
    const isAccounts = userRoles.includes('Accounts');
    
    let claimHtml = request.claim_details.map(item => `
        <tr>
            <td><input type="date" value="${item.date || ''}" disabled readonly></td>
            <td><input type="text" value="${item.from || ''}" disabled readonly></td>
            <td><input type="text" value="${item.to || ''}" disabled readonly></td>
            <td><input type="text" value="${item.mode || ''}" disabled readonly></td>
            <td><input type="number" value="${item.kms || ''}" disabled readonly></td>
            <td><input type="number" value="${item.amount || ''}" disabled readonly></td>
        </tr>
    `).join('');

    const hrStatusClass = (request.status_hr || 'pending').toLowerCase().replace(/ /g, '-');
    const accountsStatusClass = (request.status_accounts || 'pending').toLowerCase().replace(/ /g, '-');

    const showMarkAsSeenButton = (isHR && (request.status_hr === 'Pending' || request.status_hr === 'Pending HR')) || (isAccounts && (request.status_accounts === 'Pending' || request.status_accounts === 'Pending Accounts'));

    let markAsSeenButtonHtml = '';
    if (showMarkAsSeenButton) {
        let roleToMark = isHR ? 'hr' : 'accounts';
        markAsSeenButtonHtml = `
        <div class="form-actions">
            <button type="button" class="form-btn btn-submit" onclick="markClaimAsSeen(${request.id}, '${roleToMark}')">Mark as Seen</button>
        </div>`;
    }

    formView.innerHTML = `
        <style>
            .form-container{max-width:100%; margin:0 auto; background:rgba(0,0,0,0.4); border:1px solid rgba(0,209,255,0.3); border-radius:15px; padding:30px;}
            .form-header{text-align:center; margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.2);}
            .form-header img{max-width:150px; margin-bottom:10px;}
            .form-header h3{color:#00d1ff; font-weight:bold; margin:5px 0;}
            .form-table{width:100%; border-collapse:collapse; margin-top:20px;}
            .form-table th, .form-table td{border:1px solid rgba(255,255,255,0.3); padding:12px; text-align:left; vertical-align:middle;}
            .form-table input, .form-table textarea, .form-table select {width:100%; padding:8px; background:rgba(0,0,0,0.5); border:1px solid #555; border-radius:4px; color:#fff; font-size:14px;}
            .form-actions{display:flex; justify-content:flex-end; gap:15px; margin-top:30px;}
            .form-btn{padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; color:white; text-align:center;}
            .btn-submit{background:linear-gradient(135deg,#28a745 0%,#218838 100%);}
            .btn-back{background:#6c757d;}
            input[type="time"]::-webkit-calendar-picker-indicator,
            input[type="date"]::-webkit-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-webkit-calendar-picker-indicator:hover,
            input[type="date"]::-webkit-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
            input[type="time"]::-moz-calendar-picker-indicator,
            input[type="date"]::-moz-calendar-picker-indicator {filter: invert(1); cursor: pointer;}
            input[type="time"]::-moz-calendar-picker-indicator:hover,
            input[type="date"]::-moz-calendar-picker-indicator:hover {filter: invert(1) brightness(1.2);}
        </style>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0;">Local Conveyance Claim (#${request.id})</h2>
            <button type="button" class="form-btn btn-back" onclick="loadPermissionsSection()">← Back</button>
        </div>
        <div class="form-container">
            <div class="form-header">
                <img src="/static/images/logo.png" alt="SSEV Logo">
                <h3>SS ENERGY VENTURES PRIVATE LIMITED</h3>
                <h3 style="text-align:center; margin-top:20px;">LOCAL CONVEYANCE CLAIM FORM</h3>
                <p>
                    <strong>HR Status:</strong> <span class="status status-${hrStatusClass}">${request.status_hr}</span><br>
                    <strong>Accounts Status:</strong> <span class="status status-${accountsStatusClass}">${request.status_accounts}</span>
                </p>
            </div>
            <form id="conveyanceApprovalForm">
                <table class="form-table">
                    <thead>
                        <tr>
                            <th>DATE</th>
                            <th>FROM</th>
                            <th>TO</th>
                            <th>MODE</th>
                            <th>KMS</th>
                            <th>AMOUNT</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${claimHtml}
                    </tbody>
                </table>
            </form>
            ${markAsSeenButtonHtml}
        </div>
    `;
}
// NEW function to mark the claim as seen by HR/Accounts
async function markClaimAsSeen(requestId) {
    let roleType = '';
    const roles = await (await fetch('/api/user/roles')).json();
    if (roles.roles.includes('HR')) {
        roleType = 'hr';
    } else if (roles.roles.includes('Accounts')) {
        roleType = 'accounts';
    }

    if (!roleType) {
        alert('You do not have permission to perform this action.');
        return;
    }

    try {
        const response = await fetch(`/api/mark_conveyance_claim_seen/${requestId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: roleType }),
        });
        const result = await response.json();

        if (result.status === 'success') {
            alert('✅ Claim marked as seen successfully!');
            loadPermissionsSection();
        } else {
            alert('❌ Failed to mark claim as seen: ' + result.message);
        }
    } catch (error) {
        console.error('Error marking claim as seen:', error);
        alert('An error occurred. Please try again.');
    }
}





























      // ==================================================================
      // 3. ASSETS & INDENTS MODULE
      // ==================================================================
      function loadIndentsSection() {
        const container = document.getElementById('assets');
        if (!container) return;
        container.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                <h2 style="margin:0;">My Asset Requests (Indents)</h2>
            </div>
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button onclick="loadNewIndentForm()" class="add-button">+ New Asset Request</button>
                <button onclick="downloadIndentsCSV()" class="download-btn" style="background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">📥 Download Indents</button>
            </div>
            <div class="assets-table-container" style="margin-top: 40px; overflow-x: auto;">
                <table class="assets-table" style="width: 100%; border-collapse: collapse; text-align: center;">
                    <thead>
                        <tr style="background-color: rgba(255,255,255,0.1);">
                            <th style="padding: 12px;">ID</th><th style="padding: 12px;">Date</th><th style="padding: 12px;">Status</th><th style="padding: 12px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="indentsTableBody"></tbody>
                </table>
            </div>
        `;
        fetchIndentsForTable();
      }


      // ================================================================
      // END: PASTED CONTENT FROM scripts.js
      // ================================================================

      // --- UTILITY AND ONLOAD ---
      function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        const dateString = now.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const clockEl = document.getElementById("liveClock");
        if (clockEl) clockEl.textContent = timeString;
        const dateEl = document.getElementById("todayDate");
        if (dateEl) dateEl.textContent = dateString;
    }
    // Clock initialization moved to DOMContentLoaded event listener

    async function loadPendingIndents() {
    const container = document.getElementById('pendingIndentsContainer');
    if (!container) return;
    
    container.innerHTML = '<p style="text-align:center; color: #ccc;">Loading your pending requests...</p>';
    
    try {
        console.log('Fetching pending indents...');
        const response = await fetch('/api/my_pending_indents');
        const result = await response.json();
        
        console.log('Pending indents response:', result);
        
        if (result.status === 'success') {
            if (result.requests.length === 0) {
                container.innerHTML = `<p style="text-align:center; color: #ccc;">You have no pending indent requests to review.</p>`;
            } else {
                let html = '<h3>New Indent Requests for Your Approval</h3>';
                result.requests.forEach(req => {
                    html += `
                        <div class="task-item">
                            <div class="task-title">Indent Request #${req.id}</div>
                            <div class="task-details">
                                <p><strong>Submitted by:</strong> ${req.indenter_name}</p>
                                <p><strong>Date:</strong> ${req.request_date}</p>
                                <p><strong>Status:</strong> ${req.status}</p>
                            </div>
                            <button onclick="openIndentForm(${req.id})" class="add-button" style="margin-top:10px;">Review Request</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        } else {
            container.innerHTML = `<p style="text-align:center; color:red;">Failed to load notifications: ${result.message}</p>`;
        }
    } catch (error) {
        console.error('Error fetching pending indents:', error);
        container.innerHTML = `<p style="text-align:center; color:red;">An error occurred while fetching notifications.</p>`;
    }
}

      // Clock initialization moved to DOMContentLoaded event listener

      document.addEventListener('DOMContentLoaded', function () {
        populateSidebar();
        getCurrentUserId(); // Call the new function here
        loadSavedSettings(); // Load saved settings
        calculateTotals(); // Initialize totals calculation
        
        // Initialize clock
        setInterval(updateClock, 1000);
        updateClock();
        
        setTimeout(() => {
          showDashboardAnnouncements();
        }, 1000);
      });

      function loadAssetsMenu() {
    const assetsContainer = document.getElementById('assets');
    if (!assetsContainer) return;
    assetsContainer.innerHTML = `
        <h2 style="margin-bottom: 20px;">Assets Management</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div onclick="loadAssetList()" style="cursor: pointer; background-color: rgba(0, 0, 0, 0.4); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 209, 255, 0.3);">
                <div style="font-size: 3rem; margin-bottom: 15px;">📦</div>
                <h3>Assets</h3><p style="color: #ccc;">Click to manage assets.</p>
            </div>
            <div onclick="loadIndentsSection()" style="cursor: pointer; background-color: rgba(0, 0, 0, 0.4); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 209, 255, 0.3);">
                <div style="font-size: 3rem; margin-bottom: 15px;">📝</div>
                <h3>Indents</h3><p style="color: #ccc;">Click to manage indents.</p>
            </div>
            <div onclick="loadRequestsSection()" style="cursor: pointer; background-color: rgba(0, 0, 0, 0.4); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 209, 255, 0.3);">
                <div style="font-size: 3rem; margin-bottom: 15px;">📋</div>
                <h3>Requests</h3><p style="color: #ccc;">Click to view all requests.</p>
            </div>
            <div onclick="loadNotificationsSection()" style="cursor: pointer; background-color: rgba(0, 0, 0, 0.4); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 209, 255, 0.3);">
                <div style="font-size: 3rem; margin-bottom: 15px;">🔔</div>
                <h3>Notifications</h3><p style="color: #ccc;">Click to manage notifications.</p>
            </div>
        </div>
        <div id="assetsSubContent" style="margin-top: 30px;"></div>
    `;
}


      // ADD THESE FUNCTIONS FOR THE NEW ASSETS MENU

      function loadAssetList() {
        const container = document.getElementById('assets') || document.getElementById('assetsSubContent');
        container.innerHTML = `
        <button onclick="loadAssetsMenu()" class="back-button">← Back to Assets Management</button>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin-bottom:0;">Assets List</h2>
            <button onclick="showAddAssetForm()" class="add-button">+ Add New Asset</button>
        </div>
        <div class="search-bar-container">
            <input type="text" id="assetSearch" placeholder="Search for assets by name or tag..." oninput="filterAssets()">
            <button class="filter-button" onclick="toggleFilters()">Filters ▼</button>
        </div>
        <div id="filterOptions" class="filter-options" style="display: none;">
            <div class="filter-dropdown">
                <label for="assignedToFilter">Assigned to:</label>
                <select id="assignedToFilter" onchange="applyFilters()">
                    <option value="">All</option>
                </select>
            </div>
            <div class="filter-dropdown">
                <label for="purchasedFromFilter">Purchased from:</label>
                <select id="purchasedFromFilter" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="Amazon">Amazon</option>
                    <option value="Flipkart">Flipkart</option>
                    <option value="Local Store">Local Store</option>
                    <option value="Direct Purchase">Direct Purchase</option>
                </select>
            </div>
            <div class="filter-dropdown">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Maintenance">Maintenance</option>
                </select>
            </div>
        </div>
        <div id="assetsListContainer" class="assets-list-container">
            <p style="text-align:center; color: #ccc;">Loading assets...</p>
        </div>
    `;
        fetchAssets();
        populateAssetOwnerDropdown();
        populateFilterDropdowns();
      }

      function loadRequestsSection() {
    const container = document.getElementById('assets') || document.getElementById('assetsSubContent');
    container.innerHTML = `
        <button onclick="loadAssetsMenu()" class="back-button">← Back to Assets Management</button>
        <h2>📋 My Approved Requests</h2>
        <div style="margin-bottom: 20px;">
            <button onclick="refreshAllRequests()" class="add-button" style="background-color: #28a745;">🔄 Refresh</button>
            <button onclick="exportAllRequests()" class="add-button" style="background-color: #17a2b8; margin-left: 10px;">📥 Export</button>
        </div>
        <div style="margin-bottom: 20px;">
            <div class="search-bar-container">
                <input type="text" id="requestSearch" placeholder="Search my approved requests..." oninput="filterRequests()" style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white;">
            </div>
        </div>
        <div id="allRequestsContainer">
            <p style="text-align:center; color: #ccc;">Loading all requests...</p>
        </div>
    `;
    loadAllRequests();
}

      function loadNotificationsSection() {
    const container = document.getElementById('assets') || document.getElementById('assetsSubContent');
    container.innerHTML = `
        <button onclick="loadAssetsMenu()" class="back-button">← Back to Assets Management</button>
        <h2>🔔 Notifications</h2>
        <div style="margin-bottom: 20px;">
            <button onclick="debugAllIndents()" class="add-button" style="background-color: #ff6b6b;">🐛 Debug All Indents</button>
            <button onclick="debugUserInfo()" class="add-button" style="background-color: #4ecdc4; margin-left: 10px;">👤 Debug User Info</button>
        </div>
        <div id="pendingIndentsContainer">
            <p style="text-align:center; color: #ccc;">Loading your pending requests...</p>
        </div>
    `;
    loadPendingIndents();
}

// Global variable to store all requests
let allRequestsData = [];

async function loadAllRequests() {
    try {
        const response = await fetch('/api/my_approved_requests');
        const data = await response.json();
        
        if (data.status === 'success') {
            allRequestsData = data.requests || [];
            displayAllRequests(allRequestsData);
        } else {
            document.getElementById('allRequestsContainer').innerHTML = `
                <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                    <p>❌ Error loading requests: ${data.message}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading all requests:', error);
        document.getElementById('allRequestsContainer').innerHTML = `
            <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                <p>❌ Error loading requests. Please try again.</p>
            </div>
        `;
    }
}

async function displayAllRequests(requests) {
    const container = document.getElementById('allRequestsContainer');
    
    if (!requests || requests.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: #ccc; padding: 40px;">
                <div style="font-size: 3rem; margin-bottom: 15px;">📋</div>
                <p>No requests found.</p>
            </div>
        `;
        return;
    }
    
    // Get user roles to determine if user is procurement
    let userRoles = [];
    try {
        const response = await fetch('/api/user/roles');
        const data = await response.json();
        userRoles = data.roles || [];
    } catch (error) {
        console.error('Error fetching user roles:', error);
    }
    
    const isProcurement = userRoles.includes('Procurement');
    
    // Create table header
    const tableHtml = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: rgba(0, 0, 0, 0.2); border-radius: 8px; overflow: hidden;">
                <thead>
                    <tr style="background: rgba(0, 209, 255, 0.2);">
                        <th style="padding: 15px; border: 1px solid #444; color: #00d1ff; text-align: left;">Request No</th>
                        <th style="padding: 15px; border: 1px solid #444; color: #00d1ff; text-align: left;">Indenter Name</th>
                        <th style="padding: 15px; border: 1px solid #444; color: #00d1ff; text-align: left;">Created Date</th>
                        <th style="padding: 15px; border: 1px solid #444; color: #00d1ff; text-align: left;">Status</th>
                        <th style="padding: 15px; border: 1px solid #444; color: #00d1ff; text-align: left;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${requests.map(request => {
                        const statusColor = getStatusColor(request.status);
                        const dateObj = request.request_date ? new Date(request.request_date) : new Date();
                        const createdDate = isNaN(dateObj.getTime()) ? 'Invalid Date' : dateObj.toLocaleDateString();
                        const createdTime = isNaN(dateObj.getTime()) ? 'Invalid Time' : dateObj.toLocaleTimeString();
                        
                        return `
                            <tr style="border-bottom: 1px solid #444;">
                                <td style="padding: 15px; border: 1px solid #444; color: #00d1ff; font-weight: bold;">#${request.id}</td>
                                <td style="padding: 15px; border: 1px solid #444; color: #fff;">${request.indenter_name || 'N/A'}</td>
                                <td style="padding: 15px; border: 1px solid #444; color: #fff;">${createdDate} ${createdTime}</td>
                                <td style="padding: 15px; border: 1px solid #444;">
                                    <span style="background: ${statusColor}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                                        ${request.status}
                                    </span>
                                </td>
                                <td style="padding: 15px; border: 1px solid #444;">
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="viewRequestDetails(${request.id})" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            👁️ View
                                        </button>
                                        ${isProcurement ? `
                                            <button onclick="downloadRequest(${request.id})" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                                📥 Download
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = tableHtml;
}

// Function to download request details
async function downloadRequest(requestId) {
    try {
        const response = await fetch(`/api/asset_requests/${requestId}/download`);
        if (!response.ok) {
            throw new Error('Failed to download request');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `request_${requestId}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error downloading request:', error);
        alert('Failed to download request. Please try again.');
    }
}

function getStatusColor(status) {
    const statusColors = {
        'Pending TL Approval': '#ffc107',
        'Pending Procurement Approval': '#17a2b8',
        'Pending TL Final Approval': '#ffc107',
        'Pending Director Approval': '#6f42c1',
        'Pending Managing Director Approval': '#dc3545',
        'Pending Procurement Type Approval': '#17a2b8',
        'Pending Procurement Final Approval': '#17a2b8',
        'Pending Accounts Approval': '#28a745',
        'Pending Final Delivery': '#fd7e14',
        'Completed': '#28a745',
        'Rejected': '#dc3545'
    };
    return statusColors[status] || '#6c757d';
}

function filterRequests() {
    const searchTerm = document.getElementById('requestSearch').value.toLowerCase();
    
    let filteredRequests = allRequestsData.filter(request => {
        const matchesSearch = !searchTerm || 
            (request.indenter_name && request.indenter_name.toLowerCase().includes(searchTerm)) ||
            (request.item_details && request.item_details.some(item => 
                item.itemName && item.itemName.toLowerCase().includes(searchTerm)
            ));
        
        return matchesSearch;
    });
    
    displayAllRequests(filteredRequests);
}

function refreshAllRequests() {
    document.getElementById('allRequestsContainer').innerHTML = '<p style="text-align:center; color: #ccc;">Loading all requests...</p>';
    loadAllRequests();
}

function exportAllRequests() {
    if (allRequestsData.length === 0) {
        alert('No requests to export.');
        return;
    }
    
    const csvContent = generateRequestsCSV(allRequestsData);
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `all_requests_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function generateRequestsCSV(requests) {
    const headers = ['ID', 'Indenter', 'Status', 'Created Date', 'Items', 'Total Cost'];
    const rows = requests.map(request => {
        const items = request.item_details ? request.item_details.map(item => item.itemName).join('; ') : 'N/A';
        const totalCost = request.item_details ? request.item_details.reduce((sum, item) => sum + (parseFloat(item.totalCost) || 0), 0) : 0;
        return [
            request.id,
            request.indenter_name || 'N/A',
            request.status,
            request.request_date ? (isNaN(new Date(request.request_date).getTime()) ? 'Invalid Date' : new Date(request.request_date).toLocaleDateString()) : 'N/A',
            items,
            totalCost
        ];
    });
    
    return [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
}

async function viewRequestDetails(requestId) {
    try {
        console.log('Fetching request details for ID:', requestId);
        // Fetch complete request data from API
        const response = await fetch(`/api/asset_requests/${requestId}`);
        if (!response.ok) {
            console.error('Response not ok:', response.status, response.statusText);
            alert('Failed to fetch request details.');
            return;
        }
        
        const result = await response.json();
        console.log('API Response:', result);
        
        if (result.status !== 'success') {
            console.error('API returned error:', result.message);
            alert('Request not found.');
            return;
        }
        
        const request = result.request;
        console.log('Request data:', request);
        
        // Display the full Purchase Indent Form in read-only mode
        displayFullIndentForm(request, true); // true = read-only mode
    } catch (error) {
        console.error('Error fetching request details:', error);
        alert('An error occurred while fetching request details.');
    }
}

// Function to display the full Purchase Indent Form
function displayFullIndentForm(request, isReadOnly = false) {
    console.log('displayFullIndentForm called with:', request, 'isReadOnly:', isReadOnly);
    
    const container = document.getElementById('assets') || document.getElementById('assetsSubContent');
    console.log('Container found:', container);
    
    const readOnlyAttr = isReadOnly ? 'readonly disabled' : '';
    const readOnlyStyle = isReadOnly ? 'background: #2a2a2a; color: #ccc; cursor: not-allowed;' : '';
    
    // Calculate grand total from item details
    let grandTotal = 0;
    if (request.item_details && request.item_details.length > 0) {
        grandTotal = request.item_details.reduce((total, item) => {
            // Use the total field if available, otherwise calculate from cost, qty, and tax
            if (item.total) {
                return total + parseFloat(item.total);
            } else {
                const cost = parseFloat(item.tentativeCost || item.cost) || 0;
                const qty = parseFloat(item.qty || item.quantity) || 0;
                const tax = parseFloat(item.tax) || 0;
                const itemTotal = cost * qty * (1 + tax / 100);
                return total + itemTotal;
            }
        }, 0);
    }
        
        // Calculate totals for step 2
        console.log('Calculating grandTotalStep2...');
        let grandTotalStep2 = 0;
        if (request.item_details && request.item_details.length > 0) {
            console.log('Item details found:', request.item_details);
            grandTotalStep2 = request.item_details.reduce((total, item) => {
            if (item.total) {
                return total + parseFloat(item.total);
            } else {
                const cost = parseFloat(item.tentativeCost || item.cost) || 0;
                const qty = parseFloat(item.qty || item.quantity) || 0;
                const tax = parseFloat(item.tax) || 0;
                const itemTotal = cost * qty * (1 + tax / 100);
                return total + itemTotal;
            }
        }, 0);
        console.log('grandTotalStep2 calculated:', grandTotalStep2);
    }
    
    const formHtml = `
        <button onclick="loadRequestsSection()" class="back-button">← Back to Requests</button>
        <div class="indent-form-container" style="max-width: 100%; margin: 0 auto; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 10px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #00d1ff; margin: 0;">PURCHASE INDENT FORM (ID: ${request.id || 'New'})</h1>
                <p style="color: #ccc; margin: 5px 0;">Status: ${request.status || 'new'}</p>
            </div>

            <!-- Indenter's Details Section -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Indenter's Details</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Name & Designation</label>
                        <input type="text" value="${request.indenter_name || request.name || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Office/Project</label>
                        <select ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                            <option value="">Select</option>
                            <option value="${request.office_project_type || ''}" selected>${request.office_project_type || 'Select'}</option>
                        </select>
                    </div>
                    ${request.office_project_type === 'Project' ? `
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Project No & Title</label>
                        <select ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                            <option value="">Select</option>
                            <option value="${request.project_name || ''}" selected>${request.project_name || 'Select'}</option>
                        </select>
                    </div>
                    ` : ''}
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Select Team Lead</label>
                        <select ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                            <option value="">-- Choose a Team Lead --</option>
                            <option value="${request.team_lead_name || ''}" selected>${request.team_lead_name || '-- Choose a Team Lead --'}</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Reference File No</label>
                        <input type="text" value="${request.reference_file_no || request.reference_file || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Type of Purchase</label>
                        <select ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                            <option value="">Select</option>
                            <option value="${request.purchase_type || ''}" selected>${request.purchase_type || 'Select'}</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Budget Head</label>
                        <select ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                            <option value="">Select</option>
                            <option value="${request.budget_head || ''}" selected>${request.budget_head || 'Select'}</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Nature of Expenditure</label>
                        <select ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                            <option value="">Select</option>
                            <option value="${request.nature_of_expenditure || ''}" selected>${request.nature_of_expenditure || 'Select'}</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">GST Applicability</label>
                        <select ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                            <option value="">Select</option>
                            <option value="${request.gst_applicable || ''}" selected>${request.gst_applicable || 'Select'}</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Details of the Item Being Demanded Section -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Details of the Item Being Demanded</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: rgba(0, 0, 0, 0.2);">
                        <thead>
                            <tr style="background: rgba(0, 209, 255, 0.2);">
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">S.No</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Name of the Item</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Preferred Brand</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Supplier/Vendor</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Tentative Cost (Rs)</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Qty</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Tax (%)</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Total (with tax)</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Required by</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Warranty</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${request.item_details ? request.item_details.map((item, index) => `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #444; color: #ccc;">${index + 1}</td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.itemName || item.itemName || item.item_name || item.name || ''}" ${readOnlyAttr} placeholder="Item Name" style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.brand || item.preferred_brand || ''}" ${readOnlyAttr} placeholder="Brand" style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.vendor || item.supplier || item.supplier_vendor || ''}" ${readOnlyAttr} placeholder="Vendor" style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.tentativeCost || item.cost || item.tentative_cost || item.price || ''}" ${readOnlyAttr} placeholder="Cost" style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.qty || item.quantity || ''}" ${readOnlyAttr} placeholder="Qty" style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.tax || item.tax_percentage || '0'}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.total || item.total_amount || '0'}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="date" value="${item.requiredBy || item.required_by || item.required_date || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.warranty || item.warranty_period || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.remarks || item.notes || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="11" style="padding: 20px; text-align: center; color: #ccc;">No items specified</td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <button ${readOnlyAttr} style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; ${readOnlyStyle}">+ ADD ROW</button>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label style="color: #ccc;">Discount:</label>
                                        <input type="number" id="discountAmount" value="${request.discount_amount || request.discountAmount || 0}" ${readOnlyAttr} style="width: 100px; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}" oninput="calculateGrandTotal()">
                                        <span style="color: #ccc;">₹</span>
                                    </div>
                                    <div style="background: #28a745; color: white; padding: 10px 20px; border-radius: 5px;">
                                        <div>Subtotal: ₹${grandTotal.toFixed(2)}</div>
                                        <div id="discountDisplay" style="color: #ff6b6b;">Discount: -₹${(request.discount_amount || request.discountAmount || 0).toFixed(2)}</div>
                                        <div id="finalTotalDisplay" style="font-weight: bold;">Grand Total: ₹${(grandTotal - (request.discount_amount || request.discountAmount || 0)).toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>
            </div>

            <!-- Teamleader - Justification of Procurement Section -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Teamleader - Justification of Procurement</h3>
                <textarea ${readOnlyAttr} placeholder="Enter justification here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; resize: vertical; ${readOnlyStyle}">${request.teamlead_justification || request.justification || request.teamlead_justification_text || ''}</textarea>
            </div>

            <!-- Procurement Section -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Procurement Section</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: rgba(0, 0, 0, 0.2);">
                        <thead>
                            <tr style="background: rgba(0, 209, 255, 0.2);">
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">S.No</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Name of Item</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Name of Vendor</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Vendor Address</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Cost</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Contact No.</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Mail ID</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">EDD</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Vendor GST</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Quote</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${request.procurement_items && request.procurement_items.length > 0 ? request.procurement_items.map((item, index) => `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #444; color: #ccc;">${index + 1}</td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.itemName || item.item_name || item.name || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.vendorName || item.vendor_name || item.vendor || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.vendorAddress || item.vendor_address || item.address || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.cost || item.price || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.contactNo || item.contact_no || item.contact || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.mailld || item.mail_id || item.email || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.edd || item.expected_delivery_date || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.vendorGst || item.vendor_gst || item.gst || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.quote || item.quotation || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <button ${readOnlyAttr} style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; ${readOnlyStyle}">Remove</button>
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="11" style="padding: 20px; text-align: center; color: #ccc;">No procurement details added.</td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
                <button ${readOnlyAttr} style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; ${readOnlyStyle}">+ ADD ROW</button>
            </div>

            <!-- Teamlead Final Approval Section -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Teamlead Final Approval</h3>
                <div style="margin-bottom: 15px;">
                    <label style="color: #ccc; display: block; margin-bottom: 5px;">Approval of Procurement:</label>
                    <textarea ${readOnlyAttr} placeholder="Enter approval details..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; resize: vertical; ${readOnlyStyle}">${request.teamlead_approval || request.teamlead_final_approval || request.approval_details || ''}</textarea>
                </div>
                <div>
                    <label style="color: #ccc; display: block; margin-bottom: 5px;">Finalized Vendor:</label>
                    <input type="text" value="${request.finalized_vendor || request.final_vendor || request.selected_vendor || ''}" ${readOnlyAttr} placeholder="Enter finalized vendor" style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                </div>
            </div>

            <!-- Approval Section (Director) -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Approval Section (Director)</h3>
                <div style="margin-bottom: 15px;">
                    <label style="color: #ccc; display: block; margin-bottom: 10px;">Approval Level:</label>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.director_approval_pi || request.director_pi_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            PI (Up to Rs. 5 Lakh)
                        </label>
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.director_approval_pd || request.director_pd_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            Project Director (Up to Rs. 50 Lac)
                        </label>
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.director_approval_chairman || request.director_chairman_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            Chairman (Full Power)
                        </label>
                    </div>
                </div>
                <div>
                    <label style="color: #ccc; display: block; margin-bottom: 5px;">Director Comments:</label>
                    <textarea ${readOnlyAttr} placeholder="Director Comments" style="width: 100%; height: 80px; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; resize: vertical; ${readOnlyStyle}">${request.director_comments || request.director_remarks || ''}</textarea>
                </div>
            </div>

            <!-- Approval Section (MD) -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Approval Section (MD)</h3>
                <div style="margin-bottom: 15px;">
                    <label style="color: #ccc; display: block; margin-bottom: 10px;">Approval Level:</label>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.md_approval_pi || request.md_pi_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            PI (Up to Rs. 5 Lakh)
                        </label>
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.md_approval_pd || request.md_pd_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            Project Director (Up to Rs. 50 Lac)
                        </label>
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.md_approval_chairman || request.md_chairman_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            Chairman (Full Power)
                        </label>
                    </div>
                </div>
                <div>
                    <label style="color: #ccc; display: block; margin-bottom: 5px;">Chairman Comments:</label>
                    <textarea ${readOnlyAttr} placeholder="Chairman Comments" style="width: 100%; height: 80px; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; resize: vertical; ${readOnlyStyle}">${request.chairman_comments || request.md_comments || request.managing_director_comments || ''}</textarea>
                </div>
            </div>

            <!-- Type of Procurement -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Type of Procurement</h3>
                <div>
                    <label style="color: #ccc; display: block; margin-bottom: 5px;">Type of Procurement:</label>
                    <select ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                        <option value="" ${!request.procurement_type ? 'selected' : ''}>Select</option>
                        <option value="COD" ${request.procurement_type === 'COD' ? 'selected' : ''}>COD</option>
                        <option value="Cheque" ${request.procurement_type === 'Cheque' ? 'selected' : ''}>Cheque</option>
                        <option value="Bank Transfers" ${request.procurement_type === 'Bank Transfers' ? 'selected' : ''}>Bank Transfers</option>
                        <option value="Card Payments" ${request.procurement_type === 'Card Payments' ? 'selected' : ''}>Card Payments</option>
                    </select>
                </div>
            </div>

            <!-- Accounts Section (Filled by Admin) -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Accounts Section (Filled by Admin)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Budget allocation:</label>
                        <input type="text" value="${request.budget_allocation || request.budget_allocated || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Budget utilized:</label>
                        <input type="text" value="${request.budget_utilized || request.budget_used || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Available balance:</label>
                        <input type="text" value="${request.available_balance || request.balance_available || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Funds available?</label>
                        <select ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                            <option value="">Select</option>
                            <option value="${request.funds_available || request.funds_available_status || ''}" selected>${request.funds_available || request.funds_available_status || 'Select'}</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Account No:</label>
                        <input type="text" value="${request.account_no || request.account_number || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">IFSC Code:</label>
                        <input type="text" value="${request.ifsc_code || request.ifsc || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Branch Name:</label>
                        <input type="text" value="${request.branch_name || request.branch || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Account Holder Name:</label>
                        <input type="text" value="${request.account_holder_name || request.account_holder || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Remarks:</label>
                        <textarea ${readOnlyAttr} placeholder="Enter remarks..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; resize: vertical; ${readOnlyStyle}">${request.accounts_remarks || ''}</textarea>
                    </div>
                </div>
            </div>

            <!-- Final Delivery Section -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Final Delivery Section</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Handed Over To:</label>
                        <input type="text" value="${request.handed_over_to || request.handover_to || request.delivered_to || ''}" ${readOnlyAttr} style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                    <div>
                        <label style="color: #ccc; display: block; margin-bottom: 5px;">Received on date:</label>
                        <input type="text" value="${request.received_date || request.delivery_date || request.received_on || ''}" ${readOnlyAttr} placeholder="dd/mm/yyyy" style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                    </div>
                </div>
            </div>

            <!-- Teamleader - Justification of Procurement Section -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Teamleader - Justification of Procurement</h3>
                <textarea ${readOnlyAttr} placeholder="Enter justification here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; resize: vertical; ${readOnlyStyle}">${request.teamlead_justification || request.justification || request.teamlead_justification_text || ''}</textarea>
            </div>

            <!-- Procurement Section -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Procurement Section</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: rgba(0, 0, 0, 0.2);">
                        <thead>
                            <tr style="background: rgba(0, 209, 255, 0.2);">
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">S.No</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Name of Item</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Name of Vendor</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Vendor Address</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Cost</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Contact No.</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Mail ID</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">EDD</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Vendor GST</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Quote</th>
                                <th style="padding: 10px; border: 1px solid #444; color: #00d1ff;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${request.procurement_items && request.procurement_items.length > 0 ? request.procurement_items.map((item, index) => `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #444; color: #ccc;">${index + 1}</td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.itemName || item.item_name || item.name || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.vendorName || item.vendor_name || item.vendor || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.vendorAddress || item.vendor_address || item.address || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.cost || item.price || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.contactNo || item.contact_no || item.contact || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.mailld || item.mail_id || item.email || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.edd || item.expected_delivery_date || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.vendorGst || item.vendor_gst || item.gst || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <input type="text" value="${item.quote || item.quotation || ''}" ${readOnlyAttr} style="width: 100%; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white; ${readOnlyStyle}">
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #444;">
                                        <button ${readOnlyAttr} style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; ${readOnlyStyle}">Remove</button>
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="11" style="padding: 20px; text-align: center; color: #ccc;">No procurement details added.</td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
                <button ${readOnlyAttr} style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; ${readOnlyStyle}">+ ADD ROW</button>
            </div>

            <!-- Teamlead Final Approval Section -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Teamlead Final Approval</h3>
                <div style="margin-bottom: 15px;">
                    <label style="color: #ccc; display: block; margin-bottom: 5px;">Approval of Procurement:</label>
                    <textarea ${readOnlyAttr} placeholder="Enter approval details..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; resize: vertical; ${readOnlyStyle}">${request.teamlead_approval || request.teamlead_final_approval || request.approval_procurement || request.approval_details || ''}</textarea>
                </div>
                <div>
                    <label style="color: #ccc; display: block; margin-bottom: 5px;">Finalized Vendor:</label>
                    <input type="text" value="${request.finalized_vendor || request.final_vendor || request.selected_vendor || ''}" ${readOnlyAttr} placeholder="Enter finalized vendor" style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; ${readOnlyStyle}">
                </div>
            </div>

            <!-- Approval Section (Director) -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Approval Section (Director)</h3>
                <div style="margin-bottom: 15px;">
                    <label style="color: #ccc; display: block; margin-bottom: 10px;">Approval Level:</label>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.director_approval_pi || request.director_pi_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            PI (Up to Rs. 5 Lakh)
                        </label>
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.director_approval_pd || request.director_pd_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            Project Director (Up to Rs. 50 Lac)
                        </label>
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.director_approval_chairman || request.director_chairman_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            Chairman (Full Power)
                        </label>
                    </div>
                </div>
                <div>
                    <label style="color: #ccc; display: block; margin-bottom: 5px;">Comments:</label>
                    <textarea ${readOnlyAttr} placeholder="Enter comments..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; resize: vertical; ${readOnlyStyle}">${request.director_comments || request.director_approval_comments || ''}</textarea>
                </div>
            </div>

            <!-- Approval Section (Managing Director) -->
            <div style="background: rgba(0, 209, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #00d1ff; margin-bottom: 15px;">Approval Section (Managing Director)</h3>
                <div style="margin-bottom: 15px;">
                    <label style="color: #ccc; display: block; margin-bottom: 10px;">Approval Level:</label>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.pi_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            PI (Up to Rs. 5 Lakh)
                        </label>
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.pd_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            Project Director (Up to Rs. 50 Lac)
                        </label>
                        <label style="color: #ccc; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${request.chairman_approval ? 'checked' : ''} ${readOnlyAttr} style="transform: scale(1.2); ${readOnlyStyle}">
                            Chairman (Full Power)
                        </label>
                    </div>
                </div>
                <div>
                    <label style="color: #ccc; display: block; margin-bottom: 5px;">Comments:</label>
                    <textarea ${readOnlyAttr} placeholder="Enter comments..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; resize: vertical; ${readOnlyStyle}">${request.chairman_comments || request.managing_director_comments || ''}</textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #444;">
                <button onclick="loadRequestsSection()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer;">Previous</button>
                ${!isReadOnly ? '<button style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer;">Submit</button>' : ''}
            </div>
        </div>
    `;
    
    console.log('Setting container innerHTML...');
    container.innerHTML = formHtml;
    console.log('displayFullIndentForm completed successfully');
}

async function debugAllIndents() {
    try {
        console.log('Fetching all indents for debugging...');
        const response = await fetch('/api/debug_all_indents');
        const result = await response.json();
        console.log('All indents:', result);
        
        if (result.status === 'success') {
            let html = '<h3>🐛 Debug: All Indents in Database</h3>';
            if (result.indents.length === 0) {
                html += '<p style="color: #ff6b6b;">No indents found in database!</p>';
            } else {
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                html += '<tr style="background: rgba(255,255,255,0.1);"><th style="padding: 10px; border: 1px solid #ccc;">ID</th><th style="padding: 10px; border: 1px solid #ccc;">Status</th><th style="padding: 10px; border: 1px solid #ccc;">Team Lead ID</th><th style="padding: 10px; border: 1px solid #ccc;">Indenter</th><th style="padding: 10px; border: 1px solid #ccc;">Date</th></tr>';
                result.indents.forEach(indent => {
                    html += `<tr><td style="padding: 10px; border: 1px solid #ccc;">${indent.id}</td><td style="padding: 10px; border: 1px solid #ccc;">${indent.status}</td><td style="padding: 10px; border: 1px solid #ccc;">${indent.team_lead_id}</td><td style="padding: 10px; border: 1px solid #ccc;">${indent.indenter_name}</td><td style="padding: 10px; border: 1px solid #ccc;">${indent.request_date}</td></tr>`;
                });
                html += '</table>';
            }
            document.getElementById('pendingIndentsContainer').innerHTML = html;
        } else {
            alert('Error fetching indents: ' + result.message);
        }
    } catch (error) {
        console.error('Error debugging indents:', error);
        alert('Error debugging indents: ' + error.message);
    }
}

async function debugUserInfo() {
    try {
        console.log('Fetching user info for debugging...');
        const response = await fetch('/api/debug_user_info');
        const result = await response.json();
        console.log('User info:', result);
        
        if (result.status === 'success') {
            let html = '<h3>👤 Debug: Current User Info</h3>';
            html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 10px;">';
            html += `<p><strong>User ID:</strong> ${result.user.id}</p>`;
            html += `<p><strong>Name:</strong> ${result.user.name}</p>`;
            html += `<p><strong>Email:</strong> ${result.user.email}</p>`;
            html += `<p><strong>Roles:</strong> ${result.user.roles.join(', ')}</p>`;
            html += '</div>';
            document.getElementById('pendingIndentsContainer').innerHTML = html;
        } else {
            alert('Error fetching user info: ' + result.message);
        }
    } catch (error) {
        console.error('Error debugging user info:', error);
        alert('Error debugging user info: ' + error.message);
    }
}

      // Ensure you also have these functions from dashboard.html, which are needed for the asset list to work
      let allAssets = []; // Make sure this is declared globally at the top of your script

      async function fetchAssets() {
    const assetsListContainer = document.getElementById('assetsListContainer');
    assetsListContainer.innerHTML = '<p style="text-align:center; color: #ccc;">Loading assets from Firebase...</p>';
    allAssets = [];
    try {
        const assetsCollection = dbAssets.collection('assigned_assets');
        const snapshot = await assetsCollection.get();
        if (snapshot.empty) {
            assetsListContainer.innerHTML = `<p style="text-align: center; color: #ccc;">No assets found.</p>`;
            return;
        }
        snapshot.forEach(doc => {
            allAssets.push({ id: doc.id, ...doc.data() });
        });
        renderAssets(allAssets);
    } catch (error) {
        console.error('Error fetching assets:', error);
        assetsListContainer.innerHTML = '<p style="text-align:center; color:red;">Failed to fetch assets.</p>';
    }
}

      function filterAssets() {
        const searchTerm = document.getElementById('assetSearch').value.toLowerCase();
        const filtered = allAssets.filter(asset =>
          (asset.assetName && asset.assetName.toLowerCase().includes(searchTerm)) ||
          (asset.serialNumber && asset.serialNumber.toLowerCase().includes(searchTerm))
        );
        renderAssets(filtered);
      }

      function toggleFilters() {
        const filterOptions = document.getElementById('filterOptions');
        const filterButton = document.querySelector('.filter-button');
        
        if (filterOptions.style.display === 'none') {
            filterOptions.style.display = 'block';
            filterButton.textContent = 'Filters ▲';
        } else {
            filterOptions.style.display = 'none';
            filterButton.textContent = 'Filters ▼';
        }
      }

      function applyFilters() {
        const searchTerm = document.getElementById('assetSearch').value.toLowerCase();
        const assignedToFilter = document.getElementById('assignedToFilter').value;
        const purchasedFromFilter = document.getElementById('purchasedFromFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        let filtered = allAssets.filter(asset => {
            // Search filter
            const matchesSearch = !searchTerm || 
                (asset.assetName && asset.assetName.toLowerCase().includes(searchTerm)) ||
                (asset.serialNumber && asset.serialNumber.toLowerCase().includes(searchTerm));

            // Assigned to filter
            const matchesAssignedTo = !assignedToFilter || 
                (asset.assignedTo && asset.assignedTo === assignedToFilter);

            // Purchased from filter
            const matchesPurchasedFrom = !purchasedFromFilter || 
                (asset.purchasedFrom && asset.purchasedFrom === purchasedFromFilter);

            // Status filter
            const matchesStatus = !statusFilter || 
                (asset.status && asset.status === statusFilter);

            return matchesSearch && matchesAssignedTo && matchesPurchasedFrom && matchesStatus;
        });

        renderAssets(filtered);
      }

      async function populateFilterDropdowns() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            const assignedToSelect = document.getElementById('assignedToFilter');
            
            if (data.status === 'success' && data.users) {
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.name;
                    option.textContent = user.name;
                    assignedToSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Error fetching users for filter dropdown:", error);
        }
      }

      function renderAssets(assetsToRender) {
        const container = document.getElementById('assetsListContainer');
        container.innerHTML = '';
        if (assetsToRender.length === 0) {
          container.innerHTML = `<p style="text-align: center; color: #ccc;">No assets found.</p>`;
          return;
        }
        assetsToRender.forEach(asset => {
          container.insertAdjacentHTML('beforeend', buildAssetCard(asset));
        });
      }

      function buildAssetCard(asset) {
        const assetId = asset.id;
        return `
    <div class="asset-item-card" id="asset-card-${assetId}">
        <div class="asset-header" onclick="toggleAssetDetails('${assetId}')">
            <span>${asset.assetName || 'N/A'}</span>
            <span>▼</span>
        </div>
        <div class="asset-details" id="asset-details-${assetId}">
            <div class="asset-detail-row">
                <span class="asset-detail-label">Serial Number:</span>
                <span class="asset-detail-value">${asset.serialNumber || 'N/A'}</span>
            </div>
            <div class="asset-detail-row">
                <span class="asset-detail-label">Assigned to:</span>
                <span class="asset-detail-value">${asset.assignedTo || 'Unassigned'}</span>
            </div>
            <div class="asset-detail-row">
                <span class="asset-detail-label">Purchase Date:</span>
                <span class="asset-detail-value">${asset.purchaseDate || 'N/A'}</span>
            </div>
            <div class="asset-detail-row">
                <span class="asset-detail-label">Purchased From:</span>
                <span class="asset-detail-value">${asset.purchasedFrom || 'N/A'}</span>
            </div>
            <div class="asset-detail-row">
                <span class="asset-detail-label">Status:</span>
                <span class="asset-detail-value">${asset.status || 'Active'}</span>
            </div>
            <div class="asset-actions">
                <button class="asset-action-btn btn-edit" onclick="editAsset('${assetId}')">Edit</button>
                <button class="asset-action-btn btn-delete" onclick="deleteAsset('${assetId}')">Delete</button>
            </div>
        </div>
    </div>`;
      }

      function toggleAssetDetails(cardId) {
        const details = document.getElementById(`details-${cardId}`);
        const header = document.getElementById(`asset-card-${cardId}`).querySelector('.asset-header');
        if (details.style.display === 'block') {
          details.style.display = 'none';
          header.classList.remove('expanded');
        } else {
          details.style.display = 'block';
          header.classList.add('expanded');
        }
      }
      // Note: functions like showAddAssetForm, deleteAsset etc. should also be copied if not present.
      function loadIndentsSection() {
    const container = document.getElementById('assets') || document.getElementById('assetsSubContent');
    if (!container) return;
    container.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <button onclick="loadAssetsMenu()" class="back-button">← Back to Assets Menu</button>
            <h2 style="margin:0; margin-left: 15px;">My Asset Requests (Indents)</h2>
        </div>
        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
            <button onclick="loadNewIndentForm()" class="add-button">+ New Asset Request</button>
            <button onclick="downloadIndentsCSV()" class="download-btn" style="background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">📥 Download Indents</button>
        </div>
        <div class="assets-table-container" style="margin-top: 40px; overflow-x: auto;">
            <table class="assets-table" style="width: 100%; border-collapse: collapse; text-align: center;">
                <thead>
                    <tr style="background-color: rgba(255,255,255,0.1);">
                        <th style="padding: 12px;">ID</th><th style="padding: 12px;">Date</th><th style="padding: 12px;">Status</th><th style="padding: 12px;">Action</th>
                    </tr>
                </thead>
                <tbody id="indentsTableBody"></tbody>
            </table>
        </div>
    `;
    fetchIndentsForTable();
}
      async function fetchIndentsForTable() {
    const indentsTableBody = document.getElementById('indentsTableBody');
    indentsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px;">Loading...</td></tr>`;
    try {
        const response = await fetch('/api/asset_requests');
        const result = await response.json();
        if (result.status === 'success') {
            indentsTableBody.innerHTML = '';
            if (!result.requests || result.requests.length === 0) {
                indentsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px;">No requests found.</td></tr>`;
                return;
            }
            result.requests.forEach(req => {
                const row = `
                    <tr>
                        <td style="padding: 10px;">${req.id}</td>
                        <td style="padding: 10px;">${new Date(req.request_date).toLocaleDateString()}</td>
                        <td style="padding: 10px;">${req.status}</td>
                        <td style="padding: 10px;"><button onclick="openIndentForm(${req.id})" class="btn" style="background-color: #007bff; font-size: 14px; padding: 6px 12px;">Open Form</button></td>
                    </tr>
                `;
                indentsTableBody.insertAdjacentHTML('beforeend', row);
            });
        } else {
            indentsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px;">Failed to load requests: ${result.message}</td></tr>`;
        }
    } catch (error) {
        console.error('Error fetching indents:', error);
        indentsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px;">An error occurred while fetching requests.</td></tr>`;
    }
}

      // Download Indents as CSV
      async function downloadIndentsCSV() {
        try {
            const response = await fetch('/api/asset_requests');
            const result = await response.json();
            
            if (result.status !== 'success' || !result.requests) {
                alert('❌ Failed to fetch indents data for download.');
                return;
            }

            if (result.requests.length === 0) {
                alert('ℹ️ No indents data available to download.');
                return;
            }

            // Create CSV headers
            const headers = ['ID', 'Request Date', 'Status', 'Requested By', 'Department', 'Project', 'Total Items', 'Total Amount'];
            
            // Create CSV rows
            const csvRows = [headers.join(',')];
            
            result.requests.forEach(req => {
                const row = [
                    req.id || '',
                    new Date(req.request_date).toLocaleDateString() || '',
                    req.status || '',
                    req.requested_by || '',
                    req.department || '',
                    req.project || '',
                    req.item_details ? req.item_details.length : 0,
                    req.total_amount || '0'
                ];
                // Escape commas and quotes in CSV
                const escapedRow = row.map(field => {
                    const str = String(field);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                });
                csvRows.push(escapedRow.join(','));
            });

            // Create and download the CSV file
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `Indents_Export_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('✅ Indents data downloaded successfully!');
            } else {
                alert('❌ Your browser does not support file downloads.');
            }
        } catch (error) {
            console.error('Error downloading indents:', error);
            alert('❌ An error occurred while downloading indents data.');
        }
      }
      async function loadNewIndentForm() {
    const mainContent = document.getElementById('assets');
    if (!mainContent) return;

    // Clear previous content
    mainContent.innerHTML = `<h2>Loading form...</h2>`;
    
    try {
        const response = await fetch('/api/asset_form_options');
        if (!response.ok) throw new Error('Network response was not ok.');
        const data = await response.json();
        
        const userRolesResponse = await fetch('/api/user/roles');
        const userRolesData = await userRolesResponse.json();
        const currentUserRoles = userRolesData.roles || [];
        
        let projectsHtml = `<option value="">Select</option>` + data.projects.map(p => `<option value="${p.id}">${p.project_name}</option>`).join('');
        let teamLeadsHtml = `<option value="">-- Choose a Team Lead --</option>` + data.team_leads.map(tl => `<option value="${tl.id}">${tl.name}</option>`).join('');
        
        // Pass 'new' as the indentStatus
        const formHtml = createIndentFormHtml(projectsHtml, teamLeadsHtml, currentUserRoles, 'new');
        
        // Add a back button and container for the form
        mainContent.innerHTML = `
            <button onclick="loadIndentsSection()" class="back-button">← Back to Indents</button>
            <div id="newAssetFormContainer" style="margin-top: 20px;">
                ${formHtml}
            </div>
        `;

        document.getElementById('officeProjectType').addEventListener('change', toggleProjectDropdown);
        document.getElementById('newIndentForm').addEventListener('input', (e) => {
            const input = e.target;
            const row = input.closest('tr');
            if (row && ['tentativeCost', 'qty', 'tax', 'taxType'].includes(input.name)) {
                recalculateTotal(row);
            }
        });
        // Calculate initial grand total
        calculateGrandTotal();
        setStep(1);
    } catch (error) {
        // Now, this is a clear error message that doesn't loop
        mainContent.innerHTML = '<h2>Error loading form options.</h2><p style="color:red;">Please check the server logs for more details.</p>';
        console.error('Error fetching form options:', error);
    }
}


      async function openIndentForm(indentId) {
    const mainContent = document.getElementById('assets');
    if (!mainContent) return;
    mainContent.innerHTML = '<h2>Loading form...</h2>';

    try {
        const [indentResponse, optionsResponse, rolesResponse] = await Promise.all([
            fetch(`/api/asset_requests/${indentId}`),
            fetch('/api/asset_form_options'),
            fetch('/api/user/roles')
        ]);
        
        if (!indentResponse.ok) throw new Error('Network response was not ok.');
        const indentData = (await indentResponse.json()).request;
        
        const optionsData = await optionsResponse.json();
        const userRolesData = await rolesResponse.json();
        const currentUserRoles = userRolesData.roles || [];

        let projectsHtml = `<option value="">Select</option>` + optionsData.projects.map(p => `<option value="${p.id}" ${indentData.project_id == p.id ? 'selected' : ''}>${p.project_name}</option>`).join('');
        let teamLeadsHtml = `<option value="">-- Choose a Team Lead --</option>` + optionsData.team_leads.map(tl => `<option value="${tl.id}" ${indentData.team_lead_id == tl.id ? 'selected' : ''}>${tl.name}</option>`).join('');
        
        const formHtml = createIndentFormHtml(projectsHtml, teamLeadsHtml, currentUserRoles, indentData.status, indentData);
        mainContent.innerHTML = formHtml;
        document.getElementById('newIndentForm').dataset.indentId = indentId;
        document.getElementById('officeProjectType').addEventListener('change', toggleProjectDropdown);
        
        if (document.getElementById('itemDetailsTableBody')) {
            document.getElementById('itemDetailsTableBody').addEventListener('input', (e) => {
                const input = e.target;
                const row = input.closest('tr');
                if (row && ['tentativeCost', 'qty', 'tax', 'taxType'].includes(input.name)) {
                    recalculateTotal(row);
                }
            });
            // Calculate initial grand total for existing data
            calculateGrandTotal();
        }
        if (document.getElementById('procurementDetailsTableBody')) {
            document.getElementById('procurementDetailsTableBody').addEventListener('input', (e) => {
                // Recalculate procurement total if needed
            });
        }
        
        setStep(1);
    } catch (error) {
        console.error('Error loading indent for review:', error);
        mainContent.innerHTML = `<h2>Error loading request: ${error.message}</h2>`;
    }
}
const safeValue = (value) => value !== null && value !== undefined ? value : '';

// Function to control the 'disabled' attribute
const isDisabled = (canEdit) => canEdit ? '' : 'disabled';
function generateItemDetailsBody(itemDetails, isEditable) {
    if (!itemDetails || itemDetails.length === 0) {
        if (!isEditable) return `<tr><td colspan="12" style="text-align: center;">No items added.</td></tr>`;
        return `
            <tr>
                <td>1</td>
                <td><input type="text" name="name" placeholder="Item Name" required ${isDisabled(isEditable)}></td>
                <td><input type="text" name="brand" placeholder="Brand" ${isDisabled(isEditable)}></td>
                <td><input type="text" name="vendor" placeholder="Vendor" ${isDisabled(isEditable)}></td>
                <td><input type="number" name="tentativeCost" placeholder="Cost" required ${isDisabled(isEditable)}></td>
                <td><input type="number" name="qty" placeholder="Qty" required ${isDisabled(isEditable)}></td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <select name="taxType" ${isDisabled(isEditable)} style="width: 60px; padding: 4px; border: 1px solid #444; border-radius: 3px; background: #333; color: white;" onchange="updateTaxSymbol(this)">
                            <option value="add">Add</option>
                            <option value="deduct">Deduct</option>
                        </select>
                        <input type="number" name="tax" placeholder="%" value="0" ${isDisabled(isEditable)} style="width: 60px; padding: 4px; border: 1px solid #444; border-radius: 3px; background: #333; color: white;" oninput="updateTaxSymbol(this.closest('td').querySelector('[name=\"taxType\"]'))">
                    </div>
                </td>
                <td><input type="text" name="total" readonly disabled></td>
                <td><input type="date" name="requiredBy" ${isDisabled(isEditable)}></td>
                <td><input type="text" name="warranty" placeholder="Warranty" ${isDisabled(isEditable)}></td>
                <td><input type="text" name="remarks" placeholder="Remarks" ${isDisabled(isEditable)}></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)" ${isDisabled(isEditable)}>Delete</button></td>
            </tr>
        `;
    }
    return itemDetails.map((item, index) => `
        <tr>
            <td>${index + 1}</td>
            <td><input type="text" name="name" value="${safeValue(item.name)}" ${isDisabled(isEditable)}></td>
            <td><input type="text" name="brand" value="${safeValue(item.brand)}" ${isDisabled(isEditable)}></td>
            <td><input type="text" name="vendor" value="${safeValue(item.vendor)}" ${isDisabled(isEditable)}></td>
            <td><input type="number" name="tentativeCost" value="${safeValue(item.tentativeCost)}" ${isDisabled(isEditable)}></td>
            <td><input type="number" name="qty" value="${safeValue(item.qty)}" ${isDisabled(isEditable)}></td>
            <td>
                <div style="display: flex; gap: 5px;">
                    <select name="taxType" ${isDisabled(isEditable)} style="width: 60px; padding: 4px; border: 1px solid #444; border-radius: 3px; background: #333; color: white;" onchange="updateTaxSymbol(this)">
                        <option value="add" ${(item.taxType || 'add') === 'add' ? 'selected' : ''}>Add</option>
                        <option value="deduct" ${item.taxType === 'deduct' ? 'selected' : ''}>Deduct</option>
                    </select>
                    <input type="number" name="tax" value="${safeValue(item.tax)}" ${isDisabled(isEditable)} style="width: 60px; padding: 4px; border: 1px solid #444; border-radius: 3px; background: #333; color: white;" oninput="updateTaxSymbol(this.closest('td').querySelector('[name=\"taxType\"]'))">
                </div>
            </td>
            <td><input type="text" name="total" value="${safeValue(item.total)}" disabled></td>
            <td><input type="date" name="requiredBy" value="${safeValue(item.requiredBy)}" ${isDisabled(isEditable)}></td>
            <td><input type="text" name="warranty" value="${safeValue(item.warranty)}" ${isDisabled(isEditable)}></td>
            <td><input type="text" name="remarks" value="${safeValue(item.remarks)}" ${isDisabled(isEditable)}></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)" ${isDisabled(isEditable)}>Delete</button></td>
        </tr>
    `).join('');
}

// Vendor Management System
let vendorDatabase = [];

// Load vendors from backend API
async function loadVendorsFromAPI() {
    try {
        const response = await fetch('/api/vendors');
        const data = await response.json();
        if (data.status === 'success') {
            vendorDatabase = data.vendors;
            console.log('Loaded vendors from API:', vendorDatabase);
            console.log('Jio vendor data:', vendorDatabase.find(v => v.name === 'Jio'));
        }
    } catch (error) {
        console.error('Error loading vendors from API:', error);
        // Fallback to localStorage if API fails
        vendorDatabase = JSON.parse(localStorage.getItem('vendorDatabase') || '[]');
    }
}

// Initialize vendors when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadVendorsFromAPI();
});

// Also reload vendors when the page becomes visible (in case it was updated in another tab)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        loadVendorsFromAPI();
    }
});

// Add CSS for vendor dropdown
const vendorDropdownCSS = `
<style>
.vendor-option {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    color: #333;
    background: white;
}

.vendor-option:hover,
.vendor-option.selected {
    background-color: #f0f0f0;
    color: #000;
}

.vendor-option:last-child {
    border-bottom: none;
}
</style>
`;

// Inject CSS
if (!document.querySelector('#vendorDropdownCSS')) {
    document.head.insertAdjacentHTML('beforeend', vendorDropdownCSS.replace('<style>', '<style id="vendorDropdownCSS">'));
}

// Add click outside handler to close dropdowns
document.addEventListener('click', function(event) {
    if (!event.target.closest('.vendor-dropdown-container')) {
        document.querySelectorAll('#vendorDropdown').forEach(dropdown => {
            dropdown.style.display = 'none';
        });
    }
});

// Debug functions for vendor database
function clearVendorDatabase() {
    vendorDatabase = [];
    localStorage.removeItem('vendorDatabase');
    console.log('Vendor database cleared');
}

function showVendorDatabase() {
    console.log('Current vendor database:', vendorDatabase);
    return vendorDatabase;
}

// Make functions available globally for debugging
window.clearVendorDatabase = clearVendorDatabase;
window.showVendorDatabase = showVendorDatabase;

// Simple test function - call this from browser console to test
function testVendorAutoPop() {
    // Add Amazon with details
    const amazonVendor = {
        name: "Amazon",
        address: "410 Terry Ave N, Seattle, WA 98109",
        contactNo: "1-888-280-4331",
        mailId: "support@amazon.com",
        edd: "2024-12-31",
        gst: "GST123456789"
    };
    saveVendorToDatabase(amazonVendor);
    console.log('Amazon vendor added:', amazonVendor);
    
    // Test auto-population
    const vendorInputs = document.querySelectorAll('input[name="vendorName"]');
    if (vendorInputs.length > 0) {
        vendorInputs[0].value = "Amazon";
        onVendorInput(vendorInputs[0]);
        console.log('Auto-population test completed. Check the form fields.');
    }
}

// Function to manually trigger auto-population for current Amazon field
function testCurrentAmazon() {
    const vendorInputs = document.querySelectorAll('input[name="vendorName"]');
    vendorInputs.forEach(input => {
        if (input.value.toLowerCase().includes('amazon')) {
            console.log('Found Amazon input, triggering auto-population...');
            onVendorInput(input);
        }
    });
}

window.testVendorAutoPop = testVendorAutoPop;
window.testCurrentAmazon = testCurrentAmazon;


// Function to force auto-populate all vendor fields on page load
function autoPopulateAllVendors() {
    document.querySelectorAll('input[name="vendorName"]').forEach(input => {
        if (input.value.trim()) {
            onVendorInput(input);
        }
    });
}

// Auto-populate vendors when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(autoPopulateAllVendors, 1000);
});

window.autoPopulateAllVendors = autoPopulateAllVendors;


async function saveVendorToDatabase(vendorData) {
    console.log('saveVendorToDatabase called with:', vendorData);
    
    try {
        // Check if vendor already exists
        const existingVendor = vendorDatabase.find(v => v.name.toLowerCase() === vendorData.name.toLowerCase());
        
        if (!existingVendor) {
            // Add new vendor to backend
            const response = await fetch('/api/vendors', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(vendorData)
            });
            
            const result = await response.json();
            if (result.status === 'success') {
                // Reload vendors from API to get latest data
                await loadVendorsFromAPI();
                console.log('Added new vendor to backend. Database now has:', vendorDatabase.length, 'vendors');
                
                // Refresh all vendor dropdowns on the page
                refreshAllVendorDropdowns();
            } else if (result.message && result.message.includes('already exists')) {
                // Vendor exists in database but not in local array, update it
                console.log('Vendor exists in database, updating...');
                await updateVendorInDatabase(vendorData);
            } else {
                console.error('Error adding vendor to backend:', result.message);
                // Fallback to localStorage
                vendorDatabase.push(vendorData);
                localStorage.setItem('vendorDatabase', JSON.stringify(vendorDatabase));
                
                // Refresh all vendor dropdowns on the page
                refreshAllVendorDropdowns();
            }
        } else {
            // Update existing vendor (for now, just update local database)
            const existingVendorIndex = vendorDatabase.findIndex(v => v.name.toLowerCase() === vendorData.name.toLowerCase());
            vendorDatabase[existingVendorIndex] = vendorData;
            localStorage.setItem('vendorDatabase', JSON.stringify(vendorDatabase));
            console.log('Updated existing vendor locally. Database now has:', vendorDatabase.length, 'vendors');
            
            // Also try to update in backend
            await updateVendorInDatabase(vendorData);
            // Reload vendors from API to get latest data
            await loadVendorsFromAPI();
        }
    } catch (error) {
        console.error('Error saving vendor to backend:', error);
        // Fallback to localStorage
    const existingVendorIndex = vendorDatabase.findIndex(v => v.name.toLowerCase() === vendorData.name.toLowerCase());
    if (existingVendorIndex === -1) {
        vendorDatabase.push(vendorData);
    } else {
        vendorDatabase[existingVendorIndex] = vendorData;
    }
    localStorage.setItem('vendorDatabase', JSON.stringify(vendorDatabase));
        console.log('Vendor database saved to localStorage as fallback');
        
        // Refresh all vendor dropdowns on the page
        refreshAllVendorDropdowns();
    }
}

function getVendorFromDatabase(vendorName) {
    return vendorDatabase.find(v => v.name.toLowerCase() === vendorName.toLowerCase());
}

function generateVendorDropdown() {
    const options = vendorDatabase.map(vendor => 
        `<option value="${vendor.name}" data-address="${vendor.address}" data-contact="${vendor.contact_no}" data-email="${vendor.email}" data-gst="${vendor.gst_number}">${vendor.name}</option>`
    ).join('');
    return `<option value="">Select or type vendor name</option>${options}`;
}

function generateVendorDropdownOptions() {
    console.log('Generating dropdown options from vendorDatabase:', vendorDatabase);
    const options = vendorDatabase.map(vendor => {
        console.log('Vendor data for dropdown:', vendor);
        return `<div class="vendor-option" data-vendor='${JSON.stringify(vendor)}' onclick="selectVendor(this)">${vendor.name}</div>`;
    }).join('');
    return options;
}

function refreshAllVendorDropdowns() {
    // Find all vendor dropdowns on the page and refresh their content
    const dropdowns = document.querySelectorAll('#vendorDropdown');
    dropdowns.forEach(dropdown => {
        dropdown.innerHTML = generateVendorDropdownOptions();
    });
    console.log('Refreshed all vendor dropdowns');
}

async function updateVendorInDatabase(vendorData) {
    try {
        // First, get the vendor ID from the database
        const response = await fetch('/api/vendors');
        const data = await response.json();
        if (data.status === 'success') {
            const existingVendor = data.vendors.find(v => v.name.toLowerCase() === vendorData.name.toLowerCase());
            if (existingVendor) {
                // Update the vendor in backend
                const updateResponse = await fetch(`/api/vendors/${existingVendor.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(vendorData)
                });
                
                const updateResult = await updateResponse.json();
                if (updateResult.status === 'success') {
                    console.log('Updated vendor in backend successfully');
                    // Update local database
                    const existingVendorIndex = vendorDatabase.findIndex(v => v.name.toLowerCase() === vendorData.name.toLowerCase());
                    if (existingVendorIndex !== -1) {
                        vendorDatabase[existingVendorIndex] = vendorData;
                    } else {
                        vendorDatabase.push(vendorData);
                    }
                    localStorage.setItem('vendorDatabase', JSON.stringify(vendorDatabase));
                    
                    // Reload vendors from API to get latest data
                    await loadVendorsFromAPI();
                    // Refresh all vendor dropdowns on the page
                    refreshAllVendorDropdowns();
                } else {
                    console.error('Error updating vendor in backend:', updateResult.message);
                }
            }
        }
    } catch (error) {
        console.error('Error updating vendor in database:', error);
    }
}

function onVendorSelect(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    if (selectedOption.value) {
        const row = selectElement.closest('tr');
        row.querySelector('input[name="vendorAddress"]').value = selectedOption.dataset.address || '';
        row.querySelector('input[name="contactNo"]').value = selectedOption.dataset.contact || '';
        row.querySelector('input[name="mailId"]').value = selectedOption.dataset.email || '';
        row.querySelector('input[name="vendorGst"]').value = selectedOption.dataset.gst || '';
    }
}

function onVendorInput(inputElement) {
    const vendorName = inputElement.value.trim();
    updateVendorDropdown(inputElement);
    
    console.log('onVendorInput called with:', vendorName);
    
    if (vendorName) {
        const vendor = getVendorFromDatabase(vendorName);
        console.log('Vendor found:', vendor);
        
        if (vendor) {
            const row = inputElement.closest('tr');
            row.querySelector('input[name="vendorAddress"]').value = vendor.address || '';
            row.querySelector('input[name="contactNo"]').value = vendor.contact_no || '';
            row.querySelector('input[name="mailId"]').value = vendor.email || '';
            row.querySelector('input[name="edd"]').value = vendor.edd || '';
            row.querySelector('input[name="vendorGst"]').value = vendor.gst_number || '';
            console.log('Auto-populated fields with:', {
                address: vendor.address,
                contact_no: vendor.contact_no,
                email: vendor.email,
                edd: vendor.edd,
                gst_number: vendor.gst_number
            });
        } else {
            console.log('No vendor found in database for:', vendorName);
            console.log('Current database:', vendorDatabase);
        }
    } else {
        // Clear fields if vendor name is empty
        const row = inputElement.closest('tr');
        row.querySelector('input[name="vendorAddress"]').value = '';
        row.querySelector('input[name="contactNo"]').value = '';
        row.querySelector('input[name="mailId"]').value = '';
        row.querySelector('input[name="edd"]').value = '';
        row.querySelector('input[name="vendorGst"]').value = '';
    }
}

async function saveVendorFromRow(row) {
    console.log('saveVendorFromRow called for row:', row);
    const vendorName = row.querySelector('input[name="vendorName"]').value.trim();
    const vendorAddress = row.querySelector('input[name="vendorAddress"]').value.trim();
    const contactNo = row.querySelector('input[name="contactNo"]').value.trim();
    const mailId = row.querySelector('input[name="mailId"]').value.trim();
    const edd = row.querySelector('input[name="edd"]').value.trim();
    const vendorGst = row.querySelector('input[name="vendorGst"]').value.trim();
    
    console.log('saveVendorFromRow called with:', {
        vendorName,
        vendorAddress,
        contactNo,
        mailId,
        edd,
        vendorGst
    });
    
    console.log('Field values from DOM:', {
        vendorName: row.querySelector('input[name="vendorName"]').value,
        vendorAddress: row.querySelector('input[name="vendorAddress"]').value,
        contactNo: row.querySelector('input[name="contactNo"]').value,
        mailId: row.querySelector('input[name="mailId"]').value,
        edd: row.querySelector('input[name="edd"]').value,
        vendorGst: row.querySelector('input[name="vendorGst"]').value
    });
    
    // Save vendor if we have at least name and one other field
    if (vendorName && (vendorAddress || contactNo || mailId || edd || vendorGst)) {
        const vendorData = {
            name: vendorName,
            address: vendorAddress,
            contact_no: contactNo,
            email: mailId,
            gst_number: vendorGst
        };
        console.log('Saving vendor data:', vendorData);
        await saveVendorToDatabase(vendorData);
    } else {
        console.log('Not saving vendor - missing required fields');
    }
}

function showVendorDropdown(inputElement) {
    const dropdown = inputElement.parentElement.querySelector('#vendorDropdown');
    if (dropdown) {
        dropdown.style.display = 'block';
        updateVendorDropdown(inputElement);
    }
}

function hideVendorDropdown(inputElement) {
    const dropdown = inputElement.parentElement.querySelector('#vendorDropdown');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

function updateVendorDropdown(inputElement) {
    const dropdown = inputElement.parentElement.querySelector('#vendorDropdown');
    const searchTerm = inputElement.value.toLowerCase();
    
    if (searchTerm) {
        const filteredVendors = vendorDatabase.filter(vendor => 
            vendor.name.toLowerCase().includes(searchTerm)
        );
        dropdown.innerHTML = filteredVendors.map(vendor => 
            `<div class="vendor-option" data-vendor='${JSON.stringify(vendor)}' onclick="selectVendor(this)">${vendor.name}</div>`
        ).join('');
    } else {
        dropdown.innerHTML = generateVendorDropdownOptions();
    }
}

function selectVendor(optionElement) {
    const vendor = JSON.parse(optionElement.getAttribute('data-vendor'));
    
    // Find the dropdown container and then the input element
    const dropdownContainer = optionElement.closest('.vendor-dropdown-container');
    const inputElement = dropdownContainer.querySelector('input[name="vendorName"]');
    const row = inputElement.closest('tr');
    
    console.log('Selected vendor:', vendor); // Debug log
    console.log('Input element found:', inputElement); // Debug log
    console.log('Row found:', row); // Debug log
    
    if (inputElement && row) {
        inputElement.value = vendor.name;
        row.querySelector('input[name="vendorAddress"]').value = vendor.address || '';
        row.querySelector('input[name="contactNo"]').value = vendor.contact_no || '';
        row.querySelector('input[name="mailId"]').value = vendor.email || '';
        row.querySelector('input[name="edd"]').value = vendor.edd || '';
        row.querySelector('input[name="vendorGst"]').value = vendor.gst_number || '';
        
        console.log('Vendor details populated successfully:', {
            name: vendor.name,
            address: vendor.address,
            contact_no: vendor.contact_no,
            email: vendor.email,
            gst_number: vendor.gst_number
        });
        
        hideVendorDropdown(inputElement);
    } else {
        console.error('Could not find input element or row');
    }
}

function handleVendorKeydown(event, inputElement) {
    const dropdown = inputElement.parentElement.querySelector('#vendorDropdown');
    const options = dropdown.querySelectorAll('.vendor-option');
    let selectedIndex = -1;
    
    // Find currently selected option
    options.forEach((option, index) => {
        if (option.classList.contains('selected')) {
            selectedIndex = index;
        }
    });
    
    if (event.key === 'ArrowDown') {
        event.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, options.length - 1);
        updateSelection(options, selectedIndex);
    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, 0);
        updateSelection(options, selectedIndex);
    } else if (event.key === 'Enter') {
        event.preventDefault();
        if (selectedIndex >= 0 && options[selectedIndex]) {
            selectVendor(options[selectedIndex]);
        }
    } else if (event.key === 'Escape') {
        hideVendorDropdown(inputElement);
    }
}

function updateSelection(options, selectedIndex) {
    options.forEach((option, index) => {
        option.classList.toggle('selected', index === selectedIndex);
    });
}

function generateProcurementDetailsBody(procurementItems, isEditable) {
    if (!procurementItems || procurementItems.length === 0) {
        if (!isEditable) return `<tr><td colspan="11" style="text-align: center;">No procurement details added.</td></tr>`;
        return `
            <tr>
                <td>1</td>
                <td><input type="text" name="itemName" placeholder="Item Name" required ${isDisabled(isEditable)}></td>
                <td>
                    <div class="vendor-dropdown-container" style="position: relative; width: 100%;">
                        <input type="text" name="vendorName" placeholder="Type or select vendor name" required ${isDisabled(isEditable)} 
                               oninput="onVendorInput(this)" onblur="saveVendorFromRow(this.closest('tr'))" 
                               onfocus="showVendorDropdown(this)" onkeydown="handleVendorKeydown(event, this)"
                               style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; background: white; color: black;">
                        <div id="vendorDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 150px; overflow-y: auto; z-index: 1000; display: none;">
                            ${generateVendorDropdownOptions()}
                        </div>
                    </div>
                </td>
                <td><input type="text" name="vendorAddress" placeholder="Vendor Address" required ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td><input type="number" name="cost" placeholder="Cost" required ${isDisabled(isEditable)}></td>
                <td><input type="text" name="contactNo" placeholder="Contact No." ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td><input type="email" name="mailId" placeholder="Mail ID" ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td><input type="date" name="edd" ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td><input type="text" name="vendorGst" placeholder="Vendor GST" ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td><input type="file" name="quoteFile" ${isDisabled(isEditable)}></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="deleteProcurementRow(this)" ${isDisabled(isEditable)}>Delete</button></td>
            </tr>
        `;
    }
    return procurementItems.map((item, index) => `
        <tr>
            <td>${index + 1}</td>
            <td><input type="text" name="itemName" value="${safeValue(item.itemName)}" ${isDisabled(isEditable)}></td>
            <td>
                <div class="vendor-dropdown-container" style="position: relative; width: 100%;">
                    <input type="text" name="vendorName" value="${safeValue(item.vendorName)}" placeholder="Type or select vendor name" required ${isDisabled(isEditable)} 
                           oninput="onVendorInput(this)" onblur="saveVendorFromRow(this.closest('tr'))" 
                           onfocus="showVendorDropdown(this)" onkeydown="handleVendorKeydown(event, this)"
                           style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; background: white; color: black;">
                    <div id="vendorDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 150px; overflow-y: auto; z-index: 1000; display: none;">
                        ${generateVendorDropdownOptions()}
                    </div>
                </div>
            </td>
            <td><input type="text" name="vendorAddress" value="${safeValue(item.vendorAddress)}" placeholder="Vendor Address" required ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
            <td><input type="number" name="cost" value="${safeValue(item.cost)}" ${isDisabled(isEditable)}></td>
            <td><input type="text" name="contactNo" value="${safeValue(item.contactNo)}" ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
            <td><input type="email" name="mailId" value="${safeValue(item.mailId)}" ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
            <td><input type="date" name="edd" value="${safeValue(item.edd)}" ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
            <td><input type="text" name="vendorGst" value="${safeValue(item.vendorGst)}" ${isDisabled(isEditable)} onchange="saveVendorFromRow(this.closest('tr'))"></td>
            <td><input type="file" name="quoteFile" ${isDisabled(isEditable)}></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="deleteProcurementRow(this)" ${isDisabled(isEditable)}>Delete</button></td>
        </tr>
    `).join('');
}

async function completeIndent(indentId) {
    const handedOverTo = document.getElementById('handedOverTo').value;
    const receivedOn = document.getElementById('receivedOn').value;

    const finalData = {
        handed_over_to: handedOverTo,
        received_on: receivedOn
    };

    if (!handedOverTo || !receivedOn) {
        alert('Please fill in both the handover name and the received date.');
        return;
    }

    try {
        const response = await fetch(`/api/asset_requests/${indentId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: 'Procurement', data: finalData, stage: 'final_delivery' })
        });
        
        // --- MODIFIED: Await the JSON parsing and check the status ---
        const result = await response.json();

        if (result.status === 'success') {
            alert('✅ Request finalized and completed!');
            loadNotificationsSection();
        } else {
            alert('❌ Failed to complete the request: ' + result.message);
        }
    } catch (error) {
        console.error('Error completing the request:', error);
        alert('An error occurred. Please try again.');
    }
}


      function createIndentFormHtml(projectsHtml, teamLeadsHtml, currentUserRoles, indentStatus, indentData = {}) {
        const hasRole = (role) => currentUserRoles.includes(role);
        const isNew = indentStatus === 'new';

        // All variables are now properly declared in the function's scope
        const isJustificationAwaiting = indentStatus === 'Pending TL Approval' && hasRole('Team Lead');
        const isProcurementAwaiting = (indentStatus === 'Pending Procurement Approval' || indentStatus === 'Pending Procurement Type Approval' || indentStatus === 'Pending Procurement Final Approval') && hasRole('Procurement');
        const isTLFinalAwaiting = indentStatus === 'Pending TL Final Approval' && hasRole('Team Lead');
        const isDirectorAwaiting = indentStatus === 'Pending Director Approval' && hasRole('Director');
        const isMDAwaiting = indentStatus === 'Pending Managing Director Approval' && hasRole('Managing Director');
        const isAccountsAwaiting = indentStatus === 'Pending Accounts Approval' && hasRole('Accounts');
        const isProcurementFinalAwaiting = indentStatus === 'Pending Procurement Final Approval' && hasRole('Procurement');
        const isAccountsFinalAwaiting = indentStatus === 'Pending Accounts Final Approval' && hasRole('Accounts');
        const isFinalDeliveryAwaiting = indentStatus === 'Pending Final Delivery' && hasRole('Procurement');
        const isCompleted = indentStatus === 'Completed' || indentStatus.startsWith('Rejected');

        const isDisabled = (canEdit) => canEdit ? '' : 'disabled';
        const show = (condition) => condition ? '' : 'style="display:none;"';

        const isStep1Editable = isNew;
        const isJustificationEditable = isJustificationAwaiting;
        const isProcurementEditable = isProcurementAwaiting || isProcurementFinalAwaiting;
        const isTLFinalApprovalEditable = isTLFinalAwaiting;
        const isDirectorEditable = isDirectorAwaiting;
        const isMDEditable = isMDAwaiting;
        const isAccountsEditable = isAccountsAwaiting;
        const isProcurementFinalEditable = isProcurementFinalAwaiting;
        const isAccountsFinalEditable = isAccountsFinalAwaiting;
        const isFinalDeliveryEditable = isFinalDeliveryAwaiting;

        const itemDetailsBody = generateItemDetailsBody(indentData.item_details, isStep1Editable);
        const procurementDetailsBody = generateProcurementDetailsBody(indentData.procurement_items, isProcurementEditable);
        
        // Calculate totals for step 2
        let grandTotalStep2 = 0;
        if (indentData.item_details && indentData.item_details.length > 0) {
            grandTotalStep2 = indentData.item_details.reduce((total, item) => {
                if (item.total) {
                    return total + parseFloat(item.total);
                } else {
                    const cost = parseFloat(item.tentativeCost || item.cost) || 0;
                    const qty = parseFloat(item.qty || item.quantity) || 0;
                    const tax = parseFloat(item.tax) || 0;
                    const itemTotal = cost * qty * (1 + tax / 100);
                    return total + itemTotal;
                }
            }, 0);
        }
        
        return `
            <div class="purchase-indent-form">
                <div class="form-header">
                    <h2>PURCHASE INDENT FORM (ID: ${indentData.id || 'New'})</h2>
                    <div style="font-size: 1.2rem; color: #ffc107;">Status: ${indentStatus}</div>
                </div>
                <form id="newIndentForm" onsubmit="event.preventDefault();">
                    <input type="hidden" id="indentId" value="${indentData.id || ''}">
                    <div id="step1">
                        <div class="form-section">
                            <h4>Indenter's Details</h4>
                            <div class="form-fields-grid">
                                <div class="form-field-group"><label for="indenterName">Name & Designation:</label><input type="text" id="indenterName" name="indenterName" value="${indentData.indenter_name || ''}" ${isDisabled(isStep1Editable)}></div>
                                <div class="form-field-group"><label for="officeProjectType">Office/Project:</label><select id="officeProjectType" name="officeProjectType" onchange="toggleProjectDropdown()" ${isDisabled(isStep1Editable)}><option value="" ${indentData.office_project_type === '' ? 'selected' : ''}>Select</option><option value="Office" ${indentData.office_project_type === 'Office' ? 'selected' : ''}>Office</option><option value="Project" ${indentData.office_project_type === 'Project' ? 'selected' : ''}>Project</option></select></div>
                                <div class="form-field-group" id="projectSelectContainer" ${show(indentData.office_project_type === 'Project')}><label for="projectSelect">Project No & Title:</label><select id="projectSelect" name="projectSelect" ${isDisabled(isStep1Editable)}>${projectsHtml}</select></div>
                                <div class="form-field-group"><label for="teamLeadSelect">Select Team Lead:</label><select id="teamLeadSelect" name="teamLeadSelect" ${isDisabled(isStep1Editable)}>${teamLeadsHtml}</select></div>
                                <div class="form-field-group"><label for="referenceFileNo">Reference File No:</label><input type="text" id="referenceFileNo" name="referenceFileNo" value="${indentData.reference_file_no || ''}" ${isDisabled(isStep1Editable)}></div>
                                <div class="form-field-group"><label for="purchaseType">Type of Purchase:</label><select id="purchaseType" name="purchaseType" ${isDisabled(isStep1Editable)}><option value="" ${indentData.purchase_type === '' ? 'selected' : ''}>Select</option><option value="Goods" ${indentData.purchase_type === 'Goods' ? 'selected' : ''}>Goods</option><option value="Services" ${indentData.purchase_type === 'Services' ? 'selected' : ''}>Services</option></select></div>
                                <div class="form-field-group"><label for="budgetHead">Budget Head:</label><select id="budgetHead" name="budgetHead" ${isDisabled(isStep1Editable)}><option value="" ${indentData.budget_head === '' ? 'selected' : ''}>Select</option><option value="MANPOWER" ${indentData.budget_head === 'MANPOWER' ? 'selected' : ''}>MANPOWER</option><option value="TRAVEL" ${indentData.budget_head === 'TRAVEL' ? 'selected' : ''}>TRAVEL</option><option value="CONTINGENCY" ${indentData.budget_head === 'CONTINGENCY' ? 'selected' : ''}>CONTINGENCY</option><option value="CONSUMABLES" ${indentData.budget_head === 'CONSUMABLES' ? 'selected' : ''}>CONSUMABLES</option><option value="MISC" ${indentData.budget_head === 'MISC' ? 'selected' : ''}>MISC</option></select></div>
                                <div class="form-field-group"><label for="natureOfExpenditure">Nature of Expenditure:</label><select id="natureOfExpenditure" name="natureOfExpenditure" ${isDisabled(isStep1Editable)}><option value="" ${indentData.nature_of_expenditure === '' ? 'selected' : ''}>Select</option><option value="RECURRING" ${indentData.nature_of_expenditure === 'RECURRING' ? 'selected' : ''}>RECURRING</option><option value="NON-RECURRING" ${indentData.nature_of_expenditure === 'NON-RECURRING' ? 'selected' : ''}>NON-RECURRING</option></select></div>
                                <div class="form-field-group"><label for="gstApplicable">GST Applicability:</label><select id="gstApplicable" name="gstApplicable" ${isDisabled(isStep1Editable)}><option value="" ${indentData.gst_applicable === '' ? 'selected' : ''}>Select</option><option value="YES" ${indentData.gst_applicable === 'YES' ? 'selected' : ''}>YES</option><option value="NO" ${indentData.gst_applicable === 'NO' ? 'selected' : ''}>NO</option></select></div>
                            </div>
                        </div>
                        <div class="form-section">
                            <h4>Details of the Item Being Demanded</h4>
                            <div class="table-responsive">
                                <table class="table table-bordered text-white">
                                    <thead><tr><th>S.No</th><th>Name of the Item</th><th>Preferred Brand</th><th>Supplier/Vendor</th><th>Tentative Cost (Rs)</th><th>Qty</th><th>Tax (%)</th><th>Total (with tax)</th><th>Required by</th><th>Warranty</th><th>Remarks</th><th>Action</th></tr></thead>
                                    <tbody id="itemDetailsTableBody">${itemDetailsBody}</tbody>
                                </table>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <button type="button" onclick="addItemRow()" class="btn btn-add" ${isDisabled(isStep1Editable)}>+ ADD ROW</button>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label style="color: #ccc;">Discount:</label>
                                        <input type="number" id="discountAmount" value="0" ${isDisabled(isStep1Editable)} style="width: 100px; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white;" oninput="calculateGrandTotal()">
                                        <span style="color: #ccc;">₹</span>
                                    </div>
                                    <div id="grandTotalDisplay" style="font-size: 18px; font-weight: bold; color: #28a745; background-color: rgba(40, 167, 69, 0.1); padding: 10px 20px; border-radius: 5px; border: 1px solid #28a745;">
                                        <div>Subtotal: ₹0.00</div>
                                        <div id="discountDisplay" style="color: #ff6b6b;">Discount: -₹0.00</div>
                                        <div id="finalTotalDisplay" style="font-weight: bold;">Grand Total: ₹0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-next" onclick="setStep(2)">Next &rarr;</button>
                        </div>
                    </div>
                    
                    <div id="step2" style="display: none;">
                        <!-- Discount and Total Summary Section -->
                        <div class="form-section">
                            <h4>Cost Summary</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label style="color: #ccc;">Discount:</label>
                                        <input type="number" id="discountAmountStep2" value="${indentData.discount_amount || 0}" ${isDisabled(false)} style="width: 100px; padding: 8px; border: 1px solid #444; border-radius: 3px; background: #333; color: white;" readonly>
                                        <span style="color: #ccc;">₹</span>
                                    </div>
                                    <div id="grandTotalDisplayStep2" style="font-size: 18px; font-weight: bold; color: #28a745; background-color: rgba(40, 167, 69, 0.1); padding: 10px 20px; border-radius: 5px; border: 1px solid #28a745;">
                                        <div>Subtotal: ₹${grandTotalStep2.toFixed(2)}</div>
                                        <div id="discountDisplayStep2" style="color: #ff6b6b;">Discount: -₹${(indentData.discount_amount || 0).toFixed(2)}</div>
                                        <div id="finalTotalDisplayStep2" style="font-weight: bold;">Grand Total: ₹${(grandTotalStep2 - (indentData.discount_amount || 0)).toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>Teamleader - Justification of Procurement</h4>
                            <div class="form-field-group">
                                <textarea id="justification" rows="3" placeholder="Enter justification here..." ${isDisabled(isJustificationEditable)}>${indentData.justification || ''}</textarea>
                            </div>
                            ${ isJustificationAwaiting ? `
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-success" onclick="approveIndentFromTL(${indentData.id})">Send</button>
                                <button type="button" class="btn btn-danger ms-2" onclick="rejectIndent(${indentData.id}, 'Team Lead')">Reject</button>
                            </div>` : '' }
                        </div>
                        
                        <div class="form-section">
                            <h4>Procurement Section</h4>
                            <div class="table-responsive">
                                <table class="table table-bordered text-white">
                                    <thead><tr><th>S.No</th><th>Name of Item</th><th>Name of Vendor</th><th>Vendor Address</th><th>Cost</th><th>Contact No.</th><th>Mail ID</th><th>EDD</th><th>Vendor GST</th><th>Quote</th><th>Action</th></tr></thead>
                                    <tbody id="procurementDetailsTableBody">${procurementDetailsBody}</tbody>
                                </table>
                            </div>
                            <button type="button" onclick="addProcurementRow()" class="btn btn-add mt-3" ${isDisabled(isProcurementEditable)}>+ ADD ROW</button>
                            ${ isProcurementAwaiting ? `
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-success" onclick="approveIndentFromProcurement(${indentData.id})">Send</button>
                                <button type="button" class="btn btn-danger ms-2" onclick="rejectIndent(${indentData.id}, 'Procurement')">Reject</button>
                            </div>` : '' }
                        </div>

                        <div class="form-section">
                            <h4>Teamlead Final Approval</h4>
                            <div class="form-field-group">
                                <label for="approvalProcurement">Approval of Procurement:</label>
                                <textarea id="approvalProcurement" rows="2" placeholder="Enter approval details..." ${isDisabled(isTLFinalApprovalEditable)}>${indentData.approval_procurement || ''}</textarea>
                            </div>
                            <div class="form-field-group">
                                <label for="finalizedVendor">Finalized Vendor:</label>
                                <input type="text" id="finalizedVendor" placeholder="Enter finalized vendor" value="${indentData.finalized_vendor || ''}" ${isDisabled(isTLFinalApprovalEditable)}>
                            </div>
                            ${ isTLFinalAwaiting ? `
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-success" onclick="finalApproveFromTL(${indentData.id})">Send</button>
                                <button type="button" class="btn btn-danger ms-2" onclick="rejectIndent(${indentData.id}, 'Team Lead')">Reject</button>
                            </div>` : '' }
                        </div>
                        
                        <div class="form-section">
                            <h4>Approval Section (Director)</h4>
                            <div class="form-check"><input type="checkbox" id="directorPiApproval" ${isDisabled(isDirectorEditable)} ${indentData.director_pi_approval ? 'checked' : ''}><label for="directorPiApproval">PI (Up to Rs. 5 Lakh)</label></div>
                            <div class="form-check"><input type="checkbox" id="directorPdApproval" ${isDisabled(isDirectorEditable)} ${indentData.director_pd_approval ? 'checked' : ''}><label for="directorPdApproval">Project Director (Up to Rs. 50 Lac)</label></div>
                            <div class="form-check"><input type="checkbox" id="directorChairmanApproval" ${isDisabled(isDirectorEditable)} ${indentData.director_chairman_approval ? 'checked' : ''}><label for="directorChairmanApproval">Chairman (Full Power)</label></div>
                            <div class="form-field-group mt-3"><label for="directorComments">Director Comments:</label><textarea id="directorComments" rows="2" placeholder="Director Comments" ${isDisabled(isDirectorEditable)}>${indentData.director_comments || ''}</textarea></div>
                            ${ isDirectorAwaiting ? `
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-success" onclick="finalApproveFromDirector(${indentData.id})">Send</button>
                                <button type="button" class="btn btn-danger ms-2" onclick="rejectIndent(${indentData.id}, 'Director')">Reject</button>
                            </div>` : '' }
                        </div>
                        
                        <div class="form-section">
                            <h4>Approval Section (MD)</h4>
                            <div class="form-check"><input type="checkbox" id="piApproval" ${isDisabled(isMDEditable)} ${indentData.pi_approval ? 'checked' : ''}><label for="piApproval">PI (Up to Rs. 5 Lakh)</label></div>
                            <div class="form-check"><input type="checkbox" id="pdApproval" ${isDisabled(isMDEditable)} ${indentData.pd_approval ? 'checked' : ''}><label for="pdApproval">Project Director (Up to Rs. 50 Lac)</label></div>
                            <div class="form-check"><input type="checkbox" id="chairmanApproval" ${isDisabled(isMDEditable)} ${indentData.chairman_approval ? 'checked' : ''}><label for="chairmanApproval">Chairman (Full Power)</label></div>
                            <div class="form-field-group mt-3"><label for="chairmanComments">Chairman Comments:</label><textarea id="chairmanComments" rows="2" placeholder="Chairman Comments" ${isDisabled(isMDEditable)}>${indentData.chairman_comments || ''}</textarea></div>
                            ${ isMDAwaiting ? `
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-success" onclick="finalApproveFromMD(${indentData.id})">Send</button>
                                <button type="button" class="btn btn-danger ms-2" onclick="rejectIndent(${indentData.id}, 'MD')">Reject</button>
                            </div>` : '' }
                        </div>

                        <div class="form-section">
                            <h4>Type of Procurement</h4>
                            <div class="form-fields-grid">
                                <div class="form-field-group"><label for="procurementType">Type of Procurement:</label><select id="procurementType" ${isDisabled(isProcurementEditable)}><option value="" ${indentData.procurement_type === '' ? 'selected' : ''}>Select</option><option value="COD" ${indentData.procurement_type === 'COD' ? 'selected' : ''}>COD</option><option value="Cheque" ${indentData.procurement_type === 'Cheque' ? 'selected' : ''}>Cheque</option><option value="Bank Transfers" ${indentData.procurement_type === 'Bank Transfers' ? 'selected' : ''}>Bank Transfers</option><option value="Card Payments" ${indentData.procurement_type === 'Card Payments' ? 'selected' : ''}>Card Payments</option></select></div>
                            </div>
                            ${ (isProcurementAwaiting || isProcurementFinalAwaiting) ? `
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-success" onclick="approveProcurementType(${indentData.id})">Send</button>
                                <button type="button" class="btn btn-danger ms-2" onclick="rejectIndent(${indentData.id}, 'Procurement')">Reject</button>
                            </div>` : '' }
                        </div>

                        <div class="form-section">
                            <h4>Accounts Section (Filled by Admin)</h4>
                            <div class="form-fields-grid">
                                <div class="form-field-group"><label for="budgetAllocation">Budget allocation:</label><input type="text" id="budgetAllocation" value="${indentData.budget_allocation || ''}" ${isDisabled(isAccountsEditable)}></div>
                                <div class="form-field-group"><label for="budgetUtilized">Budget utilized:</label><input type="text" id="budgetUtilized" value="${indentData.budget_utilized || ''}" ${isDisabled(isAccountsEditable)}></div>
                                <div class="form-field-group"><label for="availableBalance">Available balance:</label><input type="text" id="availableBalance" value="${indentData.available_balance || ''}" ${isDisabled(isAccountsEditable)}></div>
                                <div class="form-field-group"><label for="fundsAvailable">Funds available?</label><select id="fundsAvailable" ${isDisabled(isAccountsEditable)}><option value="" ${indentData.funds_available === null ? 'selected' : ''}>Select</option><option value="true" ${indentData.funds_available === true ? 'selected' : ''}>Yes</option><option value="false" ${indentData.funds_available === false ? 'selected' : ''}>No</option></select></div>
                                <div class="form-field-group"><label for="accountNo">Account No:</label><input type="text" id="accountNo" value="${indentData.account_no || ''}" ${isDisabled(isAccountsEditable)}></div>
                                <div class="form-field-group"><label for="ifscCode">IFSC Code:</label><input type="text" id="ifscCode" value="${indentData.ifsc_code || ''}" ${isDisabled(isAccountsEditable)}></div>
                                <div class="form-field-group"><label for="branchName">Branch Name:</label><input type="text" id="branchName" value="${indentData.branch_name || ''}" ${isDisabled(isAccountsEditable)}></div>
                                <div class="form-field-group"><label for="accountHolderName">Account Holder Name:</label><input type="text" id="accountHolderName" value="${indentData.account_holder_name || ''}" ${isDisabled(isAccountsEditable)}></div>
                                <div class="form-field-group"><label for="accountsRemarks">Remarks:</label><textarea id="accountsRemarks" rows="3" placeholder="Enter remarks..." ${isDisabled(isAccountsEditable)}>${indentData.accounts_remarks || ''}</textarea></div>
                            </div>
                            ${ isAccountsAwaiting ? `
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-success" onclick="finalApproveFromAccounts(${indentData.id})">Finalize</button>
                                <button type="button" class="btn btn-danger ms-2" onclick="rejectIndent(${indentData.id}, 'Accounts')">Reject</button>
                            </div>` : '' }
                        </div>
                        
                        
                        
                        <div class="form-section">
                            <h4>Final Delivery Section</h4>
                            <div class="form-fields-grid">
                                <div class="form-field-group"><label for="handedOverTo">Handed Over To:</label><input type="text" id="handedOverTo" value="${indentData.handed_over_to || ''}" ${isDisabled(isFinalDeliveryEditable)}></div>
                                <div class="form-field-group"><label for="receivedOn">Received on date:</label><input type="date" id="receivedOn" value="${indentData.received_on || ''}" ${isDisabled(isFinalDeliveryEditable)}></div>
                            </div>
                            ${ isFinalDeliveryAwaiting ? `
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-success" onclick="completeIndent(${indentData.id})">Finalize & Complete</button>
                                <button type="button" class="btn btn-danger ms-2" onclick="rejectIndent(${indentData.id}, 'Procurement')">Reject</button>
                            </div>` : '' }
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary" onclick="setStep(1)">← Previous</button>
                            ${ isNew ? `<button type="button" class="btn btn-success" onclick="submitIndentForm()">Submit</button>` : '' }
                        </div>
                    </div>
                </form>
            </div>
        `;
    }
async function approveIndentFromTL(indentId) {
        const justification = document.getElementById('justification').value;
        if (!justification) {
            alert('Please provide a justification before approving.');
            return;
        }
        try {
            const response = await fetch(`/api/asset_requests/${indentId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'Team Lead', data: { justification: justification } })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('✅ Indent request approved and forwarded to Procurement!');
                loadNotificationsSection(); 
            } else {
                alert('❌ Failed to approve indent: ' + result.message);
            }
        } catch (error) {
            console.error('Error approving indent:', error);
            alert('An error occurred. Please try again.');
        }
    }

    async function finalApproveFromDirector(indentId) {
        const directorPiApproval = document.getElementById('directorPiApproval').checked;
        const directorPdApproval = document.getElementById('directorPdApproval').checked;
        const directorChairmanApproval = document.getElementById('directorChairmanApproval').checked;
        const directorComments = document.getElementById('directorComments').value;
        
        if (!directorPiApproval && !directorPdApproval && !directorChairmanApproval) {
            alert('Please select at least one approval level.');
            return;
        }
        
        try {
            const response = await fetch(`/api/asset_requests/${indentId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    role: 'Director', 
                    data: { 
                        director_pi_approval: directorPiApproval,
                        director_pd_approval: directorPdApproval,
                        director_chairman_approval: directorChairmanApproval,
                        director_comments: directorComments
                    } 
                })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('✅ Indent request approved by Director and forwarded to MD!');
                loadNotificationsSection(); 
            } else {
                alert('❌ Failed to approve indent: ' + result.message);
            }
        } catch (error) {
            console.error('Error approving indent:', error);
            alert('An error occurred. Please try again.');
        }
    }

    async function finalApproveFromProcurementFinal(indentId) {
        const finalProcurementType = document.getElementById('finalProcurementType').value;
        
        if (!finalProcurementType) {
            alert('Please select the type of procurement.');
            return;
        }
        
        try {
            const response = await fetch(`/api/asset_requests/${indentId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    role: 'Procurement', 
                    data: { 
                        final_procurement_type: finalProcurementType
                    } 
                })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('✅ Procurement type finalized and forwarded to Accounts!');
                loadNotificationsSection(); 
            } else {
                alert('❌ Failed to finalize procurement: ' + result.message);
            }
        } catch (error) {
            console.error('Error finalizing procurement:', error);
            alert('An error occurred. Please try again.');
        }
    }

    async function finalApproveFromAccountsFinal(indentId) {
        const finalBudgetAllocation = document.getElementById('finalBudgetAllocation').value;
        const finalBudgetUtilized = document.getElementById('finalBudgetUtilized').value;
        const finalAvailableBalance = document.getElementById('finalAvailableBalance').value;
        
        if (!finalBudgetAllocation || !finalBudgetUtilized || !finalAvailableBalance) {
            alert('Please fill in all budget fields.');
            return;
        }
        
        try {
            const response = await fetch(`/api/asset_requests/${indentId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    role: 'Accounts', 
                    data: { 
                        final_budget_allocation: finalBudgetAllocation,
                        final_budget_utilized: finalBudgetUtilized,
                        final_available_balance: finalAvailableBalance
                    } 
                })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('✅ Final accounts approved and forwarded to Procurement for delivery!');
                loadNotificationsSection(); 
            } else {
                alert('❌ Failed to approve final accounts: ' + result.message);
            }
        } catch (error) {
            console.error('Error approving final accounts:', error);
            alert('An error occurred. Please try again.');
        }
    }


      function setStep(stepNumber) {
    const container = document.getElementById('assets') || document.getElementById('assetsSubContent');
    container.innerHTML = `
        <button onclick="loadAssetsMenu()" class="back-button">← Back to Assets Management</button>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin-bottom:0;">Assets List</h2>
            <button onclick="showAddAssetForm()" class="add-button">+ Add New Asset</button>
        </div>
        <div class="search-bar-container">
            <input type="text" id="assetSearch" placeholder="Search for assets by name or tag..." oninput="filterAssets()">
        </div>
        <div id="assetsListContainer" class="assets-list-container">
            <p style="text-align:center; color: #ccc;">Loading assets...</p>
        </div>
    `;
    fetchAssets();
    populateAssetOwnerDropdown();
}
function setStep(stepNumber) {
        document.getElementById('step1').style.display = (stepNumber === 1) ? 'block' : 'none';
        document.getElementById('step2').style.display = (stepNumber === 2) ? 'block' : 'none';
    }
async function approveIndentFromProcurement(indentId) {
        const procurementItems = [];
        const rows = document.querySelectorAll('#procurementDetailsTableBody tr');
        rows.forEach(row => {
            const costInput = row.querySelector('[name="cost"]');
            const cost = parseFloat(costInput.value) || 0;
            
            const vendorName = row.querySelector('[name="vendorName"]').value.trim();
            const vendorAddress = row.querySelector('[name="vendorAddress"]').value.trim();
            const contactNo = row.querySelector('[name="contactNo"]').value.trim();
            const mailId = row.querySelector('[name="mailId"]').value.trim();
            const edd = row.querySelector('[name="edd"]').value.trim();
            const vendorGst = row.querySelector('[name="vendorGst"]').value.trim();
            
            // Save vendor to database if we have vendor details
            if (vendorName && (vendorAddress || contactNo || mailId || edd || vendorGst)) {
                const vendorData = {
                    name: vendorName,
                    address: vendorAddress,
                    contactNo: contactNo,
                    mailId: mailId,
                    edd: edd,
                    gst: vendorGst
                };
                saveVendorToDatabase(vendorData);
            }
            
            procurementItems.push({
                itemName: row.querySelector('[name="itemName"]').value,
                vendorName: vendorName,
                vendorAddress: vendorAddress,
                cost: cost,
                contactNo: contactNo,
                mailId: mailId,
                edd: row.querySelector('[name="edd"]').value,
                vendorGst: vendorGst,
            });
        });

        if (procurementItems.some(item => !item.itemName || !item.vendorName || !item.cost)) {
            alert('Please fill in all required procurement details.');
            return;
        }

        try {
            const response = await fetch(`/api/asset_requests/${indentId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'Procurement', data: { procurement_items: procurementItems } })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('✅ Procurement details saved and sent to Team Lead for final approval!');
                loadNotificationsSection();
            } else {
                alert('❌ Failed to update procurement details: ' + result.message);
            }
        } catch (error) {
            console.error('Error updating procurement details:', error);
            alert('An error occurred. Please try again.');
        }
    }

    async function approveProcurementType(indentId) {
        const procurementType = document.getElementById('procurementType').value;

        if (!procurementType) {
            alert('Please select a Type of Procurement.');
            return;
        }

        try {
            const response = await fetch(`/api/asset_requests/${indentId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    role: 'Procurement', 
                    data: { 
                        procurementType: procurementType
                    } 
                })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('✅ Procurement type saved and sent to Accounts!');
                loadNotificationsSection();
            } else {
                alert('❌ Failed to update procurement type: ' + result.message);
            }
        } catch (error) {
            console.error('Error updating procurement type:', error);
            alert('An error occurred. Please try again.');
        }
    }

    async function finalApproveFromTL(indentId) {
    const approvalProcurement = document.getElementById('approvalProcurement').value;
    const finalizedVendor = document.getElementById('finalizedVendor').value;

    if (!approvalProcurement || !finalizedVendor) {
        alert('Please provide your final approval and finalize the vendor.');
        return;
    }

    try {
        const response = await fetch(`/api/asset_requests/${indentId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                role: 'Team Lead', // Corrected role
                data: {
                    approval_procurement: approvalProcurement, 
                    finalized_vendor: finalizedVendor
                } 
            })
        });
        const result = await response.json();
        if (result.status === 'success') {
            alert('✅ Final Team Lead approval granted. Request forwarded for managing director approval!'); 
            loadNotificationsSection();
        } else {
            alert('❌ Failed to grant final approval: ' + result.message);
        }
    } catch (error) {
        console.error('Error with final TL approval:', error);
        alert('An error occurred. Please try again.');
    }
}
async function finalApproveFromMD(indentId) {
    const piApproval = document.getElementById('piApproval').checked;
    const pdApproval = document.getElementById('pdApproval').checked;
    const chairmanApproval = document.getElementById('chairmanApproval').checked;
    const chairmanComments = document.getElementById('chairmanComments').value;

    const finalData = {
        pi_approval: piApproval,
        pd_approval: pdApproval,
        chairman_approval: chairmanApproval,
        chairman_comments: chairmanComments
    };

    if (!chairmanApproval && !piApproval && !pdApproval) {
        alert('Please provide at least one level of approval.');
        return;
    }

    try {
        const response = await fetch(`/api/asset_requests/${indentId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: 'Managing Director', data: finalData })
        });
        const result = await response.json();
        if (result.status === 'success') {
            alert('✅ Request finalized and updated!');
            loadNotificationsSection();
        } else {
            alert('❌ Failed to finalize request: ' + result.message);
        }
    } catch (error) {
        console.error('Error finalizing request:', error);
        alert('An error occurred. Please try again.');
    }
}
async function finalApproveFromAccounts(indentId) {
        const budgetAllocation = document.getElementById('budgetAllocation').value;
        const budgetUtilized = document.getElementById('budgetUtilized').value;
        const availableBalance = document.getElementById('availableBalance').value;
        const fundsAvailableString = document.getElementById('fundsAvailable').value;
        const procurementType = document.getElementById('procurementType').value;
        const accountNo = document.getElementById('accountNo').value;
        const ifscCode = document.getElementById('ifscCode').value;
        const branchName = document.getElementById('branchName').value;
        const accountHolderName = document.getElementById('accountHolderName').value;

        // Correctly convert the string value to a boolean
        const fundsAvailableBoolean = fundsAvailableString === 'true';

        const accountsData = {
            budgetAllocation: budgetAllocation,
            budgetUtilized: budgetUtilized,
            availableBalance: availableBalance,
            fundsAvailable: fundsAvailableBoolean,
            procurementType: procurementType,
            accountNo: accountNo,
            ifscCode: ifscCode,
            branchName: branchName,
            accountHolderName: accountHolderName,
        };

        try {
            const response = await fetch(`/api/asset_requests/${indentId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'Accounts', data: accountsData })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('✅ Accounts details saved. The request has been forwarded to Procurement for final delivery.');
                loadNotificationsSection();
            } else {
                alert('❌ Failed to update accounts details: ' + result.message);
            }
        } catch (error) {
            console.error('Error updating accounts details:', error);
            alert('An error occurred. Please try again.');
        }
    }
    async function rejectIndent(indentId, role) {
        const comments = prompt("Please provide a reason for rejection:");
        if (!comments) {
            return; // Do nothing if user cancels or enters no text
        }
        try {
            const response = await fetch(`/api/asset_requests/${indentId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: role, comments: comments })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('✅ Indent request rejected successfully.');
                loadPendingIndents(); // Reload the notifications list
            } else {
                alert('❌ Failed to reject indent: ' + result.message);
            }
        } catch (error) {
            console.error('Error rejecting indent:', error);
            alert('An error occurred. Please try again.');
        }
    }

      function toggleProjectDropdown() {
        const projectType = document.getElementById('officeProjectType').value;
        document.getElementById('projectSelectContainer').style.display = projectType === 'Project' ? 'flex' : 'none';
      }

      function recalculateTotal(row) {
        const cost = parseFloat(row.querySelector('[name="tentativeCost"]').value) || 0;
        const qty = parseFloat(row.querySelector('[name="qty"]').value) || 0;
        const taxInput = row.querySelector('[name="tax"]');
        const taxValue = taxInput ? taxInput.value.replace(/[+\-]/g, '') : '0';
        const tax = parseFloat(taxValue) || 0;
        const taxTypeSelect = row.querySelector('[name="taxType"]');
        const taxType = taxTypeSelect ? taxTypeSelect.value : 'add';
        const totalInput = row.querySelector('[name="total"]');
        
        if (cost && qty) {
            let itemTotal = cost * qty;
            if (tax > 0) {
                if (taxType === 'add') {
                    itemTotal = itemTotal * (1 + tax / 100);
                } else if (taxType === 'deduct') {
                    itemTotal = itemTotal * (1 - tax / 100);
                }
            }
            totalInput.value = itemTotal.toFixed(2);
        } else {
            totalInput.value = '';
        }
        
        // Calculate and update grand total
        calculateGrandTotal();
      }

      function updateTaxSymbol(taxTypeSelect) {
        const taxInput = taxTypeSelect.closest('td').querySelector('[name="tax"]');
        if (taxInput) {
            const taxType = taxTypeSelect.value;
            const currentValue = taxInput.value;
            
            // Remove any existing symbols
            const numericValue = currentValue.replace(/[+\-]/g, '');
            
            if (taxType === 'add' && numericValue) {
                taxInput.value = '+' + numericValue;
            } else if (taxType === 'deduct' && numericValue) {
                taxInput.value = '-' + numericValue;
            } else {
                taxInput.value = numericValue;
            }
            
            // Trigger recalculation
            const row = taxInput.closest('tr');
            if (row) {
                recalculateTotal(row);
            }
        }
      }

      function calculateGrandTotal() {
        const tableBody = document.getElementById('itemDetailsTableBody');
        if (!tableBody) return;
        
        let subtotal = 0;
        const rows = tableBody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const totalInput = row.querySelector('[name="total"]');
            if (totalInput && totalInput.value) {
                subtotal += parseFloat(totalInput.value) || 0;
            }
        });
        
        // Get discount amount
        const discountInput = document.getElementById('discountAmount');
        const discount = discountInput ? parseFloat(discountInput.value) || 0 : 0;
        
        // Calculate final total
        const finalTotal = Math.max(0, subtotal - discount);
        
        // Update the display
        const grandTotalElement = document.getElementById('grandTotalDisplay');
        if (grandTotalElement) {
            // Check if it's the new format with multiple lines
            const subtotalElement = grandTotalElement.querySelector('div:first-child');
            const discountElement = document.getElementById('discountDisplay');
            const finalTotalElement = document.getElementById('finalTotalDisplay');
            
            if (subtotalElement && discountElement && finalTotalElement) {
                // New format with subtotal, discount, and final total
                subtotalElement.textContent = `Subtotal: ₹${subtotal.toFixed(2)}`;
                discountElement.textContent = `Discount: -₹${discount.toFixed(2)}`;
                finalTotalElement.textContent = `Grand Total: ₹${finalTotal.toFixed(2)}`;
            } else {
                // Old format - just grand total
                grandTotalElement.textContent = `Grand Total: ₹${finalTotal.toFixed(2)}`;
            }
        }
      }

      function addItemRow() {
        const tableBody = document.getElementById('itemDetailsTableBody');
        const newRowIndex = tableBody.rows.length + 1;
        const newRowHtml = `
            <tr>
                <td>${newRowIndex}</td>
                <td style="min-width: 200px;"><input type="text" name="name" placeholder="Item Name"></td>
                <td style="min-width: 200px;"><input type="text" name="brand" placeholder="Brand"></td>
                <td style="min-width: 200px;"><input type="text" name="vendor" placeholder="Vendor"></td>
                <td style="min-width: 150px;"><input type="number" name="tentativeCost" placeholder="Cost"></td>
                <td style="min-width: 100px;"><input type="number" name="qty" placeholder="Qty"></td>
                <td style="min-width: 150px;">
                    <div style="display: flex; gap: 5px;">
                        <select name="taxType" style="width: 60px; padding: 4px; border: 1px solid #444; border-radius: 3px; background: #333; color: white;" onchange="updateTaxSymbol(this)">
                            <option value="add">Add</option>
                            <option value="deduct">Deduct</option>
                        </select>
                        <input type="number" name="tax" placeholder="%" value="0" style="width: 60px; padding: 4px; border: 1px solid #444; border-radius: 3px; background: #333; color: white;" oninput="updateTaxSymbol(this.closest('td').querySelector('[name=\"taxType\"]'))">
                    </div>
                </td>
                <td style="min-width: 150px;"><input type="text" name="total" readonly disabled></td>
                <td style="min-width: 170px;"><input type="date" name="requiredBy"></td>
                <td style="min-width: 150px;"><input type="text" name="warranty" placeholder="Warranty"></td>
                <td style="min-width: 200px;"><input type="text" name="remarks" placeholder="Remarks"></td>
                <td style="min-width: 100px;"><button type="button" class="btn btn-danger btn-sm" onclick="deleteItemRow(this)">Delete</button></td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', newRowHtml);
        
        // Add event listener to the new row for automatic calculation
        const newRow = tableBody.lastElementChild;
        newRow.addEventListener('input', (e) => {
            if (['tentativeCost', 'qty', 'tax', 'taxType'].includes(e.target.name)) {
                recalculateTotal(newRow);
            }
        });
    }

      function deleteItemRow(button) {
        if (document.getElementById('itemDetailsTableBody').rows.length > 1) {
          button.closest('tr').remove();
          // Recalculate grand total after deletion
          calculateGrandTotal();
        }
      }
      function addProcurementRow() {
        const tableBody = document.getElementById('procurementDetailsTableBody');
        const newRowIndex = tableBody.rows.length + 1;
        const newRowHtml = `
            <tr>
                <td>${newRowIndex}</td>
                <td style="min-width: 200px;"><input type="text" name="itemName" placeholder="Item Name"></td>
                <td style="min-width: 200px;">
                    <div class="vendor-dropdown-container" style="position: relative; width: 100%;">
                        <input type="text" name="vendorName" placeholder="Type or select vendor name" required 
                               oninput="onVendorInput(this)" onblur="saveVendorFromRow(this.closest('tr'))" 
                               onfocus="showVendorDropdown(this)" onkeydown="handleVendorKeydown(event, this)"
                               style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; background: white; color: black;">
                        <div id="vendorDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 150px; overflow-y: auto; z-index: 1000; display: none;">
                            ${generateVendorDropdownOptions()}
                        </div>
                    </div>
                </td>
                <td style="min-width: 250px;"><input type="text" name="vendorAddress" placeholder="Vendor Address" onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td style="min-width: 150px;"><input type="number" name="cost" placeholder="Cost"></td>
                <td style="min-width: 180px;"><input type="text" name="contactNo" placeholder="Contact No." onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td style="min-width: 200px;"><input type="email" name="mailId" placeholder="Mail ID" onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td style="min-width: 170px;"><input type="date" name="edd" onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td style="min-width: 180px;"><input type="text" name="vendorGst" placeholder="Vendor GST" onchange="saveVendorFromRow(this.closest('tr'))"></td>
                <td style="min-width: 200px;"><input type="file" name="quoteFile"></td>
                <td style="min-width: 100px;"><button type="button" class="btn btn-danger btn-sm" onclick="deleteProcurementRow(this)">Delete</button></td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', newRowHtml);
    }
    function deleteProcurementRow(button) {
        const row = button.closest('tr');
        if (document.getElementById('procurementDetailsTableBody').rows.length > 1) {
            row.remove();
        }
    }

      async function submitIndentForm() {
        const form = document.getElementById('newIndentForm');
        const formData = {
            indenterName: form.querySelector('#indenterName').value,
            officeProjectType: form.querySelector('#officeProjectType').value,
            projectId: form.querySelector('#projectSelect').value || null,
            teamLeadId: form.querySelector('#teamLeadSelect').value || null,
            referenceFileNo: form.querySelector('#referenceFileNo').value,
            purchaseType: form.querySelector('#purchaseType').value,
            budgetHead: form.querySelector('#budgetHead').value,
            natureOfExpenditure: form.querySelector('#natureOfExpenditure').value,
            gstApplicable: form.querySelector('#gstApplicable').value,
            discountAmount: parseFloat(document.getElementById('discountAmount').value) || 0,
            itemDetails: [],
        };
        
        const rows = form.querySelectorAll('#itemDetailsTableBody tr');
        rows.forEach(row => {
            formData.itemDetails.push({
                name: row.querySelector('[name="name"]').value,
                brand: row.querySelector('[name="brand"]').value,
                vendor: row.querySelector('[name="vendor"]').value,
                tentativeCost: parseFloat(row.querySelector('[name="tentativeCost"]').value) || 0,
                qty: parseInt(row.querySelector('[name="qty"]').value) || 0,
                tax: parseFloat(row.querySelector('[name="tax"]').value.replace(/[+\-]/g, '')) || 0,
                taxType: row.querySelector('[name="taxType"]').value,
                total: parseFloat(row.querySelector('[name="total"]').value) || 0,
                requiredBy: row.querySelector('[name="requiredBy"]').value,
                warranty: row.querySelector('[name="warranty"]').value,
                remarks: row.querySelector('[name="remarks"]').value,
            });
        });

        try {
            const response = await fetch('/api/asset_requests', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('✅ Indent request submitted successfully!');
                loadIndentsSection();
            } else {
                alert('❌ Failed to submit indent: ' + result.message);
            }
        } catch (error) {
            console.error('Error submitting indent:', error);
            alert('An error occurred. Please try again.');
        }
    }












      // ==================================================================
      // 4. settings MODULE
      // ==================================================================
// START: Settings Module JavaScript
function loadSettingsPage(title) {
    const settingsContainer = document.getElementById('settings');
    if (!settingsContainer) {
        console.error("Settings container not found.");
        return;
    }
    
    // The main settings page content is already in the HTML.
    // So, we only need to load content for sub-pages.
    if (title === 'Appearance') {
        const appearanceHtml = `
            <div class="salaries-container" style="max-width: 600px; padding: 20px;">
                <h2 style="margin-bottom: 20px;">🎨 Appearance Settings</h2>
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 16px;">
                    <span onclick="loadSettingsPage('main')" style="font-size: 26px; color: #fff; cursor: pointer; padding: 6px 12px;position:relative;right:0px;">✖️</span>
                </div>
                <div style="max-width: 950px;">
                    ${appearanceCard('Mode', `<select class="appearance-select" id="modeSelector" onchange="applyMode()"><option value="light">Light</option><option value="dark">Dark</option></select>`)}
                    ${appearanceCard('Side Panel Position', `<select class="appearance-select" id="sidePanelSelector" onchange="applySidePanelPosition()"><option value="left">Show on left</option><option value="right">Show on right</option></select>`)}
                    ${appearanceCard('Font Size', `<select class="appearance-select" id="fontSizeSelector" onchange="applyFontSize()"><option value="small">Small</option><option value="medium" selected>Medium</option><option value="large">Large</option></select>`)}
                    
                    <div class="appearance-card" id="customize-fonts-card">
                        <div class="appearance-label" style="cursor: pointer;">
                            <span>Customize Fonts</span>
                            <span id="customize-fonts-arrow" style="font-size: 18px; line-height: 1;">▶</span>
                        </div>
                        <div id="customize-fonts-content" class="appearance-content">
                            <ul id="font-list">
                            </ul>
                        </div>
                    </div>
                    
                    <div class="appearance-card" id="background-card">
                        <div class="appearance-label" style="cursor: pointer;">
                            <span>Background</span>
                            <span id="background-arrow" style="font-size: 18px; line-height: 1;">▶</span>
                        </div>
                        <div id="background-content" class="appearance-content">
                            <ul id="background-video-list">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>`;
        settingsContainer.innerHTML = appearanceHtml;
        
        // Font Customization Logic
        const customizeFontsCard = document.getElementById('customize-fonts-card');
        const customizeFontsContent = document.getElementById('customize-fonts-content');
        const fontList = document.getElementById('font-list');
        const customizeFontsArrow = document.getElementById('customize-fonts-arrow');

        const availableFonts = [
            'Arial, sans-serif',
            'Verdana, sans-serif',
            'Helvetica, sans-serif',
            'Times New Roman, serif',
            'Courier New, monospace',
            'Georgia, serif',
            'Palatino, serif',
            'Garamond, serif',
            'Trebuchet MS, sans-serif',
            'Impact, sans-serif'
        ];

        if (customizeFontsCard && customizeFontsContent && fontList) {
            customizeFontsCard.addEventListener('click', function() {
                const isOpen = customizeFontsContent.style.display === 'block';
                customizeFontsContent.style.display = isOpen ? 'none' : 'block';
                customizeFontsArrow.textContent = isOpen ? '▶' : '▼';

                if (!isOpen) {
                    fontList.innerHTML = '';
                    availableFonts.forEach(fontName => {
                        const listItem = document.createElement('li');
                        const displayName = fontName.split(',')[0].replace(/"/g, '');
                        listItem.textContent = displayName;
                        listItem.style.fontFamily = fontName;
                        fontList.appendChild(listItem);
                    });
                }
            });

            fontList.addEventListener('click', function(event) {
                if (event.target.tagName === 'LI') {
                    const selectedFont = event.target.style.fontFamily;
                    document.body.style.fontFamily = selectedFont;
                    localStorage.setItem('erpFont', selectedFont);
                    customizeFontsContent.style.display = 'none';
                    customizeFontsArrow.textContent = '▶';
                }
            });
        }

        // Background Video Customization Logic
        const backgroundCard = document.getElementById('background-card');
        const backgroundContent = document.getElementById('background-content');
        const backgroundVideoList = document.getElementById('background-video-list');
        const backgroundArrow = document.getElementById('background-arrow');

        const videoFiles = ['admindb.mp4', 'bg1.mp4', 'bg2.mp4', 'bg3.mp4', 'bg4.mp4', 'bg5.mp4', 'bg6.mp4', 'bg7.mp4', 'bg8.mp4', 'bg9.mp4', 'bg10.mp4', 'bg11.mp4'];

        if (backgroundCard && backgroundContent && backgroundVideoList) {
            backgroundCard.addEventListener('click', function() {
                const isOpen = backgroundContent.style.display === 'block';
                backgroundContent.style.display = isOpen ? 'none' : 'block';
                backgroundArrow.textContent = isOpen ? '▶' : '▼';

                if (!isOpen) {
                    backgroundVideoList.innerHTML = '';
                    videoFiles.forEach(videoFile => {
                        if (videoFile !== 'admindb.mp4') {
                            const videoId = videoFile.split('.')[0];
                            const listItem = document.createElement('li');
                            listItem.textContent = `Background ${videoId.replace('bg', '')}`;
                            listItem.dataset.videoSrc = `/static/videos/${videoFile}`;
                            backgroundVideoList.appendChild(listItem);
                        }
                    });
                }
            });

            backgroundVideoList.addEventListener('click', function(event) {
                if (event.target.tagName === 'LI') {
                    const selectedVideoSrc = event.target.dataset.videoSrc;
                    applyBackgroundVideo(selectedVideoSrc);
                    localStorage.setItem('erpBackgroundVideo', selectedVideoSrc);
                    
                    backgroundContent.style.display = 'none';
                    backgroundArrow.textContent = '▶';
                }
            });
        }
    } else if (title === 'Profile Settings') {
        const profileSettingsHtml = `
            <div class="salaries-container" style="max-width: 600px; padding: 20px;">
                <h2 style="margin-bottom: 20px;">👤 Profile Settings</h2>
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 16px;">
                    <span onclick="loadSettingsPage('main')" style="font-size: 26px; color: #fff; cursor: pointer; padding: 6px 12px;position:relative;right:0px;">✖️</span>
                </div>
                <div class="appearance-card" id="profile-card" onclick="toggleDropdown('profile-content')">
                    <div class="appearance-label">
                        <span>Account Actions</span>
                        <span class="toggle-icon">▶</span>
                    </div>
                    <div id="profile-content" class="settings-dropdown">
                        <div onclick="openChangePasswordModal()">Change Password</div>
                    </div>
                </div>
            </div>`;
        settingsContainer.innerHTML = profileSettingsHtml;
    }
    // Handle other settings pages here, e.g., 'Sidebar', 'Notifications'
    else {
        // Fallback for other pages or to return to the main settings view
        settingsContainer.innerHTML = `
            <h2 style="margin-bottom: 20px;">⚙️ Settings</h2>
            <div id="settings-main-content">
                <div onclick="loadSettingsPage('Appearance')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.08); padding: 16px 22px; border-radius: 8px; margin-top: 14px;"><span style="color: white; font-size: 17px;">Appearance</span><span style="color: white; font-size: 18px;">▶</span></div>
                <div onclick="loadSettingsPage('Profile Settings')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.08); padding: 16px 22px; border-radius: 8px; margin-top: 14px;"><span style="color: white; font-size: 17px;">Profile Settings</span><span style="color: white; font-size: 18px;">▶</span></div>
                <div onclick="resetAllSettings()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,0,0,0.2); padding: 16px 22px; border-radius: 8px; margin-top: 14px; border: 1px solid rgba(255,0,0,0.3);"><span style="color: #ff6b6b; font-size: 17px;">Undo All Settings</span><span style="color: #ff6b6b; font-size: 18px;">↻</span></div>
            </div>`;
    }
}

// Helper function for the appearance cards
function appearanceCard(title, html) {
    const id = title.replace(/\s+/g, '-').toLowerCase();
    return `<div class="appearance-card"><div class="appearance-label" onclick="toggleAppearance('${id}')">${title} <span id="${id}-arrow">▶</span></div><div class="appearance-content" id="${id}-content" onclick="event.stopPropagation();">${html}</div></div>`;
}

// Helper function to toggle the appearance dropdowns
function toggleAppearance(id) {
    const content = document.getElementById(`${id}-content`);
    const arrow = document.getElementById(`${id}-arrow`);
    const open = content.style.display === 'block';
    content.style.display = open ? 'none' : 'block';
    arrow.textContent = open ? '▶' : '▼';
}

// Function to apply the selected theme mode
function applyMode() {
    const mode = document.getElementById('modeSelector').value;
    localStorage.setItem('selectedMode', mode);
    const body = document.body;
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main');
    const topbar = document.querySelector('.topbar');
    const bgVideo = document.getElementById('bgVideo');

    // Define colors using a custom property if not already defined
    document.documentElement.style.setProperty('--dark-bg', mode === 'dark' ? '#0a192f' : '#ffffff');
    document.documentElement.style.setProperty('--light-bg', mode === 'dark' ? '#112240' : '#f0f0f0');
    document.documentElement.style.setProperty('--lightest-bg', mode === 'dark' ? '#233554' : '#e0e0e0');
    document.documentElement.style.setProperty('--text-primary', mode === 'dark' ? '#ccd6f6' : '#333333');
    document.documentElement.style.setProperty('--text-secondary', mode === 'dark' ? '#8892b0' : '#555555');
    document.documentElement.style.setProperty('--accent', mode === 'dark' ? '#64ffda' : '#007bff');
    document.documentElement.style.setProperty('--accent-tint', mode === 'dark' ? 'rgba(100, 255, 218, 0.1)' : 'rgba(0, 123, 255, 0.1)');

    body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--dark-bg');
    body.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');

    if (bgVideo) {
        bgVideo.style.display = mode === 'dark' ? 'block' : 'none';
    }
    
    // Update colors of specific elements to match the new mode
    document.querySelectorAll('.widget h3::before').forEach(el => {
        el.style.backgroundColor = mode === 'dark' ? '#64ffda' : '#007bff';
    });
}


// Function to apply the selected side panel position
function applySidePanelPosition() {
    const position = document.getElementById('sidePanelSelector').value;
    localStorage.setItem('sidePanelPosition', position);
    const sidebar = document.querySelector('.sidebar');
    const main = document.querySelector('.main');
    const topbar = document.querySelector('.topbar');
    if (position === 'right') {
        sidebar.style.left = 'auto';
        sidebar.style.right = '0';
        main.style.marginLeft = '0';
        main.style.marginRight = '230px';
        topbar.style.left = '0';
        topbar.style.right = '230px';
        sidebar.style.borderRight = 'none';
        sidebar.style.borderLeft = '1px solid var(--lightest-bg)';
        
        // Enable sidebar toggle functionality for right position
        localStorage.setItem('sidebarToggleEnabled', 'true');
    } else {
        sidebar.style.left = '0';
        sidebar.style.right = 'auto';
        main.style.marginLeft = '230px';
        main.style.marginRight = '0';
        topbar.style.left = '230px';
        topbar.style.right = '0';
        sidebar.style.borderLeft = 'none';
        sidebar.style.borderRight = '1px solid var(--lightest-bg)';
        
        // Disable sidebar toggle functionality for left position
        localStorage.setItem('sidebarToggleEnabled', 'false');
    }
}

// Function to toggle sidebar visibility
function toggleSidebar() {
    const sidebarToggleEnabled = localStorage.getItem('sidebarToggleEnabled') === 'true';
    if (!sidebarToggleEnabled) return;
    
    const sidebar = document.querySelector('.sidebar');
    const main = document.querySelector('.main');
    const topbar = document.querySelector('.topbar');
    
    if (sidebar.style.display === 'none') {
        // Show sidebar
        sidebar.style.display = 'block';
        main.style.marginRight = '230px';
        topbar.style.right = '230px';
    } else {
        // Hide sidebar
        sidebar.style.display = 'none';
        main.style.marginRight = '0';
        topbar.style.right = '0';
    }
}

// Function to apply the selected font size
function applyFontSize() {
    const size = document.getElementById('fontSizeSelector').value;
    localStorage.setItem('fontSize', size);
    let fontSizeValue;
    switch (size) {
        case 'small':
            fontSizeValue = '13px';
            break;
        case 'medium':
            fontSizeValue = '15px';
            break;
        case 'large':
            fontSizeValue = '17px';
            break;
        default:
            fontSizeValue = '15px';
            break;
    }
    document.body.style.fontSize = fontSizeValue;
}

// Function to apply the selected background video
function applyBackgroundVideo(videoSrc) {
    const bgVideo = document.getElementById('bgVideo');
    if (bgVideo) {
        bgVideo.src = videoSrc;
        bgVideo.load();
        bgVideo.play().catch(e => console.log('Video play failed:', e));
    }
}

// Function to load saved settings on page load
function loadSavedSettings() {
    // Load sidebar position
    const savedPosition = localStorage.getItem('sidePanelPosition');
    if (savedPosition) {
        const sidebar = document.querySelector('.sidebar');
        const main = document.querySelector('.main');
        const topbar = document.querySelector('.topbar');
        const hamburger = document.getElementById('hamburger');
        
        if (savedPosition === 'right') {
            sidebar.style.left = 'auto';
            sidebar.style.right = '0';
            main.style.marginLeft = '0';
            main.style.marginRight = '230px';
            topbar.style.left = '0';
            topbar.style.right = '230px';
            sidebar.style.borderRight = 'none';
            sidebar.style.borderLeft = '1px solid var(--lightest-bg)';
            
            
            // Enable sidebar toggle functionality for right position
            localStorage.setItem('sidebarToggleEnabled', 'true');
        } else {
            sidebar.style.left = '0';
            sidebar.style.right = 'auto';
            main.style.marginLeft = '230px';
            main.style.marginRight = '0';
            topbar.style.left = '230px';
            topbar.style.right = '0';
            sidebar.style.borderLeft = 'none';
            sidebar.style.borderRight = '1px solid var(--lightest-bg)';
            
            
            // Disable sidebar toggle functionality for left position
            localStorage.setItem('sidebarToggleEnabled', 'false');
        }
    }
    
    // Load font size
    const savedFontSize = localStorage.getItem('fontSize');
    if (savedFontSize) {
        let fontSizeValue;
        switch (savedFontSize) {
            case 'small':
                fontSizeValue = '13px';
                break;
            case 'medium':
                fontSizeValue = '15px';
                break;
            case 'large':
                fontSizeValue = '17px';
                break;
            default:
                fontSizeValue = '15px';
                break;
        }
        document.body.style.fontSize = fontSizeValue;
    }
    
    // Load background video
    const savedBackgroundVideo = localStorage.getItem('erpBackgroundVideo');
    if (savedBackgroundVideo) {
        const bgVideo = document.getElementById('bgVideo');
        if (bgVideo) {
            bgVideo.src = savedBackgroundVideo;
            bgVideo.load();
            bgVideo.play().catch(e => console.log('Video play failed:', e));
        }
    }
    
    // Load font family
    const savedFont = localStorage.getItem('erpFont');
    if (savedFont) {
        document.body.style.fontFamily = savedFont;
    }
}

// Function to reset all settings to default
function resetAllSettings() {
    if (confirm('Are you sure you want to reset all settings to default? This action cannot be undone.')) {
        // Clear all localStorage settings
        localStorage.removeItem('selectedMode');
        localStorage.removeItem('sidePanelPosition');
        localStorage.removeItem('sidebarToggleEnabled');
        localStorage.removeItem('fontSize');
        localStorage.removeItem('erpFont');
        localStorage.removeItem('erpBackgroundVideo');
        
        // Reset to default values
        const sidebar = document.querySelector('.sidebar');
        const main = document.querySelector('.main');
        const topbar = document.querySelector('.topbar');
        const hamburger = document.getElementById('hamburger');
        
        // Reset sidebar position to left
        sidebar.style.left = '0';
        sidebar.style.right = 'auto';
        main.style.marginLeft = '230px';
        main.style.marginRight = '0';
        topbar.style.left = '230px';
        topbar.style.right = '0';
        sidebar.style.borderLeft = 'none';
        sidebar.style.borderRight = '1px solid var(--lightest-bg)';
        
        // Reset hamburger menu position
        if (hamburger) {
            hamburger.style.left = '30px';
            hamburger.style.right = 'auto';
            hamburger.style.display = 'block';
        }
        
        // Reset font size
        document.body.style.fontSize = '15px';
        
        // Reset background video
        const bgVideo = document.getElementById('bgVideo');
        if (bgVideo) {
            bgVideo.src = '/static/videos/mdbbg.mp4';
            bgVideo.load();
            bgVideo.play().catch(e => console.log('Video play failed:', e));
        }
        
        alert('All settings have been reset to default values!');
        
        // Reload the page to ensure all changes take effect
        window.location.reload();
    }
}

// END: Settings Module JavaScript



//--------------------------
//Salaries
//---------------------------
function toggleIndividualDropdown(contentId) {
         const content = document.getElementById(contentId);
         const header = content.previousElementSibling;
         const toggleIcon = header.querySelector('.toggle-icon');
         
         console.log('Before toggle:', contentId, 'collapsed:', content.classList.contains('collapsed'));
         
         content.classList.toggle('collapsed');
         header.classList.toggle('collapsed');
         
         console.log('After toggle:', contentId, 'collapsed:', content.classList.contains('collapsed'));
         
         // Update the arrow icon and inline styles
         if (content.classList.contains('collapsed')) {
           toggleIcon.textContent = '▼';
           toggleIcon.style.transform = 'rotate(0deg)';
           content.style.display = 'none';
           content.style.maxHeight = '0';
           content.style.opacity = '0';
           content.style.overflow = 'hidden';
           console.log('Section collapsed, showing ▼');
         } else {
           toggleIcon.textContent = '▲';
           toggleIcon.style.transform = 'rotate(0deg)';
           content.style.display = 'block';
           content.style.maxHeight = '400px';
           content.style.opacity = '1';
           content.style.overflow = 'auto';
           console.log('Section expanded, showing ▲');
         }
       }
       
       // Main Salaries Functions
       function toggleMainDropdown(contentId) {
         const content = document.getElementById(contentId);
         const header = content.previousElementSibling;
         const toggleIcon = header.querySelector('.toggle-icon');
         
         console.log('Before toggle main:', contentId, 'collapsed:', content.classList.contains('collapsed'));
         
         content.classList.toggle('collapsed');
         header.classList.toggle('collapsed');
         
         console.log('After toggle main:', contentId, 'collapsed:', content.classList.contains('collapsed'));
         
         // Update the arrow icon and inline styles
         if (content.classList.contains('collapsed')) {
           toggleIcon.textContent = '▼';
           toggleIcon.style.transform = 'rotate(0deg)';
           content.style.display = 'none';
           content.style.maxHeight = '0';
           content.style.opacity = '0';
           content.style.overflow = 'hidden';
           console.log('Main section collapsed, showing ▼');
         } else {
           toggleIcon.textContent = '▲';
           toggleIcon.style.transform = 'rotate(0deg)';
           content.style.display = 'block';
           content.style.maxHeight = '400px';
           content.style.opacity = '1';
           content.style.overflow = 'auto';
           console.log('Main section expanded, showing ▲');
         }
      }

        // Employee Dropdown Functions
       // Employee Dropdown Functions
let employeeDropdownOpen = false;

async function populateEmployeeDropdown() {
    console.log('Populating employee dropdown...');
    const employeeSelect = document.getElementById('employeeNameSelect');
    
    if (!employeeSelect) {
        console.error('Employee select dropdown not found!');
        return;
    }
    
    try {
        // Fetch employees from User Info table
        console.log('Fetching employee data from /api/get_all_employee_info...');
        const response = await fetch('/api/get_all_employee_info');
        const data = await response.json();
        console.log('API response:', data);
        
        if (data.status === 'success' && data.employees) {
            console.log(`Found ${data.employees.length} employees from User Info`);
            employeeSelect.innerHTML = '<option value="">-- Select an Employee --</option>';
            data.employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.full_name;
                employeeSelect.appendChild(option);
            });
            
            employeeSelect.addEventListener('change', (event) => {
                const selectedEmployeeId = event.target.value;
                if (selectedEmployeeId) {
                    updateEmployeeInfo(selectedEmployeeId);
                } else {
                    resetSalariesForm();
                }
            });
            
            // Load the first employee by default
            if (data.employees.length > 0) {
                const firstEmployeeId = data.employees[0].id;
                employeeSelect.value = firstEmployeeId;
                updateEmployeeInfo(firstEmployeeId);
            } else {
                resetSalariesForm();
            }

        } else {
            console.error('Failed to load employees from User Info:', data.message);
            // Fallback to users API if employee info fails
            console.log('Trying fallback API /api/users...');
            const fallbackResponse = await fetch('/api/users');
            const fallbackData = await fallbackResponse.json();
            console.log('Fallback API response:', fallbackData);
            
            if (fallbackData.status === 'success' && fallbackData.users) {
                console.log(`Found ${fallbackData.users.length} users from fallback API`);
                employeeSelect.innerHTML = '<option value="">-- Select an Employee --</option>';
                fallbackData.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                employeeSelect.appendChild(option);
            });
            }
        }
    } catch (error) {
        console.error('Error fetching employees for dropdown:', error);
    }
}


function resetSalariesForm() {
    document.getElementById('employeeId').textContent = 'N/A';
    document.getElementById('employeeDesignation').textContent = 'N/A';
    document.getElementById('employeeAccount').textContent = 'N/A';
    
    const inputs = document.querySelectorAll('#earningsContent input, #deductionsContent input, #leavesContent input');
    inputs.forEach(input => {
        if (input.type === 'number') {
            input.value = '0.00';
        } else {
            input.value = '0';
        }
    });
    
    document.getElementById('totalEarnings').textContent = '0.00';
    document.getElementById('totalDeductions').textContent = '0.00';
    document.getElementById('netSalary').textContent = '0.00';
}

function updateEmployeeInfo(userId) {
        if (!userId) {
            resetSalariesForm();
            return;
        }

        fetch(`/api/get_employee_info/${userId}`)
        .then(res => res.json())
        .then(data => {
                if (data.status === 'success' && data.employee) {
                    const emp = data.employee;

                    // Update the top header details
                    document.getElementById('employeeId').textContent = `SSDEV-${emp.id.toString().padStart(2, '0')}-002`;
                    document.getElementById('employeeDesignation').textContent = emp.designation || 'N/A';
                    document.getElementById('employeeAccount').textContent = emp.account_number || 'N/A';

                    // Populate form fields with data
                    document.getElementById('actualGrossSalary').value = (emp.actual_gross_salary || 0).toFixed(2);
                    document.getElementById('basic').value = (emp.basic || 0).toFixed(2);
                    document.getElementById('hra').value = (emp.hra || 0).toFixed(2);
                    document.getElementById('conveyance').value = (emp.conveyance || 0).toFixed(2);
                    document.getElementById('specialAllowance').value = (emp.special_allowance || 0).toFixed(2);

                    // Populate other fields from backend or set to 0.00
                    document.getElementById('vehicleMaintenance').value = (emp.vehicle_maintenance || 0).toFixed(2);
                    document.getElementById('addOthersActuals').value = (emp.add_others || 0).toFixed(2);
                    document.getElementById('providentFund').value = (emp.provident_fund || 0).toFixed(2);
                    document.getElementById('esi').value = (emp.esi || 0).toFixed(2);
                    document.getElementById('professionalTax').value = (emp.professional_tax || 0).toFixed(2);
                    document.getElementById('incomeTax').value = (emp.income_tax || 0).toFixed(2);
                    document.getElementById('advance').value = (emp.advance || 0).toFixed(2);
                    document.getElementById('otherDeductions').value = (emp.other_deductions || 0).toFixed(2);
                    document.getElementById('lossOfPay').value = (emp.loss_of_pay || 0).toFixed(2);
                    document.getElementById('totalLeaves').value = emp.total_leaves || '0';
                    document.getElementById('leaveAvailed').value = emp.leave_availed || '0';
                    document.getElementById('balanceLeaves').value = emp.balance_leaves || '0';
                    document.getElementById('noOfLopDays').value = emp.no_of_lop_days || '0';
                    document.getElementById('totalDays').value = emp.total_days || '30';
                    document.getElementById('ndp').value = emp.ndp || '0';
                    
                    // Populate Earnings section fields (from separate earnings fields)
                    document.getElementById('earningsBasic').value = (emp.earnings_basic || emp.basic || 0).toFixed(2);
                    document.getElementById('earningsHra').value = (emp.earnings_hra || emp.hra || 0).toFixed(2);
                    document.getElementById('earningsConveyance').value = (emp.earnings_conveyance || emp.conveyance || 0).toFixed(2);
                    document.getElementById('earningsVehicleMaintenance').value = (emp.earnings_vehicle_maintenance || emp.vehicle_maintenance || 0).toFixed(2);
                    document.getElementById('earningsSpecialAllowance').value = (emp.earnings_special_allowance || emp.special_allowance || 0).toFixed(2);
                    document.getElementById('addOthersEarnings').value = (emp.earnings_add_others || emp.add_others || 0).toFixed(2);
                    
                    // Call calculateTotals() here to ensure the summary fields are updated.
                    calculateTotals();

                } else {
                    console.log('Employee data not found, trying fallback...');
                    // Fallback: try to get basic user info
                    fetch('/api/users')
                        .then(res => res.json())
                        .then(userData => {
                            if (userData.status === 'success' && userData.users) {
                                const user = userData.users.find(u => u.id == userId);
                                if (user) {
                                    document.getElementById('employeeId').textContent = `SSDEV-${user.id.toString().padStart(2, '0')}-002`;
                                    document.getElementById('employeeDesignation').textContent = user.designation || 'N/A';
                                    document.getElementById('employeeAccount').textContent = 'N/A';
                                    resetSalariesForm();
                                } else {
                                    resetSalariesForm();
                                }
                            } else {
                                resetSalariesForm();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching fallback user data:', error);
                            resetSalariesForm();
                        });
                }
            })
            .catch(error => {
                console.error('Error fetching employee data:', error);
                resetSalariesForm();
            });
    }








async function downloadPayslip() {
    console.log('downloadPayslip() function called');
    
    // Check if employee is selected
    const employeeSelect = document.getElementById('employeeNameSelect');
    if (!employeeSelect || !employeeSelect.value) {
        alert('❌ Please select an employee first!');
        return;
    }
    
    const selectedEmployeeId = employeeSelect.value;
    const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
    const employeeId = document.getElementById('employeeId').textContent;
    const designation = document.getElementById('employeeDesignation').textContent;
    const bankAc = document.getElementById('employeeAccount').textContent;
    
    // Fetch employee data to get PF No
    let pfNo = 'N/A';
    try {
        const response = await fetch(`/api/get_employee_info/${selectedEmployeeId}`);
        const data = await response.json();
        if (data.status === 'success' && data.employee) {
            pfNo = data.employee.pf_no || 'N/A';
        }
    } catch (error) {
        console.error('Error fetching employee data:', error);
    }
    
    console.log('Employee selected:', employeeName);
    
    // Get form values from Earnings section (as requested by user)
    const basic = document.getElementById('earningsBasic').value;
    const hra = document.getElementById('earningsHra').value;
    const conveyance = document.getElementById('earningsConveyance').value;
    const vehicleMaintenance = document.getElementById('earningsVehicleMaintenance').value;
    const specialAllowance = document.getElementById('earningsSpecialAllowance').value;
    const addOthersEarnings = document.getElementById('addOthersEarnings').value;
    const totalEarnings = parseFloat(document.getElementById('totalEarnings').textContent) || 0;
    
    const providentFund = parseFloat(document.getElementById('providentFund').value) || 0;
    const esi = parseFloat(document.getElementById('esi').value) || 0;
    const professionalTax = parseFloat(document.getElementById('professionalTax').value) || 0;
    const incomeTax = parseFloat(document.getElementById('incomeTax').value) || 0;
    const advance = parseFloat(document.getElementById('advance').value) || 0;
    const otherDeductions = parseFloat(document.getElementById('otherDeductions').value) || 0;
    const lossOfPay = parseFloat(document.getElementById('lossOfPay').value) || 0;
    const totalDeductions = parseFloat(document.getElementById('totalDeductions').textContent) || 0;

    const totalLeaves = document.getElementById('totalLeaves').value;
    const leaveAvailed = document.getElementById('leaveAvailed').value;
    const balanceLeaves = document.getElementById('balanceLeaves').value;
    const lopDays = document.getElementById('noOfLopDays').value;
    const totalDays = document.getElementById('totalDays').value || '30';
    const ndp = document.getElementById('ndp').value || '0';

    const netSalary = totalEarnings - totalDeductions;

    // Get current month and year for payslip title
    const now = new Date();
    const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE",
                       "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
    const currentMonth = monthNames[now.getMonth()];
    const currentYear = now.getFullYear();
    const payslipTitle = `PAYSLIP FOR THE MONTH OF ${currentMonth} - ${currentYear}`;

    // Determine watermark for individual payslip (default to SSEV watermark)
    const watermarkSrc = 'static/images/watermark-ssev.png';

    // Build the payslip HTML string
    const payslipHtml = `
    <div class="payslip-container" style="position: relative;">
        <!-- Watermark -->
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; display: flex; align-items: center; justify-content: center; background-image: url('${watermarkSrc}'); background-repeat: no-repeat; background-position: center; background-size: contain;">
        </div>
        
        <table class="payslip-header-table">
            <tr>
                <td style="width: 15%; border: none;">
                    <img src="static/images/logo.png" alt="Company Logo" class="payslip-logo">
                </td>
                <td style="width: 85%; border: none; padding: 0;">
                    <div class="company-name">SSEV SOFTWARE SOLUTIONS PRIVATE LIMITED</div>
                    <div class="company-details">Corporate office: #2-057/A/112, 1st Floor, VSS Nandadeep,<br>Near Medchal RTA Office, Petbasheerabad Village, Kompally Road,<br>Medchal District Telangana Hyderabad 500067.<br>Ph.040-35042301.</div>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="payslip-title" style="border-left: none; border-right: none;">${payslipTitle}</td>
            </tr>
        </table>
        
        <table class="payslip-main-table" style="margin-top: 20px;">
            <tr>
                <td style="width: 25%;">Employee No</td>
                <td style="width: 25%;">${employeeId || 'N/A'}</td>
                <td style="width: 25%;">Designation</td>
                <td style="width: 25%;">${designation || 'N/A'}</td>
            </tr>
            <tr>
                <td>Name</td>
                <td>${employeeName || 'N/A'}</td>
                <td>Total Days</td>
                <td>${totalDays || '30'}</td>
            </tr>
            <tr>
                <td>Bank A/c No</td>
                <td>${bankAc || 'N/A'}</td>
                <td>LOP</td>
                <td>${lopDays || '0'}</td>
            </tr>
            <tr>
                <td>PF No.</td>
                <td>${pfNo}</td>
                <td>Effective work days</td>
                <td>${ndp || '0'}</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: center;">Total Leaves : ${totalLeaves || '0'} | Leave Availed : ${leaveAvailed || '0'} | Balance : ${balanceLeaves || '0'}</td>
            </tr>
            <tr>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Earnings</th>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Deductions</th>
            </tr>
            <tr>
                <td>BASIC</td>
                <td>${basic || '0.00'}</td>
                <td>PF</td>
                <td>${providentFund || '0'}</td>
            </tr>
            <tr>
                <td>HRA</td>
                <td>${hra || '0.00'}</td>
                <td>ESI</td>
                <td>${esi || '0.00'}</td>
            </tr>
            <tr>
                <td>CONVEYANCE</td>
                <td>${conveyance || '0.00'}</td>
                <td>P. Tax</td>
                <td>${professionalTax || '0.00'}</td>
            </tr>
            <tr>
                <td>VEHICLE MAINTENANCE</td>
                <td>${vehicleMaintenance || '0.00'}</td>
                <td>Income Tax</td>
                <td>${incomeTax || '0.00'}</td>
            </tr>
            <tr>
                <td>SPL ALLOWANCE</td>
                <td>${specialAllowance || '0.00'}</td>
                <td>Advance</td>
                <td>${advance || '0.00'}</td>
            </tr>
            <tr>
                <td>Add Others</td>
                <td>${addOthersEarnings || '0.00'}</td>
                <td>Others Deduction</td>
                <td>${otherDeductions || '0.00'}</td>
            </tr>
            <tr>
                <td colspan="2" style="border: none;"></td>
                <td>Loss of Pay</td>
                <td>${lossOfPay || '0.00'}</td>
            </tr>
            <tr class="payslip-total-row">
                <td>Total Earnings</td>
                <td>${totalEarnings}</td>
                <td>Total Deduction</td>
                <td>${totalDeductions}</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: right; font-weight: bold; font-size: 12pt;">Net Salary: ${netSalary}</td>
            </tr>
        </table>
        
        <!-- System Generated Disclaimer -->
        <div style="margin-top: 20px; text-align: left; font-size: 10pt; color: #666;">
            It is System generated, Signature not required
        </div>
    </div>`;

    // Use html2pdf to generate the PDF
    const element = document.createElement('div');
    element.innerHTML = payslipHtml;

    console.log('Generating PDF payslip...');
    html2pdf().from(element).save('payslip.pdf');
    console.log('✅ Payslip PDF generated successfully!');
}

async function downloadSalarySheetByBranch(branchName) {
    try {
        const response = await fetch('/api/get_all_employee_info');
        const data = await response.json();

        if (data.status !== 'success' || !data.employees) {
            alert('❌ Failed to fetch employee data.');
            return;
        }

        const normalizedBranchName = branchName.trim().toUpperCase();
        
        // Debug: Log all employees and their branches
        console.log('All employees:', data.employees);
        console.log('Looking for branch:', normalizedBranchName);
        
        const employeesForBranch = data.employees.filter(emp => {
            if (emp.office_branch) {
                const empBranch = emp.office_branch.trim().toUpperCase();
                console.log(`Employee ${emp.full_name}: branch="${emp.office_branch}" -> normalized="${empBranch}"`);
                // Handle the specific case where dropdown shows "SSEV SOFT SOLS" but database has "SSEV SOFTSOLS"
                if (normalizedBranchName === 'SSEV SOFT SOLS') {
                    return empBranch === 'SSEV SOFT SOLS' || 
                           empBranch === 'SSEV SOFTSOLS' || 
                           empBranch === 'SSEVSOFTSOLS' ||
                           empBranch.includes('SOFT') ||
                           empBranch.includes('SOFTSOLS');
                }
                
                return empBranch === normalizedBranchName;
            }
            console.log(`Employee ${emp.full_name}: no office_branch field`);
            return false;
        });

        // Check if we have employees without office_branch and include them for SSEV Softsols
        const employeesWithoutBranch = data.employees.filter(emp => !emp.office_branch);
        
        if (employeesForBranch.length === 0) {
            if (employeesWithoutBranch.length > 0 && branchName === 'SSEV Softsols') {
                // For SSEV Softsols, include employees without branch assignment
                employeesForBranch.push(...employeesWithoutBranch);
                console.log(`Including employees without branch for SSEV Softsols: ${employeesWithoutBranch.map(emp => emp.full_name).join(', ')}`);
            } else {
                alert(`No employees found for the branch: ${branchName}`);
                return;
            }
        } else if (employeesWithoutBranch.length > 0 && branchName === 'SSEV Softsols') {
            // If we found some employees with branch, also include those without branch for SSEV Softsols
            employeesForBranch.push(...employeesWithoutBranch);
            console.log(`Also including employees without branch for SSEV Softsols: ${employeesWithoutBranch.map(emp => emp.full_name).join(', ')}`);
        }

        const payslipElements = [];
        for (const employee of employeesForBranch) {
            console.log(`Fetching details for employee: ${employee.full_name} (ID: ${employee.id})`);
            
            try {
                const empDetailsResponse = await fetch(`/api/get_employee_info/${employee.id}`);
                const empDetailsData = await empDetailsResponse.json();

                console.log(`Employee ${employee.full_name} details:`, empDetailsData);

                if (empDetailsData.status === 'success' && empDetailsData.employee) {
                    const payslipHtml = createPayslipHtml(empDetailsData.employee, branchName);
                    payslipElements.push(payslipHtml);
                    console.log(`✅ Successfully created payslip for ${employee.full_name}`);
                } else {
                    console.error(`❌ Failed to get employee details for ${employee.full_name}:`, empDetailsData);
                }
            } catch (error) {
                console.error(`❌ Error fetching details for ${employee.full_name}:`, error);
            }
        }

        console.log(`📊 Summary: Found ${employeesForBranch.length} employees, generated ${payslipElements.length} payslips`);
        
        if (payslipElements.length === 0) {
            alert(`No payslips could be generated for the employees of branch: ${branchName}`);
            return;
        }
        
        if (payslipElements.length < employeesForBranch.length) {
            console.warn(`⚠️ Warning: Only ${payslipElements.length} out of ${employeesForBranch.length} employees had complete salary data`);
        }
        
        // This is the corrected and crucial part for handling page breaks.
        // It joins the HTML strings with a page break element in between.
        let payslipsWithBreaks = payslipElements.join('<div style="page-break-after: always;"></div>');

        // Note: For the final version, you can move the entirepayslip-container class to the body.
        // This is an advanced fix, but for now, this version of the code should work correctly.
        // The original payslip-container class might be causing a few minor layout issues,
        // but it won't produce blank pages.

        const filename = `${branchName}_Salary_Sheet.pdf`;
        html2pdf().from(payslipsWithBreaks).set({
            margin: [10, 10, 10, 10], // Adjust margins for a better fit
            filename: filename,
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();

        alert(`✅ ${branchName} salary sheet is being generated and downloaded.`);
    } catch (error) {
        console.error('Error downloading salary sheet:', error);
        alert('An error occurred while generating the salary sheet.');
    }
}

async function downloadSalarySheetTable(branchName) {
    try {
        console.log('downloadSalarySheetTable() called for branch:', branchName);
        
        const response = await fetch('/api/get_all_employee_info');
        const data = await response.json();

        console.log('API response:', data);

        if (data.status !== 'success' || !data.employees) {
            alert('❌ Failed to fetch employee data.');
            return;
        }
        
        console.log('Total employees fetched:', data.employees.length);

        const normalizedBranchName = branchName.trim().toUpperCase();
        
        // Filter employees by branch with flexible matching
        const employeesForBranch = data.employees.filter(emp => {
            if (emp.office_branch) {
                const empBranch = emp.office_branch.trim().toUpperCase();
                
                // Handle the specific case where dropdown shows "SSEV SOFT SOLS" but database has "SSEV SOFTSOLS"
                if (normalizedBranchName === 'SSEV SOFT SOLS') {
                    return empBranch === 'SSEV SOFT SOLS' || 
                           empBranch === 'SSEV SOFTSOLS' || 
                           empBranch === 'SSEVSOFTSOLS' ||
                           empBranch.includes('SOFT') ||
                           empBranch.includes('SOFTSOLS');
                }
                
                return empBranch === normalizedBranchName;
            }
            return false;
        });

        console.log('Employees found for branch:', employeesForBranch.length);
        
        if (employeesForBranch.length === 0) {
            alert(`❌ No employees found for the branch: ${branchName}`);
            console.log('No employees matched. Check employee branch names in database.');
            return;
        }
        
        console.log('Generating Excel file...');

        // Get current month and year
        const now = new Date();
        const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE",
                           "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
        const currentMonth = monthNames[now.getMonth()];
        const currentYear = now.getFullYear();

        // Calculate working days for the month (assuming 30 days per month for now)
        const workingDays = 30;

        // Create the salary sheet table HTML
        let salarySheetHtml = `
        <div style="font-family: Arial, sans-serif; margin: 20px;">
            <h2 style="text-align: center; margin-bottom: 30px;">
                SSEV SOFTWARE SOLUTIONS OF PRIVATE LIMITED<br>
                SALARY STATEMENT FOR THE MONTH OF ${currentMonth} - ${currentYear}
            </h2>
            
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 10px; table-layout: fixed;">
                <thead>
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 5%;">S No</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 15%;">Name of the Employee</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 12%;">Designation</th>
                        <th colspan="3" style="border: 1px solid #000; padding: 4px; text-align: center; width: 12%;">Total</th>
                        <th colspan="4" style="border: 1px solid #000; padding: 4px; text-align: center; width: 20%;">Actuals</th>
                        <th colspan="4" style="border: 1px solid #000; padding: 4px; text-align: center; width: 20%;">Earnings</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 6%;">Total</th>
                        <th colspan="5" style="border: 1px solid #000; padding: 4px; text-align: center; width: 25%;">Employee Contribution</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 6%;">Net</th>
                        <th colspan="1" style="border: 1px solid #000; padding: 4px; text-align: center; width: 6%;">Employers Contribution</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center; width: 6%;">TOTAL</th>
                    </tr>
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Days</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">NDP</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Fixed Gross</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">BASIC</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">HRA</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">CONV</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Spl. Allow</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">BASIC</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">HRA</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">CONV</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Spl. Allow</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">PF</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">IT</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Salary Advance</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">P.Tax</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">Additional Arrears</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;">PF</th>
                        <th style="border: 1px solid #000; padding: 4px; text-align: center;"></th>
                    </tr>
                </thead>
                <tbody>`;

        // Add employee rows
        employeesForBranch.forEach((emp, index) => {
            // Get salary details from employee info
            const basic = parseFloat(emp.basic) || 0;
            const hra = parseFloat(emp.hra) || 0;
            const conveyance = parseFloat(emp.conveyance) || 0;
            const specialAllowance = parseFloat(emp.special_allowance) || 0;
            const actualGrossSalary = parseFloat(emp.actual_gross_salary) || 0;
            
            // Get NDP from employee data
            const ndp = parseFloat(emp.ndp) || workingDays;
            
            // Calculate totals
            const earningsTotal = basic + hra + conveyance + specialAllowance;
            const fixedGross = actualGrossSalary || earningsTotal;
            
            // Employee contributions
            const pf = parseFloat(emp.provident_fund) || 0;
            const incomeTax = parseFloat(emp.income_tax) || 0;
            const salaryAdvance = parseFloat(emp.advance) || 0;
            const professionalTax = parseFloat(emp.professional_tax) || 0;
            const additionalArrears = 0; // This field doesn't exist in current schema
            
            const employeeContributionsTotal = pf + incomeTax + salaryAdvance + professionalTax + additionalArrears;
            const net = earningsTotal - employeeContributionsTotal;
            const employerPf = pf; // Same as employee PF
            const total = net + employerPf;

            salarySheetHtml += `
                <tr>
                    <td style="border: 1px solid #000; padding: 4px; text-align: center;">${index + 1}</td>
                    <td style="border: 1px solid #000; padding: 4px;">${emp.full_name || 'N/A'}</td>
                    <td style="border: 1px solid #000; padding: 4px;">${emp.designation || 'N/A'}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: center;">${workingDays}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: center;">${ndp}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${fixedGross.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${basic.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${hra.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${conveyance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${specialAllowance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${basic.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${hra.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${conveyance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${specialAllowance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${earningsTotal.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${pf.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${incomeTax.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${salaryAdvance.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${professionalTax.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${additionalArrears.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${net.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${employerPf.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 4px; text-align: right;">${total.toFixed(2)}</td>
                </tr>`;
        });

        salarySheetHtml += `
                </tbody>
            </table>
        </div>`;

        // Create Excel data
        const excelData = [];
        
        // Add header rows
        excelData.push(['SSEV SOFTWARE SOLUTIONS OF PRIVATE LIMITED']);
        excelData.push([`SALARY STATEMENT FOR THE MONTH OF ${currentMonth} - ${currentYear}`]);
        excelData.push([]); // Empty row
        
        // Add grouped headers row with proper structure
        excelData.push([
            'S No', 'Name of the Employee', 'Designation', 
            'Total', '', '',  // Total group header spans 3 columns
            'Actuals', '', '', '',  // Actuals group header spans 4 columns
            'Earnings', '', '', '',  // Earnings group header spans 4 columns
            'Total',  // Standalone Total
            'Employee Contribution', '', '', '', '',  // Employee Contribution group header spans 5 columns
            'Net',  // Standalone Net
            'Employers Contribution', '',  // Employers Contribution group header spans 2 columns
            'TOTAL'  // Final TOTAL
        ]);
        
        // Add sub-headers row
        excelData.push([
            '', '', '',  // S No, Name, Designation
            'Days', 'NDP', 'Fixed Gross',  // Total group sub-headers
            'BASIC', 'HRA', 'CONV', 'Spl. Allow',  // Actuals group sub-headers
            'BASIC', 'HRA', 'CONV', 'Spl. Allow',  // Earnings group sub-headers
            'Total',  // Standalone Total
            'PF', 'IT', 'Salary Advance', 'P.Tax', 'Additional Arrears',  // Employee Contribution sub-headers
            'Net',  // Standalone Net
            'PF', 'TOTAL'  // Employers Contribution sub-headers
        ]);
        
        // Add employee data rows
        employeesForBranch.forEach((emp, index) => {
            // Get employee name and designation from user info
            const employeeName = emp.full_name || 'N/A';
            const designation = emp.designation || 'N/A';
            
            // Get NDP from employee data
            const ndpValue = parseFloat(emp.ndp) || workingDays;
            
            // Fixed Gross = actual_gross_salary
            const fixedGross = parseFloat(emp.actual_gross_salary) || 0;
            
            // ACTUALS section - from original/planned salary values
            const actualsBasic = parseFloat(emp.basic) || 0;
            const actualsHra = parseFloat(emp.hra) || 0;
            const actualsConveyance = parseFloat(emp.conveyance) || 0;
            const actualsSpecialAllowance = parseFloat(emp.special_allowance) || 0;
            const additionalArrears = parseFloat(emp.add_others) || 0; // Add Others from actuals
            
            // EARNINGS section - from separate earnings fields (what's actually being paid)
            // If earnings fields are null/undefined, fall back to actuals values
            const earningsBasic = parseFloat(emp.earnings_basic) || parseFloat(emp.basic) || 0;
            const earningsHra = parseFloat(emp.earnings_hra) || parseFloat(emp.hra) || 0;
            const earningsConveyance = parseFloat(emp.earnings_conveyance) || parseFloat(emp.conveyance) || 0;
            const earningsSpecialAllowance = parseFloat(emp.earnings_special_allowance) || parseFloat(emp.special_allowance) || 0;
            
            // Calculate earnings total
            const earningsTotal = earningsBasic + earningsHra + earningsConveyance + earningsSpecialAllowance;
            
            // DEDUCTIONS section - from deductions in salaries
            const pf = parseFloat(emp.provident_fund) || 0;
            const incomeTax = parseFloat(emp.income_tax) || 0;
            const salaryAdvance = parseFloat(emp.advance) || 0;
            const professionalTax = parseFloat(emp.professional_tax) || 0;
            
            // Calculate totals
            const employeeContributionsTotal = pf + incomeTax + salaryAdvance + professionalTax + additionalArrears;
            const net = earningsTotal - employeeContributionsTotal;
            const employerPf = pf; // Same as employee PF
            const total = net + employerPf;

            excelData.push([
                index + 1,                    // S No
                employeeName,                 // Name of the Employee
                designation,                  // Designation
                workingDays,                  // Days
                ndpValue,                     // NDP (from leaves)
                fixedGross,                   // Fixed Gross (actual_gross_salary)
                actualsBasic,                 // BASIC (Actuals)
                actualsHra,                   // HRA (Actuals)
                actualsConveyance,            // CONV (Actuals)
                actualsSpecialAllowance,      // Spl. Allow (Actuals)
                earningsBasic,                // BASIC (Earnings)
                earningsHra,                  // HRA (Earnings)
                earningsConveyance,           // CONV (Earnings)
                earningsSpecialAllowance,     // Spl. Allow (Earnings)
                earningsTotal,                // Total (Earnings)
                pf,                           // PF (Employee)
                incomeTax,                    // IT (Employee)
                salaryAdvance,                // Salary Advance
                professionalTax,              // P.Tax
                additionalArrears,            // Additional Arrears (Add Others)
                net,                          // Net
                employerPf,                   // PF (Employer)
                total                         // TOTAL
            ]);
        });

        // Create and download Excel file
        const filename = branchName === 'SSEV SOFT SOLS' ? 'SSEV_SOFT_SOLS_Salary_Statement.xlsx' : `${branchName}_Salary_Statement.xlsx`;
        
        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // Add cell merging for grouped headers
        if (!ws['!merges']) ws['!merges'] = [];
        
        // Find the header row (after company name, month, and empty row)
        const headerRow = 3; // 0-based index (row 4 in Excel)
        const subHeaderRow = 4; // 0-based index (row 5 in Excel)
        
        // Merge cells for grouped headers
        // Total group (columns D-F, spans 3 columns)
        ws['!merges'].push({s: {r: headerRow, c: 3}, e: {r: headerRow, c: 5}});
        
        // Actuals group (columns G-J, spans 4 columns)
        ws['!merges'].push({s: {r: headerRow, c: 6}, e: {r: headerRow, c: 9}});
        
        // Earnings group (columns K-N, spans 4 columns)
        ws['!merges'].push({s: {r: headerRow, c: 10}, e: {r: headerRow, c: 13}});
        
        // Employee Contribution group (columns P-T, spans 5 columns)
        ws['!merges'].push({s: {r: headerRow, c: 15}, e: {r: headerRow, c: 19}});
        
        // Employers Contribution group (columns V-W, spans 2 columns)
        ws['!merges'].push({s: {r: headerRow, c: 21}, e: {r: headerRow, c: 22}});
        
        // Add styling for grouped headers
        const headerStyle = {
            font: { bold: true, size: 12, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "366092" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: {
                top: { style: "thin", color: { rgb: "000000" } },
                bottom: { style: "thin", color: { rgb: "000000" } },
                left: { style: "thin", color: { rgb: "000000" } },
                right: { style: "thin", color: { rgb: "000000" } }
            }
        };
        
        const subHeaderStyle = {
            font: { bold: true, size: 10 },
            fill: { fgColor: { rgb: "D9E2F3" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: {
                top: { style: "thin", color: { rgb: "000000" } },
                bottom: { style: "thin", color: { rgb: "000000" } },
                left: { style: "thin", color: { rgb: "000000" } },
                right: { style: "thin", color: { rgb: "000000" } }
            }
        };
        
        // Apply styling to grouped header cells
        const headerCells = [
            'D3', 'E3', 'F3',  // Total group
            'G3', 'H3', 'I3', 'J3',  // Actuals group
            'K3', 'L3', 'M3', 'N3',  // Earnings group
            'O3',  // Standalone Total
            'P3', 'Q3', 'R3', 'S3', 'T3',  // Employee Contribution group
            'U3',  // Standalone Net
            'V3', 'W3',  // Employers Contribution group
            'X3'   // Final TOTAL
        ];
        
        headerCells.forEach(cell => {
            if (!ws[cell]) ws[cell] = { v: '' };
            ws[cell].s = headerStyle;
        });
        
        // Apply styling to sub-header cells
        const subHeaderCells = [
            'D4', 'E4', 'F4',  // Total sub-headers
            'G4', 'H4', 'I4', 'J4',  // Actuals sub-headers
            'K4', 'L4', 'M4', 'N4',  // Earnings sub-headers
            'O4',  // Standalone Total
            'P4', 'Q4', 'R4', 'S4', 'T4',  // Employee Contribution sub-headers
            'U4',  // Standalone Net
            'V4', 'W4',  // Employers Contribution sub-headers
            'X4'   // Final TOTAL
        ];
        
        subHeaderCells.forEach(cell => {
            if (!ws[cell]) ws[cell] = { v: '' };
            ws[cell].s = subHeaderStyle;
        });
        
        // Set column widths
        const colWidths = [
            { wch: 5 },   // S No
            { wch: 20 },  // Name
            { wch: 15 },  // Designation
            { wch: 8 },   // Days
            { wch: 8 },   // NDP
            { wch: 12 },  // Fixed Gross
            { wch: 10 },  // BASIC (Actuals)
            { wch: 10 },  // HRA (Actuals)
            { wch: 10 },  // CONV (Actuals)
            { wch: 12 },  // Spl. Allow (Actuals)
            { wch: 10 },  // BASIC (Earnings)
            { wch: 10 },  // HRA (Earnings)
            { wch: 10 },  // CONV (Earnings)
            { wch: 12 },  // Spl. Allow (Earnings)
            { wch: 10 },  // Total
            { wch: 10 },  // PF
            { wch: 10 },  // IT
            { wch: 12 },  // Salary Advance
            { wch: 10 },  // P.Tax
            { wch: 15 },  // Additional Arrears
            { wch: 10 },  // Net
            { wch: 10 },  // PF (Employer)
            { wch: 10 }   // TOTAL
        ];
        ws['!cols'] = colWidths;
        
        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Salary Statement');
        
        // Generate and download Excel file
        console.log('Downloading file:', filename);
        XLSX.writeFile(wb, filename);
        console.log('✅ Excel file generated successfully!');

    } catch (error) {
        console.error('❌ Error downloading salary sheet table:', error);
        alert('❌ Error downloading salary sheet table: ' + error.message);
    }
}

async function saveSalaryData() {
    try {
        const selectedEmployeeId = document.getElementById('employeeNameSelect').value;
        if (!selectedEmployeeId) {
            alert('Please select an employee first.');
            return;
        }

        // Get all form data from Earnings section (as requested by user)
        const formData = {
            actual_gross_salary: parseFloat(document.getElementById('earningsBasic').value) + parseFloat(document.getElementById('earningsHra').value) + parseFloat(document.getElementById('earningsConveyance').value) + parseFloat(document.getElementById('earningsVehicleMaintenance').value) + parseFloat(document.getElementById('earningsSpecialAllowance').value) + parseFloat(document.getElementById('addOthersEarnings').value),
            basic: parseFloat(document.getElementById('earningsBasic').value) || 0,
            hra: parseFloat(document.getElementById('earningsHra').value) || 0,
            conveyance: parseFloat(document.getElementById('earningsConveyance').value) || 0,
            vehicle_maintenance: parseFloat(document.getElementById('earningsVehicleMaintenance').value) || 0,
            special_allowance: parseFloat(document.getElementById('earningsSpecialAllowance').value) || 0,
            add_others: parseFloat(document.getElementById('addOthersEarnings').value) || 0,
            provident_fund: parseFloat(document.getElementById('providentFund').value) || 0,
            esi: parseFloat(document.getElementById('esi').value) || 0,
            professional_tax: parseFloat(document.getElementById('professionalTax').value) || 0,
            income_tax: parseFloat(document.getElementById('incomeTax').value) || 0,
            advance: parseFloat(document.getElementById('advance').value) || 0,
            other_deductions: parseFloat(document.getElementById('otherDeductions').value) || 0,
            loss_of_pay: parseFloat(document.getElementById('lossOfPay').value) || 0,
            total_leaves: parseInt(document.getElementById('totalLeaves').value) || 0,
            leave_availed: parseInt(document.getElementById('leaveAvailed').value) || 0,
            balance_leaves: parseInt(document.getElementById('balanceLeaves').value) || 0,
            no_of_lop_days: parseInt(document.getElementById('noOfLopDays').value) || 0,
            total_days: parseInt(document.getElementById('totalDays').value) || 30,
            ndp: parseInt(document.getElementById('ndp').value) || 0
        };

        // Send data to backend to save
        const response = await fetch('/api/update_employee_salary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                employee_id: selectedEmployeeId,
                salary_data: formData
            })
        });

        const result = await response.json();
        
        if (result.status === 'success') {
            alert('✅ Salary data saved successfully!');
        } else {
            alert('❌ Error saving salary data: ' + result.message);
        }

    } catch (error) {
        console.error('Error saving salary data:', error);
        alert('Error saving salary data: ' + error.message);
    }
}

// Cache bust - v2.0 - Fixed pay slip date issue
function getCurrentMonthYear() {
    const now = new Date();
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
    return `Pay-Slip For The Month of ${monthNames[now.getMonth()]} ${now.getFullYear()}`;
}

// OLD FUNCTION REMOVED - Using the updated function below
function createPayslipHtml_OLD_DISABLED(emp, companyBranch = '') {
    // This function has been replaced by the updated version below
    return '';
    const designation = (emp.roles && emp.roles.includes('Manager')) ? 'Manager' : 'Employee';
    const employeeId = `SSDEV-${emp.id.toString().padStart(2, '0')}-002`;
    const payslipTitle = getCurrentMonthYear();

    // Determine watermark based on company branch
    let watermarkSrc = '';
    if (companyBranch && companyBranch.toLowerCase().includes('softsols')) {
        watermarkSrc = 'static/images/watermark-ssev-softsols.png';
    } else {
        watermarkSrc = 'static/images/watermark-ssev.png';
    }
    
    console.log(`Using watermark: ${watermarkSrc} for company branch: ${companyBranch}`);

    return `
    <div class="payslip-container" style="position: relative;">
        <!-- Watermark -->
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; display: flex; align-items: center; justify-content: center; background-image: url('${watermarkSrc}'); background-repeat: no-repeat; background-position: center; background-size: contain;">
        </div>
        
        <table class="payslip-header-table">
            <tr>
                <td style="width: 15%; border: none;">
                    <img src="static/images/logo.png" alt="Company Logo" class="payslip-logo">
                </td>
                <td style="width: 85%; border: none; padding: 0;">
                    <div class="company-name">SSEV SOFTWARE SOLUTIONS PRIVATE LIMITED</div>
                    <div class="company-details">Corporate office: #2-057/A/112, 1st Floor, VSS Nandadeep,<br>Near Medchal RTA Office, Petbasheerabad Village, Kompally Road,<br>Medchal District Telangana Hyderabad 500067.<br>Ph.040-35042301.</div>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="payslip-title" style="border-left: none; border-right: none;">${payslipTitle}</td>
            </tr>
        </table>
        
        <table class="payslip-main-table" style="margin-top: 20px;">
            <tr>
                <td style="width: 25%;">Employee No</td>
                <td style="width: 25%;">${employeeId || 'N/A'}</td>
                <td style="width: 25%;">Designation</td>
                <td style="width: 25%;">${designation || 'N/A'}</td>
            </tr>
            <tr>
                <td>Name</td>
                <td>${emp.full_name || 'N/A'}</td>
                <td>Total Days</td>
                <td>4</td>
            </tr>
            <tr>
                <td>Bank A/c No</td>
                <td>${emp.account_number || 'N/A'}</td>
                <td>LOP</td>
                <td>0</td>
            </tr>
            <tr>
                <td>PF No.</td>
                <td>${emp.pf_no || 'N/A'}</td>
                <td>Effective work days</td>
                <td>4</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: center;">Total Leaves : ${emp.total_leaves || '0'} | Leave Availed : 0 | Balance : 0</td>
            </tr>
            <tr>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Earnings</th>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Deductions</th>
            </tr>
            <tr>
                <td>BASIC</td>
                <td>${emp.basic || '0.00'}</td>
                <td>PF</td>
                <td>${emp.provident_fund || '0'}</td>
            </tr>
            <tr>
                <td>HRA</td>
                <td>${emp.hra || '0.00'}</td>
                <td>ESI</td>
                <td>${emp.esi || '0.00'}</td>
            </tr>
            <tr>
                <td>CONVEYANCE</td>
                <td>${emp.conveyance || '0.00'}</td>
                <td>P. Tax</td>
                <td>${emp.professional_tax || '0.00'}</td>
            </tr>
            <tr>
                <td>VEHICLE MAINTENANCE</td>
                <td>0.00</td>
                <td>Income Tax</td>
                <td>${emp.income_tax || '0.00'}</td>
            </tr>
            <tr>
                <td>SPL ALLOWANCE</td>
                <td>${emp.special_allowance || '0.00'}</td>
                <td>Advance</td>
                <td>${emp.advance || '0.00'}</td>
            </tr>
            <tr>
                <td>Add Others</td>
                <td>0.00</td>
                <td>Others Deduction</td>
                <td>0.00</td>
            </tr>
            <tr class="payslip-total-row">
                <td>Total Earnings</td>
                <td>${totalEarnings}</td>
                <td>Total Deduction</td>
                <td>${totalDeductions}</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: right; font-weight: bold; font-size: 12pt;">Net Salary: ${netSalary}</td>
            </tr>
        </table>
        
        <!-- System Generated Disclaimer -->
        <div style="margin-top: 20px; text-align: left; font-size: 10pt; color: #666;">
            It is System generated, Signature not required
        </div>
    </div>`;
}

       async function populateIndividualEmployeeDropdown() {
         const employeeSelect = document.getElementById('individualEmployeeSelect');
         try {
           const response = await fetch('/api/users');
           const data = await response.json();
           if (data.status === 'success' && data.users) {
             // Sort employees alphabetically by name
             const sortedUsers = data.users.sort((a, b) => a.name.localeCompare(b.name));
             
             employeeSelect.innerHTML = '';
             sortedUsers.forEach(user => {
               const option = document.createElement('option');
               option.value = user.id;
               option.textContent = user.name;
               employeeSelect.appendChild(option);
             });
             if (sortedUsers.length > 0) {
               employeeSelect.value = sortedUsers[0].id;
               updateIndividualEmployeeInfo(sortedUsers[0].id);
             }
           } else {
             console.error('Failed to load users for dropdown:', data.message);
           }
         } catch (error) {
           console.error('Error fetching users for dropdown:', error);
         }
         
         employeeSelect.addEventListener('change', (event) => {
           updateIndividualEmployeeInfo(event.target.value);
         });
       }
  


// ==================================================================
      // Projects Module Functions (Copied from your previous code)
      // ==================================================================

      // --- State Management ---
      let currentOpenProjectId = null;

      // --- Modal Controls ---
      function openAddProjectModal() { document.getElementById('addProjectModal').style.display = 'flex'; }
      function closeAddProjectModal() { document.getElementById('addProjectModal').style.display = 'none'; }
      function openAddTaskModal(projectId) {
          currentOpenProjectId = projectId;
          document.getElementById('saveTaskButton').onclick = () => saveNewTask(projectId);
          document.getElementById('addTaskModal').style.display = 'flex';
      }
      function closeAddTaskModal() {
          document.getElementById('addTaskModal').style.display = 'none';
          document.getElementById('newTaskName').value = '';
          document.getElementById('newTaskDesc').value = '';
          document.getElementById('newTaskDeadline').value = '';
      }

      // --- Core Logic ---
      function showMyWorkMainView() {
          document.getElementById('my-work-details-view').style.display = 'none';
          document.getElementById('my-work-main-view').style.display = 'block';
          
          // Ensure work navigation cards are generated when Projects section is shown
          if (userRoles && userRoles.length > 0) {
              generateWorkNavigationCards();
          }
      }
      
      // Function to generate work navigation cards based on user role
      function generateWorkNavigationCards() {
          const workNavButtons = document.getElementById('work-nav-buttons');
          if (!workNavButtons) {
              return;
          }
          
          let cardsHtml = '';
          
          // Check if user is Team Lead
          const isTeamLead = userRoles && userRoles.includes('Team Lead');
          // Check if user is Employee (but not Team Lead)
          const isEmployee = userRoles && userRoles.includes('Employee') && !isTeamLead;
          
          // Common cards for all users
          cardsHtml += `
              <div class="work-nav-card" onclick="loadMyTasks()">
                  <h3>📝 Tasks</h3>
                  <p>View tasks and teams assigned to you.</p>
              </div>
              <div class="work-nav-card" onclick="loadMyProjects()">
                  <h3>📂 My Projects</h3>
                  <p>View all projects you are a part of.</p>
              </div>
          `;
          
          // Team Lead specific card
          if (isTeamLead) {
              cardsHtml += `
                  <div class="work-nav-card" onclick="loadAssignTasks()">
                      <h3>📋 Assign Tasks</h3>
                      <p>Assign new tasks to your team members.</p>
                  </div>
              `;
          }
          
          // Employee specific card
          if (isEmployee) {
              cardsHtml += `
                  <div class="work-nav-card" onclick="loadAssignedTasks()">
                      <h3>✅ Assigned Tasks</h3>
                      <p>View and complete tasks assigned to you.</p>
                  </div>
              `;
          }
          
          workNavButtons.innerHTML = cardsHtml;
      }
      
      async function loadMyTasks() {
          const mainView = document.getElementById('my-work-main-view');
          const detailsView = document.getElementById('my-work-details-view');

          mainView.style.display = 'none';
          detailsView.innerHTML = '<p>Loading your tasks...</p>';
          detailsView.style.display = 'block';

          try {
              const response = await fetch('/api/my_tasks');
              const data = await response.json();

              if (data.status === 'success' && data.tasks) {
                  let tasksHtml = `
                      <button class="back-button" onclick="showMyWorkMainView()">← Back to My Work</button>
                      <h2>Assigned Tasks</h2>
                  `;

                  if (data.tasks.length === 0) {
                      tasksHtml += '<p>You have no tasks assigned.</p>';
                  } else {
                      data.tasks.forEach((task, index) => {
                          const taskTitle = task.group_name || 'Unnamed Task';
                          tasksHtml += `
                              <div class="task-item">
                                  <div class="task-title">${index + 1}. ${taskTitle}</div>
                                  <div class="task-details">
                                      <strong>From Project:</strong> ${task.project_name || 'N/A'} <br>
                                      <strong>Group Type:</strong> ${task.group_type || 'General'}
                                  </div>
                              </div>
                          `;
                      });
                  }
                  detailsView.innerHTML = tasksHtml;

              } else {
                  detailsView.innerHTML = `<p style="color:red;">Error loading tasks: ${data.message}</p>`;
              }
          } catch (error) {
              console.error('Failed to fetch tasks:', error);
              detailsView.innerHTML = '<p style="color:red;">Could not connect to the task service.</p>';
          }
      }

      async function loadMyProjects() {
          const mainView = document.getElementById('my-work-main-view');
          const detailsView = document.getElementById('my-work-details-view');
          mainView.style.display = 'none';
          detailsView.innerHTML = '<p>Loading your projects...</p>';
          detailsView.style.display = 'block';

          try {
              const response = await fetch('/api/user/projects');
              const data = await response.json();
              if (data.status === 'success') {
                  renderProjectList(data.projects);
              } else {
                  detailsView.innerHTML = `<p style="color:red;">Error: ${data.message}</p>`;
              }
          } catch (error) {
              console.error(error);
              detailsView.innerHTML = `<p style="color:red;">Could not fetch projects.</p>`;
          }
      }

      async function saveNewProject() {
          const projectName = document.getElementById('newProjectName').value.trim();
          if (!projectName) {
              alert('Project name cannot be empty.');
              return;
          }

          const response = await fetch('/api/user/projects', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ project_name: projectName })
          });

          const data = await response.json();

          if (data.status === 'success') {
              closeAddProjectModal();
              loadMyProjects();
          } else {
              alert(`Error saving project: ${data.message}`);
          }
      }

      async function showProjectDetails(projectId, projectName) {
          currentOpenProjectId = projectId;
          currentOpenProjectName = projectName;
          const detailsView = document.getElementById('my-work-details-view');
          detailsView.innerHTML = `<p>Loading tasks for ${projectName}...</p>`;

          const response = await fetch(`/api/project/${projectId}/tasks`);
          const data = await response.json();
          if (data.status === 'success') {
              renderTaskList(projectId, projectName, data.tasks);
          } else {
              detailsView.innerHTML = `<p style="color:red;">Error loading tasks: ${data.message}</p>`;
          }
      }

      async function saveNewTask(projectId) {
          const taskData = {
              name: document.getElementById('newTaskName').value.trim(),
              description: document.getElementById('newTaskDesc').value.trim(),
              deadline: document.getElementById('newTaskDeadline').value,
          };

          if (!taskData.name) {
              alert('Task name cannot be empty.');
              return;
          }

          const response = await fetch(`/api/project/${projectId}/tasks`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(taskData)
          });

          const data = await response.json();

          if (data.status === 'success') {
              closeAddTaskModal();
              showProjectDetails(projectId, currentOpenProjectName);
          } else {
              alert(`Error saving task: ${data.message}`);
          }
      }
      
      // --- Rendering Functions ---
      function renderProjectList(projects) {
          const detailsView = document.getElementById('my-work-details-view');
          let html = `
              <button class="back-button" onclick="showMyWorkMainView()">← Back to My Work</button>
              <div class="header-with-button">
                  <h2>My Projects</h2>
                  <button class="add-button" onclick="openAddProjectModal()">+ Add Project</button>
              </div>
              <div id="project-list-container">`;

          if (projects.length > 0) {
              projects.forEach(p => {
                  html += `<div class="project-list-item" data-project-id="${p.id}" data-project-name="${p.name}" onclick="showProjectDetails(${p.id}, '${p.name}')">${p.name}</div>`;
              });
          } else {
              html += `<p>You haven't created any projects yet. Click "+ Add Project" to start.</p>`;
          }
          html += `</div>`;
          detailsView.innerHTML = html;
      }

      function renderTaskList(projectId, projectName, tasks) {
          const detailsView = document.getElementById('my-work-details-view');
          let html = `
              <button class="back-button" onclick="loadMyProjects()">← Back to Projects</button>
              <div class="header-with-button">
                  <h2>${projectName}</h2>
                  <button class="add-button" onclick="openAddTaskModal(${projectId})">+ Add Task</button>
              </div>
              <div id="task-list-container">`;

          if (tasks.length > 0) {
              tasks.forEach(t => {
                  const isCompleted = t.completed ? 'completed' : '';
                  const isChecked = t.completed ? 'checked' : '';
                  html += `
                      <div class="task-item-container">
                          <div class="task-item-visible">
                              <input type="checkbox" ${isChecked} onchange="toggleTaskCompletion(this, ${t.id})">
                              <span class="task-name ${isCompleted}" id="task-name-${t.id}">${t.name}</span>
                              <span class="task-details-toggle" onclick="toggleTaskDetails(this, ${t.id})">▼</span>
                          </div>
                          <div class="task-hidden-details" id="task-details-${t.id}">
                              <p><strong>Description:</strong> ${t.description || 'No description'}</p>
                              <p><strong>Deadline:</strong> ${t.deadline ? new Date(t.deadline).toLocaleString() : 'No deadline'}</p>
                          </div>
                      </div>`;
              });
          } else {
              html += `<p>No tasks yet. Click "+ Add Task" to create one.</p>`;
          }
          html += `</div>`;
          detailsView.innerHTML = html;
      }

      // --- Rendering Functions ---
      function renderProjectList(projects) {
          const detailsView = document.getElementById('my-work-details-view');
          let html = `
              <button class="back-button" onclick="showMyWorkMainView()">← Back to My Work</button>
              <div class="header-with-button">
                  <h2>My Projects</h2>
                  <button class="add-button" onclick="openAddProjectModal()">+ Add Project</button>
              </div>
              <div id="project-list-container">`;

          if (projects.length > 0) {
              projects.forEach(p => {
                  html += `<div class="project-list-item" data-project-id="${p.id}" data-project-name="${p.name}" onclick="showProjectDetails(${p.id}, '${p.name}')">${p.name}</div>`;
              });
          } else {
              html += `<p>You haven't created any projects yet. Click "+ Add Project" to start.</p>`;
          }
          html += `</div>`;
          detailsView.innerHTML = html;
      }

      function renderTaskList(projectId, projectName, tasks) {
          const detailsView = document.getElementById('my-work-details-view');
          let html = `
              <button class="back-button" onclick="loadMyProjects()">← Back to Projects</button>
              <div class="header-with-button">
                  <h2>${projectName}</h2>
                  <button class="add-button" onclick="openAddTaskModal(${projectId})">+ Add Task</button>
              </div>
              <div id="task-list-container">`;

          if (tasks.length > 0) {
              tasks.forEach(t => {
                  const isCompleted = t.completed ? 'completed' : '';
                  const isChecked = t.completed ? 'checked' : '';
                  html += `
                      <div class="task-item-container">
                          <div class="task-item-visible">
                              <input type="checkbox" ${isChecked} onchange="toggleTaskCompletion(this, ${t.id})">
                              <span class="task-name ${isCompleted}" id="task-name-${t.id}">${t.name}</span>
                              <span class="task-details-toggle" onclick="toggleTaskDetails(this, ${t.id})">▼</span>
                          </div>
                          <div class="task-hidden-details" id="task-details-${t.id}">
                              <p><strong>Description:</strong> ${t.description || 'No description'}</p>
                              <p><strong>Deadline:</strong> ${t.deadline ? new Date(t.deadline).toLocaleString() : 'No deadline'}</p>
                          </div>
                      </div>`;
              });
          } else {
              html += `<p>No tasks yet. Click "+ Add Task" to create one.</p>`;
          }
          html += `</div>`;
          detailsView.innerHTML = html;
      }

      // Function to show project details with task management
      async function showProjectDetails(projectId, projectName) {
          const mainView = document.getElementById('my-work-main-view');
          const detailsView = document.getElementById('my-work-details-view');
          mainView.style.display = 'none';
          detailsView.innerHTML = '<p>Loading project details...</p>';
          detailsView.style.display = 'block';

          try {
              // Fetch project tasks
              const response = await fetch(`/api/project/${projectId}/personal_tasks`);
              const data = await response.json();
              
              if (data.status === 'success') {
                  renderProjectDetails(projectId, projectName, data.tasks);
              } else {
                  detailsView.innerHTML = `<p style="color:red;">Error: ${data.message}</p>`;
              }
          } catch (error) {
              console.error('Failed to fetch project tasks:', error);
              detailsView.innerHTML = '<p style="color:red;">Could not connect to the task service.</p>';
          }
      }

      // Render project details with task management
      function renderProjectDetails(projectId, projectName, tasks) {
          const detailsView = document.getElementById('my-work-details-view');
          let html = `
              <button class="back-button" onclick="loadMyProjects()">← Back to My Projects</button>
              <div class="header-with-button">
                  <h2>${projectName}</h2>
                  <button class="add-button" onclick="openAddProjectTaskModal(${projectId})">+ Add Task</button>
              </div>
              <div id="project-tasks-container">`;

          if (tasks.length > 0) {
              html += `
                  <div class="project-task-list">
                      <table class="task-table">
                          <thead>
                              <tr>
                                  <th>Task</th>
                                  <th>Deadline</th>
                                  <th>Status</th>
                                  <th>Created</th>
                              </tr>
                          </thead>
                          <tbody>`;
              
              tasks.forEach(task => {
                  const isCompleted = task.is_completed;
                  const deadlineText = task.deadline || 'No deadline';
                  
                  html += `
                      <tr class="project-task-row ${isCompleted ? 'completed' : ''}">
                          <td>
                              <label class="task-checkbox-label">
                                  <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                         onchange="toggleProjectTask(${task.id})" 
                                         class="task-checkbox">
                                  <span class="task-text ${isCompleted ? 'strikethrough' : ''}">${task.task_name}</span>
                              </label>
                          </td>
                          <td>${deadlineText}</td>
                          <td><span class="status-badge ${isCompleted ? 'completed' : 'pending'}">${isCompleted ? 'Completed' : 'Pending'}</span></td>
                          <td>${task.created_at}</td>
                      </tr>`;
              });
              
              html += `
                          </tbody>
                      </table>
                  </div>`;
          } else {
              html += `<p>No tasks yet. Click "+ Add Task" to create one.</p>`;
          }
          
          html += `</div>`;
          detailsView.innerHTML = html;
      }

      // Open add project task modal
      function openAddProjectTaskModal(projectId) {
          const modalHtml = `
              <div id="addProjectTaskModal" class="modal-overlay" onclick="closeAddProjectTaskModal(event)">
                  <div class="modal-content" onclick="event.stopPropagation()">
                      <div class="modal-header">
                          <h3>Add Task to Project</h3>
                          <button class="modal-close" onclick="closeAddProjectTaskModal()">&times;</button>
                      </div>
                      <div class="modal-body">
                          <form id="addProjectTaskForm">
                              <div class="form-group">
                                  <label for="projectTaskName">Task Name:</label>
                                  <input type="text" id="projectTaskName" name="taskName" required 
                                         placeholder="Enter task description..." 
                                         style="width: 100%; padding: 10px; border: 1px solid #666; border-radius: 5px; background: #222; color: white;">
                              </div>
                              <div class="form-group">
                                  <label for="projectTaskDeadline">Deadline:</label>
                                  <input type="date" id="projectTaskDeadline" name="deadline" 
                                         style="width: 100%; padding: 10px; border: 1px solid #666; border-radius: 5px; background: #222; color: white;">
                              </div>
                              <div class="modal-actions">
                                  <button type="button" class="cancel-button" onclick="closeAddProjectTaskModal()">Cancel</button>
                                  <button type="submit" class="save-button">Save Task</button>
                              </div>
                          </form>
                      </div>
                  </div>
              </div>
          `;
          
          // Add modal to page
          document.body.insertAdjacentHTML('beforeend', modalHtml);
          
          // Add form submit handler
          document.getElementById('addProjectTaskForm').addEventListener('submit', (e) => handleAddProjectTaskSubmit(e, projectId));
      }

      // Handle add project task form submission
      async function handleAddProjectTaskSubmit(event, projectId) {
          event.preventDefault();
          
          const taskName = document.getElementById('projectTaskName').value.trim();
          const deadline = document.getElementById('projectTaskDeadline').value;
          
          if (!taskName) {
              alert('Please enter a task name');
              return;
          }
          
          try {
              const response = await fetch(`/api/project/${projectId}/add_personal_task`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      task_name: taskName,
                      deadline: deadline
                  })
              });
              
              const data = await response.json();
              
              if (data.status === 'success') {
                  closeAddProjectTaskModal();
                  // Refresh the project details
                  const projectName = document.querySelector('.header-with-button h2').textContent;
                  showProjectDetails(projectId, projectName);
                  alert('Task added successfully!');
              } else {
                  alert('Error adding task: ' + data.message);
              }
          } catch (error) {
              console.error('Error adding project task:', error);
              alert('Error adding task. Please try again.');
          }
      }

      // Close add project task modal
      function closeAddProjectTaskModal(event) {
          if (event && event.target !== event.currentTarget) return;
          
          const modal = document.getElementById('addProjectTaskModal');
          if (modal) {
              modal.remove();
          }
      }

      // Toggle project task completion
      async function toggleProjectTask(taskId) {
          try {
              const response = await fetch(`/api/personal_project_task/${taskId}/toggle`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  }
              });
              
              const data = await response.json();
              
              if (data.status === 'success') {
                  // Update the UI immediately
                  const checkbox = document.querySelector(`input[onchange="toggleProjectTask(${taskId})"]`);
                  const taskText = checkbox.nextElementSibling;
                  const row = checkbox.closest('tr');
                  const statusBadge = row.querySelector('.status-badge');
                  
                  if (checkbox.checked) {
                      taskText.classList.add('strikethrough');
                      row.classList.add('completed');
                      statusBadge.textContent = 'Completed';
                      statusBadge.className = 'status-badge completed';
                  } else {
                      taskText.classList.remove('strikethrough');
                      row.classList.remove('completed');
                      statusBadge.textContent = 'Pending';
                      statusBadge.className = 'status-badge pending';
                  }
              } else {
                  alert('Error updating task: ' + data.message);
                  // Revert checkbox state
                  const checkbox = document.querySelector(`input[onchange="toggleProjectTask(${taskId})"]`);
                  checkbox.checked = !checkbox.checked;
              }
          } catch (error) {
              console.error('Error toggling project task:', error);
              alert('Error updating task. Please try again.');
              // Revert checkbox state
              const checkbox = document.querySelector(`input[onchange="toggleProjectTask(${taskId})"]`);
              checkbox.checked = !checkbox.checked;
          }
      }

      // === TASK MANAGEMENT FUNCTIONS ===
      
      // Function for Team Leads to assign tasks
      async function loadAssignTasks() {
          const mainView = document.getElementById('my-work-main-view');
          const detailsView = document.getElementById('my-work-details-view');
          mainView.style.display = 'none';
          detailsView.innerHTML = '<p>Loading assigned tasks...</p>';
          detailsView.style.display = 'block';

          try {
              const response = await fetch('/api/assigned_tasks');
              const data = await response.json();
              
              if (data.status === 'success') {
                  renderAssignedTasksList(data.tasks);
              } else {
                  detailsView.innerHTML = `<p style="color:red;">Error: ${data.message}</p>`;
              }
          } catch (error) {
              console.error('Failed to fetch assigned tasks:', error);
              detailsView.innerHTML = '<p style="color:red;">Could not connect to the task service.</p>';
          }
      }

      // Function for Employees to view their assigned tasks
      async function loadAssignedTasks() {
          const mainView = document.getElementById('my-work-main-view');
          const detailsView = document.getElementById('my-work-details-view');
          mainView.style.display = 'none';
          detailsView.innerHTML = '<p>Loading your assigned tasks...</p>';
          detailsView.style.display = 'block';

          try {
              const response = await fetch('/api/my_assigned_tasks');
              const data = await response.json();
              
              if (data.status === 'success') {
                  renderMyAssignedTasksList(data.tasks);
              } else {
                  detailsView.innerHTML = `<p style="color:red;">Error: ${data.message}</p>`;
              }
          } catch (error) {
              console.error('Failed to fetch my assigned tasks:', error);
              detailsView.innerHTML = '<p style="color:red;">Could not connect to the task service.</p>';
          }
      }

      // Render assigned tasks list for Team Leads
      function renderAssignedTasksList(tasks) {
          const detailsView = document.getElementById('my-work-details-view');
          let html = `
              <button class="back-button" onclick="showMyWorkMainView()">← Back to My Work</button>
              <div class="header-with-button">
                  <h2>Assigned Tasks</h2>
                  <button class="add-button" onclick="openAssignTaskModal()">+ Assign Task</button>
              </div>
              <div id="assigned-tasks-container">`;

          if (tasks.length > 0) {
              html += `
                  <div class="task-list">
                      <table class="task-table">
                          <thead>
                              <tr>
                                  <th>Task Name</th>
                                  <th>Assigned To</th>
                                  <th>Status</th>
                                  <th>Created</th>
                                  <th>Completed</th>
                              </tr>
                          </thead>
                          <tbody>`;
              
              tasks.forEach(task => {
                  const statusClass = task.status === 'Completed' ? 'completed' : 'pending';
                  const completedDate = task.completed_at || 'Not completed';
                  
                  html += `
                      <tr class="task-row ${statusClass}">
                          <td>${task.task_name}</td>
                          <td>${task.assigned_to_name}</td>
                          <td><span class="status-badge ${statusClass}">${task.status}</span></td>
                          <td>${task.created_at}</td>
                          <td>${completedDate}</td>
                      </tr>`;
              });
              
              html += `
                          </tbody>
                      </table>
                  </div>`;
          } else {
              html += `<p>No tasks assigned yet. Click "+ Assign Task" to create one.</p>`;
          }
          
          html += `</div>`;
          detailsView.innerHTML = html;
      }

      // Render my assigned tasks list for Employees
      function renderMyAssignedTasksList(tasks) {
          const detailsView = document.getElementById('my-work-details-view');
          let html = `
              <button class="back-button" onclick="showMyWorkMainView()">← Back to My Work</button>
              <div class="header-with-button">
                  <h2>My Assigned Tasks</h2>
              </div>
              <div id="my-assigned-tasks-container">`;

          if (tasks.length > 0) {
              html += `
                  <div class="task-list">
                      <table class="task-table">
                          <thead>
                              <tr>
                                  <th>Task Name</th>
                                  <th>Assigned By</th>
                                  <th>Status</th>
                                  <th>Created</th>
                                  <th>Action</th>
                              </tr>
                          </thead>
                          <tbody>`;
              
              tasks.forEach(task => {
                  const statusClass = task.status === 'Completed' ? 'completed' : 'pending';
                  const isCompleted = task.status === 'Completed';
                  
                  html += `
                      <tr class="task-row ${statusClass}">
                          <td class="${isCompleted ? 'strikethrough' : ''}">${task.task_name}</td>
                          <td>${task.assigned_by_name}</td>
                          <td><span class="status-badge ${statusClass}">${task.status}</span></td>
                          <td>${task.created_at}</td>
                          <td>
                              ${!isCompleted ? 
                                  `<button class="complete-button" onclick="completeTask(${task.id})">Mark Complete</button>` :
                                  `<span class="completed-text">Completed on ${task.completed_at}</span>`
                              }
                          </td>
                      </tr>`;
              });
              
              html += `
                          </tbody>
                      </table>
                  </div>`;
          } else {
              html += `<p>No tasks assigned to you yet.</p>`;
          }
          
          html += `</div>`;
          detailsView.innerHTML = html;
      }

      // Open assign task modal
      async function openAssignTaskModal() {
          try {
              // Fetch active users for dropdown
              const response = await fetch('/api/active_users_for_tasks');
              const data = await response.json();
              
              if (data.status !== 'success') {
                  alert('Error loading users: ' + data.message);
                  return;
              }
              
              const users = data.users;
              let userOptions = '<option value="">Select a user...</option>';
              users.forEach(user => {
                  userOptions += `<option value="${user.id}">${user.name} (${user.email})</option>`;
              });
              
              // Create modal HTML
              const modalHtml = `
                  <div id="assignTaskModal" class="modal-overlay" onclick="closeAssignTaskModal(event)">
                      <div class="modal-content" onclick="event.stopPropagation()">
                          <div class="modal-header">
                              <h3>Assign New Task</h3>
                              <button class="modal-close" onclick="closeAssignTaskModal()">&times;</button>
                          </div>
                          <div class="modal-body">
                              <form id="assignTaskForm">
                                  <div class="form-group">
                                      <label for="taskName">Task Name:</label>
                                      <input type="text" id="taskName" name="taskName" required 
                                             placeholder="Enter task description..." 
                                             style="width: 100%; padding: 10px; border: 1px solid #666; border-radius: 5px; background: #222; color: white;">
                                  </div>
                                  <div class="form-group">
                                      <label for="assignedTo">Assign To:</label>
                                      <select id="assignedTo" name="assignedTo" required 
                                              style="width: 100%; padding: 10px; border: 1px solid #666; border-radius: 5px; background: #222; color: white;">
                                          ${userOptions}
                                      </select>
                                  </div>
                                  <div class="modal-actions">
                                      <button type="button" class="cancel-button" onclick="closeAssignTaskModal()">Cancel</button>
                                      <button type="submit" class="save-button">Save Task</button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  </div>
              `;
              
              // Add modal to page
              document.body.insertAdjacentHTML('beforeend', modalHtml);
              
              // Add form submit handler
              document.getElementById('assignTaskForm').addEventListener('submit', handleAssignTaskSubmit);
              
          } catch (error) {
              console.error('Error opening assign task modal:', error);
              alert('Error loading users for task assignment');
          }
      }

      // Handle assign task form submission
      async function handleAssignTaskSubmit(event) {
          event.preventDefault();
          
          const taskName = document.getElementById('taskName').value.trim();
          const assignedToId = document.getElementById('assignedTo').value;
          
          if (!taskName || !assignedToId) {
              alert('Please fill in all fields');
              return;
          }
          
          try {
              const response = await fetch('/api/assign_task', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      task_name: taskName,
                      assigned_to_id: parseInt(assignedToId)
                  })
              });
              
              const data = await response.json();
              
              if (data.status === 'success') {
                  closeAssignTaskModal();
                  loadAssignTasks(); // Refresh the task list
                  alert('Task assigned successfully!');
              } else {
                  alert('Error assigning task: ' + data.message);
              }
          } catch (error) {
              console.error('Error assigning task:', error);
              alert('Error assigning task. Please try again.');
          }
      }

      // Close assign task modal
      function closeAssignTaskModal(event) {
          if (event && event.target !== event.currentTarget) return;
          
          const modal = document.getElementById('assignTaskModal');
          if (modal) {
              modal.remove();
          }
      }

      // Complete task function for employees
      async function completeTask(taskId) {
          if (!confirm('Are you sure you want to mark this task as completed?')) {
              return;
          }
          
          try {
              const response = await fetch(`/api/complete_task/${taskId}`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  }
              });
              
              const data = await response.json();
              
              if (data.status === 'success') {
                  loadAssignedTasks(); // Refresh the task list
                  alert('Task marked as completed!');
              } else {
                  alert('Error completing task: ' + data.message);
              }
          } catch (error) {
              console.error('Error completing task:', error);
              alert('Error completing task. Please try again.');
          }
      }

      
// --- SUPPORT SECTION ---
      // --- SUPPORT SECTION ---
      function loadSupportSection() {
    const supportContainer = document.getElementById('supportContentContainer');
    if (!supportContainer) return;

    supportContainer.innerHTML = `
        <h2 style="margin-bottom: 20px;">💬 Support</h2>
        <div class="query-box">
            <form id="supportQueryForm">
                <textarea id="supportQueryText" placeholder="Type your query here..." style="width: 100%; height: 120px; padding: 10px; border-radius: 5px; border: 1px solid #555; background: #222; color: #fff;"></textarea>
                <button type="submit" class="add-button" style="margin-top: 15px;">Send Query</button>
            </form>
        </div>
        <div class="faq-section">
            <h3 style="text-align: center; color: #00d1ff; margin-bottom: 20px;">Frequently Asked Questions</h3>
            <div class="faq-container">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>1. What is the purpose of this ERP system?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>This ERP (Enterprise Resource Planning) platform centralizes company operations, enabling efficient management of users, attendance, teams, roles, salaries, assets, billing, and support—all from a single dashboard.</p></div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>2. Who can use the ERP system?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>Only authorized employees with valid login credentials can access the ERP. Access levels and permissions are controlled through role-based authentication.</p></div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>3. How is attendance managed in the system?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>Attendance can be marked manually or through integrated attendance systems. Admins and authorized managers can view, edit, and generate attendance reports.</p></div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>4. How are salaries handled?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>The Salaries module allows payroll teams to calculate, manage, and disburse employee salaries. It also maintains payment records for future reference.</p></div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>5. Can I manage company assets here?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>Yes. The Assets module lets you track company-owned assets, assign them to employees, and maintain their lifecycle history.</p></div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>6. What is the Billing module used for?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>The Billing section handles client invoices, payments, and expense tracking to streamline financial management.</p></div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>7. How does role management work?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>The Roles module assigns specific access permissions and functionalities to different users, ensuring data security and workflow control.</p></div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>8. How can I raise a support request?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>Use the Support module to submit technical or operational issues. The support team will address your request as per company SLA.</p></div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>9. Can I customize settings in the ERP?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>Yes. The Settings module lets you configure system preferences, notification settings, and other custom parameters.</p></div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>10. Is my data secure in this ERP?</span><span class="faq-toggle">▼</span>
                    </div>
                    <div class="faq-answer"><p>Yes. The ERP uses role-based access control, encrypted data storage, and secure login protocols to ensure that sensitive business data remains protected.</p></div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('supportQueryForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const queryText = document.getElementById('supportQueryText').value;
        if (queryText.trim() === "") {
            alert("Please enter your query.");
            return;
        }
        const subject = "New Support Query from ERP Dashboard";
        const body = encodeURIComponent(queryText);
        window.location.href = `mailto:admin@ssev.co.in?subject=${subject}&body=${body}`;
    });
}
    function toggleFaq(element) {
    const answer = element.nextElementSibling;
    element.classList.toggle('active');

    if (answer.style.maxHeight) {
        answer.style.maxHeight = null;
        answer.style.padding = "0 20px";
    } else {
        answer.style.padding = "0 20px";
        answer.style.maxHeight = answer.scrollHeight + 40 + "px";
    }
}

// Add event listeners for download buttons after the salaries section is loaded
function addSalaryDownloadListeners() {
    // Add event listeners for the first set of buttons
    const downloadSsevSheet = document.getElementById('downloadSsevSheet');
    const downloadSoftsolsSheet = document.getElementById('downloadSoftsolsSheet');
    
    if (downloadSsevSheet) {
        downloadSsevSheet.addEventListener('click', () => {
            downloadSalarySheetTable('SSEV');
        });
    }
    
    if (downloadSoftsolsSheet) {
        downloadSoftsolsSheet.addEventListener('click', () => {
            downloadSalarySheetTable('SSEV Softsols');
        });
    }
    
    // Add event listeners for the second set of buttons
    const downloadSsevSheet2 = document.getElementById('downloadSsevSheet2');
    const downloadSoftsolsSheet2 = document.getElementById('downloadSoftsolsSheet2');
    
    if (downloadSsevSheet2) {
        downloadSsevSheet2.addEventListener('click', () => {
            downloadSalarySheetTable('SSEV');
        });
    }
    
    if (downloadSoftsolsSheet2) {
        downloadSoftsolsSheet2.addEventListener('click', () => {
            downloadSalarySheetTable('SSEV Softsols');
        });
    }
}

async function downloadSalarySheetByBranch(branchName) {
    try {
        const response = await fetch('/api/get_all_employee_info');
        const data = await response.json();

        if (data.status !== 'success' || !data.employees) {
            alert('❌ Failed to fetch employee data.');
            return;
        }

        const normalizedBranchName = branchName.trim().toUpperCase();
        
        // Debug: Log all employees and their branches
        console.log('All employees:', data.employees);
        console.log('Looking for branch:', normalizedBranchName);
        
        const employeesForBranch = data.employees.filter(emp => {
            if (emp.office_branch) {
                const empBranch = emp.office_branch.trim().toUpperCase();
                console.log(`Employee ${emp.full_name}: branch="${emp.office_branch}" -> normalized="${empBranch}"`);
                // Handle the specific case where dropdown shows "SSEV SOFT SOLS" but database has "SSEV SOFTSOLS"
                if (normalizedBranchName === 'SSEV SOFT SOLS') {
                    return empBranch === 'SSEV SOFT SOLS' || 
                           empBranch === 'SSEV SOFTSOLS' || 
                           empBranch === 'SSEVSOFTSOLS' ||
                           empBranch.includes('SOFT') ||
                           empBranch.includes('SOFTSOLS');
                }
                
                return empBranch === normalizedBranchName;
            }
            console.log(`Employee ${emp.full_name}: no office_branch field`);
            return false;
        });

        // Check if we have employees without office_branch and include them for SSEV Softsols
        const employeesWithoutBranch = data.employees.filter(emp => !emp.office_branch);
        
        if (employeesForBranch.length === 0) {
            if (employeesWithoutBranch.length > 0 && branchName === 'SSEV Softsols') {
                // For SSEV Softsols, include employees without branch assignment
                employeesForBranch.push(...employeesWithoutBranch);
                console.log(`Including employees without branch for SSEV Softsols: ${employeesWithoutBranch.map(emp => emp.full_name).join(', ')}`);
            } else {
                alert(`No employees found for the branch: ${branchName}`);
                return;
            }
        } else if (employeesWithoutBranch.length > 0 && branchName === 'SSEV Softsols') {
            // If we found some employees with branch, also include those without branch for SSEV Softsols
            employeesForBranch.push(...employeesWithoutBranch);
            console.log(`Also including employees without branch for SSEV Softsols: ${employeesWithoutBranch.map(emp => emp.full_name).join(', ')}`);
        }

        const payslipElements = [];
        for (const employee of employeesForBranch) {
            console.log(`Fetching details for employee: ${employee.full_name} (ID: ${employee.id})`);
            
            try {
                const empDetailsResponse = await fetch(`/api/get_employee_info/${employee.id}`);
                const empDetailsData = await empDetailsResponse.json();

                console.log(`Employee ${employee.full_name} details:`, empDetailsData);

                if (empDetailsData.status === 'success' && empDetailsData.employee) {
                    const payslipHtml = createPayslipHtml(empDetailsData.employee, branchName);
                    payslipElements.push(payslipHtml);
                    console.log(`✅ Successfully created payslip for ${employee.full_name}`);
                } else {
                    console.error(`❌ Failed to get employee details for ${employee.full_name}:`, empDetailsData);
                }
            } catch (error) {
                console.error(`❌ Error fetching details for ${employee.full_name}:`, error);
            }
        }

        console.log(`📊 Summary: Found ${employeesForBranch.length} employees, generated ${payslipElements.length} payslips`);
        
        if (payslipElements.length === 0) {
            alert(`No payslips could be generated for the employees of branch: ${branchName}`);
            return;
        }
        
        if (payslipElements.length < employeesForBranch.length) {
            console.warn(`⚠️ Warning: Only ${payslipElements.length} out of ${employeesForBranch.length} employees had complete salary data`);
        }
        
        // Join the HTML strings with page breaks
        let payslipsWithBreaks = payslipElements.join('<div style="page-break-after: always;"></div>');

        const filename = `${branchName}_Salary_Sheet.pdf`;
        html2pdf().from(payslipsWithBreaks).set({
            margin: [10, 10, 10, 10],
            filename: filename,
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();

        alert(`✅ ${branchName} salary sheet is being generated and downloaded.`);
    } catch (error) {
        console.error('Error downloading salary sheet:', error);
        alert('An error occurred while generating the salary sheet.');
    }
}

function createPayslipHtml(emp, companyBranch = '') {
    // Total Earnings = Basic + HRA + Conveyance + Special Allowance + Vehicle Maintenance + Add Others (from earnings section)
    const totalEarnings = (emp.basic || 0) + (emp.hra || 0) + (emp.conveyance || 0) + (emp.special_allowance || 0) + (emp.vehicle_maintenance || 0) + (emp.add_others || 0);
    // Total Deductions = PF + ESI + Professional Tax + Income Tax + Advance + Other Deductions + Loss of Pay
    const totalDeductions = (emp.provident_fund || 0) + (emp.esi || 0) + (emp.professional_tax || 0) + (emp.income_tax || 0) + (emp.advance || 0) + (emp.other_deductions || 0) + (emp.loss_of_pay || 0);
    const netSalary = totalEarnings - totalDeductions;
    const payslipTitle = getCurrentMonthYear();

    // Determine watermark based on company branch
    let watermarkSrc = '';
    if (companyBranch && companyBranch.toLowerCase().includes('softsols')) {
        watermarkSrc = 'static/images/watermark-ssev-softsols.png';
    } else {
        watermarkSrc = 'static/images/watermark-ssev.png';
    }
    
    console.log(`Using watermark: ${watermarkSrc} for company branch: ${companyBranch}`);

    return `
    <div class="payslip-container" style="position: relative;">
        <!-- Watermark -->
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; display: flex; align-items: center; justify-content: center; background-image: url('${watermarkSrc}'); background-repeat: no-repeat; background-position: center; background-size: contain;">
        </div>
        
        <table class="payslip-header-table">
            <tr>
                <td style="width: 15%; border: none;">
                    <img src="static/images/logo.png" alt="Company Logo" class="payslip-logo">
                </td>
                <td style="width: 85%; border: none; padding: 0;">
                    <div class="company-name">SSEV SOFTWARE SOLUTIONS PRIVATE LIMITED</div>
                    <div class="company-details">Corporate office: #2-057/A/112, 1st Floor, VSS Nandadeep,<br>Near Medchal RTA Office, Petbasheerabad Village, Kompally Road,<br>Medchal District Telangana Hyderabad 500067.<br>Ph.040-35042301.</div>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="payslip-title" style="border-left: none; border-right: none;">${payslipTitle}</td>
            </tr>
        </table>
        
        <table class="payslip-main-table" style="margin-top: 20px;">
            <tr>
                <td style="width: 25%;">Employee No</td>
                <td style="width: 25%;">${emp.employee_id || 'N/A'}</td>
                <td style="width: 25%;">Designation</td>
                <td style="width: 25%;">${emp.designation || 'N/A'}</td>
            </tr>
            <tr>
                <td>Name</td>
                <td>${emp.full_name || 'N/A'}</td>
                <td>Total Days</td>
                <td>${emp.total_days || '30'}</td>
            </tr>
            <tr>
                <td>Bank A/c No</td>
                <td>${emp.bank_account_number || 'N/A'}</td>
                <td>LOP</td>
                <td>${emp.loss_of_pay || '0'}</td>
            </tr>
            <tr>
                <td>PF No.</td>
                <td>${emp.pf_no || 'N/A'}</td>
                <td>Date of Joining</td>
                <td>${emp.date_of_joining || 'N/A'}</td>
            </tr>
            <tr>
                <td colspan="2"></td>
                <td>Effective work days</td>
                <td>${emp.ndp || '0'}</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: center;">Total Leaves : ${emp.total_leaves || '0'} | Leave Availed : ${emp.leave_availed || '0'} | Balance : ${emp.balance_leaves || '0'}</td>
            </tr>
            <tr>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Earnings</th>
                <th colspan="2" style="text-align: center; background-color: #ddd;">Deductions</th>
            </tr>
            <tr>
                <td>BASIC</td>
                <td>${(emp.basic || 0).toFixed(2)}</td>
                <td>PF</td>
                <td>${(emp.provident_fund || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>HRA</td>
                <td>${(emp.hra || 0).toFixed(2)}</td>
                <td>ESI</td>
                <td>${(emp.esi || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>CONVEYANCE</td>
                <td>${(emp.conveyance || 0).toFixed(2)}</td>
                <td>P. Tax</td>
                <td>${(emp.professional_tax || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>VEHICLE MAINTENANCE</td>
                <td>${(emp.vehicle_maintenance || 0).toFixed(2)}</td>
                <td>Income Tax</td>
                <td>${(emp.income_tax || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>SPL ALLOWANCE</td>
                <td>${(emp.special_allowance || 0).toFixed(2)}</td>
                <td>Advance</td>
                <td>${(emp.advance || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td>Add Others</td>
                <td>${(emp.add_others || 0).toFixed(2)}</td>
                <td>Others Deduction</td>
                <td>${(emp.other_deductions || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td colspan="2" style="border: none;"></td>
                <td>Loss of Pay</td>
                <td>${(emp.loss_of_pay || 0).toFixed(2)}</td>
            </tr>
            <tr class="payslip-total-row">
                <td>Total Earnings</td>
                <td>${totalEarnings.toFixed(2)}</td>
                <td>Total Deduction</td>
                <td>${totalDeductions.toFixed(2)}</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: right; font-weight: bold; font-size: 12pt;">Net Salary: ${netSalary.toFixed(2)}</td>
            </tr>
        </table>
        
        <!-- System Generated Disclaimer -->
        <div style="margin-top: 20px; text-align: left; font-size: 10pt; color: #666;">
            It is System generated, Signature not required
        </div>
    </div>`;
}

// Call the function to add event listeners when the page loads
document.addEventListener('DOMContentLoaded', function() {
    addSalaryDownloadListeners();
});



    </script>

</body>

</html>
